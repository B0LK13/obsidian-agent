/*
=========================================================
  OBSIDIAN AGENT PLUGIN
  AI-enhanced assistant for Obsidian
  
  Version: 1.4.0
  Author: B0LK13
  License: MIT
  Repository: https://github.com/B0LK13/obsidian-agent
=========================================================
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository
*/

"use strict";var me=Object.defineProperty;var He=Object.getOwnPropertyDescriptor;var Ue=Object.getOwnPropertyNames;var _e=Object.prototype.hasOwnProperty;var ze=(p,s)=>{for(var e in s)me(p,e,{get:s[e],enumerable:!0})},qe=(p,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let n of Ue(s))!_e.call(p,n)&&n!==e&&me(p,n,{get:()=>s[n],enumerable:!(t=He(s,n))||t.enumerable});return p};var je=p=>qe(me({},"__esModule",{value:!0}),p);var Ze={};ze(Ze,{default:()=>pe});module.exports=je(Ze);var g=require("obsidian");var fe=[{id:"openai-gpt4",name:"OpenAI GPT-4",apiProvider:"openai",apiKey:"",customApiUrl:"",model:"gpt-4",temperature:.7,maxTokens:2e3,systemPrompt:"You are a helpful AI assistant integrated into Obsidian."},{id:"openai-gpt35",name:"OpenAI GPT-3.5 (Fast)",apiProvider:"openai",apiKey:"",customApiUrl:"",model:"gpt-3.5-turbo",temperature:.7,maxTokens:2e3,systemPrompt:"You are a helpful AI assistant integrated into Obsidian."},{id:"anthropic-claude",name:"Anthropic Claude",apiProvider:"anthropic",apiKey:"",customApiUrl:"",model:"claude-3-sonnet-20240229",temperature:.7,maxTokens:2e3,systemPrompt:"You are a helpful AI assistant integrated into Obsidian."},{id:"ollama-local",name:"Ollama (Local)",apiProvider:"ollama",apiKey:"",customApiUrl:"http://localhost:11434",model:"llama2",temperature:.7,maxTokens:2e3,systemPrompt:"You are a helpful AI assistant integrated into Obsidian."}],P={enabled:!0,triggerMode:"both",autoTriggerDelay:1e3,manualTriggerShortcut:"ctrl+space",phraseTriggers:["...","//"],maxCompletions:5,maxTokens:100,debounceDelay:300,showInMarkdownOnly:!1,excludedFolders:["templates",".obsidian"]},O={enabled:!0,suggestionTypes:{links:!0,tags:!0,summaries:!0,todos:!0,improvements:!0,expansions:!0,organization:!0},autoAnalyze:!0,maxSuggestions:5,privacyMode:"hybrid"},Pe={apiKey:"",apiProvider:"openai",customApiUrl:"",model:"gpt-4",temperature:.7,maxTokens:2e3,systemPrompt:"You are a helpful AI assistant integrated into Obsidian. Help users with note-taking, knowledge management, and content generation.",enableAutoCompletion:!1,enableContextAwareness:!0,enableTokenTracking:!0,costThreshold:10,conversations:[],maxConversations:20,enableConversationPersistence:!0,profiles:[],activeProfileId:"default",customTemplates:[],contextConfig:{enableLinkedNotes:!1,enableBacklinks:!1,enableTagContext:!1,enableFolderContext:!1,maxNotesPerSource:5,maxTokensPerNote:1e3,linkDepth:1,excludeFolders:"templates, .obsidian"},cacheConfig:{enabled:!0,maxEntries:100,maxAgeDays:30,matchThreshold:1},cacheData:{entries:[],stats:{totalEntries:0,totalHits:0,totalMisses:0,estimatedSavings:0,cacheSize:0}},accessibilityConfig:{enableHighContrast:!1,enableReducedMotion:!1},completionConfig:P,suggestionConfig:O,embeddingConfig:{provider:"openai",model:"text-embedding-3-small",enabled:!1,autoRefresh:!0}};function _(){return`profile_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function Ae(p){return{id:"default",name:"Default",apiProvider:p.apiProvider,apiKey:p.apiKey,customApiUrl:p.customApiUrl,model:p.model,temperature:p.temperature,maxTokens:p.maxTokens,systemPrompt:p.systemPrompt}}var u=require("obsidian");var ye=require("obsidian");var De={enabled:!0,maxEntries:100,maxAgeDays:30,matchThreshold:1},z=class{constructor(s){this.cache=new Map;this.stats={totalEntries:0,totalHits:0,totalMisses:0,estimatedSavings:0,cacheSize:0};this.settings=s||De}hashString(s){let e=0;for(let t=0;t<s.length;t++){let n=s.charCodeAt(t);e=(e<<5)-e+n,e=e&e}return Math.abs(e).toString(36)}generateCacheKey(s,e,t,n){let i=this.hashString(s.trim().toLowerCase()),a=this.hashString((e||"").trim().toLowerCase()),o=n.toFixed(2);return`${i}_${a}_${t}_${o}`}generateKeyFromEntry(s){var t,n;let e=(n=(t=s.temperature)==null?void 0:t.toFixed(2))!=null?n:"0.00";return s.promptHash&&s.contextHash?`${s.promptHash}_${s.contextHash}_${s.model}_${e}`:this.generateCacheKey(s.prompt,"",s.model,s.temperature)}get(s,e,t,n){if(!this.settings.enabled)return null;let i=this.generateCacheKey(s,e,t,n),a=this.cache.get(i);if(!a)return this.stats.totalMisses++,null;let o=this.settings.maxAgeDays*24*60*60*1e3;return Date.now()-a.createdAt>o?(this.cache.delete(i),this.stats.totalMisses++,null):(a.accessedAt=Date.now(),a.accessCount++,this.cache.set(i,a),this.stats.totalHits++,this.stats.estimatedSavings+=a.tokensUsed,a)}set(s,e,t,n,i,a,o=0,r=0){if(!this.settings.enabled)return this.createEntry(s,e,t,n,i,a,o,r);this.cache.size>=this.settings.maxEntries&&this.evictOldest();let c=this.generateCacheKey(s,e,t,n),l=this.createEntry(s,e,t,n,i,a,o,r);return this.cache.set(c,l),this.stats.totalEntries=this.cache.size,this.updateCacheSize(),l}createEntry(s,e,t,n,i,a,o,r){let c=Date.now();return{id:`cache_${c}_${Math.random().toString(36).substr(2,9)}`,promptHash:this.hashString(s.trim().toLowerCase()),contextHash:this.hashString((e||"").trim().toLowerCase()),prompt:s,response:i,model:t,temperature:n,tokensUsed:a,inputTokens:o,outputTokens:r,createdAt:c,accessedAt:c,accessCount:1}}evictOldest(){let s=null,e=1/0;for(let[t,n]of this.cache.entries())n.accessedAt<e&&(e=n.accessedAt,s=t);s&&this.cache.delete(s)}updateCacheSize(){let s=0;for(let e of this.cache.values())s+=e.prompt.length+e.response.length+200;this.stats.cacheSize=s}deleteEntry(s){for(let[e,t]of this.cache.entries())if(t.id===s)return this.cache.delete(e),this.stats.totalEntries=this.cache.size,this.updateCacheSize(),!0;return!1}clearCache(){this.cache.clear(),this.stats.totalEntries=0,this.stats.cacheSize=0}resetStats(){this.stats.totalHits=0,this.stats.totalMisses=0,this.stats.estimatedSavings=0}getStats(){return{...this.stats,totalEntries:this.cache.size}}getAllEntries(){return Array.from(this.cache.values()).sort((s,e)=>e.accessedAt-s.accessedAt)}getHitRate(){let s=this.stats.totalHits+this.stats.totalMisses;return s===0?0:this.stats.totalHits/s*100}getEstimatedCostSavings(s=.002){return this.stats.estimatedSavings/1e3*s}updateSettings(s){for(this.settings={...this.settings,...s};this.cache.size>this.settings.maxEntries;)this.evictOldest();this.stats.totalEntries=this.cache.size}getSettings(){return{...this.settings}}exportCache(){return{entries:this.getAllEntries(),stats:this.getStats(),settings:this.getSettings()}}importCache(s){if(s.settings&&(this.settings={...De,...s.settings}),s.stats&&(this.stats={...this.stats,...s.stats}),s.entries){this.cache.clear();let e=Date.now(),t=this.settings.maxAgeDays*24*60*60*1e3;for(let n of s.entries){if(e-n.createdAt>t)continue;let i=this.generateKeyFromEntry(n);if(this.cache.set(i,n),this.cache.size>=this.settings.maxEntries)break}this.stats.totalEntries=this.cache.size,this.updateCacheSize()}}isEnabled(){return this.settings.enabled}setEnabled(s){this.settings.enabled=s}invalidateByContext(s){let e=0,t=[];for(let[n,i]of this.cache.entries())i.prompt.includes(s)&&(t.push(n),e++);for(let n of t)this.cache.delete(n);return this.stats.totalEntries=this.cache.size,this.updateCacheSize(),e}cleanExpired(){let s=Date.now(),e=this.settings.maxAgeDays*24*60*60*1e3,t=0,n=[];for(let[i,a]of this.cache.entries())s-a.createdAt>e&&(n.push(i),t++);for(let i of n)this.cache.delete(i);return this.stats.totalEntries=this.cache.size,this.updateCacheSize(),t}getFormattedCacheSize(){let s=this.stats.cacheSize;return s<1024?`${s} B`:s<1024*1024?`${(s/1024).toFixed(1)} KB`:`${(s/(1024*1024)).toFixed(1)} MB`}getMostFrequentEntries(s=10){return Array.from(this.cache.values()).sort((e,t)=>t.accessCount-e.accessCount).slice(0,s)}getRecentlyAccessedEntries(s=10){return Array.from(this.cache.values()).sort((e,t)=>t.accessedAt-e.accessedAt).slice(0,s)}getPrefetchCandidates(s,e=5){let t=new Set(s.toLowerCase().split(/\s+/)),n=[];for(let i of this.cache.values()){let a=new Set(i.prompt.toLowerCase().split(/\s+/)),o=0;for(let c of t)a.has(c)&&o++;let r=o/Math.max(t.size,1)*(i.accessCount/10);r>.3&&n.push({entry:i,score:r})}return n.sort((i,a)=>a.score-i.score).slice(0,e).map(i=>i.entry)}optimize(){let s=Array.from(this.cache.entries()),e=Date.now(),t=0,n=s.map(([a,o])=>{let r=1/(1+(e-o.accessedAt)/864e5),c=Math.min(o.accessCount/100,1),l=1/(1+o.response.length/1e3),d=r*.4+c*.4+l*.2;return{key:a,entry:o,value:d}}),i=this.settings.maxEntries*.8;if(this.cache.size>i){n.sort((o,r)=>o.value-r.value);let a=Math.floor((this.cache.size-i)*1.2);for(let o=0;o<a&&o<n.length;o++)this.cache.delete(n[o].key),t++;this.stats.totalEntries=this.cache.size,this.updateCacheSize()}return t}batchGet(s){let e=new Map;for(let t of s){let n=this.get(t.prompt,t.context,t.model,t.temperature);if(n){let i=this.generateCacheKey(t.prompt,t.context,t.model,t.temperature);e.set(i,n)}}return e}batchSet(s){let e=0;for(let t of s)this.set(t.prompt,t.context,t.model,t.temperature,t.response,t.tokensUsed,t.inputTokens||0,t.outputTokens||0),e++;return e}getPerformanceMetrics(){let s=Array.from(this.cache.values()),e=this.stats.totalHits+this.stats.totalMisses,t=e>0?this.stats.totalHits/e*100:0,n=s.map(r=>r.accessCount).sort((r,c)=>r-c),i=n.length>0?n.reduce((r,c)=>r+c,0)/n.length:0,a=n.length>0?n[Math.floor(n.length/2)]:0,o=s.length>0?this.stats.totalHits/s.length:0;return{hitRate:t,avgAccessCount:i,medianAccessCount:a,totalSavings:this.stats.estimatedSavings,estimatedCostSavings:this.getEstimatedCostSavings(),cacheEfficiency:o}}};var F=class p extends Error{constructor(e,t){super(e);this.code=t;this.name="AgentError",Object.setPrototypeOf(this,p.prototype)}},C=class p extends F{constructor(e,t){super(e,"VALIDATION_ERROR");this.field=t;this.name="ValidationError",Object.setPrototypeOf(this,p.prototype)}},L=class p extends F{constructor(e,t,n){super(e,"API_ERROR");this.statusCode=t;this.provider=n;this.name="APIError",Object.setPrototypeOf(this,p.prototype)}},M=class p extends F{constructor(e,t){super(e,"CONFIGURATION_ERROR");this.setting=t;this.name="ConfigurationError",Object.setPrototypeOf(this,p.prototype)}},q=class p extends F{constructor(e,t){super(e,"NETWORK_ERROR");this.originalError=t;this.name="NetworkError",Object.setPrototypeOf(this,p.prototype)}};var T=class{static required(s,e){if(s==null)throw new C(`${e} is required`,e);return s}static notEmpty(s,e){let t=this.required(s,e);if(typeof t!="string"||t.trim().length===0)throw new C(`${e} cannot be empty`,e);return t}static inRange(s,e,t,n){if(typeof s!="number"||isNaN(s))throw new C(`${n} must be a valid number`,n);if(s<e||s>t)throw new C(`${n} must be between ${e} and ${t}`,n);return s}static positive(s,e){if(typeof s!="number"||isNaN(s)||s<=0)throw new C(`${e} must be a positive number`,e);return s}static nonNegative(s,e){if(typeof s!="number"||isNaN(s)||s<0)throw new C(`${e} must be a non-negative number`,e);return s}static notEmptyArray(s,e){let t=this.required(s,e);if(!Array.isArray(t)||t.length===0)throw new C(`${e} must be a non-empty array`,e);return t}static oneOf(s,e,t){if(!e.includes(s))throw new C(`${t} must be one of: ${e.join(", ")}`,t);return s}static apiKey(s,e="API key"){let t=this.notEmpty(s,e);if(t.length<10)throw new C(`${e} is too short (minimum 10 characters)`,e);return t}static url(s,e){let t=this.notEmpty(s,e);try{new URL(t)}catch(n){throw new C(`${e} is not a valid URL`,e)}return t}static temperature(s){return this.inRange(s,0,2,"temperature")}static maxTokens(s){return this.inRange(s,1,1e5,"maxTokens")}static safeArrayAccess(s,e,t){return!Array.isArray(s)||e<0||e>=s.length?t:s[e]}static safeGet(s,e,t){if(!s||typeof s!="object")return t;let n=s[e];return n!==void 0?n:t}static maxLength(s,e,t){let n=this.required(s,t);if(typeof n!="string")throw new C(`${t} must be a string`,t);return n.length>e?n.substring(0,e):n}static isString(s){return typeof s=="string"}static isNumber(s){return typeof s=="number"&&!isNaN(s)}static isObject(s){return typeof s=="object"&&s!==null&&!Array.isArray(s)}static isArray(s){return Array.isArray(s)}};var $=class{constructor(s){this.timeoutMs=3e4;this.maxRetries=3;this.initialRetryDelayMs=1e3;this.retryDelayMultiplier=2;this.currentAbortController=null;this.bypassCache=!1;var e;if(!s)throw new C("Settings are required");if(this.settings=s,this.cacheService=new z(s.cacheConfig),(e=s.cacheData)!=null&&e.entries&&Array.isArray(s.cacheData.entries)&&s.cacheData.entries.length>0)try{this.cacheService.importCache({entries:s.cacheData.entries,stats:s.cacheData.stats||{hits:0,misses:0,evictions:0},settings:s.cacheConfig})}catch(t){console.error("Failed to import cache data:",t)}}getCacheService(){return this.cacheService}setBypassCache(s){this.bypassCache=s}updateCacheSettings(s){this.cacheService.updateSettings(s.cacheConfig)}cancelCurrentRequest(){this.currentAbortController&&(this.currentAbortController.abort(),this.currentAbortController=null)}async testConnection(){if(this.settings.apiProvider!=="ollama"&&!this.settings.apiKey)return{success:!1,message:"API key not configured"};let s=Date.now();try{let e=await this.callAPIWithRetry([{role:"user",content:'Test connection. Please respond with "OK" only.'}],void 0,1),t=Date.now()-s;return!e||typeof e.text!="string"?{success:!1,message:"Connection succeeded but received invalid response"}:e.text.trim().toLowerCase()==="ok"||e.text.length>0?{success:!0,message:`Connection successful! Response time: ${t}ms`,responseTime:t}:{success:!1,message:"Connection succeeded but returned unexpected response"}}catch(e){let t=Date.now()-s;return{success:!1,message:this.getErrorMessage(e),responseTime:t}}}async generateCompletion(s){let e=typeof s=="string"?{prompt:s}:s,{prompt:t,context:n,imageData:i,stream:a,onChunk:o,onProgress:r}=e;try{T.notEmpty(t,"prompt")}catch(l){throw new C("Prompt cannot be empty")}if(this.settings.apiProvider!=="ollama"&&!this.settings.apiKey)throw new M("API key not configured. Please set it in settings.","apiKey");if(!this.settings.model||this.settings.model.trim().length===0)throw new M("Model not configured. Please select a model in settings.","model");if(!a&&!this.bypassCache&&this.cacheService.isEnabled())try{let l=this.cacheService.get(t,n||"",this.settings.model,this.settings.temperature);if(l)return{text:l.response,tokensUsed:l.tokensUsed,inputTokens:l.inputTokens,outputTokens:l.outputTokens,fromCache:!0,cacheEntry:l}}catch(l){console.warn("Cache lookup failed, continuing with API call:",l)}this.bypassCache=!1;let c=[];this.settings.systemPrompt&&this.settings.systemPrompt.trim().length>0&&c.push({role:"system",content:this.settings.systemPrompt}),n&&this.settings.enableContextAwareness&&n.trim().length>0&&c.push({role:"system",content:`Context from current note:
${n}`}),c.push({role:"user",content:t});try{let l;if(a&&o?l=await this.streamAPI(c,i,o,r):l=await this.callAPIWithRetry(c,i),!l||typeof l.text!="string")throw new L("Received invalid response from API");if(this.cacheService.isEnabled()&&l.text&&l.text.length>0)try{let d=this.cacheService.set(t,n||"",this.settings.model,this.settings.temperature,l.text,l.tokensUsed||0,l.inputTokens||0,l.outputTokens||0);l.cacheEntry=d}catch(d){console.warn("Failed to cache result:",d)}return l.fromCache=!1,l}catch(l){throw console.error("AI Service Error:",l),l instanceof C||l instanceof L||l instanceof M||l instanceof q?l:new L(this.getErrorMessage(l))}}getErrorMessage(s){var e,t,n,i,a,o,r,c,l,d,h,m,f;return s.name==="AbortError"||(e=s.message)!=null&&e.includes("timeout")?"Request timed out. Please check your internet connection and try again.":(t=s.message)!=null&&t.includes("401")||(n=s.message)!=null&&n.includes("authentication")?"Invalid API key. Please check your API key in settings.":(i=s.message)!=null&&i.includes("429")||(a=s.message)!=null&&a.includes("rate limit")||(o=s.message)!=null&&o.includes("API limit")?"API rate limit reached. Please wait a moment and try again. Tip: Consider using a local LLM like Ollama for unlimited usage.":(r=s.message)!=null&&r.includes("500")||(c=s.message)!=null&&c.includes("502")||(l=s.message)!=null&&l.includes("503")?"API service is temporarily unavailable. Please try again later. Tip: Check https://status.openai.com or provider status page.":(d=s.message)!=null&&d.includes("404")||(h=s.message)!=null&&h.includes("model not found")?"Model not found. Please check the model name in settings.":(m=s.message)!=null&&m.includes("quota")||(f=s.message)!=null&&f.includes("billing")?"API quota exceeded or billing issue. Please check your provider dashboard. Tip: Consider using a local LLM like Ollama to avoid API costs.":`Failed to generate completion: ${s.message}`}async callAPIWithRetry(s,e,t){let n=t!=null?t:this.maxRetries,i;for(let a=0;a<=n;a++)try{if(a>0){let o=this.getRetryDelay(a);await this.sleep(o)}return await this.callAPIWithTimeout(s,e)}catch(o){if(i=o,this.shouldNotRetry(o))throw o;if(a<n){let r=this.getRetryDelay(a+1);console.log(`Retry attempt ${a+1}/${n} after ${r}ms`)}}throw i}shouldNotRetry(s){var t;let e=((t=s.message)==null?void 0:t.toLowerCase())||"";return!!(e.includes("401")||e.includes("authentication")||e.includes("404")||e.includes("model not found")||e.includes("429")||e.includes("rate limit")||e.includes("api limit")||e.includes("quota")||e.includes("billing"))}getRetryDelay(s){return this.initialRetryDelayMs*Math.pow(this.retryDelayMultiplier,s-1)}async streamAPI(s,e,t,n){var f,y,x,S;let i,a,o;switch(this.settings.apiProvider){case"openai":i="https://api.openai.com/v1/chat/completions",a={"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`};let k=[...s];if(e){let w=k.map(v=>v.role).lastIndexOf("user");if(w!==-1){let v=k[w].content;k[w].content=[{type:"text",text:v},{type:"image_url",image_url:{url:e.startsWith("data:")?e:`data:image/jpeg;base64,${e}`}}]}}o={model:e?this.settings.model.includes("vision")?this.settings.model:"gpt-4o":this.settings.model,messages:k,temperature:this.settings.temperature,max_tokens:this.settings.maxTokens,stream:!0};break;case"anthropic":{i="https://api.anthropic.com/v1/messages",a={"Content-Type":"application/json","x-api-key":this.settings.apiKey,"anthropic-version":"2023-06-01"};let w=s.find(E=>E.role==="system"),v=s.filter(E=>E.role!=="system");o={model:this.settings.model,max_tokens:this.settings.maxTokens,temperature:this.settings.temperature,system:w==null?void 0:w.content,messages:v,stream:!0};break}case"ollama":{i=`${this.settings.customApiUrl||"http://localhost:11434"}/api/chat`,a={"Content-Type":"application/json"},o={model:this.settings.model,messages:s,options:{temperature:this.settings.temperature,num_predict:this.settings.maxTokens},stream:!0};break}case"custom":{if(!this.settings.customApiUrl)throw new Error("Custom API URL not configured");i=this.settings.customApiUrl,a={"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`},o={model:this.settings.model,messages:s,temperature:this.settings.temperature,max_tokens:this.settings.maxTokens,stream:!0};break}default:throw new Error(`Unknown API provider: ${this.settings.apiProvider}`)}let r="",c=0,l=0,d=0,h=await(0,ye.requestUrl)({url:i,method:"POST",headers:a,body:JSON.stringify(o),throw:!1});if(h.status!==200){let k=h.text||"";throw new Error(`API request failed with status ${h.status}: ${k}`)}let m=h.text||"";if(this.settings.apiProvider==="ollama"){let k=m.split(`
`).filter(Boolean);for(let w of k)try{let v=JSON.parse(w);(f=v.message)!=null&&f.content&&(r+=v.message.content,n&&n(r)),v.eval_count&&(d=v.eval_count),v.prompt_eval_count&&(l=v.prompt_eval_count),v.done&&(c=(v.eval_count||0)+(v.prompt_eval_count||0),t&&t({content:r,done:!0,tokensUsed:c,inputTokens:l,outputTokens:d}))}catch(v){console.error("Failed to parse Ollama chunk:",w)}}else{let k=m.split(`
`);for(let w of k)if(w.startsWith("data: ")){let v=w.slice(6);if(v.trim()==="[DONE]"){t&&t({content:r,done:!0,tokensUsed:c,inputTokens:l,outputTokens:d});break}try{let E=JSON.parse(v),ue="";(S=(x=(y=E.choices)==null?void 0:y[0])==null?void 0:x.delta)!=null&&S.content&&(ue=E.choices[0].delta.content||""),E.usage&&(c=E.usage.total_tokens||0,E.usage.prompt_tokens&&(l=E.usage.prompt_tokens),E.usage.completion_tokens&&(d=E.usage.completion_tokens)),ue&&(r+=ue,n&&n(r))}catch(E){console.error("Failed to parse SSE data:",v)}}}return{text:r,tokensUsed:c||0,inputTokens:l,outputTokens:d}}sleep(s){return new Promise(e=>setTimeout(e,s))}async callAPIWithTimeout(s,e){return Promise.race([this.callAPI(s,e),this.timeoutPromise(this.timeoutMs)])}timeoutPromise(s){return new Promise((e,t)=>{setTimeout(()=>{let n=new Error(`Request timeout after ${s}ms`);n.name="AbortError",t(n)},s)})}async callAPI(s,e){var r,c,l,d,h,m;let t,n,i;switch(this.settings.apiProvider){case"openai":t="https://api.openai.com/v1/chat/completions",n={"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`};let f=[...s];if(e){let y=f.map(x=>x.role).lastIndexOf("user");if(y!==-1){let x=f[y].content;f[y].content=[{type:"text",text:x},{type:"image_url",image_url:{url:e.startsWith("data:")?e:`data:image/jpeg;base64,${e}`}}]}}i={model:e?this.settings.model.includes("vision")?this.settings.model:"gpt-4o":this.settings.model,messages:f,temperature:this.settings.temperature,max_tokens:this.settings.maxTokens};break;case"anthropic":{t="https://api.anthropic.com/v1/messages",n={"Content-Type":"application/json","x-api-key":this.settings.apiKey,"anthropic-version":"2023-06-01"};let y=s.find(S=>S.role==="system"),x=s.filter(S=>S.role!=="system");i={model:this.settings.model,max_tokens:this.settings.maxTokens,temperature:this.settings.temperature,system:y==null?void 0:y.content,messages:x};break}case"ollama":{t=`${this.settings.customApiUrl||"http://localhost:11434"}/api/chat`,n={"Content-Type":"application/json"},i={model:this.settings.model,messages:s,options:{temperature:this.settings.temperature,num_predict:this.settings.maxTokens},stream:!1};break}case"custom":{if(!this.settings.customApiUrl)throw new Error("Custom API URL not configured");t=this.settings.customApiUrl,n={"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`},i={model:this.settings.model,messages:s,temperature:this.settings.temperature,max_tokens:this.settings.maxTokens};break}default:throw new Error(`Unknown API provider: ${this.settings.apiProvider}`)}let a=await(0,ye.requestUrl)({url:t,method:"POST",headers:n,body:JSON.stringify(i),throw:!1});if(a.status!==200){let f=a.text||"";throw new Error(`API request failed with status ${a.status}: ${f}`)}let o={text:""};return this.settings.apiProvider==="anthropic"?(o.text=a.json.content[0].text,o.tokensUsed=(r=a.json.usage)==null?void 0:r.output_tokens):this.settings.apiProvider==="ollama"?(o.text=((c=a.json.message)==null?void 0:c.content)||"",o.tokensUsed=a.json.eval_count||0,o.inputTokens=a.json.prompt_eval_count||0,o.outputTokens=a.json.eval_count||0):(o.text=a.json.choices[0].message.content,o.inputTokens=(l=a.json.usage)==null?void 0:l.prompt_tokens,o.outputTokens=(d=a.json.usage)==null?void 0:d.completion_tokens,o.tokensUsed=(((h=a.json.usage)==null?void 0:h.prompt_tokens)||0)+(((m=a.json.usage)==null?void 0:m.completion_tokens)||0)),o}};var Me=[{id:"summarize",name:"Summarize",description:"Create a concise summary of the text",category:"Writing",prompt:`Please provide a concise summary of the following text, capturing the main points and key takeaways:

{text}`,variables:["text"],isBuiltIn:!0},{id:"expand",name:"Expand Ideas",description:"Elaborate on ideas with more detail",category:"Writing",prompt:`Please expand on the following ideas with more detail, examples, and context:

{text}`,variables:["text"],isBuiltIn:!0},{id:"rewrite-formal",name:"Rewrite (Formal)",description:"Rewrite text in a more formal tone",category:"Writing",prompt:`Please rewrite the following text in a more formal, professional tone while preserving the original meaning:

{text}`,variables:["text"],isBuiltIn:!0},{id:"rewrite-casual",name:"Rewrite (Casual)",description:"Rewrite text in a more casual tone",category:"Writing",prompt:`Please rewrite the following text in a more casual, conversational tone while preserving the original meaning:

{text}`,variables:["text"],isBuiltIn:!0},{id:"proofread",name:"Proofread",description:"Check for grammar, spelling, and style",category:"Writing",prompt:`Please proofread the following text for grammar, spelling, punctuation, and style issues. Provide the corrected version and list the changes made:

{text}`,variables:["text"],isBuiltIn:!0},{id:"shorten",name:"Make Concise",description:"Shorten text while keeping key points",category:"Writing",prompt:`Please make the following text more concise while preserving all key information and meaning:

{text}`,variables:["text"],isBuiltIn:!0},{id:"explain",name:"Explain Simply",description:"Explain a topic in simple terms",category:"Research",prompt:`Please explain the following topic in simple terms that anyone can understand. Use analogies and examples where helpful:

{topic}`,variables:["topic"],isBuiltIn:!0},{id:"compare",name:"Compare & Contrast",description:"Compare two or more items",category:"Research",prompt:`Please compare and contrast the following items, highlighting their similarities, differences, advantages, and disadvantages:

{items}`,variables:["items"],isBuiltIn:!0},{id:"analyze",name:"Analyze",description:"Provide in-depth analysis",category:"Research",prompt:`Please provide an in-depth analysis of the following, including key insights, implications, and considerations:

{subject}`,variables:["subject"],isBuiltIn:!0},{id:"pros-cons",name:"Pros & Cons",description:"List advantages and disadvantages",category:"Research",prompt:`Please list the pros and cons of the following, with explanations for each point:

{subject}`,variables:["subject"],isBuiltIn:!0},{id:"key-points",name:"Extract Key Points",description:"Extract main points as bullet points",category:"Note-taking",prompt:`Please extract the key points from the following text as a bulleted list:

{text}`,variables:["text"],isBuiltIn:!0},{id:"questions",name:"Generate Questions",description:"Create thought-provoking questions",category:"Note-taking",prompt:`Please generate thought-provoking questions about the following topic that would help deepen understanding:

{topic}`,variables:["topic"],isBuiltIn:!0},{id:"outline",name:"Create Outline",description:"Generate a structured outline",category:"Note-taking",prompt:`Please create a detailed, structured outline for the following topic:

{topic}`,variables:["topic"],isBuiltIn:!0},{id:"flashcards",name:"Create Flashcards",description:"Generate Q&A flashcards for studying",category:"Note-taking",prompt:`Please create flashcards (question and answer pairs) from the following content for studying:

{content}`,variables:["content"],isBuiltIn:!0},{id:"action-items",name:"Extract Action Items",description:"Find and list action items/todos",category:"Note-taking",prompt:`Please extract all action items, tasks, and todos from the following text:

{text}`,variables:["text"],isBuiltIn:!0},{id:"explain-code",name:"Explain Code",description:"Explain what code does",category:"Coding",prompt:"Please explain what the following code does, including its purpose, how it works, and any notable patterns or techniques used:\n\n```\n{code}\n```",variables:["code"],isBuiltIn:!0},{id:"debug",name:"Debug Code",description:"Find potential bugs and issues",category:"Coding",prompt:"Please analyze the following code for potential bugs, issues, edge cases, and improvements:\n\n```\n{code}\n```",variables:["code"],isBuiltIn:!0},{id:"refactor",name:"Refactor Code",description:"Suggest code improvements",category:"Coding",prompt:"Please suggest improvements and refactoring for the following code to make it cleaner, more efficient, or more maintainable:\n\n```\n{code}\n```",variables:["code"],isBuiltIn:!0},{id:"document-code",name:"Document Code",description:"Add documentation and comments",category:"Coding",prompt:"Please add comprehensive documentation and comments to the following code:\n\n```\n{code}\n```",variables:["code"],isBuiltIn:!0},{id:"brainstorm",name:"Brainstorm Ideas",description:"Generate creative ideas",category:"Creative",prompt:`Please brainstorm creative ideas related to the following topic. Think outside the box and provide diverse suggestions:

{topic}`,variables:["topic"],isBuiltIn:!0},{id:"write-intro",name:"Write Introduction",description:"Create an engaging introduction",category:"Creative",prompt:`Please write an engaging introduction for a piece about the following topic:

{topic}`,variables:["topic"],isBuiltIn:!0},{id:"write-conclusion",name:"Write Conclusion",description:"Create a strong conclusion",category:"Creative",prompt:`Please write a strong, memorable conclusion for a piece about the following topic, summarizing key points:

{topic}`,variables:["topic"],isBuiltIn:!0}];function Le(){return`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}var j=class extends u.PluginSettingTab{constructor(e,t){super(e,t);this.errorElements=new Map;this.plugin=t}addSettingsActions(e){let t=e.createDiv({cls:"settings-actions"});t.style.display="flex",t.style.gap="0.5rem",t.style.marginBottom="1rem",t.createEl("button",{text:"Export Settings",cls:"mod-cta"}).addEventListener("click",()=>this.exportSettings()),t.createEl("button",{text:"Import Settings",cls:"mod-cta"}).addEventListener("click",()=>this.importSettings());let a=t.createDiv({cls:"setting-item-description"});a.textContent="Backup or restore your configuration"}addProfileSection(e){e.createEl("h3",{text:"AI Profiles"});let t=this.plugin.getActiveProfile();new u.Setting(e).setName("Active Profile").setDesc("Switch between different AI configurations").addDropdown(r=>{this.plugin.settings.profiles.forEach(c=>{r.addOption(c.id,c.name)}),r.setValue(this.plugin.settings.activeProfileId),r.onChange(async c=>{await this.plugin.switchProfile(c),this.display()})});let n=e.createDiv({cls:"profile-actions"});if(n.style.display="flex",n.style.gap="0.5rem",n.style.marginBottom="1rem",n.createEl("button",{text:"Create Profile",cls:"mod-cta"}).addEventListener("click",()=>this.openProfileEditor()),n.createEl("button",{text:"Edit Current"}).addEventListener("click",()=>{t&&this.openProfileEditor(t)}),n.createEl("button",{text:"Duplicate"}).addEventListener("click",async()=>{if(t){let r={...t,id:_(),name:`${t.name} (Copy)`};await this.plugin.createProfile(r),this.display()}}),t&&t.id!=="default"&&n.createEl("button",{text:"Delete",cls:"mod-warning"}).addEventListener("click",async()=>{confirm(`Delete profile "${t.name}"?`)&&(await this.plugin.deleteProfile(t.id),this.display())}),new u.Setting(e).setName("Add from Template").setDesc("Quickly add a preconfigured profile").addDropdown(r=>{r.addOption("","Select template..."),fe.forEach(c=>{r.addOption(c.id,c.name)}),r.onChange(async c=>{if(!c)return;let l=fe.find(d=>d.id===c);if(l){let d={...l,id:_()};await this.plugin.createProfile(d),this.display()}})}),t){let r=e.createDiv({cls:"profile-info"});r.style.padding="0.75rem",r.style.backgroundColor="var(--background-secondary)",r.style.borderRadius="var(--radius-s)",r.style.marginBottom="1rem",r.createEl("strong",{text:`Active: ${t.name}`});let c=r.createDiv();c.style.fontSize="var(--font-smaller)",c.style.color="var(--text-muted)",c.style.marginTop="0.25rem",c.textContent=`Provider: ${t.apiProvider} | Model: ${t.model} | Temp: ${t.temperature}`}}openProfileEditor(e){new ve(this.app,e||null,async n=>{e?await this.plugin.updateProfile(n):await this.plugin.createProfile(n),this.display()}).open()}addTemplatesSection(e){var i;e.createEl("h3",{text:"Prompt Templates"});let t=((i=this.plugin.settings.customTemplates)==null?void 0:i.length)||0,n=Me.length;if(new u.Setting(e).setName("Templates").setDesc(`${n} built-in templates, ${t} custom templates`).addButton(a=>a.setButtonText("Create Custom Template").setCta().onClick(()=>this.openTemplateEditor())),t>0){let a=e.createDiv({cls:"custom-templates-list"});a.style.marginTop="0.5rem",a.style.marginBottom="1rem",this.plugin.settings.customTemplates.forEach(o=>{let r=a.createDiv({cls:"template-list-item"});r.style.display="flex",r.style.justifyContent="space-between",r.style.alignItems="center",r.style.padding="0.5rem",r.style.marginBottom="0.25rem",r.style.backgroundColor="var(--background-secondary)",r.style.borderRadius="var(--radius-s)";let c=r.createDiv();c.createEl("strong",{text:o.name});let l=c.createDiv();l.style.fontSize="var(--font-smaller)",l.style.color="var(--text-muted)",l.textContent=`${o.category} - ${o.description}`;let d=r.createDiv({cls:"template-actions"});d.style.display="flex",d.style.gap="0.25rem";let h=d.createEl("button",{text:"Edit"});h.style.fontSize="var(--font-smaller)",h.addEventListener("click",()=>this.openTemplateEditor(o));let m=d.createEl("button",{text:"Delete",cls:"mod-warning"});m.style.fontSize="var(--font-smaller)",m.addEventListener("click",async()=>{if(confirm(`Delete template "${o.name}"?`)){let f=this.plugin.settings.customTemplates.findIndex(y=>y.id===o.id);f>=0&&(this.plugin.settings.customTemplates.splice(f,1),await this.plugin.saveSettings(),this.display(),new u.Notice("Template deleted"))}})})}}openTemplateEditor(e){new be(this.app,e||null,async n=>{if(this.plugin.settings.customTemplates||(this.plugin.settings.customTemplates=[]),e){let i=this.plugin.settings.customTemplates.findIndex(a=>a.id===n.id);i>=0&&(this.plugin.settings.customTemplates[i]=n)}else this.plugin.settings.customTemplates.push(n);await this.plugin.saveSettings(),this.display(),new u.Notice(e?"Template updated":"Template created")}).open()}display(){let{containerEl:e}=this;e.empty(),this.errorElements.clear(),e.createEl("h2",{text:"Obsidian Agent Settings"}),this.addSettingsActions(e),e.createEl("hr"),this.addProfileSection(e),e.createEl("hr"),this.addTemplatesSection(e),e.createEl("hr"),new u.Setting(e).setName("API Provider").setDesc("Select your AI API provider").addDropdown(t=>t.addOption("openai","OpenAI").addOption("anthropic","Anthropic").addOption("ollama","Ollama (Local)").addOption("custom","Custom API").setValue(this.plugin.settings.apiProvider).onChange(async n=>{switch(this.plugin.settings.apiProvider=n,n){case"ollama":this.plugin.settings.customApiUrl="http://localhost:11434",this.plugin.settings.model="llama3.2";break;case"openai":this.plugin.settings.customApiUrl="",this.plugin.settings.model="gpt-4";break;case"anthropic":this.plugin.settings.customApiUrl="",this.plugin.settings.model="claude-3-sonnet-20240229";break;case"custom":break}await this.plugin.saveSettings(),this.display()})),this.addApiKeySetting(e),(this.plugin.settings.apiProvider==="custom"||this.plugin.settings.apiProvider==="ollama")&&this.addCustomApiUrlSetting(e),this.addModelSetting(e),this.addTemperatureSetting(e),this.addMaxTokensSetting(e),this.addSystemPromptSetting(e),this.addEmbeddingSettings(e),this.addContextAwarenessSetting(e),this.addVaultContextSettings(e),this.addConversationPersistenceSetting(e),this.addCacheSettings(e),this.addInlineCompletionSettings(e),this.addSuggestionSettings(e),this.addAccessibilitySettings(e),this.addTokenTrackingSetting(e),this.addReconnectButton(e),this.addTestConnectionButton(e)}addVaultContextSettings(e){e.createEl("h3",{text:"Vault-Wide Context"});let t=e.createEl("p",{cls:"setting-item-description"});t.textContent="Include content from related notes to give AI more context about your knowledge base.",t.style.marginBottom="1rem",new u.Setting(e).setName("Include Linked Notes").setDesc("Add content from notes linked in the current note").addToggle(n=>{var i;return n.setValue(((i=this.plugin.settings.contextConfig)==null?void 0:i.enableLinkedNotes)||!1).onChange(async a=>{this.plugin.settings.contextConfig||(this.plugin.settings.contextConfig={enableLinkedNotes:!1,enableBacklinks:!1,enableTagContext:!1,enableFolderContext:!1,maxNotesPerSource:5,maxTokensPerNote:1e3,linkDepth:1,excludeFolders:"templates, .obsidian"}),this.plugin.settings.contextConfig.enableLinkedNotes=a,await this.plugin.saveSettings()})}),new u.Setting(e).setName("Include Backlinks").setDesc("Add content from notes that link TO the current note").addToggle(n=>{var i;return n.setValue(((i=this.plugin.settings.contextConfig)==null?void 0:i.enableBacklinks)||!1).onChange(async a=>{this.plugin.settings.contextConfig||(this.plugin.settings.contextConfig={enableLinkedNotes:!1,enableBacklinks:!1,enableTagContext:!1,enableFolderContext:!1,maxNotesPerSource:5,maxTokensPerNote:1e3,linkDepth:1,excludeFolders:"templates, .obsidian"}),this.plugin.settings.contextConfig.enableBacklinks=a,await this.plugin.saveSettings()})}),new u.Setting(e).setName("Include Same-Tag Notes").setDesc("Add content from notes with the same tags").addToggle(n=>{var i;return n.setValue(((i=this.plugin.settings.contextConfig)==null?void 0:i.enableTagContext)||!1).onChange(async a=>{this.plugin.settings.contextConfig||(this.plugin.settings.contextConfig={enableLinkedNotes:!1,enableBacklinks:!1,enableTagContext:!1,enableFolderContext:!1,maxNotesPerSource:5,maxTokensPerNote:1e3,linkDepth:1,excludeFolders:"templates, .obsidian"}),this.plugin.settings.contextConfig.enableTagContext=a,await this.plugin.saveSettings()})}),new u.Setting(e).setName("Include Folder Notes").setDesc("Add content from notes in the same folder").addToggle(n=>{var i;return n.setValue(((i=this.plugin.settings.contextConfig)==null?void 0:i.enableFolderContext)||!1).onChange(async a=>{this.plugin.settings.contextConfig||(this.plugin.settings.contextConfig={enableLinkedNotes:!1,enableBacklinks:!1,enableTagContext:!1,enableFolderContext:!1,maxNotesPerSource:5,maxTokensPerNote:1e3,linkDepth:1,excludeFolders:"templates, .obsidian"}),this.plugin.settings.contextConfig.enableFolderContext=a,await this.plugin.saveSettings()})}),new u.Setting(e).setName("Max Notes Per Source").setDesc("Maximum number of notes to include from each source").addText(n=>{var i;return n.setPlaceholder("5").setValue(String(((i=this.plugin.settings.contextConfig)==null?void 0:i.maxNotesPerSource)||5)).onChange(async a=>{let o=parseInt(a);this.plugin.settings.contextConfig||(this.plugin.settings.contextConfig={enableLinkedNotes:!1,enableBacklinks:!1,enableTagContext:!1,enableFolderContext:!1,maxNotesPerSource:5,maxTokensPerNote:1e3,linkDepth:1,excludeFolders:"templates, .obsidian"}),this.plugin.settings.contextConfig.maxNotesPerSource=isNaN(o)?5:Math.max(1,o),await this.plugin.saveSettings()})}),new u.Setting(e).setName("Max Tokens Per Note").setDesc("Maximum tokens to include from each additional note").addText(n=>{var i;return n.setPlaceholder("1000").setValue(String(((i=this.plugin.settings.contextConfig)==null?void 0:i.maxTokensPerNote)||1e3)).onChange(async a=>{let o=parseInt(a);this.plugin.settings.contextConfig||(this.plugin.settings.contextConfig={enableLinkedNotes:!1,enableBacklinks:!1,enableTagContext:!1,enableFolderContext:!1,maxNotesPerSource:5,maxTokensPerNote:1e3,linkDepth:1,excludeFolders:"templates, .obsidian"}),this.plugin.settings.contextConfig.maxTokensPerNote=isNaN(o)?1e3:Math.max(100,o),await this.plugin.saveSettings()})}),new u.Setting(e).setName("Link Depth").setDesc("How many levels of links to follow (1 = direct links only)").addDropdown(n=>{var i;return n.addOption("1","1 (Direct links)").addOption("2","2 (Links of links)").setValue(String(((i=this.plugin.settings.contextConfig)==null?void 0:i.linkDepth)||1)).onChange(async a=>{this.plugin.settings.contextConfig||(this.plugin.settings.contextConfig={enableLinkedNotes:!1,enableBacklinks:!1,enableTagContext:!1,enableFolderContext:!1,maxNotesPerSource:5,maxTokensPerNote:1e3,linkDepth:1,excludeFolders:"templates, .obsidian"}),this.plugin.settings.contextConfig.linkDepth=parseInt(a),await this.plugin.saveSettings()})}),new u.Setting(e).setName("Exclude Folders").setDesc("Folders to exclude from context (comma-separated)").addText(n=>{var i;return n.setPlaceholder("templates, .obsidian").setValue(((i=this.plugin.settings.contextConfig)==null?void 0:i.excludeFolders)||"templates, .obsidian").onChange(async a=>{this.plugin.settings.contextConfig||(this.plugin.settings.contextConfig={enableLinkedNotes:!1,enableBacklinks:!1,enableTagContext:!1,enableFolderContext:!1,maxNotesPerSource:5,maxTokensPerNote:1e3,linkDepth:1,excludeFolders:"templates, .obsidian"}),this.plugin.settings.contextConfig.excludeFolders=a,await this.plugin.saveSettings()})})}addCacheSettings(e){var i;e.createEl("h3",{text:"Response Caching"});let t=e.createEl("p",{cls:"setting-item-description"});t.textContent="Cache AI responses to reduce API costs and improve response time for repeated queries.",t.style.marginBottom="1rem",this.plugin.settings.cacheConfig||(this.plugin.settings.cacheConfig={enabled:!0,maxEntries:100,maxAgeDays:30,matchThreshold:1}),new u.Setting(e).setName("Enable Response Caching").setDesc("Cache identical queries to save API calls").addToggle(a=>a.setValue(this.plugin.settings.cacheConfig.enabled).onChange(async o=>{var r,c;this.plugin.settings.cacheConfig.enabled=o,await this.plugin.saveSettings(),(c=(r=this.plugin.aiService)==null?void 0:r.getCacheService())==null||c.setEnabled(o)})),new u.Setting(e).setName("Max Cache Entries").setDesc("Maximum number of cached responses (oldest removed first)").addText(a=>a.setPlaceholder("100").setValue(String(this.plugin.settings.cacheConfig.maxEntries)).onChange(async o=>{var c;let r=parseInt(o);this.plugin.settings.cacheConfig.maxEntries=isNaN(r)?100:Math.max(10,r),await this.plugin.saveSettings(),(c=this.plugin.aiService)==null||c.updateCacheSettings(this.plugin.settings)})),new u.Setting(e).setName("Cache Expiration (Days)").setDesc("How long to keep cached responses").addText(a=>a.setPlaceholder("30").setValue(String(this.plugin.settings.cacheConfig.maxAgeDays)).onChange(async o=>{var c;let r=parseInt(o);this.plugin.settings.cacheConfig.maxAgeDays=isNaN(r)?30:Math.max(1,r),await this.plugin.saveSettings(),(c=this.plugin.aiService)==null||c.updateCacheSettings(this.plugin.settings)}));let n=(i=this.plugin.aiService)==null?void 0:i.getCacheService();if(n){let a=n.getStats(),o=n.getHitRate(),r=n.getEstimatedCostSavings(),c=e.createDiv({cls:"cache-stats"});c.style.padding="1rem",c.style.backgroundColor="var(--background-secondary)",c.style.borderRadius="var(--radius-s)",c.style.marginBottom="1rem",c.createEl("h4",{text:"Cache Statistics"}),c.style.marginTop="0";let l=c.createDiv({cls:"stats-grid"});l.style.display="grid",l.style.gridTemplateColumns="repeat(2, 1fr)",l.style.gap="0.5rem",l.style.marginTop="0.5rem",this.createStatCard(l,"Cached Entries",String(a.totalEntries)),this.createStatCard(l,"Cache Hits",String(a.totalHits)),this.createStatCard(l,"Cache Misses",String(a.totalMisses)),this.createStatCard(l,"Hit Rate",`${o.toFixed(1)}%`),this.createStatCard(l,"Tokens Saved",String(a.estimatedSavings)),this.createStatCard(l,"Est. Savings",`$${r.toFixed(4)}`),this.createStatCard(l,"Cache Size",n.getFormattedCacheSize());let d=c.createDiv({cls:"cache-actions"});d.style.display="flex",d.style.gap="0.5rem",d.style.marginTop="1rem",d.createEl("button",{text:"Clear Cache",cls:"mod-warning"}).addEventListener("click",async()=>{confirm("Clear all cached responses? This cannot be undone.")&&(n.clearCache(),this.plugin.settings.cacheData={entries:[],stats:n.getStats()},await this.plugin.saveSettings(),this.display(),new u.Notice("Cache cleared"))}),d.createEl("button",{text:"Clean Expired"}).addEventListener("click",async()=>{let y=n.cleanExpired(),x=n.exportCache();this.plugin.settings.cacheData={entries:x.entries,stats:x.stats},await this.plugin.saveSettings(),this.display(),new u.Notice(`Removed ${y} expired entries`)}),d.createEl("button",{text:"Reset Stats"}).addEventListener("click",async()=>{n.resetStats();let y=n.exportCache();this.plugin.settings.cacheData={entries:y.entries,stats:y.stats},await this.plugin.saveSettings(),this.display(),new u.Notice("Statistics reset")}),a.totalEntries>0&&d.createEl("button",{text:"View Entries"}).addEventListener("click",()=>{new we(this.app,this.plugin).open()})}}getCompletionConfig(){let e=this.plugin.settings.completionConfig;return e?this.plugin.settings.completionConfig={...P,...e,phraseTriggers:Array.isArray(e.phraseTriggers)&&e.phraseTriggers.length?e.phraseTriggers:[...P.phraseTriggers],excludedFolders:Array.isArray(e.excludedFolders)&&e.excludedFolders.length?e.excludedFolders:[...P.excludedFolders]}:this.plugin.settings.completionConfig={...P},this.plugin.settings.completionConfig}addInlineCompletionSettings(e){e.createEl("h3",{text:"Inline Completions"});let t=this.getCompletionConfig();new u.Setting(e).setName("Enable Inline Completions").setDesc("Show AI suggestions while typing inside the editor").addToggle(n=>n.setValue(t.enabled).onChange(async i=>{t.enabled=i,await this.plugin.saveSettings()})),new u.Setting(e).setName("Trigger Mode").setDesc("Manual = hotkey only, Auto = after a pause, Both = either").addDropdown(n=>n.addOption("manual","Manual").addOption("auto","Auto").addOption("both","Both").setValue(t.triggerMode).onChange(async i=>{t.triggerMode=i,await this.plugin.saveSettings()})),new u.Setting(e).setName("Auto Trigger Delay (ms)").setDesc("How long to wait after typing before auto suggestions run").addText(n=>n.setPlaceholder(String(P.autoTriggerDelay)).setValue(String(t.autoTriggerDelay)).onChange(async i=>{let a=parseInt(i,10);t.autoTriggerDelay=isNaN(a)?P.autoTriggerDelay:Math.max(200,a),await this.plugin.saveSettings()})),new u.Setting(e).setName("Manual Shortcut").setDesc("Keyboard shortcut to trigger completion (e.g., ctrl+space)").addText(n=>n.setValue(t.manualTriggerShortcut).onChange(async i=>{t.manualTriggerShortcut=i.trim()||P.manualTriggerShortcut,await this.plugin.saveSettings()})),new u.Setting(e).setName("Phrase Triggers").setDesc("Comma-separated endings that auto-request completions (e.g., ..., //)").addText(n=>n.setValue(t.phraseTriggers.join(", ")).onChange(async i=>{t.phraseTriggers=i.split(",").map(a=>a.trim()).filter(Boolean),await this.plugin.saveSettings()})),new u.Setting(e).setName("Max Suggestions per Request").setDesc("Limit how many completions are offered each time").addSlider(n=>n.setLimits(1,10,1).setDynamicTooltip().setValue(t.maxCompletions).onChange(async i=>{t.maxCompletions=i,await this.plugin.saveSettings()})),new u.Setting(e).setName("Max Tokens per Completion").setDesc("Shorter values keep inline completions snappy").addText(n=>n.setPlaceholder(String(P.maxTokens)).setValue(String(t.maxTokens)).onChange(async i=>{let a=parseInt(i,10);t.maxTokens=isNaN(a)?P.maxTokens:Math.max(16,a),await this.plugin.saveSettings()})),new u.Setting(e).setName("Show in Markdown Only").setDesc("Disable completions in other editor types").addToggle(n=>n.setValue(t.showInMarkdownOnly).onChange(async i=>{t.showInMarkdownOnly=i,await this.plugin.saveSettings()})),new u.Setting(e).setName("Excluded Folders").setDesc("Comma-separated list of folders where completions stay off").addText(n=>n.setPlaceholder(P.excludedFolders.join(", ")).setValue(t.excludedFolders.join(", ")).onChange(async i=>{t.excludedFolders=i.split(",").map(a=>a.trim()).filter(Boolean),await this.plugin.saveSettings()}))}getSuggestionConfig(){let e=this.plugin.settings.suggestionConfig;return e?this.plugin.settings.suggestionConfig={...O,...e,suggestionTypes:{...O.suggestionTypes,...e.suggestionTypes||{}}}:this.plugin.settings.suggestionConfig={...O},this.plugin.settings.suggestionConfig}addSuggestionSettings(e){e.createEl("h3",{text:"Intelligent Suggestions"});let t=this.getSuggestionConfig();new u.Setting(e).setName("Enable Suggestions").setDesc("Analyze the current note and propose improvements automatically").addToggle(i=>i.setValue(t.enabled).onChange(async a=>{t.enabled=a,await this.plugin.saveSettings()})),new u.Setting(e).setName("Auto Analyze Notes").setDesc("Run analysis automatically when you stop typing").addToggle(i=>i.setValue(t.autoAnalyze).onChange(async a=>{t.autoAnalyze=a,await this.plugin.saveSettings()})),new u.Setting(e).setName("Max Suggestions per Note").setDesc("Keep the list focused on the most useful actions").addSlider(i=>i.setLimits(1,10,1).setDynamicTooltip().setValue(t.maxSuggestions).onChange(async a=>{t.maxSuggestions=a,await this.plugin.saveSettings()})),new u.Setting(e).setName("Privacy Mode").setDesc("Choose whether to use cloud, local, or hybrid analysis models").addDropdown(i=>i.addOption("cloud","Cloud").addOption("local","Local only").addOption("hybrid","Hybrid (auto choose)").setValue(t.privacyMode).onChange(async a=>{t.privacyMode=a,await this.plugin.saveSettings()}));let n={links:"Link suggestions",tags:"Tag suggestions",summaries:"Summary prompts",todos:"TODO extraction",improvements:"Writing improvements",expansions:"Expansion ideas",organization:"Organization hints"};e.createEl("h4",{text:"Suggestion Types"}),Object.entries(n).forEach(([i,a])=>{new u.Setting(e).setName(a).addToggle(o=>o.setValue(t.suggestionTypes[i]).onChange(async r=>{t.suggestionTypes[i]=r,await this.plugin.saveSettings()}))})}addEmbeddingSettings(e){e.createEl("h3",{text:"Embedding & Semantic Brain"});let t=this.plugin.settings.embeddingConfig||{provider:"openai",model:"text-embedding-3-small",enabled:!1,autoRefresh:!0};new u.Setting(e).setName("Enable Semantic Features").setDesc("Enable vector embeddings for Semantic Search and Memory").addToggle(n=>n.setValue(t.enabled).onChange(async i=>{this.plugin.settings.embeddingConfig.enabled=i,await this.plugin.saveSettings(),this.display()})),t.enabled&&(new u.Setting(e).setName("Embedding Provider").setDesc("Select provider for generating vector embeddings").addDropdown(n=>n.addOption("openai","OpenAI (Requires Key)").addOption("ollama","Ollama (Local)").addOption("local","Local Transformers (Soon)").setValue(t.provider).onChange(async i=>{this.plugin.settings.embeddingConfig.provider=i,i==="ollama"&&!this.plugin.settings.embeddingConfig.model&&(this.plugin.settings.embeddingConfig.model="nomic-embed-text"),await this.plugin.saveSettings(),this.display()})),new u.Setting(e).setName("Embedding Model").setDesc("Model used for vectorization").addText(n=>n.setPlaceholder(t.provider==="openai"?"text-embedding-3-small":"nomic-embed-text").setValue(t.model).onChange(async i=>{this.plugin.settings.embeddingConfig.model=i,await this.plugin.saveSettings()})))}addConversationPersistenceSetting(e){var i;e.createEl("h3",{text:"Conversation History"}),new u.Setting(e).setName("Enable Conversation Persistence").setDesc("Save conversations across sessions").addToggle(a=>a.setValue(this.plugin.settings.enableConversationPersistence).onChange(async o=>{this.plugin.settings.enableConversationPersistence=o,await this.plugin.saveSettings()})),new u.Setting(e).setName("Max Saved Conversations").setDesc("Maximum number of conversations to keep (oldest are deleted)").addText(a=>a.setPlaceholder("20").setValue(String(this.plugin.settings.maxConversations)).onChange(async o=>{let r=parseInt(o);this.plugin.settings.maxConversations=isNaN(r)||r<1?20:r,await this.plugin.saveSettings()}));let t=((i=this.plugin.settings.conversations)==null?void 0:i.length)||0,n=new u.Setting(e).setName("Saved Conversations").setDesc(`${t} conversation(s) saved`);t>0&&n.addButton(a=>a.setButtonText("Clear All").setWarning().onClick(async()=>{confirm("Delete all saved conversations? This cannot be undone.")&&(this.plugin.settings.conversations=[],this.plugin.settings.activeConversationId=void 0,await this.plugin.saveSettings(),this.display(),new u.Notice("All conversations deleted"))}))}addAccessibilitySettings(e){e.createEl("h3",{text:"Accessibility"});let t=e.createEl("p",{cls:"setting-item-description"});t.textContent="Customize plugin for your accessibility needs.",t.style.marginBottom="1rem",this.plugin.settings.accessibilityConfig||(this.plugin.settings.accessibilityConfig={enableHighContrast:!1,enableReducedMotion:!1}),new u.Setting(e).setName("High Contrast Mode").setDesc("Increase color contrast for better visibility").addToggle(n=>n.setValue(this.plugin.settings.accessibilityConfig.enableHighContrast).onChange(async i=>{this.plugin.settings.accessibilityConfig.enableHighContrast=i,await this.plugin.saveSettings(),this.plugin.applyAccessibilitySettings(),new u.Notice(i?"High contrast enabled":"High contrast disabled")})),new u.Setting(e).setName("Reduced Motion").setDesc("Disable animations and transitions (also respects system preference)").addToggle(n=>n.setValue(this.plugin.settings.accessibilityConfig.enableReducedMotion).onChange(async i=>{this.plugin.settings.accessibilityConfig.enableReducedMotion=i,await this.plugin.saveSettings(),this.plugin.applyAccessibilitySettings(),new u.Notice(i?"Reduced motion enabled":"Reduced motion disabled")}))}addTokenTrackingSetting(e){new u.Setting(e).setName("Enable Token Tracking").setDesc("Track API token usage and estimate costs").addToggle(t=>t.setValue(this.plugin.settings.enableTokenTracking).onChange(async n=>{this.plugin.settings.enableTokenTracking=n,await this.plugin.saveSettings()})),new u.Setting(e).setName("Cost Warning Threshold ($)").setDesc("Show warning when estimated cost exceeds this amount").addText(t=>t.setPlaceholder("10").setValue(String(this.plugin.settings.costThreshold)).onChange(async n=>{let i=parseFloat(n);this.plugin.settings.costThreshold=isNaN(i)?10:i,await this.plugin.saveSettings()})),this.addUsageSummary(e)}addUsageSummary(e){let t=e.createDiv({cls:"usage-summary"});t.style.marginTop="1.5rem",t.style.padding="1rem",t.style.border="1px solid var(--background-modifier-border)",t.style.borderRadius="var(--radius-s)",t.style.backgroundColor="var(--background-secondary)";let n=this.plugin.settings,i=n.totalTokensUsed||0,a=n.totalRequests||0,o=n.estimatedCost||0;t.createEl("h3",{text:"Usage Summary"});let r=t.createDiv({cls:"stats-grid"});if(r.style.display="grid",r.style.gridTemplateColumns="repeat(2, 1fr)",r.style.gap="0.5rem",r.style.marginTop="0.5rem",this.createStatCard(r,"Total Requests",String(a)),this.createStatCard(r,"Tokens Used",String(i)),this.createStatCard(r,"Estimated Cost",`$${o.toFixed(2)}`),i>0){let l=(i/a).toFixed(0);this.createStatCard(r,"Avg Tokens/Request",l)}let c=t.createEl("button",{text:"Export Usage Data (CSV)",cls:"mod-cta"});c.style.marginTop="1rem",c.addEventListener("click",()=>this.exportUsageData())}createStatCard(e,t,n){let i=e.createDiv({cls:"stat-card"});i.style.padding="0.5rem",i.style.borderRadius="var(--radius-s)",i.style.backgroundColor="var(--background-primary)";let a=i.createDiv({cls:"stat-label"});a.style.fontSize="var(--font-smaller)",a.style.color="var(--text-muted)",a.textContent=t;let o=i.createDiv({cls:"stat-value"});o.style.fontSize="var(--font-ui-large)",o.style.fontWeight="bold",o.textContent=n}exportUsageData(){let e=this.plugin.settings,t=["Metric,Value",`Total Requests,${e.totalRequests||0}`,`Total Tokens Used,${e.totalTokensUsed||0}`,`Estimated Cost ($),${(e.estimatedCost||0).toFixed(2)}`,`Export Date,${new Date().toISOString()}`].join(`
`),n=new Blob([t],{type:"text/csv"}),i=URL.createObjectURL(n),a=document.createElement("a");a.href=i,a.download=`obsidian-agent-usage-${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i),new u.Notice("Usage data exported")}addApiKeySetting(e){let t=this.plugin.settings.apiProvider==="ollama";new u.Setting(e).setName("API Key").setDesc(t?"Not required for Ollama":"Enter your API key for the selected provider").addText(n=>{n.setPlaceholder(t?"N/A":"Enter your API key").setValue(this.plugin.settings.apiKey).onChange(async i=>{this.plugin.settings.apiKey=i,await this.plugin.saveSettings(),this.validateApiKeySetting(i,e)}),n.inputEl.disabled=t,t&&(n.inputEl.style.opacity="0.5")}),this.validateApiKeySetting(this.plugin.settings.apiKey,e)}validateApiKeySetting(e,t){let i=Array.from(t.querySelectorAll(".setting-item")).find(a=>{var o;return(o=a.textContent)==null?void 0:o.includes("API Key")});i&&(this.clearError("apiKey",i),this.plugin.settings.apiProvider!=="custom"&&!e.trim()&&this.showError("apiKey",i,"API Key is required for this provider"))}addCustomApiUrlSetting(e){new u.Setting(e).setName("Custom API URL").setDesc("Enter URL for your custom API endpoint").addText(t=>t.setPlaceholder("https://api.example.com/v1/chat").setValue(this.plugin.settings.customApiUrl).onChange(async n=>{this.plugin.settings.customApiUrl=n,await this.plugin.saveSettings(),this.validateCustomApiUrlSetting(n,e)})),this.validateCustomApiUrlSetting(this.plugin.settings.customApiUrl,e)}validateCustomApiUrlSetting(e,t){let i=Array.from(t.querySelectorAll(".setting-item")).find(a=>{var o;return(o=a.textContent)==null?void 0:o.includes("Custom API URL")});i&&(this.clearError("customApiUrl",i),e.trim()?this.isValidUrl(e)||this.showError("customApiUrl",i,"Please enter a valid URL (e.g., https://api.example.com/v1/chat)"):this.showError("customApiUrl",i,"Custom API URL is required when using Custom API provider"))}isValidUrl(e){try{return new URL(e),!0}catch(t){return!1}}addModelSetting(e){new u.Setting(e).setName("Model").setDesc("AI model to use").addText(t=>t.setPlaceholder("gpt-4").setValue(this.plugin.settings.model).onChange(async n=>{this.plugin.settings.model=n,await this.plugin.saveSettings(),this.validateModelSetting(n,e)})),this.validateModelSetting(this.plugin.settings.model,e)}validateModelSetting(e,t){let i=Array.from(t.querySelectorAll(".setting-item")).find(a=>{var o,r;return((o=a.textContent)==null?void 0:o.includes("Model"))&&!((r=a.textContent)!=null&&r.includes("Temperature"))});i&&(this.clearError("model",i),e.trim()||this.showError("model",i,"Model name is required"))}addTemperatureSetting(e){new u.Setting(e).setName("Temperature").setDesc("Controls randomness (0-1). Higher values make output more random.").addSlider(t=>t.setLimits(0,1,.1).setValue(this.plugin.settings.temperature).setDynamicTooltip().onChange(async n=>{this.plugin.settings.temperature=n,await this.plugin.saveSettings()}))}addMaxTokensSetting(e){new u.Setting(e).setName("Max Tokens").setDesc("Maximum number of tokens to generate").addText(t=>t.setPlaceholder("2000").setValue(String(this.plugin.settings.maxTokens)).onChange(async n=>{let i=parseInt(n);this.plugin.settings.maxTokens=isNaN(i)?2e3:i,await this.plugin.saveSettings(),this.validateMaxTokensSetting(n,e)})),this.validateMaxTokensSetting(String(this.plugin.settings.maxTokens),e)}validateMaxTokensSetting(e,t){let i=Array.from(t.querySelectorAll(".setting-item")).find(o=>{var r;return(r=o.textContent)==null?void 0:r.includes("Max Tokens")});if(!i)return;this.clearError("maxTokens",i);let a=parseInt(e);isNaN(a)||a<1?this.showError("maxTokens",i,"Max Tokens must be a positive integer (at least 1)"):a>1e5&&this.showError("maxTokens",i,"Max Tokens value is too large. Please use a reasonable value (e.g., 2000-8000)")}addSystemPromptSetting(e){new u.Setting(e).setName("System Prompt").setDesc("The system prompt that defines AI assistant behavior").addTextArea(t=>t.setPlaceholder("You are a helpful assistant...").setValue(this.plugin.settings.systemPrompt).onChange(async n=>{this.plugin.settings.systemPrompt=n,await this.plugin.saveSettings()}))}addContextAwarenessSetting(e){new u.Setting(e).setName("Enable Context Awareness").setDesc("Allow agent to access current note context").addToggle(t=>t.setValue(this.plugin.settings.enableContextAwareness).onChange(async n=>{this.plugin.settings.enableContextAwareness=n,await this.plugin.saveSettings()}))}addReconnectButton(e){let t=e.createDiv({cls:"setting-item"}),n=t.createEl("button",{text:"Reconnect LLM",cls:"mod-cta"});n.addEventListener("click",async()=>{try{n.disabled=!0,n.textContent="Connecting...",this.plugin.aiService=new $(this.plugin.settings),new u.Notice("LLM connection refreshed successfully")}catch(a){new u.Notice(`Failed to reconnect: ${a.message}`),console.error("Reconnect Error:",a)}finally{n.disabled=!1,n.textContent="Reconnect LLM"}});let i=t.createDiv({cls:"setting-item-description"});i.textContent="Reinitialize LLM connection (useful after changing provider or API key)"}addTestConnectionButton(e){let t=e.createDiv({cls:"setting-item"}),n=t.createEl("button",{text:"Test Connection",cls:"mod-cta"});n.addEventListener("click",async()=>{try{n.disabled=!0,n.textContent="Testing...";let a=await this.plugin.aiService.testConnection();a.success?new u.Notice(`Connection successful! Response time: ${a.responseTime}ms`):new u.Notice(`Connection failed: ${a.message}`,5e3)}catch(a){new u.Notice(`Test failed: ${a.message}`,5e3),console.error("Test Connection Error:",a)}finally{n.disabled=!1,n.textContent="Test Connection"}});let i=t.createDiv({cls:"setting-item-description"});i.textContent="Verify your API configuration is working correctly"}showError(e,t,n){let i=this.errorElements.get(e);i||(i=t.createDiv({cls:"setting-error"}),i.style.color="var(--text-error)",i.style.fontSize="var(--font-smaller)",i.style.marginTop="0.5rem",this.errorElements.set(e,i)),i.textContent=n}clearError(e,t){let n=this.errorElements.get(e);n&&(n.remove(),this.errorElements.delete(e))}exportSettings(){let e={...this.plugin.settings,apiKey:this.plugin.settings.apiKey?"***":""},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download=`obsidian-agent-settings-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n),new u.Notice("Settings exported successfully")}async importSettings(){let e=document.createElement("input");e.type="file",e.accept="application/json",e.onchange=async t=>{var i;let n=(i=t.target.files)==null?void 0:i[0];if(n)try{let a=await n.text(),o=JSON.parse(a),r=["apiProvider","model","temperature","maxTokens","systemPrompt","enableContextAwareness"];for(let l of r)if(!(l in o)){new u.Notice("Invalid settings file: missing required fields",3e3);return}if(!confirm("This will overwrite your current settings. Continue?"))return;Object.assign(this.plugin.settings,o),o.apiKey==="***"&&(this.plugin.settings.apiKey=""),await this.plugin.saveSettings(),this.display(),new u.Notice("Settings imported successfully")}catch(a){new u.Notice(`Failed to import settings: ${a.message}`,3e3),console.error("Import Error:",a)}},document.body.appendChild(e),e.click(),document.body.removeChild(e)}},ve=class extends u.Modal{constructor(s,e,t){super(s),this.profile=e,this.onSave=t,this.formData=e?{...e}:{id:_(),name:"",apiProvider:"openai",apiKey:"",customApiUrl:"",model:"gpt-4",temperature:.7,maxTokens:2e3,systemPrompt:"You are a helpful AI assistant integrated into Obsidian."}}onOpen(){let{contentEl:s}=this;s.createEl("h2",{text:this.profile?"Edit Profile":"Create Profile"}),new u.Setting(s).setName("Profile Name").addText(i=>i.setPlaceholder("My Profile").setValue(this.formData.name).onChange(a=>this.formData.name=a)),new u.Setting(s).setName("API Provider").addDropdown(i=>i.addOption("openai","OpenAI").addOption("anthropic","Anthropic").addOption("ollama","Ollama (Local)").addOption("custom","Custom API").setValue(this.formData.apiProvider).onChange(a=>{switch(this.formData.apiProvider=a,a){case"ollama":this.formData.customApiUrl="http://localhost:11434",this.formData.model="llama3.2";break;case"openai":this.formData.customApiUrl="",this.formData.model="gpt-4";break;case"anthropic":this.formData.customApiUrl="",this.formData.model="claude-3-sonnet-20240229";break;case"custom":break}})),new u.Setting(s).setName("API Key").setDesc("Leave empty for Ollama").addText(i=>i.setPlaceholder("sk-...").setValue(this.formData.apiKey).onChange(a=>this.formData.apiKey=a)),new u.Setting(s).setName("Custom API URL").setDesc("Required for Custom/Ollama providers").addText(i=>i.setPlaceholder("http://localhost:11434").setValue(this.formData.customApiUrl).onChange(a=>this.formData.customApiUrl=a)),new u.Setting(s).setName("Model").addText(i=>i.setPlaceholder("gpt-4").setValue(this.formData.model).onChange(a=>this.formData.model=a)),new u.Setting(s).setName("Temperature").addSlider(i=>i.setLimits(0,1,.1).setValue(this.formData.temperature).setDynamicTooltip().onChange(a=>this.formData.temperature=a)),new u.Setting(s).setName("Max Tokens").addText(i=>i.setPlaceholder("2000").setValue(String(this.formData.maxTokens)).onChange(a=>{let o=parseInt(a);this.formData.maxTokens=isNaN(o)?2e3:o})),new u.Setting(s).setName("System Prompt").addTextArea(i=>i.setPlaceholder("You are a helpful assistant...").setValue(this.formData.systemPrompt).onChange(a=>this.formData.systemPrompt=a));let e=s.createDiv({cls:"button-container"});e.style.display="flex",e.style.justifyContent="flex-end",e.style.gap="0.5rem",e.style.marginTop="1rem",e.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),e.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",()=>{if(!this.formData.name.trim()){new u.Notice("Profile name is required");return}this.onSave(this.formData),this.close()})}onClose(){let{contentEl:s}=this;s.empty()}},be=class extends u.Modal{constructor(s,e,t){super(s),this.template=e,this.onSave=t,this.formData=e?{...e}:{id:Le(),name:"",description:"",category:"Custom",prompt:"",variables:[],isBuiltIn:!1}}onOpen(){let{contentEl:s}=this;s.createEl("h2",{text:this.template?"Edit Template":"Create Template"}),new u.Setting(s).setName("Template Name").addText(a=>a.setPlaceholder("My Template").setValue(this.formData.name).onChange(o=>this.formData.name=o)),new u.Setting(s).setName("Description").addText(a=>a.setPlaceholder("What this template does").setValue(this.formData.description).onChange(o=>this.formData.description=o)),new u.Setting(s).setName("Category").addDropdown(a=>a.addOption("Writing","Writing").addOption("Research","Research").addOption("Note-taking","Note-taking").addOption("Coding","Coding").addOption("Creative","Creative").addOption("Custom","Custom").setValue(this.formData.category).onChange(o=>this.formData.category=o)),new u.Setting(s).setName("Prompt Template").setDesc("Use {text}, {topic}, {code}, etc. as placeholders");let e=s.createEl("textarea");e.style.width="100%",e.style.minHeight="150px",e.style.marginBottom="1rem",e.style.padding="0.5rem",e.style.borderRadius="var(--radius-s)",e.style.border="1px solid var(--background-modifier-border)",e.style.fontFamily="var(--font-monospace)",e.placeholder=`Please summarize the following:

{text}`,e.value=this.formData.prompt,e.addEventListener("input",a=>{this.formData.prompt=a.target.value});let t=s.createDiv({cls:"button-container"});t.style.display="flex",t.style.justifyContent="flex-end",t.style.gap="0.5rem",t.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),t.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",()=>{if(!this.formData.name.trim()){new u.Notice("Template name is required");return}if(!this.formData.prompt.trim()){new u.Notice("Prompt template is required");return}this.onSave(this.formData),this.close()})}onClose(){let{contentEl:s}=this;s.empty()}},we=class extends u.Modal{constructor(e,t){var i;super(e);this.entries=[];this.searchTerm="";this.plugin=t;let n=(i=t.aiService)==null?void 0:i.getCacheService();n&&(this.entries=n.getAllEntries())}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Cached Responses"});let t=e.createDiv({cls:"cache-search"});t.style.marginBottom="1rem",new u.Setting(t).setName("Search").setDesc("Filter cached responses by keyword").addText(i=>i.setPlaceholder("Search cached responses...").onChange(a=>{this.searchTerm=a.toLowerCase(),this.renderEntries(e)})),this.renderEntries(e);let n=e.createEl("button",{text:"Close",cls:"mod-cta"});n.style.marginTop="1rem",n.addEventListener("click",()=>this.close())}renderEntries(e){let t=e.querySelector(".cache-entries-list");t&&t.remove();let n=this.searchTerm?this.entries.filter(a=>a.prompt.toLowerCase().includes(this.searchTerm)||a.response.toLowerCase().includes(this.searchTerm)):this.entries;if(n.length===0){let a=e.createDiv({cls:"cache-empty"});a.style.padding="2rem",a.style.textAlign="center",a.style.color="var(--text-muted)",a.textContent=this.searchTerm?"No cached responses match your search.":"No cached responses yet.";return}let i=e.createDiv({cls:"cache-entries-list"});if(i.style.maxHeight="400px",i.style.overflowY="auto",n.slice(0,50).forEach(a=>{let o=i.createDiv({cls:"cache-entry-item"});o.style.padding="0.75rem",o.style.marginBottom="0.5rem",o.style.backgroundColor="var(--background-secondary)",o.style.borderRadius="var(--radius-s)";let r=o.createDiv({cls:"cache-entry-header"});r.style.display="flex",r.style.justifyContent="space-between",r.style.alignItems="center",r.style.marginBottom="0.5rem";let c=r.createDiv();c.style.fontSize="var(--font-smaller)",c.style.color="var(--text-muted)";let l=new Date(a.createdAt).toLocaleDateString();c.textContent=`${l} | ${a.model} | ${a.tokensUsed} tokens | Used ${a.accessCount}x`;let d=r.createEl("button",{text:"Delete",cls:"mod-warning"});d.style.fontSize="var(--font-smaller)",d.style.padding="0.25rem 0.5rem",d.addEventListener("click",()=>{var f;if(confirm("Delete this cached response?")){let y=(f=this.plugin.aiService)==null?void 0:f.getCacheService();y&&y.deleteEntry(a.id)&&(this.entries=this.entries.filter(x=>x.id!==a.id),this.renderEntries(e),new u.Notice("Cached response deleted"))}});let h=o.createDiv({cls:"cache-entry-prompt"});h.style.fontWeight="bold",h.style.fontSize="var(--font-small)",h.style.marginBottom="0.25rem",h.textContent=a.prompt.substring(0,200)+(a.prompt.length>200?"...":"");let m=o.createDiv({cls:"cache-entry-response"});m.style.fontSize="var(--font-small)",m.style.color="var(--text-muted)",m.textContent=a.response.substring(0,300)+(a.response.length>300?"...":"")}),n.length>50){let a=e.createDiv({cls:"cache-more"});a.style.textAlign="center",a.style.color="var(--text-muted)",a.style.marginTop="0.5rem",a.textContent=`Showing 50 of ${n.length} entries. Use search to filter.`}}onClose(){let{contentEl:e}=this;e.empty()}};var b=require("obsidian");var V={"gpt-4":8192,"gpt-4-32k":32768,"gpt-4-turbo":128e3,"gpt-4-turbo-preview":128e3,"gpt-4o":128e3,"gpt-4o-mini":128e3,"gpt-3.5-turbo":4096,"gpt-3.5-turbo-16k":16384,"claude-3-opus":2e5,"claude-3-sonnet":2e5,"claude-3-haiku":2e5,"claude-3-opus-20240229":2e5,"claude-3-sonnet-20240229":2e5,"claude-2":1e5,"claude-2.1":2e5,llama2:4096,"llama2:7b":4096,"llama2:13b":4096,"llama2:70b":4096,mistral:8192,mixtral:32768,codellama:16384,phi:2048,gemma:8192,default:4096};function A(p,s="openai"){if(!p)return 0;let e;switch(s){case"anthropic":e=3.5;break;case"ollama":e=4;break;default:e=4}let t=Math.ceil(p.length/e),n=p.match(/```[\s\S]*?```/g);if(n){let i=n.reduce((a,o)=>a+o.length,0);t+=Math.ceil(i*(1/3-1/e))}return Math.max(1,t)}function Ve(p){if(V[p])return V[p];for(let[s,e]of Object.entries(V))if(p.toLowerCase().includes(s.toLowerCase()))return e;return V.default}function $e(p,s,e,t,n,i){let a=A(p,i),o=A(s,i),r=e.reduce((m,f)=>m+A(f.content,i)+4,0),c=A(t,i),l=a+o+r+c,d=Ve(n),h=Math.min(100,Math.round(l/d*100));return{systemPrompt:a,context:o,conversationHistory:r,currentPrompt:c,total:l,limit:d,percentage:h}}function Ie(p){return p>=95?"critical":p>=80?"high":p>=60?"medium":"low"}function Fe(p){switch(p){case"critical":return"var(--text-error)";case"high":return"var(--text-warning)";case"medium":return"var(--text-accent)";default:return"var(--text-muted)"}}function xe(p){return p>=1e3?`${(p/1e3).toFixed(1)}k`:p.toString()}function R(p,s,e="openai"){if(A(p,e)<=s)return p;let i=Math.floor(s*(e==="anthropic"?3.5:4));if(i<=100)return p.substring(0,i);let a=Math.floor(i*.6),o=i-a-20,r=p.substring(0,a),c=p.substring(p.length-o);return`${r}

[... content truncated ...]

${c}`}var D=require("obsidian"),G=class{constructor(s){this.dots=[];this.container=s.createDiv({cls:"oa-typing-indicator"}),this.container.createSpan({text:"AI is typing",cls:"oa-sr-only"});let e=this.container.createDiv({cls:"oa-typing-indicator__dots"});for(let t=0;t<3;t++)this.dots.push(e.createDiv({cls:"oa-typing-indicator__dot"}));this.hide()}show(){this.container.style.display="flex"}hide(){this.container.style.display="none"}destroy(){this.container.remove()}},K=class{constructor(s,e){this.reactions=new Map;this.container=s.createDiv({cls:"oa-message__reactions"}),this.onReactionToggle=e;let t=this.container.createSpan({cls:"oa-reaction oa-reaction__add",text:"+"});(0,D.setTooltip)(t,"Add reaction"),t.addEventListener("click",n=>{n.stopPropagation(),this.showReactionPicker(n)})}addReaction(s,e=1,t=!1){this.reactions.set(s,{emoji:s,count:e,userReacted:t}),this.render()}removeReaction(s){this.reactions.delete(s),this.render()}toggleReaction(s){let e=this.reactions.get(s);e?e.userReacted?e.count>1?this.reactions.set(s,{...e,count:e.count-1,userReacted:!1}):this.reactions.delete(s):this.reactions.set(s,{...e,count:e.count+1,userReacted:!0}):this.reactions.set(s,{emoji:s,count:1,userReacted:!0}),this.render(),this.onReactionToggle(s)}render(){this.container.querySelectorAll(".oa-reaction:not(.oa-reaction__add)").forEach(t=>t.remove());let e=this.container.querySelector(".oa-reaction__add");this.reactions.forEach(t=>{let n=document.createElement("span");n.className=`oa-reaction ${t.userReacted?"oa-reaction--active":""}`,n.innerHTML=`${t.emoji} ${t.count>1?t.count:""}`,(0,D.setTooltip)(n,t.userReacted?"Remove reaction":"Add reaction"),n.addEventListener("click",i=>{i.stopPropagation(),this.toggleReaction(t.emoji)}),e?this.container.insertBefore(n,e):this.container.appendChild(n)})}showReactionPicker(s){let e=document.createElement("div");e.className="oa-reaction-picker",e.style.position="absolute",e.style.zIndex="1000",["\u{1F44D}","\u2764\uFE0F","\u{1F604}","\u{1F389}","\u{1F914}","\u{1F440}","\u{1F525}","\u2705"].forEach(a=>{e.createDiv({cls:"oa-reaction-picker__emoji",text:a}).addEventListener("click",()=>{this.toggleReaction(a),e.remove()})}),document.body.appendChild(e);let n=s.target.getBoundingClientRect();e.style.left=`${n.left}px`,e.style.top=`${n.top-e.offsetHeight-8}px`;let i=a=>{e.contains(a.target)||(e.remove(),document.removeEventListener("click",i))};setTimeout(()=>document.addEventListener("click",i),0)}destroy(){this.container.remove()}};var W=class{constructor(s,e,t){this.unreadCount=0;this.onClick=t,this.button=s.createEl("button",{cls:"oa-scroll-bottom"}),(0,D.setIcon)(this.button,"arrow-down"),(0,D.setTooltip)(this.button,"Scroll to bottom"),this.badge=this.button.createDiv({cls:"oa-scroll-bottom__badge"}),this.badge.style.display="none",this.button.addEventListener("click",()=>{this.onClick(),this.hide()}),this.hide(),e.addEventListener("scroll",()=>{e.scrollHeight-e.scrollTop-e.clientHeight<100&&this.hide()})}show(){this.button.style.display="flex"}hide(){this.button.style.display="none",this.unreadCount=0,this.updateBadge()}incrementUnread(){this.unreadCount++,this.updateBadge(),this.show()}updateBadge(){this.unreadCount>0?(this.badge.style.display="flex",this.badge.textContent=this.unreadCount>99?"99+":String(this.unreadCount)):this.badge.style.display="none"}destroy(){this.button.remove()}},Y=class{constructor(s,e,t){this.onSearch=e,this.onResultClick=t,this.container=s.createDiv({cls:"oa-search-container"});let n=this.container.createDiv({cls:"oa-search-input-wrapper"});n.createSpan({cls:"oa-search-icon"}),(0,D.setIcon)(n.querySelector(".oa-search-icon"),"search"),this.input=n.createEl("input",{cls:"oa-search-input",attr:{placeholder:"Search conversation...",type:"text"}});let i=n.createEl("button",{cls:"oa-search-clear"});(0,D.setIcon)(i,"x"),i.addEventListener("click",()=>{this.input.value="",this.clearResults(),this.input.focus()}),this.resultsContainer=this.container.createDiv({cls:"oa-search-results"}),this.resultsContainer.style.display="none";let a;this.input.addEventListener("input",()=>{clearTimeout(a),a=window.setTimeout(()=>{this.performSearch()},300)}),this.input.addEventListener("keydown",o=>{o.key==="Escape"&&(this.clearResults(),this.input.blur())})}performSearch(){let s=this.input.value.trim();if(!s){this.clearResults();return}let e=this.onSearch(s);this.renderResults(e,s)}renderResults(s,e){if(this.resultsContainer.empty(),s.length===0){this.resultsContainer.createDiv({cls:"oa-search-empty",text:"No results found"}),this.resultsContainer.style.display="block";return}s.forEach(t=>{let n=this.resultsContainer.createDiv({cls:"oa-search-result"}),i=t.content;t.matchRanges.forEach(([o,r])=>{let c=i.slice(o,r);i=i.slice(0,o)+`<span class="oa-search-result__match">${c}</span>`+i.slice(r)}),n.innerHTML=i;let a=new Date(t.timestamp).toLocaleTimeString();n.createDiv({cls:"oa-search-result__time",text:a}),n.addEventListener("click",()=>{this.onResultClick(t),this.clearResults()})}),this.resultsContainer.style.display="block"}clearResults(){this.resultsContainer.empty(),this.resultsContainer.style.display="none"}focus(){this.input.focus()}destroy(){this.container.remove()}},Q=class{constructor(s,e){this.container=s.createDiv({cls:"oa-message-actions"}),e.forEach(t=>{let n=this.container.createEl("button",{cls:"oa-message-action"});(0,D.setIcon)(n,t.icon),(0,D.setTooltip)(n,t.label),n.addEventListener("click",i=>{i.stopPropagation(),t.onClick()})})}destroy(){this.container.remove()}};function Ge(p,s,e){return p.animate(s,e)}function Re(p,s=300){return Ge(p,[{transform:"translateY(20px)",opacity:0},{transform:"translateY(0)",opacity:1}],{duration:s,easing:"cubic-bezier(0.34, 1.56, 0.64, 1)",fill:"forwards"})}var I=class extends b.Modal{constructor(e,t,n,i,a,o){super(e);this.prompt="";this.context="";this.chatHistory=[];this.currentConversationId=null;this.isStreaming=!1;this.currentResponse="";this.messageReactions=new Map;if(this.aiService=t,this.settings=n,this.saveSettings=i,this.context=a,this.onSubmit=o,this.settings.enableConversationPersistence&&this.settings.activeConversationId){let r=this.settings.conversations.find(c=>c.id===this.settings.activeConversationId);r&&(this.currentConversationId=r.id,this.chatHistory=[...r.messages])}}onOpen(){let{contentEl:e}=this;this.modalEl.addClass("obsidian-agent-modal"),e.addClass("oa-modal-content");let t=e.createDiv({cls:"oa-modal-header-glass"});this.renderHeader(t);let n=e.createDiv({cls:"oa-search-wrapper"});n.style.display="none",this.searchInterface=new Y(n,i=>this.searchMessages(i),i=>this.scrollToMessage(i.id)),this.chatHistoryContainer=e.createDiv({cls:"chat-history-container"}),this.messageListEl=this.chatHistoryContainer.createDiv({cls:"oa-message-list"}),this.typingIndicator=new G(this.messageListEl),this.scrollButton=new W(e,this.chatHistoryContainer,()=>this.scrollToBottom()),this.renderChatHistory(),this.renderInputArea(e),setTimeout(()=>{var i;return(i=this.textAreaElement)==null?void 0:i.focus()},0)}renderHeader(e){let t=e.createDiv({cls:"oa-header-row"});t.style.display="flex",t.style.justifyContent="space-between",t.style.alignItems="center";let n=t.createDiv();n.createEl("h2",{text:"AI Agent Assistant",cls:"oa-modal-title"}),n.createEl("p",{text:"Ask anything about your notes",cls:"oa-header-subtitle"});let i=t.createDiv({cls:"oa-header-actions"});i.style.display="flex",i.style.gap="var(--oa-space-sm)";let a=i.createEl("button",{cls:"oa-input-action"});(0,b.setIcon)(a,"search"),(0,b.setTooltip)(a,"Search conversation"),a.addEventListener("click",()=>{var l;let c=this.contentEl.querySelector(".oa-search-wrapper");if(c){let d=c.style.display!=="none";c.style.display=d?"none":"block",d||(l=this.searchInterface)==null||l.focus()}});let o=i.createEl("button",{cls:"oa-input-action"});(0,b.setIcon)(o,"trash-2"),(0,b.setTooltip)(o,"Clear chat"),o.addEventListener("click",()=>this.clearChatWithConfirmation());let r=i.createEl("button",{cls:"oa-input-action"});(0,b.setIcon)(r,"download"),(0,b.setTooltip)(r,"Export conversation"),r.addEventListener("click",()=>this.exportConversation())}renderInputArea(e){let t=e.createDiv({cls:"oa-input-container"});this.tokenCounterContainer=t.createDiv({cls:"token-counter-container"});let n=this.tokenCounterContainer.createDiv({cls:"token-bar-container"});this.tokenCounterBar=n.createDiv({cls:"token-bar-fill"}),this.tokenCounterText=this.tokenCounterContainer.createDiv({cls:"token-text"}),this.updateTokenCounter();let i=t.createDiv({cls:"oa-input-wrapper"}),a=new b.TextAreaComponent(i);this.textAreaElement=a.inputEl,this.textAreaElement.addClass("oa-input"),this.textAreaElement.placeholder="Type your message...",this.textAreaElement.addEventListener("keydown",l=>this.handleKeyDown(l)),a.onChange(l=>{this.prompt=l,this.updateTokenCounter()});let o=i.createDiv({cls:"oa-input-actions"}),r=o.createEl("button",{cls:"oa-input-action"});(0,b.setIcon)(r,"mic"),(0,b.setTooltip)(r,"Voice input (coming soon)"),r.addEventListener("click",()=>{new b.Notice("Voice input feature coming soon!")});let c=o.createEl("button",{cls:"oa-input-action"});(0,b.setIcon)(c,"layout-template"),(0,b.setTooltip)(c,"Use template"),c.addEventListener("click",()=>this.openTemplatesPicker()),this.submitButton=o.createEl("button",{cls:"oa-input-action oa-input-action--primary"}),(0,b.setIcon)(this.submitButton,"send"),(0,b.setTooltip)(this.submitButton,"Send message (Enter)"),this.submitButton.addEventListener("click",()=>this.handleSubmit()),this.stopButton=o.createEl("button",{cls:"oa-input-action oa-input-action--danger"}),(0,b.setIcon)(this.stopButton,"square"),(0,b.setTooltip)(this.stopButton,"Stop generation"),this.stopButton.style.display="none",this.stopButton.addEventListener("click",()=>this.stopGeneration())}renderChatHistory(){if(this.messageListEl.empty(),this.chatHistory.length===0){this.showWelcomeMessage();return}this.chatHistory.forEach((e,t)=>{this.renderMessage(e,t)}),this.scrollToBottom()}renderMessage(e,t){let n=e.role==="user",i=this.messageListEl.createDiv({cls:`oa-message oa-message--${n?"user":"assistant"}`});t===this.chatHistory.length-1&&Re(i,300);let a=i.createDiv({cls:"oa-message__bubble"}),o=a.createDiv({cls:"message-content"});n?o.textContent=e.content:o.innerHTML=this.renderMarkdown(e.content),!n&&this.isStreaming&&t===this.chatHistory.length-1&&o.createSpan({cls:"oa-streaming-cursor"});let r=a.createDiv({cls:"message-meta"});r.style.fontSize="var(--font-smallest)",r.style.color="var(--text-muted)",r.style.marginTop="var(--oa-space-xs)";let c=new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(r.textContent=c,e.tokensUsed&&(r.textContent+=` \xB7 ${e.tokensUsed} tokens`),e.fromCache&&(r.textContent+=" \xB7 cached"),new Q(i,[{icon:"copy",label:"Copy message",onClick:()=>{navigator.clipboard.writeText(e.content),new b.Notice("Message copied to clipboard")}},{icon:"quote",label:"Reply",onClick:()=>this.quoteMessage(e)},{icon:"trash-2",label:"Delete",onClick:()=>this.deleteMessage(t)}]),!n){let d=new K(i,h=>{new b.Notice(`Reacted with ${h}`)});this.messageReactions.set(t,d)}let l=this.messageListEl.querySelector(".oa-typing-indicator");l?this.messageListEl.insertBefore(i,l):this.messageListEl.appendChild(i)}renderMarkdown(e){let t=e.replace(/```(\w*)\n([\s\S]*?)```/g,'<pre><code class="language-$1">$2</code></pre>').replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\*\*\*([^*]+)\*\*\*/g,"<strong><em>$1</em></strong>").replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/\*([^*]+)\*/g,"<em>$1</em>").replace(/~~([^~]+)~~/g,"<del>$1</del>").replace(/### (.+)/g,"<h4>$1</h4>").replace(/## (.+)/g,"<h3>$1</h3>").replace(/# (.+)/g,"<h2>$1</h2>").replace(/^> (.+)/gm,"<blockquote>$1</blockquote>").replace(/^- \[ \] (.+)/gm,'<div class="oa-task oa-task--todo">$1</div>').replace(/^- \[x\] (.+)/gm,'<div class="oa-task oa-task--done">$1</div>').replace(/^[-*] (.+)/gm,"<li>$1</li>").replace(/\n/g,"<br>");return t=t.replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>"),t}showWelcomeMessage(){let e=this.messageListEl.createDiv({cls:"oa-welcome-message"});e.style.textAlign="center",e.style.padding="var(--oa-space-2xl)",e.style.color="var(--text-muted)";let t=e.createDiv({cls:"oa-welcome-icon"});t.style.fontSize="3rem",t.style.marginBottom="var(--oa-space-md)",t.textContent="\u2728",e.createEl("h3",{text:"Welcome to AI Agent"}),e.createEl("p",{text:"Ask me anything about your notes, or use templates for common tasks."})}async handleSubmit(e=!1){if(!this.prompt.trim()){new b.Notice("Please enter a message");return}e&&this.aiService.setBypassCache(!0),this.addMessage("user",this.prompt),this.prompt="",this.textAreaElement.value="",this.updateTokenCounter(),this.typingIndicator.show(),this.isStreaming=!0,this.submitButton.style.display="none",this.stopButton.style.display="flex";try{let t=await this.aiService.generateCompletion({prompt:this.prompt,context:this.context,stream:!0,onChunk:n=>{this.onStreamChunk(n),n.done&&this.finishStreaming(t)},onProgress:n=>{this.isStreaming&&this.onStreamProgress(n)}})}catch(t){t.name!=="AbortError"&&(new b.Notice(`Error: ${t.message}`),console.error("Agent Error:",t)),this.stopStreaming()}}onStreamChunk(e){if(!e.done&&e.content&&(this.currentResponse+=e.content,this.chatHistory.length>0)){let t=this.chatHistory[this.chatHistory.length-1];t.role==="assistant"&&(t.content=this.currentResponse,this.updateLastMessage())}}onStreamProgress(e){if(this.typingIndicator.hide(),this.chatHistory.length===0||this.chatHistory[this.chatHistory.length-1].role!=="assistant")this.addMessage("assistant",e,!1);else{let t=this.chatHistory[this.chatHistory.length-1];t.content=e,this.updateLastMessage()}this.scrollToBottom()}finishStreaming(e){if(this.stopStreaming(),this.currentResponse){if(this.chatHistory.length>0){let t=this.chatHistory[this.chatHistory.length-1];t.role==="assistant"&&(t.content=this.currentResponse,t.tokensUsed=e.tokensUsed,t.fromCache=e.fromCache)}this.renderChatHistory(),this.saveCurrentConversation(),e.fromCache&&new b.Notice("Response loaded from cache"),this.onSubmit(this.currentResponse)}this.currentResponse=""}stopStreaming(){this.isStreaming=!1,this.typingIndicator.hide(),this.submitButton.style.display="flex",this.stopButton.style.display="none"}stopGeneration(){this.aiService.cancelCurrentRequest(),this.stopStreaming(),new b.Notice("Generation stopped")}addMessage(e,t,n,i){this.chatHistory.push({role:e,content:t,timestamp:Date.now(),fromCache:n,tokensUsed:i}),this.renderMessage(this.chatHistory[this.chatHistory.length-1],this.chatHistory.length-1),this.scrollToBottom()}updateLastMessage(){let e=this.messageListEl.querySelectorAll(".oa-message");if(e.length>0){let n=e[e.length-1].querySelector(".message-content");if(n){let i=this.chatHistory[this.chatHistory.length-1];n.innerHTML=this.renderMarkdown(i.content),this.isStreaming&&i.role==="assistant"&&n.createSpan({cls:"oa-streaming-cursor"})}}}updateTokenCounter(){if(!this.tokenCounterBar||!this.tokenCounterText)return;let e=$e(this.settings.systemPrompt,this.settings.enableContextAwareness?this.context:"",this.chatHistory,this.prompt,this.settings.model,this.settings.apiProvider),t=Ie(e.percentage),n=Fe(t);this.tokenCounterBar.style.width=`${Math.min(100,e.percentage)}%`,this.tokenCounterBar.style.backgroundColor=n,this.tokenCounterText.empty(),this.tokenCounterText.createSpan({text:`${xe(e.total)} / ${xe(e.limit)} tokens`})}handleKeyDown(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this.handleSubmit()),e.key==="Escape"&&this.close(),(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="k"&&(e.preventDefault(),this.clearChatWithConfirmation())}scrollToBottom(){this.chatHistoryContainer.scrollTop=this.chatHistoryContainer.scrollHeight}searchMessages(e){let t=[],n=e.toLowerCase();return this.chatHistory.forEach((i,a)=>{let r=i.content.toLowerCase().indexOf(n);r!==-1&&t.push({id:String(a),content:i.content,timestamp:i.timestamp,matchRanges:[[r,r+e.length]]})}),t}scrollToMessage(e){let t=this.messageListEl.querySelectorAll(".oa-message"),n=parseInt(e);t[n]&&(t[n].scrollIntoView({behavior:"smooth",block:"center"}),t[n].classList.add("oa-message--highlighted"),setTimeout(()=>{t[n].classList.remove("oa-message--highlighted")},2e3))}quoteMessage(e){let t=e.content.split(`
`).map(n=>`> ${n}`).join(`
`);this.prompt=`${t}

`,this.textAreaElement.value=this.prompt,this.textAreaElement.focus(),this.updateTokenCounter()}deleteMessage(e){confirm("Delete this message?")&&(this.chatHistory.splice(e,1),this.renderChatHistory(),this.saveCurrentConversation())}clearChatWithConfirmation(){this.chatHistory.length!==0&&confirm("Clear the entire conversation?")&&(this.chatHistory=[],this.currentConversationId=null,this.settings.activeConversationId=void 0,this.renderChatHistory(),this.saveSettings(),new b.Notice("Conversation cleared"))}exportConversation(){if(this.chatHistory.length===0){new b.Notice("No conversation to export");return}let e=`# AI Conversation Export

`;e+=`*Exported on ${new Date().toLocaleString()}*

---

`,this.chatHistory.forEach(t=>{let n=t.role==="user"?"**You**":"**AI**",i=new Date(t.timestamp).toLocaleString();e+=`${n} *(${i})*:

${t.content}

---

`}),navigator.clipboard.writeText(e),new b.Notice("Conversation copied to clipboard")}openTemplatesPicker(){new b.Notice("Template picker coming soon!")}async saveCurrentConversation(){if(!this.settings.enableConversationPersistence)return;let e=Date.now();if(this.currentConversationId){let t=this.settings.conversations.findIndex(n=>n.id===this.currentConversationId);t>=0&&(this.settings.conversations[t].messages=[...this.chatHistory],this.settings.conversations[t].updatedAt=e)}else this.currentConversationId=`conv_${e}_${Math.random().toString(36).substr(2,9)}`,this.settings.conversations.unshift({id:this.currentConversationId,title:this.generateConversationTitle(),messages:[...this.chatHistory],createdAt:e,updatedAt:e}),this.settings.conversations.length>this.settings.maxConversations&&(this.settings.conversations=this.settings.conversations.slice(0,this.settings.maxConversations));this.settings.activeConversationId=this.currentConversationId,await this.saveSettings()}generateConversationTitle(){let e=this.chatHistory.find(t=>t.role==="user");return e?e.content.substring(0,50)+(e.content.length>50?"...":""):`Conversation ${new Date().toLocaleDateString()}`}onClose(){this.aiService.cancelCurrentRequest(),this.typingIndicator.destroy(),this.scrollButton.destroy(),this.messageReactions.forEach(e=>e.destroy()),this.contentEl.empty()}};var Ne=require("obsidian");var J=class{constructor(s){this.app=s}async gatherContext(s,e,t,n="openai"){let i=[];if(t.sources.find(a=>a.type==="current"&&a.enabled)){let a=R(e,t.maxTokensPerNote,n);i.push({source:"current",notePath:(s==null?void 0:s.path)||"current",noteTitle:(s==null?void 0:s.basename)||"Current Note",content:a,tokens:A(a,n)})}if(!s)return i;if(t.sources.find(a=>a.type==="linked"&&a.enabled)){let a=await this.getLinkedNotesContext(s,t,n);i.push(...a)}if(t.sources.find(a=>a.type==="backlinks"&&a.enabled)){let a=await this.getBacklinksContext(s,t,n);i.push(...a)}if(t.sources.find(a=>a.type==="tags"&&a.enabled)){let a=await this.getTagContexts(s,t,n);i.push(...a)}if(t.sources.find(a=>a.type==="folder"&&a.enabled)){let a=await this.getFolderContexts(s,t,n);i.push(...a)}return this.dedupeContexts(i)}async getLinkedNotesContext(s,e,t){let n=[],i=this.app.metadataCache.getFileCache(s);if(!(i!=null&&i.links))return n;let a=new Set,o=[...i.links],r=0;for(;o.length>0&&r<e.linkDepth&&n.length<e.maxNotesPerSource;){let c=[...o];o.length=0;for(let l of c){if(n.length>=e.maxNotesPerSource)break;let d=this.app.metadataCache.getFirstLinkpathDest(l.link,s.path);if(!(!d||a.has(d.path))&&!this.isExcluded(d.path,e.excludeFolders)){a.add(d.path);try{let h=await this.app.vault.read(d),m=R(h,e.maxTokensPerNote,t);if(n.push({source:"linked",notePath:d.path,noteTitle:d.basename,content:m,tokens:A(m,t)}),r<e.linkDepth-1){let f=this.app.metadataCache.getFileCache(d);f!=null&&f.links&&o.push(...f.links)}}catch(h){console.error(`Failed to read linked note: ${d.path}`,h)}}}r++}return n}async getBacklinksContext(s,e,t){let n=[],i=[],a=this.app.metadataCache.resolvedLinks||{};for(let[o,r]of Object.entries(a)){if(!r||!r[s.path]||o===s.path)continue;let c=this.app.vault.getAbstractFileByPath(o);c instanceof Ne.TFile&&i.push(c)}for(let o of i.slice(0,e.maxNotesPerSource))if(!this.isExcluded(o.path,e.excludeFolders))try{let r=await this.app.vault.read(o),c=R(r,e.maxTokensPerNote,t);n.push({source:"backlink",notePath:o.path,noteTitle:o.basename,content:c,tokens:A(c,t)})}catch(r){console.error(`Failed to read backlink: ${o.path}`,r)}return n}async getTagContexts(s,e,t){let n=[],i=this.app.metadataCache.getFileCache(s);if(!(i!=null&&i.tags))return n;let a=new Set(i.tags.map(c=>c.tag)),o=new Set([s.path]),r=this.app.vault.getMarkdownFiles();for(let c of r){if(n.length>=e.maxNotesPerSource)break;if(o.has(c.path)||this.isExcluded(c.path,e.excludeFolders))continue;let l=this.app.metadataCache.getFileCache(c);if(!(l!=null&&l.tags))continue;if(l.tags.map(m=>m.tag).some(m=>a.has(m))){o.add(c.path);try{let m=await this.app.vault.read(c),f=R(m,e.maxTokensPerNote,t);n.push({source:"tag",notePath:c.path,noteTitle:c.basename,content:f,tokens:A(f,t)})}catch(m){console.error(`Failed to read tagged note: ${c.path}`,m)}}}return n}async getFolderContexts(s,e,t){let n=[],i=s.parent;if(!i)return n;let a=this.app.vault.getMarkdownFiles().filter(o=>{var r;return((r=o.parent)==null?void 0:r.path)===i.path&&o.path!==s.path});for(let o of a.slice(0,e.maxNotesPerSource))if(!this.isExcluded(o.path,e.excludeFolders))try{let r=await this.app.vault.read(o),c=R(r,e.maxTokensPerNote,t);n.push({source:"folder",notePath:o.path,noteTitle:o.basename,content:c,tokens:A(c,t)})}catch(r){console.error(`Failed to read folder note: ${o.path}`,r)}return n}isExcluded(s,e){let t=s.replace(/\\/g,"/").toLowerCase(),n=t.split("/").filter(Boolean);return e.some(i=>{let a=i.trim().replace(/\\/g,"/").toLowerCase();if(!a)return!1;if(a.includes("/")){let o=a.replace(/^\/+|\/+$/g,"");return t===o||t.startsWith(`${o}/`)||t.includes(`/${o}/`)}return n.includes(a)})}dedupeContexts(s){let e=new Set,t=[];for(let n of s)e.has(n.notePath)||(e.add(n.notePath),t.push(n));return t}formatContextsForPrompt(s){if(s.length===0)return"";let e="",t={};s.forEach(n=>{t[n.source]||(t[n.source]=[]),t[n.source].push(n)});for(let[n,i]of Object.entries(t)){let a=this.getSourceLabel(n);e+=`
--- ${a} ---
`,i.forEach(o=>{n!=="current"&&(e+=`
[${o.noteTitle}]
`),e+=`${o.content}
`})}return e}getSourceLabel(s){return{current:"Current Note",linked:"Linked Notes",backlink:"Notes Linking Here",tag:"Notes with Same Tags",folder:"Notes in Same Folder"}[s]||s}};var X=require("obsidian");var B=class{constructor(s){T.required(s,"app"),this.app=s,this.vault=s.vault}async scanVault(s){var a,o;let e=Date.now(),t=[],n=this.vault.getMarkdownFiles(),i=0;for(let r=0;r<n.length;r++){let c=n[r];s&&s(r+1,n.length);let l=await this.scanFile(c);t.push(...l);let d=this.app.metadataCache.getFileCache(c);d&&(i+=(((a=d.links)==null?void 0:a.length)||0)+(((o=d.embeds)==null?void 0:o.length)||0))}return{totalLinks:i,deadLinks:t,brokenCount:t.length,scanDuration:Date.now()-e,filesScanned:n.length}}async scanFile(s){var n,i;if(!s||!(s instanceof X.TFile))return[];let e=[],t=this.app.metadataCache.getFileCache(s);if(!t)return e;if(t.links)for(let a of t.links)this.resolveLink(a.link,s.path)||e.push({sourceFile:s.basename,sourcePath:s.path,linkText:a.displayText||a.link,linkTarget:a.link,lineNumber:((n=a.position)==null?void 0:n.start.line)||0,type:"wikilink",suggestions:await this.findSuggestions(a.link)});if(t.embeds)for(let a of t.embeds)this.resolveLink(a.link,s.path)||e.push({sourceFile:s.basename,sourcePath:s.path,linkText:a.displayText||a.link,linkTarget:a.link,lineNumber:((i=a.position)==null?void 0:i.start.line)||0,type:"embed",suggestions:await this.findSuggestions(a.link)});return e}resolveLink(s,e){try{let t=s.split("#")[0].split("^")[0];return t?this.app.metadataCache.getFirstLinkpathDest(t,e):null}catch(t){return console.error("Error resolving link:",s,t),null}}async findSuggestions(s){let e=this.vault.getMarkdownFiles(),t=s.split("#")[0].split("^")[0].toLowerCase();return e.map(i=>({file:i,score:this.calculateSimilarity(t,i.basename.toLowerCase())})).filter(i=>i.score>.3).sort((i,a)=>a.score-i.score).slice(0,5).map(i=>i.file.path)}calculateSimilarity(s,e){let t=s.length>e.length?s:e,n=s.length>e.length?e:s;if(t.length===0)return 1;if(t.includes(n))return .8;let i=this.levenshteinDistance(s,e);return(t.length-i)/t.length}levenshteinDistance(s,e){let t=[];for(let n=0;n<=e.length;n++)t[n]=[n];for(let n=0;n<=s.length;n++)t[0][n]=n;for(let n=1;n<=e.length;n++)for(let i=1;i<=s.length;i++)e.charAt(n-1)===s.charAt(i-1)?t[n][i]=t[n-1][i-1]:t[n][i]=Math.min(t[n-1][i-1]+1,t[n][i-1]+1,t[n-1][i]+1);return t[e.length][s.length]}async repairLinks(s,e=!1){var a;let t=[],n=0,i=0;for(let o of s){if(!e&&(!o.suggestions||o.suggestions.length===0)){i++;continue}let r=(a=o.suggestions)==null?void 0:a[0];if(!r){i++;continue}try{let c=this.vault.getAbstractFileByPath(o.sourcePath);if(!(c instanceof X.TFile)){i++,t.push({file:o.sourcePath,oldLink:o.linkTarget,newLink:r,success:!1});continue}let l=await this.vault.read(c),d=this.vault.getAbstractFileByPath(r),h=d instanceof X.TFile?d.basename:r,m=o.type==="embed"?`![[${o.linkTarget}]]`:`[[${o.linkTarget}]]`,f=o.type==="embed"?`![[${h}]]`:`[[${h}]]`;l.includes(m)?(l=l.replace(m,f),await this.vault.modify(c,l),n++,t.push({file:o.sourcePath,oldLink:o.linkTarget,newLink:h,success:!0})):(i++,t.push({file:o.sourcePath,oldLink:o.linkTarget,newLink:h,success:!1}))}catch(c){console.error("Error repairing link:",o,c),i++,t.push({file:o.sourcePath,oldLink:o.linkTarget,newLink:r,success:!1})}}return{repairedCount:n,failedCount:i,repairs:t}}async removeDeadLinks(s,e){try{let t=await this.vault.read(s),n=0,i=e.filter(a=>a.sourcePath===s.path);for(let a of i){let o=a.type==="embed"?`![[${a.linkTarget}]]`:`[[${a.linkTarget}]]`;t.includes(o)&&(t=t.replace(o,a.linkText||""),n++)}return n>0&&await this.vault.modify(s,t),n}catch(t){return console.error("Error removing dead links:",t),0}}generateReport(s){let e=[];if(e.push(`# Dead Links Report
`),e.push(`**Scan Date:** ${new Date().toISOString()}
`),e.push(`**Files Scanned:** ${s.filesScanned}`),e.push(`**Total Links:** ${s.totalLinks}`),e.push(`**Broken Links:** ${s.brokenCount}`),e.push(`**Scan Duration:** ${s.scanDuration}ms
`),s.deadLinks.length===0)e.push(`\u2705 No dead links found!
`);else{e.push(`## Broken Links
`);let t=new Map;for(let n of s.deadLinks)t.has(n.sourcePath)||t.set(n.sourcePath,[]),t.get(n.sourcePath).push(n);for(let[n,i]of t){e.push(`### [[${n}]]
`);for(let a of i)e.push(`- **Line ${a.lineNumber}:** \`[[${a.linkTarget}]]\` (${a.type})`),a.suggestions&&a.suggestions.length>0&&e.push(`  - Suggestions: ${a.suggestions.slice(0,3).map(o=>`[[${o}]]`).join(", ")}`);e.push("")}}return e.join(`
`)}};var Oe=require("obsidian");var Ke={minRelevanceScore:.5,maxSuggestionsPerNote:10,excludeTags:[],includeTags:[],semanticThreshold:.6},Z=class{constructor(s){T.required(s,"app"),this.vault=s.vault,this.metadataCache=s.metadataCache}async suggestLinks(s,e){if(!s||!(s instanceof Oe.TFile))return[];let t={...Ke,...e},n=await this.vault.read(s),i=this.metadataCache.getFileCache(s),a=this.getExistingLinks(i),o=[],r=this.vault.getMarkdownFiles().filter(c=>c.path!==s.path);for(let c of r){if(a.has(c.path))continue;let l=await this.calculateRelevance(s,c,n,t);l.relevanceScore>=t.minRelevanceScore&&o.push({targetFile:c.basename,targetPath:c.path,relevanceScore:l.relevanceScore,matchType:l.matchType,matchedPhrase:l.matchedPhrase,context:l.context})}return o.sort((c,l)=>l.relevanceScore-c.relevanceScore),o.slice(0,t.maxSuggestionsPerNote)}getExistingLinks(s){let e=new Set;if(!s)return e;if(s.links)for(let t of s.links){let n=this.metadataCache.getFirstLinkpathDest(t.link,"");n&&e.add(n.path)}if(s.embeds)for(let t of s.embeds){let n=this.metadataCache.getFirstLinkpathDest(t.link,"");n&&e.add(n.path)}return e}async calculateRelevance(s,e,t,n){let i=0,a="semantic",o,r,c=e.basename,l=await this.vault.read(e),d=this.metadataCache.getFileCache(e),h=this.metadataCache.getFileCache(s),m=new RegExp(`\\b${this.escapeRegex(c)}\\b`,"i");if(m.test(t)){i=1,a="exact",o=c;let S=t.match(m);return S&&(r=this.extractContext(t,S.index||0)),{relevanceScore:i,matchType:a,matchedPhrase:o,context:r}}let f=c.toLowerCase().split(/\s+/);for(let S of f)if(S.length>3){let k=new RegExp(`\\b${this.escapeRegex(S)}\\b`,"i");if(k.test(t)){let w=.8*(S.length/c.length);if(w>i){i=w,a="partial",o=S;let v=t.match(k);v&&(r=this.extractContext(t,v.index||0))}}}if(h!=null&&h.tags&&(d!=null&&d.tags)){let S=new Set(h.tags.map(v=>v.tag)),k=new Set(d.tags.map(v=>v.tag)),w=[...S].filter(v=>k.has(v));if(w.length>0){let v=.7*(w.length/Math.max(S.size,k.size));v>i&&(i=v,a="tag",o=w.join(", "))}}let y=this.calculateSemanticSimilarity(t,l);return y>=n.semanticThreshold&&y>i&&(i=y*.6,a="semantic"),this.getExistingLinks(d).has(s.path)&&(i=Math.min(1,i+.2)),{relevanceScore:i,matchType:a,matchedPhrase:o,context:r}}calculateSemanticSimilarity(s,e){let t=r=>{let c=r.toLowerCase().replace(/[#*_\[\]()]/g," ").split(/\s+/).filter(l=>l.length>3&&!/^\d+$/.test(l));return new Set(c)},n=t(s),i=t(e);if(n.size===0||i.size===0)return 0;let a=[...n].filter(r=>i.has(r)).length,o=n.size+i.size-a;return a/o}extractContext(s,e,t=100){let n=Math.max(0,e-t),i=Math.min(s.length,e+t),a=s.substring(n,i),o=a.lastIndexOf(".",t),r=a.indexOf(".",t);return o!==-1&&(a=a.substring(o+1)),r!==-1&&(a=a.substring(0,r+1)),a.trim()}escapeRegex(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async applyLinks(s,e,t=!1){try{let n=await this.vault.read(s),i=0;for(let a of e){if(!a.matchedPhrase||a.matchType==="semantic")continue;let o=new RegExp(`\\b(${this.escapeRegex(a.matchedPhrase)})\\b(?!\\]\\])`,"gi");o.test(n)&&(n=n.replace(o,`[[$1|${a.matchedPhrase}]]`),i++)}return i>0&&t&&await this.vault.modify(s,n),i}catch(n){return console.error("Error applying links:",n),0}}generateReport(s,e){let t=[];if(t.push(`# Link Suggestions for [[${s.basename}]]
`),t.push(`**Generated:** ${new Date().toISOString()}
`),t.push(`**Suggestions Found:** ${e.length}
`),e.length===0)return t.push(`No link suggestions found.
`),t.join(`
`);t.push(`## Suggested Links
`);for(let n of e){let i=(n.relevanceScore*100).toFixed(1);t.push(`### [[${n.targetPath}|${n.targetFile}]]`),t.push(`- **Relevance:** ${i}%`),t.push(`- **Match Type:** ${n.matchType}`),n.matchedPhrase&&t.push(`- **Matched:** "${n.matchedPhrase}"`),n.context&&t.push(`- **Context:** "${n.context}"`),t.push("")}return t.join(`
`)}};var Ce=require("obsidian");var We={minConfidence:.4,maxSuggestions:5,learnFromHistory:!0,useSemanticSimilarity:!0},H=class{constructor(s){this.tagPatterns=null;this.idfCache=null;T.required(s,"app"),this.vault=s.vault,this.metadataCache=s.metadataCache}async suggestTags(s,e={}){if(!s||!(s instanceof Ce.TFile))return[];let t={...We,...e},n=await this.vault.read(s),i=this.getExistingTags(s),a=[];this.tagPatterns||await this.buildTagPatterns();let o=await this.suggestFromContent(n,i);if(a.push(...o),t.learnFromHistory){let c=await this.suggestFromPatterns(n,i);a.push(...c)}if(t.useSemanticSimilarity){let c=await this.suggestFromSimilarNotes(s,n,i);a.push(...c)}if(i.length>0){let c=this.suggestFromCoOccurrence(i);a.push(...c)}return this.mergeSuggestions(a).filter(c=>c.confidence>=t.minConfidence).sort((c,l)=>l.confidence-c.confidence).slice(0,t.maxSuggestions)}async applyTags(s,e){if(!s||!(s instanceof Ce.TFile))throw new Error("Invalid file");let t=await this.vault.read(s),n=this.metadataCache.getFileCache(s);n!=null&&n.frontmatter?t=this.addTagsToFrontmatter(t,e):t=`
`+e.map(a=>`#${a}`).join(" ")+`

`+t,await this.vault.modify(s,t)}async buildTagPatterns(){this.tagPatterns=new Map;let s=this.vault.getMarkdownFiles(),e=new Map;for(let n of s){let i=this.metadataCache.getFileCache(n);if(!(i!=null&&i.tags))continue;let a=await this.vault.read(n),o=this.extractKeywords(a),r=i.tags.map(c=>c.tag);for(let c of r){this.tagPatterns.has(c)||this.tagPatterns.set(c,{tag:c,keywords:new Set,frequency:0,coOccurrences:new Map});let l=this.tagPatterns.get(c);l.frequency++,o.forEach(d=>l.keywords.add(d));for(let d of r)if(d!==c){let h=l.coOccurrences.get(d)||0;l.coOccurrences.set(d,h+1)}}o.forEach(c=>{e.set(c,(e.get(c)||0)+1)})}this.idfCache=new Map;let t=s.length;for(let[n,i]of e)this.idfCache.set(n,Math.log(t/i))}async suggestFromContent(s,e){var a;let t=[],n=this.extractKeywords(s),i=new Set(e);if(!this.tagPatterns)return t;for(let[o,r]of this.tagPatterns){if(i.has(o))continue;let c=n.filter(h=>r.keywords.has(h));if(c.length===0)continue;let l=0;for(let h of c){let m=((a=this.idfCache)==null?void 0:a.get(h))||1;l+=m}let d=Math.min(1,l/(r.keywords.size*.5));d>.3&&t.push({tag:o.replace("#",""),confidence:d,reason:"content_match",examples:c.slice(0,3)})}return t}async suggestFromPatterns(s,e){let t=[],n=this.extractKeywords(s),i=new Set(e);if(!this.tagPatterns)return t;for(let[a,o]of this.tagPatterns){if(i.has(a))continue;let r=n.filter(h=>o.keywords.has(h)).length;if(r<2)continue;let c=r/o.keywords.size,l=Math.log(o.frequency+1)/10,d=Math.min(1,c*.7+l*.3);d>.35&&t.push({tag:a.replace("#",""),confidence:d,reason:"pattern_learned"})}return t}async suggestFromSimilarNotes(s,e,t){let n=[],i=this.vault.getMarkdownFiles().filter(d=>d.path!==s.path),a=new Set(t),o=new Set(this.extractKeywords(e)),r=[];for(let d of i.slice(0,100)){let h=await this.vault.read(d),m=new Set(this.extractKeywords(h)),f=[...o].filter(S=>m.has(S)),y=new Set([...o,...m]),x=f.length/y.size;x>.3&&r.push({file:d,score:x})}r.sort((d,h)=>h.score-d.score);let c=new Map,l=new Map;for(let{file:d,score:h}of r.slice(0,5)){let m=this.metadataCache.getFileCache(d);if(m!=null&&m.tags)for(let f of m.tags){let y=f.tag.replace("#","");a.has(y)||(c.set(y,(c.get(y)||0)+1),l.set(y,Math.max(l.get(y)||0,h)))}}for(let[d,h]of c){let m=(l.get(d)||0)*(h/5);m>.3&&n.push({tag:d,confidence:m,reason:"similar_notes"})}return n}suggestFromCoOccurrence(s){let e=[];if(!this.tagPatterns)return e;let t=new Set(s.map(i=>i.startsWith("#")?i:`#${i}`)),n=new Map;for(let i of t){let a=this.tagPatterns.get(i);if(a)for(let[o,r]of a.coOccurrences)t.has(o)||n.set(o,(n.get(o)||0)+r)}for(let[i,a]of n){let o=Math.min(1,a/10);o>.3&&e.push({tag:i.replace("#",""),confidence:o,reason:"frequency"})}return e}mergeSuggestions(s){let e=new Map;for(let t of s){let n=e.get(t.tag);n?n.confidence=Math.min(1,Math.max(n.confidence,t.confidence)+Math.min(n.confidence,t.confidence)*.3):e.set(t.tag,{...t})}return Array.from(e.values())}getExistingTags(s){let e=this.metadataCache.getFileCache(s);return e!=null&&e.tags?e.tags.map(t=>t.tag.replace("#","")):[]}extractKeywords(s){let t=s.replace(/```[\s\S]*?```/g,"").replace(/`[^`]+`/g,"").replace(/!\[\[.*?\]\]/g,"").replace(/\[\[(.*?)\]\]/g,"$1").replace(/[#*_\[\]()]/g," ").toLowerCase().split(/\s+/).filter(n=>n.length>3).filter(n=>!/^\d+$/.test(n)).filter(n=>!this.isStopWord(n));return[...new Set(t)]}isStopWord(s){return new Set(["the","and","for","are","but","not","you","all","can","her","was","one","our","out","day","get","has","him","his","how","its","may","new","now","old","see","two","who","boy","did","she","use","way","will","with","this","that","have","from","they","been","what","when","make","like","time","just","know","take","into","year","your","some","could","them","than","then","these","would","other"]).has(s)}addTagsToFrontmatter(s,e){let t=/^---\n([\s\S]*?)\n---/,n=s.match(t);if(n){let i=n[1],a=/^tags:\s*(.*)$/m,o=i.match(a);if(o){let r=o[1].replace(/[\[\]]/g,"").split(",").map(h=>h.trim()).filter(h=>h),l=`tags: [${[...new Set([...r,...e])].join(", ")}]`,d=i.replace(a,l);return s.replace(t,`---
${d}
---`)}else{let r=`${i}
tags: [${e.join(", ")}]`;return s.replace(t,`---
${r}
---`)}}else return`---
tags: [${e.join(", ")}]
---

`+s}clearCache(){this.tagPatterns=null,this.idfCache=null}};var Ye={level:"standard",includeSections:!1,includeKeyPoints:!0,includeQuotes:!1,maxLength:0,preserveStructure:!1},Qe={mode:"thematic",includeCitations:!0,identifyGaps:!0,findContradictions:!0},U=class{constructor(s,e){T.required(s,"app"),T.required(e,"aiService"),this.vault=s.vault,this.aiService=e}async summarizeNote(s,e={}){let t={...Ye,...e},n=await this.vault.read(s),i=t.includeSections?this.extractSections(n):null,a=this.buildSummaryPrompt(n,s.basename,t,i),r=(await this.aiService.generateCompletion(a)).text.trim(),c=t.includeKeyPoints?await this.extractKeyPoints(n):void 0,l=t.includeQuotes?this.extractQuotes(n):void 0;return{summary:r,level:t.level,wordCount:r.split(/\s+/).length,keyPoints:c,quotes:l,sections:i||void 0}}async synthesizeNotes(s,e={}){let t={...Qe,...e},n=await Promise.all(s.map(async h=>({file:h,content:await this.vault.read(h)}))),i=this.buildSynthesisPrompt(n,t),o=(await this.aiService.generateCompletion(i)).text.trim(),r=t.mode==="thematic"?await this.extractThemes(o):void 0,c=t.findContradictions?this.identifyContradictions(o):void 0,l=t.identifyGaps?this.identifyGaps(o):void 0,d=t.includeCitations?this.extractCitations(o,s):new Map;return{synthesis:o,mode:t.mode,sources:s.map(h=>h.basename),themes:r,contradictions:c,gaps:l,citations:d}}async generateProgressiveSummary(s){let e=new Map,t=["quick","standard","detailed"];for(let n of t){let i=await this.summarizeNote(s,{level:n});e.set(n,i.summary)}return e}buildSummaryPrompt(s,e,t,n){let a={quick:`Provide a TL;DR summary of "${e}" in 1-2 sentences. Focus on the single most important idea.

Content:
${s}

TL;DR:`,standard:`Summarize "${e}" in a concise paragraph (3-5 sentences). Include the main points and key takeaways.

Content:
${s}

Summary:`,detailed:`Create a detailed summary of "${e}" with the following structure:
1. Overview (2-3 sentences)
2. Key Points (bulleted list of 5-7 main ideas)
3. Important Details (2-3 paragraphs covering significant information)
4. Conclusion (1-2 sentences)

Content:
${s}

Detailed Summary:`,academic:`Provide an academic-style summary of "${e}" with this structure:

**Abstract:** (150-200 words summarizing the entire content)

**Main Arguments/Claims:** (Bulleted list of key arguments or claims made)

**Methods/Approach:** (If applicable, how the topic is explored or analyzed)

**Key Findings/Insights:** (Main discoveries, conclusions, or insights)

**Implications:** (Significance and potential applications)

**References:** (Key concepts, theories, or sources mentioned)

Content:
${s}

Academic Summary:`}[t.level];if(t.includeSections&&n&&n.size>0){a+=`

Summarize each major section:
`;for(let[o,r]of n)a+=`
## ${o}
${r.substring(0,500)}...
`}return t.maxLength&&t.maxLength>0&&(a+=`

Keep the summary under ${t.maxLength} words.`),a}buildSynthesisPrompt(s,e){let t=e.topic||"the provided notes",n=`Synthesize insights across ${s.length} notes about ${t}.

Notes:
${s.map(o=>`
### [[${o.file.basename}]]
${this.extractKeyContent(o.content)}
`).join(`
`)}
`,i={thematic:`Organize the synthesis by themes:
1. Identify 3-5 major themes across the notes
2. For each theme, synthesize what the notes say
3. Note where notes agree, differ, or complement each other
4. Include [[note references]] for all claims`,chronological:`Organize the synthesis chronologically:
1. Identify the timeline or progression of ideas
2. Show how concepts developed or evolved
3. Highlight turning points or key developments
4. Connect earlier and later ideas`,comparative:`Organize the synthesis as a comparison:
1. Identify areas of agreement between notes
2. Highlight differences in perspective or approach
3. Analyze why differences exist
4. Synthesize a balanced view incorporating all perspectives`,argumentative:`Organize the synthesis as an argument:
1. Identify the main claim or thesis supported by these notes
2. Present supporting evidence from across notes
3. Address counterarguments or limitations
4. Build a coherent, well-supported argument`},a=n+`
`+i[e.mode];return e.identifyGaps&&(a+=`

**Knowledge Gaps:** Identify what information is missing or underexplored.`),e.findContradictions&&(a+=`

**Contradictions:** Note any contradictions or tensions between the notes.`),e.includeCitations&&(a+=`

Use [[note name]] format to cite sources for all claims.`),a}extractSections(s){let e=new Map,t=/^(#{1,6})\s+(.+)$/gm,n=[],i;for(;(i=t.exec(s))!==null;)n.push({level:i[1].length,title:i[2],position:i.index});for(let a=0;a<n.length;a++){let o=n[a].position,r=a<n.length-1?n[a+1].position:s.length,c=s.substring(o,r).trim();e.set(n[a].title,c)}return e}async extractKeyPoints(s){let e=[],t=s.match(/^[\s]*[-*]\s+(.+)$/gm);t&&t.length>0&&e.push(...t.map(i=>i.replace(/^[\s]*[-*]\s+/,"").trim()).slice(0,5));let n=s.split(/\n\n+/);for(let i of n.slice(0,5)){let a=i.match(/^[^.!?]+[.!?]/);if(a){let o=a[0].trim();o.length>20&&!e.includes(o)&&e.push(o)}}return e.slice(0,7)}extractQuotes(s){let e=[],t=s.match(/^>\s+(.+)$/gm);t&&e.push(...t.map(i=>i.replace(/^>\s+/,"").trim()));let n=s.match(/"([^"]{20,200})"/g);return n&&e.push(...n.slice(0,3)),e.slice(0,5)}extractKeyContent(s,e=1e3){let t=s.replace(/```[\s\S]*?```/g,"[code]");t=t.substring(0,e);let n=t.lastIndexOf(".");return n>e*.7&&(t=t.substring(0,n+1)),t+"..."}async extractThemes(s){let e=[],t=s.match(/^#{2,3}\s+(.+)$/gm);return t&&e.push(...t.map(n=>n.replace(/^#{2,3}\s+/,"").trim())),e}identifyContradictions(s){let e=[],t=["however","contradicts","conflicts with","disagrees","on the other hand","in contrast","while","whereas"],n=s.split(/[.!?]+/);for(let i of n){let a=i.toLowerCase();t.some(o=>a.includes(o))&&e.push(i.trim())}return e.slice(0,5)}identifyGaps(s){let e=[],t=["missing","unclear","not addressed","unexplored","gap","unknown","needs further","requires more"],n=s.split(/[.!?]+/);for(let i of n){let a=i.toLowerCase();t.some(o=>a.includes(o))&&e.push(i.trim())}return e.slice(0,5)}extractCitations(s,e){let t=new Map,n=/\[\[([^\]]+)\]\]/g,i;for(;(i=n.exec(s))!==null;){let a=i[1].split("|")[0].trim();if(e.find(r=>r.basename===a)){t.has(a)||t.set(a,[]);let r=Math.max(0,i.index-100),c=Math.min(s.length,i.index+100),l=s.substring(r,c).trim();t.get(a).push(l)}}return t}};var Je={exactMatchThreshold:1,nearDuplicateThreshold:.95,semanticThreshold:.7,minContentLength:50,ignoreFrontmatter:!0,compareTitle:!0,compareTags:!0},ee=class{constructor(s){this.tfidfCache=null;this.idfCache=null;this.contentHashes=null;T.required(s,"app"),this.vault=s.vault,this.metadataCache=s.metadataCache}async findDuplicates(s={}){let e={...Je,...s},t=this.vault.getMarkdownFiles(),n=[],i=new Set;await this.buildCaches(t,e);let a=await this.findExactDuplicates(t,e);n.push(...a),a.forEach(c=>c.notes.forEach(l=>i.add(l.path)));let o=await this.findNearDuplicates(t.filter(c=>!i.has(c.path)),e);n.push(...o),o.forEach(c=>c.notes.forEach(l=>i.add(l.path)));let r=await this.findSemanticDuplicates(t.filter(c=>!i.has(c.path)),e);return n.push(...r),n}async compareNotes(s,e){let t=await this.vault.read(s),n=await this.vault.read(e),i=this.calculateSimilarity(t,n),a;i===1?a="exact":i>=.95?a="near-exact":s.basename.toLowerCase()===e.basename.toLowerCase()?a="title":a="semantic";let o=this.extractSections(t),r=this.extractSections(n),c=[],l=new Map;for(let[d,h]of o)r.has(d)?c.push(d):(l.has(s.basename)||l.set(s.basename,[]),l.get(s.basename).push(d));for(let[d,h]of r)o.has(d)||(l.has(e.basename)||l.set(e.basename,[]),l.get(e.basename).push(d));return{file1:s,file2:e,similarity:i,matchType:a,commonSections:c,uniqueSections:l}}async mergeDuplicates(s,e){if(s.notes.length<2)throw new Error("Need at least 2 notes to merge");let t;switch(e.type){case"keep-first":t=s.notes[0];break;case"keep-longest":t=await this.getLongestNote(s.notes);break;case"merge-content":t=await this.mergeContent(s.notes,e);break;default:t=s.notes[0]}e.createBackup&&await this.createBackups(s.notes);let n=new Set,i=new Set;if(e.preserveTags||e.preserveLinks)for(let o of s.notes){let r=this.metadataCache.getFileCache(o);e.preserveTags&&(r!=null&&r.tags)&&r.tags.forEach(c=>n.add(c.tag)),e.preserveLinks&&(r!=null&&r.links)&&r.links.forEach(c=>i.add(c.link))}let a=await this.vault.read(t);e.preserveTags&&n.size>0&&(a=this.addTagsToContent(a,[...n])),e.preserveLinks&&i.size>0&&(a=this.addLinksSection(a,[...i])),await this.vault.modify(t,a);for(let o of s.notes)o.path!==t.path&&await this.vault.delete(o);return t}async buildCaches(s,e){this.tfidfCache=new Map,this.idfCache=new Map,this.contentHashes=new Map;let t=new Map,n=s.length;for(let i of s){let a=await this.vault.read(i),o=this.cleanContent(a,e);if(o.length<e.minContentLength)continue;this.contentHashes.set(i.path,this.hashContent(o));let r=this.extractTerms(o),c=new Map;for(let h of r)c.set(h,(c.get(h)||0)+1);let l=Math.max(...c.values());for(let[h,m]of c)c.set(h,m/l);this.tfidfCache.set(i.path,c);let d=new Set(r);for(let h of d)t.set(h,(t.get(h)||0)+1)}for(let[i,a]of t)this.idfCache.set(i,Math.log(n/a));for(let[i,a]of this.tfidfCache){let o=new Map;for(let[r,c]of a){let l=this.idfCache.get(r)||0;o.set(r,c*l)}this.tfidfCache.set(i,o)}}async findExactDuplicates(s,e){let t=[],n=new Map;if(!this.contentHashes)return t;for(let i of s){let a=this.contentHashes.get(i.path);a&&(n.has(a)||n.set(a,[]),n.get(a).push(i))}for(let[i,a]of n)if(a.length>1){let o=await this.vault.read(a[0]);t.push({id:`exact-${i}`,notes:a,similarity:1,duplicateType:"exact",commonContent:o.substring(0,200)+"..."})}return t}async findNearDuplicates(s,e){let t=[],n=new Set;for(let i=0;i<s.length;i++){if(n.has(s[i].path))continue;let a=[s[i]];n.add(s[i].path);for(let o=i+1;o<s.length;o++){if(n.has(s[o].path))continue;await this.calculateNoteSimilarity(s[i],s[o])>=e.nearDuplicateThreshold&&(a.push(s[o]),n.add(s[o].path))}a.length>1&&t.push({id:`near-${s[i].path}`,notes:a,similarity:e.nearDuplicateThreshold,duplicateType:"near-exact"})}return t}async findSemanticDuplicates(s,e){let t=[],n=new Set;for(let i=0;i<s.length;i++){if(n.has(s[i].path))continue;let a=[s[i]];n.add(s[i].path);for(let o=i+1;o<s.length;o++){if(n.has(s[o].path))continue;let r=await this.calculateNoteSimilarity(s[i],s[o]);r>=e.semanticThreshold&&r<e.nearDuplicateThreshold&&(a.push(s[o]),n.add(s[o].path))}a.length>1&&t.push({id:`semantic-${s[i].path}`,notes:a,similarity:e.semanticThreshold,duplicateType:"semantic"})}return t}async calculateNoteSimilarity(s,e){if(!this.tfidfCache)return 0;let t=this.tfidfCache.get(s.path),n=this.tfidfCache.get(e.path);return!t||!n?0:this.cosineSimilarity(t,n)}cosineSimilarity(s,e){let t=0,n=0,i=0;for(let[a,o]of s){let r=e.get(a)||0;t+=o*r,n+=o*o}for(let a of e.values())i+=a*a;return n===0||i===0?0:t/(Math.sqrt(n)*Math.sqrt(i))}calculateSimilarity(s,e){let t=new Set(this.extractTerms(s)),n=new Set(this.extractTerms(e)),i=[...t].filter(o=>n.has(o)).length,a=new Set([...t,...n]).size;return a===0?0:i/a}cleanContent(s,e){let t=s;return e.ignoreFrontmatter&&(t=t.replace(/^---\n[\s\S]*?\n---\n/,"")),t=t.replace(/```[\s\S]*?```/g,""),t=t.replace(/`[^`]+`/g,""),t=t.replace(/\[\[([^\]]+)\]\]/g,"$1"),t=t.replace(/\[([^\]]+)\]\([^\)]+\)/g,"$1"),t=t.replace(/[#*_~]/g,""),t=t.replace(/\s+/g," ").trim(),t.toLowerCase()}extractTerms(s){return s.toLowerCase().split(/\s+/).filter(t=>t.length>2).filter(t=>!/^\d+$/.test(t)).filter(t=>!this.isStopWord(t))}isStopWord(s){return new Set(["the","and","for","are","but","not","you","all","can","her","was","one","our","out","day","get","has","him","his","how","its","may","new","now","old","see","two","who","boy","did","she","use","way","will","with","this","that","have","from","they","been","what","when","make","like","time"]).has(s)}hashContent(s){let e=0;for(let t=0;t<s.length;t++){let n=s.charCodeAt(t);e=(e<<5)-e+n,e=e&e}return e.toString(36)}extractSections(s){let e=new Map,t=/^#{1,6}\s+(.+)$/gm,n=[],i;for(;(i=t.exec(s))!==null;)n.push({title:i[1],position:i.index});for(let a=0;a<n.length;a++){let o=n[a].position,r=a<n.length-1?n[a+1].position:s.length;e.set(n[a].title,s.substring(o,r))}return e}async getLongestNote(s){let e=s[0],t=0;for(let n of s){let i=await this.vault.read(n);i.length>t&&(t=i.length,e=n)}return e}async mergeContent(s,e){return this.getLongestNote(s)}async createBackups(s){let e="Backups/Duplicates";for(let t of s){let n=await this.vault.read(t),i=`${e}/${t.basename} - ${Date.now()}.md`;await this.vault.create(i,n)}}addTagsToContent(s,e){let t=/^---\n([\s\S]*?)\n---/,n=s.match(t);if(n){let i=n[1],a=`tags: [${e.join(", ")}]`;if(i.includes("tags:"))return s;{let o=`${i}
${a}`;return s.replace(t,`---
${o}
---`)}}else return`${e.map(a=>a.startsWith("#")?a:`#${a}`).join(" ")}

${s}`}addLinksSection(s,e){let t=`

## Related Links
${e.map(n=>`- [[${n}]]`).join(`
`)}`;return s+t}clearCache(){this.tfidfCache=null,this.idfCache=null,this.contentHashes=null}};var Se=require("obsidian"),te=class{constructor(s,e,t,n){this.linkGraphCache=null;this.RECENCY_DECAY_DAYS=30;this.MAX_LINK_DISTANCE=3;this.vault=s,this.metadataCache=e,this.vectorStore=t,this.embeddingService=n}async buildSemanticClusters(){return new Map}async scoreNoteRelevance(s,e,t){let n=this.computeRecencyScore(s),i=0;t&&(i=this.computeLinkScore(t,s));let a=0,o=n*.3+i*.2,r=[];return n>70&&r.push("Recently modified"),i>50&&r.push("Connected via links"),{file:s,score:o,reasons:r,recencyScore:n,linkScore:i,semanticScore:a}}async getAdaptiveContext(s,e,t=4e3){if(!this.embeddingService)throw new Error("Embedding service required for adaptive context");let n=await this.embeddingService.generateEmbedding(e),i=await this.vectorStore.search(n.vector,20,.4),a=[],o=new Set,r=await this.vault.read(s),c=`# Current Note: ${s.basename}

${r}

`,l=this.estimateTokens(c);c+=`# Related Context (Semantic Search)

`;for(let d of i){if(d.id===s.path)continue;let h=this.vault.getAbstractFileByPath(d.id);if(!(h instanceof Se.TFile))continue;let f=(await this.vault.read(h)).substring(0,500).replace(/\n/g," "),y=`## ${h.basename} (Relevance: ${(d.score*100).toFixed(0)}%)
${f}...

`,x=this.estimateTokens(y);if(l+x>t)break;c+=y,l+=x,a.push(h)}return{primaryNote:s,relatedNotes:a,contextText:c,tokenEstimate:l,includedClusters:Array.from(o)}}async detectProjectBoundaries(){var i,a;let s=new Map,e=this.vault.getMarkdownFiles(),t=new Map,n=new Map;for(let o of e){let r=this.metadataCache.getFileCache(o),c=[];if((i=r==null?void 0:r.frontmatter)!=null&&i.tags){let d=Array.isArray(r.frontmatter.tags)?r.frontmatter.tags:[r.frontmatter.tags];c.push(...d.map(String))}r!=null&&r.tags&&c.push(...r.tags.map(d=>d.tag));for(let d of c){let h=String(d).replace(/^#/,"");(h.startsWith("project-")||h.includes("project"))&&(t.has(h)||t.set(h,[]),t.get(h).push(o))}let l=((a=o.parent)==null?void 0:a.path)||"root";n.has(l)||n.set(l,[]),n.get(l).push(o)}for(let[o,r]of t){if(r.length<2)continue;let c=this.computeProjectStats(r);s.set(`tag-${o}`,{name:o,notes:r,startDate:c.startDate,lastModified:c.lastModified,isActive:this.isProjectActive(c.lastModified),tags:[o]})}for(let[o,r]of n){if(r.length<3||s.has(`folder-${o}`))continue;let c=this.computeProjectStats(r);s.set(`folder-${o}`,{name:o,notes:r,startDate:c.startDate,lastModified:c.lastModified,isActive:this.isProjectActive(c.lastModified),tags:[]})}return s}async findClusterMates(s){if(!this.vectorStore)return[];let e=this.vectorStore.get(s.path);if(!e)return[];let t=await this.vectorStore.search(e.vector,5,.5),n=[];for(let i of t){if(i.id===s.path)continue;let a=this.vault.getAbstractFileByPath(i.id);a instanceof Se.TFile&&n.push(a)}return n}async getClusterTheme(s){return"Semantic Cluster"}computeRecencyScore(s){let t=(Date.now()-s.stat.mtime)/(1e3*60*60*24);return Math.max(0,100*Math.exp(-t/this.RECENCY_DECAY_DAYS))}computeLinkScore(s,e){let t=this.computeLinkDistance(s,e);return t===0?0:t===1?100:t===2?60:t===3?30:10}computeLinkDistance(s,e){var i;this.linkGraphCache||this.buildLinkGraph();let t=[[s.path,0]],n=new Set([s.path]);for(;t.length>0;){let[a,o]=t.shift();if(a===e.path)return o;if(o>=this.MAX_LINK_DISTANCE)continue;let r=((i=this.linkGraphCache)==null?void 0:i.get(a))||new Set;for(let c of r)n.has(c)||(n.add(c),t.push([c,o+1]))}return 0}buildLinkGraph(){this.linkGraphCache=new Map;let s=this.vault.getMarkdownFiles();for(let e of s){let t=this.metadataCache.getFileCache(e),n=new Set;if(t!=null&&t.links)for(let i of t.links){let a=this.metadataCache.getFirstLinkpathDest(i.link,e.path);a&&n.add(a.path)}this.linkGraphCache.set(e.path,n)}}computeProjectStats(s){let e=1/0,t=0;for(let n of s)n.stat.ctime<e&&(e=n.stat.ctime),n.stat.mtime>t&&(t=n.stat.mtime);return{startDate:e,lastModified:t}}isProjectActive(s){return(Date.now()-s)/(1e3*60*60*24)<7}estimateTokens(s){return Math.ceil(s.length/4)}clearCaches(){this.linkGraphCache=null}};var se=class{constructor(s,e,t,n){this.vault=s,this.metadataCache=e,this.contextEngine=t,this.aiService=n}async synthesizeNotes(s,e){let t=new Map,n=[];for(let l of s){let d=await this.vault.read(l);n.push(`# ${l.basename}
${d}`);let h=this.extractKeyPassages(d);h.length>0&&t.set(l.basename,h)}let i=n.join(`

---

`),a=this.buildSynthesisPrompt(i,e),r=(await this.aiService.generateCompletion(a)).text;return{...this.parseSynthesisResponse(r),citations:t,notesAnalyzed:s.length}}async researchQuery(s){let e=await this.findMatchingNotes(s);return e.length===0?{summary:"No notes found matching your query.",keyInsights:[],contradictions:[],knowledgeGaps:["No existing notes on this topic"],citations:new Map,notesAnalyzed:0}:await this.synthesizeNotes(e,s.query)}async extractArgumentMap(s){let e=[],t=[],n=[];for(let a of s){let o=await this.vault.read(a),r=await this.extractClaims(o,a.basename);e.push(...r);let c=await this.extractEvidence(o,a.basename);t.push(...c)}for(let a of t)for(let o of e)this.evidenceSupports(a,o)&&(n.push({from:a.id,to:o.id,type:"supports"}),a.supportsClaims.push(o.id));for(let a=0;a<e.length;a++)for(let o=a+1;o<e.length;o++)this.claimsContradict(e[a],e[o])&&n.push({from:e[a].id,to:e[o].id,type:"contradicts"});let i=[];for(let a of e)n.filter(r=>r.to===a.id&&r.type==="supports").length===0&&i.push(`Claim "${a.text.substring(0,50)}..." lacks supporting evidence`);return{claims:e,evidence:t,relationships:n,logicalGaps:i}}async findContradictions(s){let e=await this.extractArgumentMap(s),t=[];for(let n of e.relationships)if(n.type==="contradicts"){let i=e.claims.find(o=>o.id===n.from),a=e.claims.find(o=>o.id===n.to);i&&a&&t.push(`"${i.text}" (${i.sourceNote}) contradicts "${a.text}" (${a.sourceNote})`)}return t}async identifyKnowledgeGaps(s,e){let t=[],n=await this.synthesizeNotes(e,s),i=`Based on the following research summary about "${s}", identify key knowledge gaps and unanswered questions:

${n.summary}

Key insights found:
${n.keyInsights.map((c,l)=>`${l+1}. ${c}`).join(`
`)}

Provide a list of 5-10 important questions or gaps that remain unanswered in this research. Focus on:
- Missing perspectives or viewpoints
- Unexplored connections
- Methodological limitations
- Areas needing more evidence
- Conflicting information that needs resolution

Format: One gap per line, as a question or statement.`,r=(await this.aiService.generateCompletion(i)).text.split(`
`).filter(c=>c.trim().length>0);for(let c of r){let l=c.replace(/^[\d.\-*\s]+/,"").trim();l.length>10&&t.push(l)}return t}async suggestResearchDirections(s,e){let t=[],n=await this.synthesizeNotes(e,s),i=await this.identifyKnowledgeGaps(s,e),a=`Based on this research about "${s}":

Summary: ${n.summary}

Knowledge Gaps:
${i.map((l,d)=>`${d+1}. ${l}`).join(`
`)}

Suggest 3-5 promising research directions to pursue next. For each direction:
1. Describe the research direction
2. Explain why it's valuable
3. Suggest specific sources or methods to explore

Format each suggestion as:
DIRECTION: [brief title]
REASONING: [why this matters]
SOURCES: [specific suggestions]
PRIORITY: [high/medium/low]
---`,c=(await this.aiService.generateCompletion(a)).text.split("---").filter(l=>l.trim());for(let l of c){let d=this.extractField(l,"DIRECTION"),h=this.extractField(l,"REASONING"),m=this.extractField(l,"SOURCES"),f=this.extractField(l,"PRIORITY");d&&h&&t.push({direction:d,reasoning:h,suggestedSources:m?[m]:[],priority:f||"medium"})}return t}async answerResearchQuestion(s,e=20){let t=this.vault.getMarkdownFiles(),n=[];for(let d of t){let h=await this.contextEngine.scoreNoteRelevance(d,s);h.score>30&&n.push(h)}n.sort((d,h)=>h.score-d.score);let i=n.slice(0,e).map(d=>d.file),a=[];for(let d of i){let h=await this.vault.read(d),m=this.extractRelevantExcerpt(h,s,500);a.push(`[${d.basename}]
${m}`)}let o=a.join(`

---

`),r=`Answer the following research question based on the provided notes from my knowledge base:

QUESTION: ${s}

KNOWLEDGE BASE EXCERPTS:
${o}

Provide a comprehensive answer that:
1. Synthesizes information from multiple sources
2. Cites specific notes in the format [[Note Name]]
3. Acknowledges any contradictions or uncertainties
4. Identifies gaps in available information
5. Provides a clear, well-reasoned conclusion

ANSWER:`;return(await this.aiService.generateCompletion(r)).text}async findMatchingNotes(s){let e=this.vault.getMarkdownFiles();s.tags&&s.tags.length>0&&(e=e.filter(i=>{let a=this.metadataCache.getFileCache(i),o=this.extractTags(a);return s.tags.some(r=>o.includes(r))})),s.folders&&s.folders.length>0&&(e=e.filter(i=>{var o;let a=((o=i.parent)==null?void 0:o.path)||"";return s.folders.some(r=>a.startsWith(r))})),s.dateRange&&(e=e.filter(i=>{let a=i.stat.mtime;return a>=s.dateRange.start&&a<=s.dateRange.end}));let t=[];for(let i of e){let a=await this.contextEngine.scoreNoteRelevance(i,s.query);a.score>30&&t.push(a)}t.sort((i,a)=>a.score-i.score);let n=s.maxNotes||10;return t.slice(0,n).map(i=>i.file)}extractTags(s){var t;let e=[];if((t=s==null?void 0:s.frontmatter)!=null&&t.tags){let n=Array.isArray(s.frontmatter.tags)?s.frontmatter.tags:[s.frontmatter.tags];e.push(...n.map(String))}return s!=null&&s.tags&&e.push(...s.tags.map(n=>n.tag)),e}extractKeyPassages(s,e=5){let t=[],n=s.split(`
`),i=["**","==","- [ ]","> ","# "];for(let a of n){if(t.length>=e)break;let o=a.trim();o.length<20||i.some(r=>o.includes(r))&&t.push(o)}return t}buildSynthesisPrompt(s,e){return`Synthesize the following notes ${e?`with particular focus on: "${e}"`:"across all topics covered"}.

${s}

Provide:
1. SUMMARY: A comprehensive synthesis (2-3 paragraphs)
2. KEY INSIGHTS: 5-7 most important insights (bullet points)
3. CONTRADICTIONS: Any conflicting information found (if any)
4. KNOWLEDGE GAPS: What important questions remain unanswered

Format your response with clear section headers.`}parseSynthesisResponse(s){let e=this.extractSection(s,"SUMMARY")||s,t=this.extractBulletPoints(s,"KEY INSIGHTS"),n=this.extractBulletPoints(s,"CONTRADICTIONS"),i=this.extractBulletPoints(s,"KNOWLEDGE GAPS");return{summary:e,keyInsights:t,contradictions:n,knowledgeGaps:i}}extractSection(s,e){let t=new RegExp(`${e}:?\\s*([\\s\\S]*?)(?=\\n\\n[A-Z]|$)`,"i"),n=s.match(t);return n?n[1].trim():null}extractBulletPoints(s,e){let t=this.extractSection(s,e);return t?t.split(`
`).map(i=>i.replace(/^[\d.\-*\s]+/,"").trim()).filter(i=>i.length>0):[]}async extractClaims(s,e){let t=[],n=s.split(/[.!?]+/).filter(a=>a.trim().length>20),i=["is","are","must","will","should","proves","demonstrates"];for(let a=0;a<n.length;a++){let o=n[a].trim();i.some(r=>o.toLowerCase().includes(` ${r} `))&&t.push({id:`claim-${e}-${a}`,text:o,sourceNote:e,confidence:"medium",type:"supporting"})}return t.slice(0,10)}async extractEvidence(s,e){let t=[],n=["according to","research shows","data indicates","study found"],i=s.split(/[.!?]+/).filter(a=>a.trim().length>20);for(let a=0;a<i.length;a++){let o=i[a].trim().toLowerCase();n.some(r=>o.includes(r))&&t.push({id:`evidence-${e}-${a}`,text:i[a].trim(),sourceNote:e,supportsClaims:[],type:"empirical"})}return t}evidenceSupports(s,e){let t=new Set(this.extractKeywords(s.text)),n=new Set(this.extractKeywords(e.text)),i=0;for(let a of n)t.has(a)&&i++;return i>=2}claimsContradict(s,e){let t=s.text.toLowerCase(),n=e.text.toLowerCase(),i=[["is","is not"],["must","must not"],["should","should not"],["increases","decreases"],["positive","negative"]];for(let[a,o]of i)if(t.includes(a)&&n.includes(o)||t.includes(o)&&n.includes(a)){let r=new Set(this.extractKeywords(t)),c=new Set(this.extractKeywords(n)),l=0;for(let d of r)c.has(d)&&l++;if(l>=2)return!0}return!1}extractKeywords(s){let e=s.toLowerCase().replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(n=>n.length>3),t=new Set(["this","that","with","from","have","been","will","would"]);return e.filter(n=>!t.has(n))}extractRelevantExcerpt(s,e,t){let n=new Set(this.extractKeywords(e)),i=s.split(`

`),a=i[0]||"",o=0;for(let r of i){if(r.trim().length<50)continue;let c=new Set(this.extractKeywords(r)),l=0;for(let d of n)c.has(d)&&l++;l>o&&(o=l,a=r)}return a.length<=t?a:a.substring(0,t)+"..."}extractField(s,e){let t=new RegExp(`${e}:?\\s*(.+?)(?=\\n[A-Z]+:|$)`,"i"),n=s.match(t);return n?n[1].trim():""}};var ke=require("obsidian"),ne=class{constructor(s){this.settings=s}async generateEmbedding(s){var t;if(!s||s.trim().length===0)throw new Error("Text is empty");let e=((t=this.settings.embeddingConfig)==null?void 0:t.provider)||"openai";if(e==="local")throw new Error("Local (Transformers.js) embeddings not yet implemented");return e==="ollama"?this.generateOllamaEmbedding(s):this.generateOpenAIEmbedding(s)}async generateOllamaEmbedding(s){var a;let e=this.settings.customApiUrl||"http://localhost:11434",t=((a=this.settings.embeddingConfig)==null?void 0:a.model)||"llama2",n=await(0,ke.requestUrl)({url:`${e}/api/embeddings`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:t,prompt:s})});if(n.status!==200)throw new Error(`Ollama Embedding failed: ${n.status} - ${n.text}`);return{vector:n.json.embedding,tokensUsed:0}}async generateOpenAIEmbedding(s){var n;if(!this.settings.apiKey)throw new Error("OpenAI API key is required for embeddings");let e=await(0,ke.requestUrl)({url:"https://api.openai.com/v1/embeddings",method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`},body:JSON.stringify({input:s,model:((n=this.settings.embeddingConfig)==null?void 0:n.model)||"text-embedding-3-small"})});if(e.status!==200)throw new Error(`Embedding request failed: ${e.status} - ${e.text}`);let t=e.json;return{vector:t.data[0].embedding,tokensUsed:t.usage.total_tokens}}};var N=class{constructor(s,e=".obsidian/plugins/obsidian-agent/vector_store.json"){this.vectors=new Map;this.metadata=new Map;this.vault=s,this.STORAGE_FILE=e}async add(s){this.vectors.set(s.id,s.vector),this.metadata.set(s.id,s.metadata)}async remove(s){this.vectors.delete(s),this.metadata.delete(s)}get(s){let e=this.vectors.get(s),t=this.metadata.get(s);return!e||!t?null:{id:s,vector:e,metadata:t,content:t.content||""}}async search(s,e=10,t=0){let n=[];for(let[i,a]of this.vectors){let o=this.cosineSimilarity(s,a);o>=t&&n.push({id:i,score:o,metadata:this.metadata.get(i)||{}})}return n.sort((i,a)=>a.score-i.score).slice(0,e)}async save(){let s={version:1,vectors:Object.fromEntries(this.vectors),metadata:Object.fromEntries(this.metadata)};await this.vault.adapter.write(this.STORAGE_FILE,JSON.stringify(s))}async load(){if(await this.vault.adapter.exists(this.STORAGE_FILE))try{let s=await this.vault.adapter.read(this.STORAGE_FILE),e=JSON.parse(s);this.vectors=new Map(Object.entries(e.vectors)),this.metadata=new Map(Object.entries(e.metadata)),console.log(`VectorStore loaded: ${this.vectors.size} documents.`)}catch(s){console.error("Failed to load VectorStore:",s)}}async clear(){this.vectors.clear(),this.metadata.clear(),await this.save()}cosineSimilarity(s,e){let t=0,n=0,i=0;for(let a=0;a<s.length;a++)t+=s[a]*e[a],n+=s[a]*s[a],i+=e[a]*e[a];return n===0||i===0?0:t/(Math.sqrt(n)*Math.sqrt(i))}};var ie=require("obsidian"),ae=class{constructor(s,e,t){this.app=s,this.embeddingService=e,this.vectorStore=t}async indexVault(s=!1){let e=this.app.vault.getMarkdownFiles(),t=e.length,n=0,i=0,a=0,o=0;new ie.Notice(`Starting vault index... (${t} files)`);for(let r of e){n++,n%10===0&&new ie.Notice(`Indexing: ${n}/${t} files...`,2e3);try{let c=this.vectorStore.get(r.path);if(!s&&c&&c.metadata.mtime===r.stat.mtime){o++;continue}let l=await this.app.vault.read(r);if(!l.trim()){o++;continue}let d=l.substring(0,3e4),h=await this.embeddingService.generateEmbedding(d);await this.vectorStore.add({id:r.path,vector:h.vector,content:d,metadata:{mtime:r.stat.mtime,basename:r.basename,path:r.path}}),i++}catch(c){console.error(`Failed to index ${r.path}`,c),a++}}await this.vectorStore.save(),new ie.Notice(`Indexing complete!
Indexed: ${i}
Skipped: ${o}
Failed: ${a}`)}};var oe=class{constructor(s,e){this.maxSteps=10;this.aiService=s,this.tools=e}async run(s){let e=`You are an intelligent agent with access to the following tools:

`;this.tools.forEach(n=>{e+=`${n.name}: ${n.description}
`}),e+=`
Use the following format:

Question: the input question you must answer
Thought: you should always think about what to do
Action: the action to take, should be one of [${this.tools.map(n=>n.name).join(", ")}]
Action Input: the input to the action
Observation: the result of the action
... (this Thought/Action/Action Input/Observation can repeat N times)
Thought: I now know the final answer
Final Answer: the final answer to the original input question

Begin!

Question: ${s}
`;let t=0;for(;t<this.maxSteps;){t++;let i=(await this.aiService.generateCompletion({prompt:e})).text;if(e+=i+`
`,i.includes("Final Answer:"))return i.split("Final Answer:")[1].trim();let a=i.match(/Action: (.*)/),o=i.match(/Action Input: (.*)/);if(a&&o){let r=a[1].trim(),c=o[1].trim(),l=this.tools.find(d=>d.name===r);if(l){let d=await l.execute(c);e+=`Observation: ${d}
`}else e+=`Observation: Error: Tool "${r}" not found.
`}else if(!i.includes("Action:"))return i}return"Error: Agent reached maximum steps without a final answer."}};var Be=require("obsidian"),re=class{constructor(s,e){this.vectorStore=s;this.embeddingService=e;this.name="search_vault";this.description="Search the vault for notes relevant to a query. Returns a list of note paths and relevance scores. Input: A search query string."}async execute(s){try{let e=await this.embeddingService.generateEmbedding(s),t=await this.vectorStore.search(e.vector,10,.4);return t.length===0?"No relevant notes found.":t.map(n=>`- ${n.id} (Score: ${(n.score*100).toFixed(0)}%)`).join(`
`)}catch(e){return`Error searching vault: ${e.message}`}}},ce=class{constructor(s){this.app=s;this.name="read_note";this.description='Read the content of a specific note. Input: The exact file path of the note (e.g., "Folder/My Note.md").'}async execute(s){let e=this.app.vault.getAbstractFileByPath(s.trim());if(!e||!(e instanceof Be.TFile))return`Error: Note not found at path "${s}".`;try{let t=await this.app.vault.read(e);return`Content of "${e.path}":

${t}`}catch(t){return`Error reading note: ${t.message}`}}},le=class{constructor(s){this.app=s;this.name="list_files";this.description='List all files in a specific folder. Input: The folder path (e.g., "Projects"). Leave empty for root.'}async execute(s){let e=s.trim()||"/",t=this.app.vault.getAbstractFileByPath(e);return e==="/"||e===""?this.app.vault.getRoot().children.map(i=>i.path).join(`
`):t&&"children"in t?t.children.map(i=>i.path).join(`
`):`Error: Folder not found at "${e}".`}},de=class{constructor(s){this.memoryService=s;this.name="remember_fact";this.description="Save a fact about the user or their preferences to long-term memory. Input: A clear, concise statement of the fact to remember."}async execute(s){try{return await this.memoryService.addMemory(s),`Fact remembered: "${s}"`}catch(e){return`Error remembering fact: ${e.message}`}}};var he=class{constructor(s,e){this.vectorStore=new N(s,".obsidian/plugins/obsidian-agent/memory_store.json"),this.embeddingService=e}async load(){await this.vectorStore.load()}async addMemory(s,e={}){if(!s||s.trim().length===0)return;let t=await this.embeddingService.generateEmbedding(s),n=`memory_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;await this.vectorStore.add({id:n,vector:t.vector,content:s,metadata:{...e,text:s,timestamp:Date.now()}}),await this.vectorStore.save()}async getRelevantMemories(s,e=5){let t=await this.embeddingService.generateEmbedding(s);return(await this.vectorStore.search(t.vector,e,.6)).map(i=>i.metadata.text)}async clear(){await this.vectorStore.clear()}};var ge=class{constructor(s,e){this.settings=s;this.vault=e}async transcribe(s){if(!this.settings.apiKey)throw new Error("OpenAI API key is required for transcription");let e=await this.vault.readBinary(s),t=new FormData,n=new Blob([e],{type:s.extension==="mp3"?"audio/mpeg":"audio/wav"});t.append("file",n,`audio.${s.extension}`),t.append("model","whisper-1");let i=await fetch("https://api.openai.com/v1/audio/transcriptions",{method:"POST",headers:{Authorization:`Bearer ${this.settings.apiKey}`},body:t});if(!i.ok){let o=await i.text();throw new Error(`Transcription failed: ${i.status} - ${o}`)}return(await i.json()).text}};var Xe=`
/* Enhanced UI RGB Variables */
:root {
  --background-primary-rgb: 255, 255, 255;
  --background-secondary-rgb: 245, 245, 245;
  --text-muted-rgb: 128, 128, 128;
  --interactive-accent-rgb: 0, 122, 255;
}

.theme-dark {
  --background-primary-rgb: 30, 30, 30;
  --background-secondary-rgb: 45, 45, 45;
  --text-muted-rgb: 150, 150, 150;
  --interactive-accent-rgb: 100, 170, 255;
}
`,Te=class extends g.Modal{constructor(s,e,t,n){super(s),this.profiles=e,this.activeProfileId=t,this.onSelect=n}onOpen(){let{contentEl:s}=this;s.createEl("h2",{text:"Switch AI Profile"});let e=s.createDiv({cls:"profile-list"});e.style.display="flex",e.style.flexDirection="column",e.style.gap="0.5rem",this.profiles.forEach(t=>{let n=t.id===this.activeProfileId,i=e.createDiv({cls:"profile-item"});i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="space-between",i.style.padding="0.75rem",i.style.borderRadius="var(--radius-s)",i.style.border="1px solid var(--background-modifier-border)",i.style.cursor="pointer",i.style.backgroundColor=n?"var(--interactive-accent)":"var(--background-secondary)",i.style.color=n?"var(--text-on-accent)":"var(--text-normal)";let a=i.createDiv();a.createEl("strong",{text:t.name});let o=a.createDiv();o.style.fontSize="var(--font-smaller)",o.style.opacity="0.8",o.textContent=`${t.apiProvider} - ${t.model}`,n&&i.createEl("span",{text:"(Active)"}),i.addEventListener("click",()=>{n||this.onSelect(t.id),this.close()})})}onClose(){let{contentEl:s}=this;s.empty()}},pe=class extends g.Plugin{async onload(){try{if(await this.loadSettings(),await this.migrateToProfiles(),this.registerStyles(),!this.settings)throw new M("Failed to load plugin settings");this.aiService=new $(this.settings),this.contextProvider=new J(this.app),this.embeddingService=new ne(this.settings),this.vectorStore=new N(this.app.vault),await this.vectorStore.load(),this.indexingService=new ae(this.app,this.embeddingService,this.vectorStore),this.memoryService=new he(this.app.vault,this.embeddingService),await this.memoryService.load(),this.audioService=new ge(this.settings,this.app.vault),this.agentService=new oe(this.aiService,[new re(this.vectorStore,this.embeddingService),new ce(this.app),new le(this.app),new de(this.memoryService)]),this.contextEngine=new te(this.app.vault,this.app.metadataCache,this.vectorStore,this.embeddingService),this.multiNoteSynthesizer=new se(this.app.vault,this.app.metadataCache,this.contextEngine,this.aiService),this.settings.totalRequests||(this.settings.totalRequests=0),this.settings.totalTokensUsed||(this.settings.totalTokensUsed=0),this.settings.estimatedCost||(this.settings.estimatedCost=0),this.addRibbonIcon("bot","Ask AI Agent",async()=>{let s=this.app.workspace.getActiveViewOfType(g.MarkdownView);if(!s||!s.file){new g.Notice("Please open a note first");return}try{let e=s.editor.getValue(),t=await this.gatherFullContext(s.file,e);new I(this.app,this.aiService,this.settings,()=>this.saveSettings(),t,n=>{n&&typeof n=="string"&&s.editor.replaceSelection(n)}).open()}catch(e){this.handleError(e,"Failed to open AI Agent")}}),this.addCommand({id:"ask-ai-agent",name:"Ask AI Agent",editorCallback:async(s,e)=>{try{let t=e;if(!t||!t.file){new g.Notice("No active file found");return}let n=s.getValue(),i=await this.gatherFullContext(t.file,n);new I(this.app,this.aiService,this.settings,()=>this.saveSettings(),i,a=>{a&&typeof a=="string"&&s.replaceSelection(a)}).open()}catch(t){this.handleError(t,"Failed to open AI Agent")}}}),this.addCommand({id:"ask-ai-agent-vault-context",name:"Ask AI Agent (with Linked Notes)",editorCallback:async(s,e)=>{try{let t=e;if(!t||!t.file){new g.Notice("No active file found");return}let n=s.getValue(),i=await this.gatherFullContext(t.file,n,!0);new I(this.app,this.aiService,this.settings,()=>this.saveSettings(),i,a=>{a&&typeof a=="string"&&s.replaceSelection(a)}).open()}catch(t){this.handleError(t,"Failed to open AI Agent with vault context")}}}),this.addCommand({id:"generate-summary",name:"Generate Summary",editorCallback:async s=>{let t=s.getSelection()||s.getValue();if(!t.trim()){new g.Notice("No text to summarize");return}new g.Notice("Generating summary...");try{let n=await this.aiService.generateCompletion({prompt:`Please provide a concise summary of the following text:

${t}`});await this.trackTokenUsage(n),s.replaceSelection(`

## Summary
${n.text}
`),new g.Notice("Summary generated!")}catch(n){new g.Notice(`Error: ${n.message}`),console.error("Summary Error:",n)}}}),this.addCommand({id:"multi-level-summary",name:"Multi-Level Summary (Quick/Standard/Detailed)",callback:async()=>{try{let s=this.app.workspace.getActiveFile();if(!s){new g.Notice("No active file");return}new g.Notice("Generating multi-level summaries...");let t=await new U(this.app,this.aiService).generateProgressiveSummary(s),n=`# Summaries: ${s.basename}

## \u{1F680} Quick Summary (TL;DR)
${t.get("quick")||"N/A"}

## \u{1F4CB} Standard Summary  
${t.get("standard")||"N/A"}

## \u{1F4DA} Detailed Summary
${t.get("detailed")||"N/A"}

---
*Generated on ${new Date().toLocaleString()}*
*Source: [[${s.basename}]]*
`,i=await this.app.vault.create(`Summaries - ${s.basename} - ${new Date().toISOString().split("T")[0]}.md`,n);await this.app.workspace.getLeaf().openFile(i),new g.Notice("Multi-level summaries generated!")}catch(s){this.handleError(s,"Failed to generate multi-level summary")}}}),this.addCommand({id:"academic-summary",name:"Generate Academic Summary",callback:async()=>{try{let s=this.app.workspace.getActiveFile();if(!s){new g.Notice("No active file");return}new g.Notice("Generating academic summary...");let t=await new U(this.app,this.aiService).summarizeNote(s,{level:"academic",includeSections:!0,includeKeyPoints:!0}),n=await this.app.vault.read(s),i=`# Academic Summary

${t.summary}

---

${n}`;await this.app.vault.modify(s,i),new g.Notice("Academic summary added to note!")}catch(s){this.handleError(s,"Failed to generate academic summary")}}}),this.addCommand({id:"expand-ideas",name:"Expand Ideas",editorCallback:async s=>{let e=s.getSelection();if(!e.trim()){new g.Notice("Please select text to expand");return}new g.Notice("Expanding ideas...");try{let t=await this.aiService.generateCompletion({prompt:`Please expand on following ideas with more detail and context:

${e}`});await this.trackTokenUsage(t),s.replaceSelection(t.text),new g.Notice("Ideas expanded!")}catch(t){new g.Notice(`Error: ${t.message}`),console.error("Expand Error:",t)}}}),this.addCommand({id:"improve-writing",name:"Improve Writing",editorCallback:async s=>{let e=s.getSelection();if(!e.trim()){new g.Notice("Please select text to improve");return}new g.Notice("Improving writing...");try{let t=await this.aiService.generateCompletion({prompt:`Please improve following text for clarity, grammar, and style:

${e}`});await this.trackTokenUsage(t),s.replaceSelection(t.text),new g.Notice("Writing improved!")}catch(t){new g.Notice(`Error: ${t.message}`),console.error("Improve Writing Error:",t)}}}),this.addCommand({id:"generate-outline",name:"Generate Outline",editorCallback:async s=>{let e=s.getSelection();if(!e.trim()){new g.Notice("Please select a topic for the outline");return}new g.Notice("Generating outline...");try{let t=await this.aiService.generateCompletion({prompt:`Please create a detailed outline for the following topic:

${e}`});await this.trackTokenUsage(t),s.replaceSelection(`

${t.text}
`),new g.Notice("Outline generated!")}catch(t){new g.Notice(`Error: ${t.message}`),console.error("Outline Error:",t)}}}),this.addCommand({id:"answer-question",name:"Answer Question Based on Note",editorCallback:s=>{let e=s.getValue();new I(this.app,this.aiService,this.settings,()=>this.saveSettings(),e,t=>{let n=s.getCursor();s.replaceRange(`

**Q:** ${t}
`,n)}).open()}}),this.addCommand({id:"switch-ai-profile",name:"Switch AI Profile",callback:()=>{let s=this.settings.profiles;if(s.length<=1){new g.Notice("No other profiles available. Create profiles in settings.");return}new Te(this.app,s,this.settings.activeProfileId,async t=>{await this.switchProfile(t)}).open()}}),this.addCommand({id:"scan-dead-links",name:"Scan Vault for Dead Links",callback:async()=>{try{new g.Notice("Scanning vault for dead links...");let s=new B(this.app),e=await s.scanVault((i,a)=>{i%10===0&&new g.Notice(`Scanning... ${i}/${a} files`)}),t=s.generateReport(e),n=await this.app.vault.create(`Dead Links Report ${new Date().toISOString().split("T")[0]}.md`,t);await this.app.workspace.getLeaf().openFile(n),new g.Notice(`Scan complete: ${e.brokenCount} dead links found`)}catch(s){this.handleError(s,"Failed to scan for dead links")}}}),this.addCommand({id:"scan-file-dead-links",name:"Scan Current File for Dead Links",callback:async()=>{try{let s=this.app.workspace.getActiveFile();if(!s){new g.Notice("No active file");return}new g.Notice("Scanning file for dead links...");let t=await new B(this.app).scanFile(s);if(t.length===0)new g.Notice("\u2705 No dead links found in this file!");else{let n=`Found ${t.length} dead link${t.length>1?"s":""} in ${s.basename}`;new g.Notice(n),console.log("Dead links:",t)}}catch(s){this.handleError(s,"Failed to scan file for dead links")}}}),this.addCommand({id:"suggest-links",name:"Suggest Internal Links for Current File",callback:async()=>{try{let s=this.app.workspace.getActiveFile();if(!s){new g.Notice("No active file");return}new g.Notice("Analyzing file for link suggestions...");let e=new Z(this.app),t=await e.suggestLinks(s);if(t.length===0)new g.Notice("No link suggestions found");else{let n=e.generateReport(s,t),i=await this.app.vault.create(`Link Suggestions - ${s.basename} - ${new Date().toISOString().split("T")[0]}.md`,n);await this.app.workspace.getLeaf().openFile(i),new g.Notice(`Found ${t.length} link suggestions`)}}catch(s){this.handleError(s,"Failed to suggest links")}}}),this.addCommand({id:"suggest-tags",name:"Suggest Tags for Current Note",callback:async()=>{try{let s=this.app.workspace.getActiveFile();if(!s){new g.Notice("No active file");return}new g.Notice("Analyzing note for tag suggestions...");let e=new H(this.app),t=await e.suggestTags(s);if(t.length===0){new g.Notice("No tag suggestions found");return}new Ee(this.app,t,async n=>{n.length>0&&(await e.applyTags(s,n),new g.Notice(`Applied ${n.length} tags`))}).open()}catch(s){this.handleError(s,"Failed to suggest tags")}}}),this.addCommand({id:"auto-tag-note",name:"Auto-Tag Current Note (Top Suggestions)",callback:async()=>{try{let s=this.app.workspace.getActiveFile();if(!s){new g.Notice("No active file");return}new g.Notice("Auto-tagging note...");let e=new H(this.app),t=await e.suggestTags(s,{minConfidence:.6,maxSuggestions:3});if(t.length===0){new g.Notice("No confident tag suggestions found");return}let n=t.map(i=>i.tag);await e.applyTags(s,n),new g.Notice(`Auto-tagged with: ${n.join(", ")}`)}catch(s){this.handleError(s,"Failed to auto-tag note")}}}),this.addCommand({id:"find-duplicates",name:"Find Duplicate & Similar Notes",callback:async()=>{try{new g.Notice("Scanning vault for duplicates...");let e=await new ee(this.app).findDuplicates({exactMatchThreshold:1,nearDuplicateThreshold:.95,semanticThreshold:.7,minContentLength:50});if(e.length===0){new g.Notice("\u2705 No duplicates found!");return}let t=this.generateDuplicateReport(e),n=await this.app.vault.create(`Duplicate Notes Report - ${new Date().toISOString().split("T")[0]}.md`,t);await this.app.workspace.getLeaf().openFile(n),new g.Notice(`Found ${e.length} duplicate groups`)}catch(s){this.handleError(s,"Failed to find duplicates")}}}),this.addCommand({id:"compare-notes",name:"Compare Current Note with Another",callback:async()=>{try{if(!this.app.workspace.getActiveFile()){new g.Notice("No active file");return}new g.Notice("Select a note to compare with..."),new g.Notice("File comparison feature coming soon!")}catch(s){this.handleError(s,"Failed to compare notes")}}}),this.addCommand({id:"synthesize-notes",name:"Synthesize Insights from Multiple Notes",callback:async()=>{var s;try{let e=this.app.vault.getMarkdownFiles(),t=await this.promptUser("Enter tag (with #) or folder path to synthesize, or leave empty for all notes:"),n=[];if(t&&t.startsWith("#")){let c=t.substring(1);for(let l of e){let d=this.app.metadataCache.getFileCache(l),h=((s=d==null?void 0:d.frontmatter)==null?void 0:s.tags)||[];(Array.isArray(h)?h:[h]).includes(c)&&n.push(l)}}else t?n=e.filter(c=>{var l;return(l=c.parent)==null?void 0:l.path.includes(t)}):n=e.sort((c,l)=>l.stat.mtime-c.stat.mtime).slice(0,20);if(n.length===0){new g.Notice("No notes found matching criteria");return}new g.Notice(`Synthesizing ${n.length} notes...`);let i=await this.multiNoteSynthesizer.synthesizeNotes(n),a=this.generateSynthesisReport(i),o=`Synthesis - ${new Date().toISOString().split("T")[0]}.md`;await this.app.vault.create(o,a);let r=this.app.vault.getAbstractFileByPath(o);r instanceof g.TFile&&await this.app.workspace.getLeaf().openFile(r),new g.Notice(`\u2713 Synthesis complete! (${n.length} notes)`)}catch(e){this.handleError(e,"Failed to synthesize notes")}}}),this.addCommand({id:"research-assistant",name:"Research Assistant - Answer from Vault",callback:async()=>{try{let s=await this.promptUser("What would you like to research in your vault?");if(!s)return;new g.Notice("Researching across your vault...");let e=await this.multiNoteSynthesizer.answerResearchQuestion(s,15),t=this.app.workspace.getActiveFile(),n=this.app.workspace.getActiveViewOfType(g.MarkdownView),i=`## Research Question

${s}

## Answer

${e}

---
*Generated by Research Assistant on ${new Date().toLocaleString()}*

`;if(n&&t){let a=n.editor;a.replaceRange(i,a.getCursor())}else{let a=`Research - ${s.substring(0,50)}.md`;await this.app.vault.create(a,i);let o=this.app.vault.getAbstractFileByPath(a);o instanceof g.TFile&&await this.app.workspace.getLeaf().openFile(o)}new g.Notice("\u2713 Research complete!")}catch(s){this.handleError(s,"Research failed")}}}),this.addCommand({id:"find-knowledge-gaps",name:"Identify Knowledge Gaps in Research",callback:async()=>{try{let s=await this.promptUser("What topic would you like to analyze for knowledge gaps?");if(!s)return;new g.Notice("Analyzing knowledge gaps...");let e=this.app.vault.getMarkdownFiles(),t=[];for(let c of e){let l=await this.contextEngine.scoreNoteRelevance(c,s);l.score>30&&t.push({file:c,score:l.score})}t.sort((c,l)=>l.score-c.score);let n=t.slice(0,10).map(c=>c.file);if(n.length===0){new g.Notice("No relevant notes found");return}let i=await this.multiNoteSynthesizer.identifyKnowledgeGaps(s,n),a=`# Knowledge Gap Analysis: ${s}

*Based on ${n.length} relevant notes*

## Identified Gaps

`+i.map((c,l)=>`${l+1}. ${c}`).join(`
`)+`

## Related Notes

`+n.map(c=>`- [[${c.basename}]]`).join(`
`)+`

---
*Generated ${new Date().toLocaleString()}*`,o=`Gap Analysis - ${s}.md`;await this.app.vault.create(o,a);let r=this.app.vault.getAbstractFileByPath(o);r instanceof g.TFile&&await this.app.workspace.getLeaf().openFile(r),new g.Notice(`\u2713 Found ${i.length} knowledge gaps`)}catch(s){this.handleError(s,"Gap analysis failed")}}}),this.addCommand({id:"suggest-research-directions",name:"Suggest Next Research Directions",callback:async()=>{try{let s=await this.promptUser("What research topic would you like suggestions for?");if(!s)return;new g.Notice("Analyzing research directions...");let e=this.app.vault.getMarkdownFiles(),t=[];for(let c of e){let l=await this.contextEngine.scoreNoteRelevance(c,s);l.score>30&&t.push({file:c,score:l.score})}t.sort((c,l)=>l.score-c.score);let n=t.slice(0,10).map(c=>c.file);if(n.length===0){new g.Notice("No relevant notes found");return}let i=await this.multiNoteSynthesizer.suggestResearchDirections(s,n),a=`# Research Direction Suggestions: ${s}

`;a+=`*Based on analysis of ${n.length} notes*

`;for(let c of i){let l=c.priority==="high"?"\u{1F534}":c.priority==="medium"?"\u{1F7E1}":"\u{1F7E2}";a+=`## ${l} ${c.direction}

`,a+=`**Why this matters:** ${c.reasoning}

`,c.suggestedSources.length>0&&(a+=`**Suggested sources:**
`,a+=c.suggestedSources.map(d=>`- ${d}`).join(`
`),a+=`

`)}a+=`## Source Notes

`,a+=n.map(c=>`- [[${c.basename}]]`).join(`
`),a+=`

---
*Generated ${new Date().toLocaleString()}*`;let o=`Research Directions - ${s}.md`;await this.app.vault.create(o,a);let r=this.app.vault.getAbstractFileByPath(o);r instanceof g.TFile&&await this.app.workspace.getLeaf().openFile(r),new g.Notice(`\u2713 Generated ${i.length} research suggestions`)}catch(s){this.handleError(s,"Failed to generate suggestions")}}}),this.addCommand({id:"find-related-notes",name:"Find Semantically Related Notes",callback:async()=>{try{let s=this.app.workspace.getActiveFile();if(!s){new g.Notice("No active file");return}new g.Notice("Finding related notes...");let e=await this.contextEngine.findClusterMates(s);if(e.length===0){new g.Notice("No semantically related notes found");return}let t=`# Notes Related to ${s.basename}

`;t+=`Found ${e.length} semantically similar notes:

`,t+=e.map(i=>`- [[${i.basename}]]`).join(`
`),t+=`

---
*Generated by Context Engine on ${new Date().toLocaleString()}*`;let n=this.app.workspace.getActiveViewOfType(g.MarkdownView);if(n){let i=n.editor;i.replaceRange(t,i.getCursor())}else{let i=`Related to ${s.basename}.md`;await this.app.vault.create(i,t)}new g.Notice(`\u2713 Found ${e.length} related notes`)}catch(s){this.handleError(s,"Failed to find related notes")}}}),this.addCommand({id:"build-semantic-clusters",name:"Discover Semantic Note Clusters",callback:async()=>{try{new g.Notice("Building semantic clusters... This may take a moment.");let s=await this.contextEngine.buildSemanticClusters(),e=`# Semantic Note Clusters

`;e+=`Discovered ${s.size} thematic clusters in your vault:

`;for(let[i,a]of s)e+=`## ${a.theme}

`,e+=`*Keywords: ${a.keywords.join(", ")}*

`,e+=`**Notes (${a.notes.length}):**
`,e+=a.notes.map(o=>`- [[${o.basename}]]`).join(`
`),e+=`

`;e+=`---
*Generated ${new Date().toLocaleString()}*`;let t=`Semantic Clusters - ${new Date().toISOString().split("T")[0]}.md`;await this.app.vault.create(t,e);let n=this.app.vault.getAbstractFileByPath(t);n instanceof g.TFile&&await this.app.workspace.getLeaf().openFile(n),new g.Notice(`\u2713 Found ${s.size} clusters`)}catch(s){this.handleError(s,"Clustering failed")}}}),this.addCommand({id:"rebuild-index",name:"Rebuild Semantic Index",callback:async()=>{let s=await this.promptUser('Rebuild entire index? This may cost API credits. Type "yes" to confirm.');(s==null?void 0:s.toLowerCase())==="yes"&&await this.indexingService.indexVault(!0)}}),this.addCommand({id:"semantic-search",name:"Semantic Search",callback:async()=>{let s=await this.promptUser("Enter search query:");if(s){new g.Notice("Searching...");try{let e=await this.embeddingService.generateEmbedding(s),t=await this.vectorStore.search(e.vector,10,.5);if(t.length===0){new g.Notice("No relevant results found.");return}let n=`# Semantic Search Results: "${s}"

`+t.map(o=>`- [[${o.metadata.basename}]] (Score: ${(o.score*100).toFixed(1)}%)`).join(`
`),i=`Search Results - ${Date.now()}.md`;await this.app.vault.create(i,n);let a=this.app.vault.getAbstractFileByPath(i);a instanceof g.TFile&&await this.app.workspace.getLeaf().openFile(a)}catch(e){this.handleError(e,"Semantic Search Failed")}}}}),this.addCommand({id:"ask-agent-auto",name:"Ask Agent (Auto)",callback:async()=>{let s=await this.promptUser("What would you like me to do?");if(s){new g.Notice("Agent is thinking...");try{let e=await this.memoryService.getRelevantMemories(s),t=e.length>0?`Context about user: ${e.join("; ")}

Question: ${s}`:s,n=await this.agentService.run(t),i=new g.Modal(this.app);i.contentEl.createEl("h2",{text:"Agent Response"}),i.contentEl.createEl("div",{text:n}),i.open()}catch(e){this.handleError(e,"Agent Error")}}}}),this.addCommand({id:"transcribe-audio",name:"Transcribe Selected Audio File",callback:async()=>{let s=this.app.workspace.getActiveFile();if(!s||!["mp3","wav","m4a","webm"].includes(s.extension)){new g.Notice("Please open an audio file first.");return}new g.Notice("Transcribing...");try{let e=await this.audioService.transcribe(s),t=`Transcript - ${s.basename}.md`;await this.app.vault.create(t,`# Transcript: ${s.basename}

${e}`),new g.Notice("Transcription complete!")}catch(e){this.handleError(e,"Transcription Failed")}}}),this.addCommand({id:"analyze-image",name:"Analyze Current Image",callback:async()=>{let s=this.app.workspace.getActiveFile();if(!s||!["png","jpg","jpeg","webp"].includes(s.extension)){new g.Notice("Please open an image file first.");return}let e=await this.promptUser("What would you like to know about this image?");if(e){new g.Notice("Analyzing image...");try{let t=await this.app.vault.readBinary(s),n=btoa(new Uint8Array(t).reduce((o,r)=>o+String.fromCharCode(r),"")),i=await this.aiService.generateCompletion({prompt:e,imageData:n}),a=new g.Modal(this.app);a.contentEl.createEl("h2",{text:"Image Analysis"}),a.contentEl.createEl("div",{text:i.text}),a.open()}catch(t){this.handleError(t,"Image Analysis Failed")}}}}),this.addSettingTab(new j(this.app,this)),console.log("Obsidian Agent plugin loaded")}catch(s){this.handleError(s,"Failed to load plugin")}}onunload(){console.log("Obsidian Agent plugin unloaded")}async loadSettings(){this.settings=Object.assign({},Pe,await this.loadData())}async gatherFullContext(s,e,t=!1){e||(e="");let n=this.settings.contextConfig;if(!(t||(n==null?void 0:n.enableLinkedNotes)||(n==null?void 0:n.enableBacklinks)||(n==null?void 0:n.enableTagContext)||(n==null?void 0:n.enableFolderContext))||!s)return e;let a={sources:[{type:"current",enabled:!0},{type:"linked",enabled:t||(n==null?void 0:n.enableLinkedNotes)||!1},{type:"backlinks",enabled:(n==null?void 0:n.enableBacklinks)||!1},{type:"tags",enabled:(n==null?void 0:n.enableTagContext)||!1},{type:"folder",enabled:(n==null?void 0:n.enableFolderContext)||!1}],maxNotesPerSource:Math.max(1,(n==null?void 0:n.maxNotesPerSource)||5),maxTokensPerNote:Math.max(100,(n==null?void 0:n.maxTokensPerNote)||1e3),linkDepth:Math.max(1,Math.min(3,(n==null?void 0:n.linkDepth)||1)),excludeFolders:((n==null?void 0:n.excludeFolders)||"templates, .obsidian").split(",").map(o=>o.trim()).filter(o=>o.length>0)};try{let o=await this.contextProvider.gatherContext(s,e,a,this.settings.apiProvider);if(!o||o.length===0)return e;let r=this.contextProvider.formatContextsForPrompt(o);if(o.length>1){let c=o.length-1;new g.Notice(`Loaded context from ${c} additional note(s)`)}return r||e}catch(o){return console.error("Failed to gather vault context:",o),new g.Notice("Warning: Could not load vault context, using current note only"),e}}async migrateToProfiles(){if(!this.settings.profiles||this.settings.profiles.length===0){let s=Ae(this.settings);this.settings.profiles=[s],this.settings.activeProfileId="default",await this.saveSettings(),console.log("Migrated settings to profile system")}}getActiveProfile(){return this.settings.profiles.find(s=>s.id===this.settings.activeProfileId)}async switchProfile(s){let e=this.settings.profiles.find(t=>t.id===s);if(!e){new g.Notice("Profile not found");return}this.settings.activeProfileId=s,this.settings.apiProvider=e.apiProvider,this.settings.apiKey=e.apiKey,this.settings.customApiUrl=e.customApiUrl,this.settings.model=e.model,this.settings.temperature=e.temperature,this.settings.maxTokens=e.maxTokens,this.settings.systemPrompt=e.systemPrompt,await this.saveSettings(),new g.Notice(`Switched to profile: ${e.name}`)}async createProfile(s){this.settings.profiles.push(s),await this.saveSettings(),new g.Notice(`Profile created: ${s.name}`)}async updateProfile(s){let e=this.settings.profiles.findIndex(t=>t.id===s.id);e>=0&&(this.settings.profiles[e]=s,s.id===this.settings.activeProfileId&&(this.settings.apiProvider=s.apiProvider,this.settings.apiKey=s.apiKey,this.settings.customApiUrl=s.customApiUrl,this.settings.model=s.model,this.settings.temperature=s.temperature,this.settings.maxTokens=s.maxTokens,this.settings.systemPrompt=s.systemPrompt),await this.saveSettings())}async deleteProfile(s){if(s==="default"){new g.Notice("Cannot delete the default profile");return}let e=this.settings.profiles.findIndex(t=>t.id===s);if(e>=0){let t=this.settings.profiles[e].name;this.settings.profiles.splice(e,1),this.settings.activeProfileId===s?await this.switchProfile("default"):await this.saveSettings(),new g.Notice(`Profile deleted: ${t}`)}}generateDuplicateReport(s){let e=[];e.push(`# Duplicate & Similar Notes Report
`),e.push(`**Scan Date:** ${new Date().toISOString()}
`),e.push(`**Groups Found:** ${s.length}
`);let t=s.filter(a=>a.duplicateType==="exact"),n=s.filter(a=>a.duplicateType==="near-exact"),i=s.filter(a=>a.duplicateType==="semantic");return e.push(`- Exact Duplicates: ${t.length}`),e.push(`- Near-Exact Duplicates: ${n.length}`),e.push(`- Semantic Duplicates: ${i.length}
`),t.length>0&&(e.push(`## \u{1F534} Exact Duplicates
`),e.push(`These notes have identical content and should be merged.
`),t.forEach((a,o)=>{e.push(`### Group ${o+1} (${a.notes.length} notes)`),e.push(`**Similarity:** 100%
`),a.notes.forEach(r=>{e.push(`- [[${r.path}]]`)}),a.commonContent&&e.push(`
**Preview:**
> ${a.commonContent}
`),e.push("")})),n.length>0&&(e.push(`## \u{1F7E1} Near-Exact Duplicates
`),e.push(`These notes are 95%+ similar with minor differences.
`),n.forEach((a,o)=>{e.push(`### Group ${o+1} (${a.notes.length} notes)`);let r=Math.round(a.similarity*100);e.push(`**Similarity:** ${r}%
`),a.notes.forEach(c=>{e.push(`- [[${c.path}]]`)}),e.push("")})),i.length>0&&(e.push(`## \u{1F7E2} Semantic Duplicates
`),e.push(`These notes cover similar topics or themes.
`),i.forEach((a,o)=>{e.push(`### Group ${o+1} (${a.notes.length} notes)`);let r=Math.round(a.similarity*100);e.push(`**Similarity:** ${r}%
`),a.notes.forEach(c=>{e.push(`- [[${c.path}]]`)}),e.push("")})),e.push(`---
`),e.push(`## \u{1F4A1} Recommendations
`),e.push("- **Exact Duplicates:** Delete all but one copy"),e.push("- **Near-Exact:** Review differences and merge if appropriate"),e.push(`- **Semantic:** Consider linking or consolidating related content
`),e.join(`
`)}generateSynthesisReport(s){let e=[];if(e.push(`# Multi-Note Synthesis Report
`),e.push(`**Generated:** ${new Date().toLocaleString()}`),e.push(`**Notes Analyzed:** ${s.notesAnalyzed}
`),e.push(`## Summary
`),e.push(s.summary+`
`),s.keyInsights&&s.keyInsights.length>0&&(e.push(`## Key Insights
`),s.keyInsights.forEach((t,n)=>{e.push(`${n+1}. ${t}`)}),e.push("")),s.contradictions&&s.contradictions.length>0&&(e.push(`## \u26A0\uFE0F Contradictions Found
`),s.contradictions.forEach(t=>{e.push(`- ${t}`)}),e.push("")),s.knowledgeGaps&&s.knowledgeGaps.length>0&&(e.push(`## \u{1F50D} Knowledge Gaps
`),s.knowledgeGaps.forEach(t=>{e.push(`- ${t}`)}),e.push("")),s.citations&&s.citations.size>0){e.push(`## \u{1F4DA} Source Citations
`);for(let[t,n]of s.citations)e.push(`### [[${t}]]`),n.forEach(i=>{e.push(`> ${i}`)}),e.push("")}return e.push("---"),e.push("*Generated by Multi-Note Synthesizer*"),e.join(`
`)}async promptUser(s){return new Promise(e=>{new class extends g.Modal{constructor(){super(...arguments);this.result=null}onOpen(){let{contentEl:i}=this;i.createEl("h3",{text:s});let a=i.createEl("input",{type:"text",attr:{style:"width: 100%; padding: 8px; margin: 10px 0;"}}),o=i.createDiv({attr:{style:"display: flex; gap: 10px; justify-content: flex-end;"}});o.createEl("button",{text:"Submit"}).addEventListener("click",()=>{this.result=a.value||null,this.close()}),o.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.result=null,this.close()}),a.addEventListener("keypress",l=>{l.key==="Enter"&&(this.result=a.value||null,this.close())}),a.focus()}onClose(){let{contentEl:i}=this;i.empty(),e(this.result)}}(this.app).open()})}async trackTokenUsage(s){try{if(!this.settings.enableTokenTracking||!s.tokensUsed)return;this.settings.totalRequests=(this.settings.totalRequests||0)+1,this.settings.totalTokensUsed=(this.settings.totalTokensUsed||0)+s.tokensUsed;let e=this.estimateCost(s);this.settings.estimatedCost=(this.settings.estimatedCost||0)+e;let t=this.settings.costThreshold||10;this.settings.estimatedCost>t&&new g.Notice(`Cost warning: You've spent approximately $${this.settings.estimatedCost.toFixed(2)} this session`,5e3),await this.saveSettings()}catch(e){console.error("Failed to track token usage:",e)}}handleError(s,e){let t=e;s instanceof C?t=`Validation error: ${s.message}`:s instanceof L?t=`API error: ${s.message}`:s instanceof M?t=`Configuration error: ${s.message}`:s.message&&(t=`${e}: ${s.message}`),console.error(e,s),new g.Notice(t,5e3)}registerStyles(){this.app.vault.adapter.read("styles.css").then(t=>{if(t){let n=document.createElement("style");n.textContent=t,n.className="obsidian-agent-styles",document.head.appendChild(n)}}),this.app.vault.adapter.read("styles-enhanced.css").then(t=>{if(t){let n=document.createElement("style");n.textContent=Xe+`
`+t,n.className="obsidian-agent-styles-enhanced",document.head.appendChild(n)}}),this.applyAccessibilitySettings()}applyAccessibilitySettings(){var s,e;document.body.classList.remove("oa-high-contrast","oa-reduced-motion"),(s=this.settings.accessibilityConfig)!=null&&s.enableHighContrast&&document.body.classList.add("oa-high-contrast"),(e=this.settings.accessibilityConfig)!=null&&e.enableReducedMotion&&document.body.classList.add("oa-reduced-motion")}estimateCost(s){if(this.settings.apiProvider==="openai"){let e=(s.inputTokens||0)/1e3*.03,t=(s.outputTokens||0)/1e3*.06;return e+t}else if(this.settings.apiProvider==="anthropic")return(s.tokensUsed||0)/1e3*.075;return 0}async saveSettings(){var n,i,a;let s=(n=this.aiService)==null?void 0:n.getCacheService();if(s&&((i=this.settings.cacheConfig)!=null&&i.enabled)){let o=s.exportCache();this.settings.cacheData={entries:o.entries,stats:o.stats}}await this.saveData(this.settings);let e=new $(this.settings),t=(a=this.aiService)==null?void 0:a.getCacheService();t&&s&&e.getCacheService().importCache({entries:t.exportCache().entries,stats:t.getStats(),settings:this.settings.cacheConfig}),this.aiService=e}},Ee=class extends g.Modal{constructor(e,t,n){super(e);this.selectedTags=new Set;this.suggestions=t,this.onSelect=n}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Suggested Tags"}),e.createEl("p",{text:"Select tags to apply to this note:",cls:"setting-item-description"});let t=e.createEl("div",{cls:"tag-suggestion-list"});this.suggestions.forEach(r=>{let c=t.createEl("div",{cls:"tag-suggestion-item",attr:{"data-tag":r.tag}}),l=c.createEl("input",{type:"checkbox",cls:"tag-checkbox"}),d=c.createEl("label",{cls:"tag-label"});d.createEl("span",{text:`#${r.tag}`,cls:"tag-name"});let h=Math.round(r.confidence*100);d.createEl("span",{text:"% ",cls:"tag-confidence"});let m=d.createEl("span",{text:this.getReasonText(r.reason),cls:"tag-reason"});r.examples&&r.examples.length>0&&m.createEl("span",{text:" ()",cls:"tag-examples"}),l.addEventListener("change",()=>{l.checked?(this.selectedTags.add(r.tag),c.addClass("selected")):(this.selectedTags.delete(r.tag),c.removeClass("selected"))}),h>=70&&(l.checked=!0,this.selectedTags.add(r.tag),c.addClass("selected"))});let n=e.createEl("div",{cls:"modal-button-container"});n.createEl("button",{text:"Apply Selected Tags",cls:"mod-cta"}).addEventListener("click",()=>{this.onSelect([...this.selectedTags]),this.close()}),n.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.close()});let o=e.createEl("style");o.textContent=`
.tag-suggestion-list {
margin: 20px 0;
max-height: 400px;
overflow-y: auto;
}
.tag-suggestion-item {
padding: 10px;
margin: 5px 0;
border: 1px solid var(--background-modifier-border);
border-radius: 5px;
display: flex;
align-items: center;
cursor: pointer;
transition: all 0.2s;
}
.tag-suggestion-item:hover {
background-color: var(--background-modifier-hover);
}
.tag-suggestion-item.selected {
background-color: var(--interactive-accent);
color: var(--text-on-accent);
border-color: var(--interactive-accent);
}
.tag-checkbox {
margin-right: 10px;
}
.tag-label {
flex: 1;
display: flex;
flex-wrap: wrap;
align-items: center;
gap: 5px;
}
.tag-name {
font-weight: 600;
margin-right: 10px;
}
.tag-confidence {
color: var(--text-accent);
font-size: 0.9em;
}
.tag-reason {
color: var(--text-muted);
font-size: 0.85em;
}
.tag-examples {
font-style: italic;
}
.modal-button-container {
display: flex;
justify-content: flex-end;
gap: 10px;
margin-top: 20px;
}
`}getReasonText(e){return{content_match:"content match",pattern_learned:"learned pattern",similar_notes:"similar notes",frequency:"frequently co-occurs"}[e]||e}onClose(){let{contentEl:e}=this;e.empty()}};
