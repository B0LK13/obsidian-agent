/*
=========================================================
  OBSIDIAN AGENT PLUGIN
  AI-enhanced assistant for Obsidian
  
  Version: 1.1.0
  Author: B0LK13
  License: MIT
  Repository: https://github.com/B0LK13/obsidian-agent
=========================================================
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository
*/

"use strict";var ke=Object.defineProperty;var et=Object.getOwnPropertyDescriptor;var tt=Object.getOwnPropertyNames;var nt=Object.prototype.hasOwnProperty;var st=(h,t)=>{for(var e in t)ke(h,e,{get:t[e],enumerable:!0})},it=(h,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of tt(t))!nt.call(h,s)&&s!==e&&ke(h,s,{get:()=>t[s],enumerable:!(n=et(t,s))||n.enumerable});return h};var at=h=>it(ke({},"__esModule",{value:!0}),h);var pt={};st(pt,{default:()=>Ce});module.exports=at(pt);var u=require("obsidian");var Te=[{id:"openai-gpt4",name:"OpenAI GPT-4",apiProvider:"openai",apiKey:"",customApiUrl:"",model:"gpt-4",temperature:.7,maxTokens:2e3,systemPrompt:`You are an intelligent AI assistant integrated into Obsidian, a powerful note-taking and knowledge management application.

Your role is to help users with their notes, writing, research, and knowledge organization. You have access to the user's vault of notes and can help them:

- Answer questions about their notes and knowledge base
- Summarize content and extract key insights
- Help with writing, editing, and improving their notes
- Suggest connections between related notes
- Organize and structure information
- Search for and retrieve relevant information from their vault

Always provide helpful, clear, and conversational responses. When you don't know something, be honest about it. If a search returns no results, offer to help create new content on that topic or suggest related areas to explore.

Focus on being genuinely helpful and conversational, not mechanical or robotic. Format your responses clearly with markdown when appropriate.`},{id:"openai-gpt35",name:"OpenAI GPT-3.5 (Fast)",apiProvider:"openai",apiKey:"",customApiUrl:"",model:"gpt-3.5-turbo",temperature:.7,maxTokens:2e3,systemPrompt:`You are an intelligent AI assistant integrated into Obsidian, a powerful note-taking and knowledge management application.

Your role is to help users with their notes, writing, research, and knowledge organization. You have access to the user's vault of notes and can help them:

- Answer questions about their notes and knowledge base
- Summarize content and extract key insights
- Help with writing, editing, and improving their notes
- Suggest connections between related notes
- Organize and structure information
- Search for and retrieve relevant information from their vault

Always provide helpful, clear, and conversational responses. When you don't know something, be honest about it. If a search returns no results, offer to help create new content on that topic or suggest related areas to explore.

Focus on being genuinely helpful and conversational, not mechanical or robotic. Format your responses clearly with markdown when appropriate.`},{id:"anthropic-claude",name:"Anthropic Claude",apiProvider:"anthropic",apiKey:"",customApiUrl:"",model:"claude-3-sonnet-20240229",temperature:.7,maxTokens:2e3,systemPrompt:`You are an intelligent AI assistant integrated into Obsidian, a powerful note-taking and knowledge management application.

Your role is to help users with their notes, writing, research, and knowledge organization. You have access to the user's vault of notes and can help them:

- Answer questions about their notes and knowledge base
- Summarize content and extract key insights
- Help with writing, editing, and improving their notes
- Suggest connections between related notes
- Organize and structure information
- Search for and retrieve relevant information from their vault

Always provide helpful, clear, and conversational responses. When you don't know something, be honest about it. If a search returns no results, offer to help create new content on that topic or suggest related areas to explore.

Focus on being genuinely helpful and conversational, not mechanical or robotic. Format your responses clearly with markdown when appropriate.`},{id:"ollama-local",name:"Ollama (Local)",apiProvider:"ollama",apiKey:"",customApiUrl:"http://localhost:11434",model:"llama2",temperature:.7,maxTokens:2e3,systemPrompt:`You are an intelligent AI assistant integrated into Obsidian, a powerful note-taking and knowledge management application.

Your role is to help users with their notes, writing, research, and knowledge organization. You have access to the user's vault of notes and can help them:

- Answer questions about their notes and knowledge base
- Summarize content and extract key insights
- Help with writing, editing, and improving their notes
- Suggest connections between related notes
- Organize and structure information
- Search for and retrieve relevant information from their vault

Always provide helpful, clear, and conversational responses. When you don't know something, be honest about it. If a search returns no results, offer to help create new content on that topic or suggest related areas to explore.

Focus on being genuinely helpful and conversational, not mechanical or robotic. Format your responses clearly with markdown when appropriate.`}],E={enabled:!0,triggerMode:"both",autoTriggerDelay:1e3,manualTriggerShortcut:"ctrl+space",phraseTriggers:["...","//"],maxCompletions:5,maxTokens:100,debounceDelay:300,showInMarkdownOnly:!1,excludedFolders:["templates",".obsidian"]},_={enabled:!0,suggestionTypes:{links:!0,tags:!0,summaries:!0,todos:!0,improvements:!0,expansions:!0,organization:!0},autoAnalyze:!0,maxSuggestions:5,privacyMode:"hybrid"},_e={apiKey:"",apiProvider:"openai",customApiUrl:"",model:"gpt-4",temperature:.7,maxTokens:2e3,systemPrompt:"You are an advanced AI assistant integrated into Obsidian with access to the user's complete vault. When asked for summaries or information: (1) Use search_vault to find relevant notes, (2) Use read_note to examine specific notes, (3) Use list_files to explore folders, (4) Always provide comprehensive answers with citations using [[note-path]] format.",enableAutoCompletion:!1,enableContextAwareness:!0,enableTokenTracking:!0,costThreshold:10,conversations:[],maxConversations:20,enableConversationPersistence:!0,profiles:[],activeProfileId:"default",customTemplates:[],contextConfig:{enableLinkedNotes:!0,enableBacklinks:!0,enableTagContext:!0,enableFolderContext:!0,maxNotesPerSource:10,maxTokensPerNote:2e3,linkDepth:2,excludeFolders:"templates, .obsidian"},cacheConfig:{enabled:!0,maxEntries:100,maxAgeDays:30,matchThreshold:1},cacheData:{entries:[],stats:{totalEntries:0,totalHits:0,totalMisses:0,estimatedSavings:0,cacheSize:0}},accessibilityConfig:{enableHighContrast:!1,enableReducedMotion:!1},completionConfig:E,suggestionConfig:_,embeddingConfig:{provider:"openai",model:"text-embedding-3-small",enabled:!0,autoRefresh:!0},agentCorePrompt:`You are an intelligent AI assistant helping a user with their Obsidian vault.

**MOMENTUM POLICY - STRICT ENFORCEMENT:**
Every response MUST include a concrete NEXT STEP. This is a hard requirement, not a preference.
- Never end with only explanation.
- If uncertain, propose the safest low-cost validation step.
- If multiple paths exist, provide 2-3 clear options and recommend one.
- If blocked by missing info, state exactly what to collect, then provide a temporary fallback action.
- Prefer progress over perfection while respecting safety constraints.

**RESPONSE CONTRACT:**
Your output must include a YAML block at the end following this schema:
\`\`\`yaml
answer: <direct response>
reasoning_summary: <short, user-safe rationale>
next_step:
  action: <single best next action>
  owner: <user|agent>
  effort: <5m|30m|half-day|1-day|2-days+>
  expected_outcome: <what success looks like>
  type: <do_now|choose_path|unblock>
alternatives:
  - option: <path A>
    when_to_use: <condition>
risks:
  - <main risk>
mitigation:
  - <how to reduce risk>
\`\`\`

Maintain a 70/30 ratio: 70% answer/explanation, 30% next action. Always end with a clear recommended next move.`,loggingConfig:{enabled:!0,logLevel:"INFO",maxHistorySize:1e3}};function z(){return`profile_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function Be(h){return{id:"default",name:"Default",apiProvider:h.apiProvider,apiKey:h.apiKey,customApiUrl:h.customApiUrl,model:h.model,temperature:h.temperature,maxTokens:h.maxTokens,systemPrompt:h.systemPrompt}}var p=require("obsidian");var Ae=require("obsidian");var Ue={enabled:!0,maxEntries:100,maxAgeDays:30,matchThreshold:1},q=class{constructor(t){this.cache=new Map;this.stats={totalEntries:0,totalHits:0,totalMisses:0,estimatedSavings:0,cacheSize:0};this.settings=t||Ue}hashString(t){let e=0;for(let n=0;n<t.length;n++){let s=t.charCodeAt(n);e=(e<<5)-e+s,e=e&e}return Math.abs(e).toString(36)}generateCacheKey(t,e,n,s){let i=this.hashString(t.trim().toLowerCase()),a=this.hashString((e||"").trim().toLowerCase()),o=s.toFixed(2);return`${i}_${a}_${n}_${o}`}generateKeyFromEntry(t){var n,s;let e=(s=(n=t.temperature)==null?void 0:n.toFixed(2))!=null?s:"0.00";return t.promptHash&&t.contextHash?`${t.promptHash}_${t.contextHash}_${t.model}_${e}`:this.generateCacheKey(t.prompt,"",t.model,t.temperature)}get(t,e,n,s){if(!this.settings.enabled)return null;let i=this.generateCacheKey(t,e,n,s),a=this.cache.get(i);if(!a)return this.stats.totalMisses++,null;let o=this.settings.maxAgeDays*24*60*60*1e3;return Date.now()-a.createdAt>o?(this.cache.delete(i),this.stats.totalMisses++,null):(a.accessedAt=Date.now(),a.accessCount++,this.cache.set(i,a),this.stats.totalHits++,this.stats.estimatedSavings+=a.tokensUsed,a)}set(t,e,n,s,i,a,o=0,r=0){if(!this.settings.enabled)return this.createEntry(t,e,n,s,i,a,o,r);this.cache.size>=this.settings.maxEntries&&this.evictOldest();let c=this.generateCacheKey(t,e,n,s),l=this.createEntry(t,e,n,s,i,a,o,r);return this.cache.set(c,l),this.stats.totalEntries=this.cache.size,this.updateCacheSize(),l}createEntry(t,e,n,s,i,a,o,r){let c=Date.now();return{id:`cache_${c}_${Math.random().toString(36).substr(2,9)}`,promptHash:this.hashString(t.trim().toLowerCase()),contextHash:this.hashString((e||"").trim().toLowerCase()),prompt:t,response:i,model:n,temperature:s,tokensUsed:a,inputTokens:o,outputTokens:r,createdAt:c,accessedAt:c,accessCount:1}}evictOldest(){let t=null,e=1/0;for(let[n,s]of this.cache.entries())s.accessedAt<e&&(e=s.accessedAt,t=n);t&&this.cache.delete(t)}updateCacheSize(){let t=0;for(let e of this.cache.values())t+=e.prompt.length+e.response.length+200;this.stats.cacheSize=t}deleteEntry(t){for(let[e,n]of this.cache.entries())if(n.id===t)return this.cache.delete(e),this.stats.totalEntries=this.cache.size,this.updateCacheSize(),!0;return!1}clearCache(){this.cache.clear(),this.stats.totalEntries=0,this.stats.cacheSize=0}resetStats(){this.stats.totalHits=0,this.stats.totalMisses=0,this.stats.estimatedSavings=0}getStats(){return{...this.stats,totalEntries:this.cache.size}}getAllEntries(){return Array.from(this.cache.values()).sort((t,e)=>e.accessedAt-t.accessedAt)}getHitRate(){let t=this.stats.totalHits+this.stats.totalMisses;return t===0?0:this.stats.totalHits/t*100}getEstimatedCostSavings(t=.002){return this.stats.estimatedSavings/1e3*t}updateSettings(t){for(this.settings={...this.settings,...t};this.cache.size>this.settings.maxEntries;)this.evictOldest();this.stats.totalEntries=this.cache.size}getSettings(){return{...this.settings}}exportCache(){return{entries:this.getAllEntries(),stats:this.getStats(),settings:this.getSettings()}}importCache(t){if(t.settings&&(this.settings={...Ue,...t.settings}),t.stats&&(this.stats={...this.stats,...t.stats}),t.entries){this.cache.clear();let e=Date.now(),n=this.settings.maxAgeDays*24*60*60*1e3;for(let s of t.entries){if(e-s.createdAt>n)continue;let i=this.generateKeyFromEntry(s);if(this.cache.set(i,s),this.cache.size>=this.settings.maxEntries)break}this.stats.totalEntries=this.cache.size,this.updateCacheSize()}}isEnabled(){return this.settings.enabled}setEnabled(t){this.settings.enabled=t}invalidateByContext(t){let e=0,n=[];for(let[s,i]of this.cache.entries())i.prompt.includes(t)&&(n.push(s),e++);for(let s of n)this.cache.delete(s);return this.stats.totalEntries=this.cache.size,this.updateCacheSize(),e}cleanExpired(){let t=Date.now(),e=this.settings.maxAgeDays*24*60*60*1e3,n=0,s=[];for(let[i,a]of this.cache.entries())t-a.createdAt>e&&(s.push(i),n++);for(let i of s)this.cache.delete(i);return this.stats.totalEntries=this.cache.size,this.updateCacheSize(),n}getFormattedCacheSize(){let t=this.stats.cacheSize;return t<1024?`${t} B`:t<1024*1024?`${(t/1024).toFixed(1)} KB`:`${(t/(1024*1024)).toFixed(1)} MB`}getMostFrequentEntries(t=10){return Array.from(this.cache.values()).sort((e,n)=>n.accessCount-e.accessCount).slice(0,t)}getRecentlyAccessedEntries(t=10){return Array.from(this.cache.values()).sort((e,n)=>n.accessedAt-e.accessedAt).slice(0,t)}getPrefetchCandidates(t,e=5){let n=new Set(t.toLowerCase().split(/\s+/)),s=[];for(let i of this.cache.values()){let a=new Set(i.prompt.toLowerCase().split(/\s+/)),o=0;for(let c of n)a.has(c)&&o++;let r=o/Math.max(n.size,1)*(i.accessCount/10);r>.3&&s.push({entry:i,score:r})}return s.sort((i,a)=>a.score-i.score).slice(0,e).map(i=>i.entry)}optimize(){let t=Array.from(this.cache.entries()),e=Date.now(),n=0,s=t.map(([a,o])=>{let r=1/(1+(e-o.accessedAt)/864e5),c=Math.min(o.accessCount/100,1),l=1/(1+o.response.length/1e3),d=r*.4+c*.4+l*.2;return{key:a,entry:o,value:d}}),i=this.settings.maxEntries*.8;if(this.cache.size>i){s.sort((o,r)=>o.value-r.value);let a=Math.floor((this.cache.size-i)*1.2);for(let o=0;o<a&&o<s.length;o++)this.cache.delete(s[o].key),n++;this.stats.totalEntries=this.cache.size,this.updateCacheSize()}return n}batchGet(t){let e=new Map;for(let n of t){let s=this.get(n.prompt,n.context,n.model,n.temperature);if(s){let i=this.generateCacheKey(n.prompt,n.context,n.model,n.temperature);e.set(i,s)}}return e}batchSet(t){let e=0;for(let n of t)this.set(n.prompt,n.context,n.model,n.temperature,n.response,n.tokensUsed,n.inputTokens||0,n.outputTokens||0),e++;return e}getPerformanceMetrics(){let t=Array.from(this.cache.values()),e=this.stats.totalHits+this.stats.totalMisses,n=e>0?this.stats.totalHits/e*100:0,s=t.map(r=>r.accessCount).sort((r,c)=>r-c),i=s.length>0?s.reduce((r,c)=>r+c,0)/s.length:0,a=s.length>0?s[Math.floor(s.length/2)]:0,o=t.length>0?this.stats.totalHits/t.length:0;return{hitRate:n,avgAccessCount:i,medianAccessCount:a,totalSavings:this.stats.estimatedSavings,estimatedCostSavings:this.getEstimatedCostSavings(),cacheEfficiency:o}}};var N=class h extends Error{constructor(e,n){super(e);this.code=n;this.name="AgentError",Object.setPrototypeOf(this,h.prototype)}},k=class h extends N{constructor(e,n){super(e,"VALIDATION_ERROR");this.field=n;this.name="ValidationError",Object.setPrototypeOf(this,h.prototype)}},D=class h extends N{constructor(e,n,s){super(e,"API_ERROR");this.statusCode=n;this.provider=s;this.name="APIError",Object.setPrototypeOf(this,h.prototype)}},L=class h extends N{constructor(e,n){super(e,"CONFIGURATION_ERROR");this.setting=n;this.name="ConfigurationError",Object.setPrototypeOf(this,h.prototype)}},j=class h extends N{constructor(e,n){super(e,"NETWORK_ERROR");this.originalError=n;this.name="NetworkError",Object.setPrototypeOf(this,h.prototype)}};var T=class{static required(t,e){if(t==null)throw new k(`${e} is required`,e);return t}static notEmpty(t,e){let n=this.required(t,e);if(typeof n!="string"||n.trim().length===0)throw new k(`${e} cannot be empty`,e);return n}static inRange(t,e,n,s){if(typeof t!="number"||isNaN(t))throw new k(`${s} must be a valid number`,s);if(t<e||t>n)throw new k(`${s} must be between ${e} and ${n}`,s);return t}static positive(t,e){if(typeof t!="number"||isNaN(t)||t<=0)throw new k(`${e} must be a positive number`,e);return t}static nonNegative(t,e){if(typeof t!="number"||isNaN(t)||t<0)throw new k(`${e} must be a non-negative number`,e);return t}static notEmptyArray(t,e){let n=this.required(t,e);if(!Array.isArray(n)||n.length===0)throw new k(`${e} must be a non-empty array`,e);return n}static oneOf(t,e,n){if(!e.includes(t))throw new k(`${n} must be one of: ${e.join(", ")}`,n);return t}static apiKey(t,e="API key"){let n=this.notEmpty(t,e);if(n.length<10)throw new k(`${e} is too short (minimum 10 characters)`,e);return n}static url(t,e){let n=this.notEmpty(t,e);try{new URL(n)}catch(s){throw new k(`${e} is not a valid URL`,e)}return n}static temperature(t){return this.inRange(t,0,2,"temperature")}static maxTokens(t){return this.inRange(t,1,1e5,"maxTokens")}static safeArrayAccess(t,e,n){return!Array.isArray(t)||e<0||e>=t.length?n:t[e]}static safeGet(t,e,n){if(!t||typeof t!="object")return n;let s=t[e];return s!==void 0?s:n}static maxLength(t,e,n){let s=this.required(t,n);if(typeof s!="string")throw new k(`${n} must be a string`,n);return s.length>e?s.substring(0,e):s}static isString(t){return typeof t=="string"}static isNumber(t){return typeof t=="number"&&!isNaN(t)}static isObject(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}static isArray(t){return Array.isArray(t)}};var Pe=(i=>(i.DEBUG="DEBUG",i.INFO="INFO",i.WARN="WARN",i.ERROR="ERROR",i.PERFORMANCE="PERFORMANCE",i))(Pe||{}),Ee=class h{constructor(){this.logHistory=[];this.maxHistorySize=1e3;this.minLevel="INFO"}static getInstance(){return h.instance||(h.instance=new h),h.instance}setLogLevel(t){this.minLevel=t}shouldLog(t){let e=["DEBUG","INFO","WARN","ERROR","PERFORMANCE"];return e.indexOf(t)>=e.indexOf(this.minLevel)}createLogEntry(t,e,n,s,i){let a={timestamp:new Date().toISOString(),level:t,message:e,context:n};return s&&(a.error={name:s.name,message:s.message,stack:s.stack}),i&&(a.performance={duration:i.duration,memoryUsage:i.memoryUsage}),a}log(t){var n;if(!this.shouldLog(t.level))return;this.logHistory.push(t),this.logHistory.length>this.maxHistorySize&&this.logHistory.shift();let e=`[${t.timestamp}] [${t.level}]${(n=t.context)!=null&&n.component?` [${t.context.component}]`:""} ${t.message}`;switch(t.level){case"ERROR":console.error(e,t);break;case"WARN":console.warn(e,t);break;case"DEBUG":console.debug(e,t);break;default:console.log(e,t)}}debug(t,e){this.log(this.createLogEntry("DEBUG",t,e))}info(t,e){this.log(this.createLogEntry("INFO",t,e))}warn(t,e){this.log(this.createLogEntry("WARN",t,e))}error(t,e,n){this.log(this.createLogEntry("ERROR",t,n,e))}performance(t,e,n){this.log(this.createLogEntry("PERFORMANCE",t,n,void 0,{duration:e}))}async measureAsync(t,e,n){let s=performance.now();try{let i=await e(),a=performance.now()-s;return this.performance(`${t} completed`,a,n),i}catch(i){let a=performance.now()-s;throw this.error(`${t} failed after ${a.toFixed(2)}ms`,i,n),i}}getLogs(t){let e=this.logHistory;if(t&&(t.level&&(e=e.filter(n=>n.level===t.level)),t.component&&(e=e.filter(n=>{var s;return((s=n.context)==null?void 0:s.component)===t.component})),t.since)){let n=t.since;e=e.filter(s=>new Date(s.timestamp)>=n)}return e}exportLogs(){return JSON.stringify(this.logHistory,null,2)}clearLogs(){this.logHistory=[]}},$=Ee.getInstance();var R=class{constructor(t){this.timeoutMs=12e4;this.maxRetries=1;this.initialRetryDelayMs=1e3;this.retryDelayMultiplier=2;this.currentAbortController=null;this.bypassCache=!1;var e;if(!t)throw new k("Settings are required");if(this.settings=t,this.cacheService=new q(t.cacheConfig),(e=t.cacheData)!=null&&e.entries&&Array.isArray(t.cacheData.entries)&&t.cacheData.entries.length>0)try{this.cacheService.importCache({entries:t.cacheData.entries,stats:t.cacheData.stats||{hits:0,misses:0,evictions:0},settings:t.cacheConfig})}catch(n){$.error("Failed to import cache data",n,{component:"AIService"})}}getCacheService(){return this.cacheService}setBypassCache(t){this.bypassCache=t}updateCacheSettings(t){this.cacheService.updateSettings(t.cacheConfig)}cancelCurrentRequest(){this.currentAbortController&&(this.currentAbortController.abort(),this.currentAbortController=null)}async testConnection(){if(this.settings.apiProvider!=="ollama"&&!this.settings.apiKey)return{success:!1,message:"API key not configured"};let t=Date.now();try{let e=await this.callAPIWithRetry([{role:"user",content:'Test connection. Please respond with "OK" only.'}],void 0,1),n=Date.now()-t;return!e||typeof e.text!="string"?{success:!1,message:"Connection succeeded but received invalid response"}:e.text.trim().toLowerCase()==="ok"||e.text.length>0?{success:!0,message:`Connection successful! Response time: ${n}ms`,responseTime:n}:{success:!1,message:"Connection succeeded but returned unexpected response"}}catch(e){let n=Date.now()-t;return{success:!1,message:this.getErrorMessage(e),responseTime:n}}}async generateCompletion(t){var d,g;let e=typeof t=="string"?{prompt:t}:t,{prompt:n,context:s,imageData:i,stream:a,onChunk:o,onProgress:r}=e;try{T.notEmpty(n,"prompt")}catch(m){throw new k("Prompt cannot be empty")}if(!(this.settings.apiProvider==="ollama"||((d=this.settings.customApiUrl)==null?void 0:d.includes("localhost"))||((g=this.settings.customApiUrl)==null?void 0:g.includes("127.0.0.1")))&&!this.settings.apiKey)throw new L("API key not configured. Please set it in settings.","apiKey");if(!this.settings.model||this.settings.model.trim().length===0)throw new L("Model not configured. Please select a model in settings.","model");if(!a&&!this.bypassCache&&this.cacheService.isEnabled())try{let m=this.cacheService.get(n,s||"",this.settings.model,this.settings.temperature);if(m)return{text:m.response,tokensUsed:m.tokensUsed,inputTokens:m.inputTokens,outputTokens:m.outputTokens,fromCache:!0,cacheEntry:m}}catch(m){$.warn("Cache lookup failed, continuing with API call",{component:"AIService",operation:"cache-lookup"})}this.bypassCache=!1;let l=[];this.settings.systemPrompt&&this.settings.systemPrompt.trim().length>0&&l.push({role:"system",content:this.settings.systemPrompt}),s&&this.settings.enableContextAwareness&&s.trim().length>0&&l.push({role:"system",content:`Context from current note:
${s}`}),l.push({role:"user",content:n});try{let m;if(a&&o?m=await this.streamAPI(l,i,o,r):m=await this.callAPIWithRetry(l,i),!m||typeof m.text!="string")throw new D("Received invalid response from API");if(this.cacheService.isEnabled()&&m.text&&m.text.length>0)try{let f=this.cacheService.set(n,s||"",this.settings.model,this.settings.temperature,m.text,m.tokensUsed||0,m.inputTokens||0,m.outputTokens||0);m.cacheEntry=f}catch(f){$.warn("Failed to cache result",{component:"AIService",operation:"cache-write"})}return m.fromCache=!1,m}catch(m){throw $.error("AI Service Error",m,{component:"AIService",operation:"generate"}),m instanceof k||m instanceof D||m instanceof L||m instanceof j?m:new D(this.getErrorMessage(m))}}getErrorMessage(t){var e,n,s,i,a,o,r,c,l,d,g,m,f;return t.name==="AbortError"||(e=t.message)!=null&&e.includes("timeout")?"Request timed out. Please check your internet connection and try again.":(n=t.message)!=null&&n.includes("401")||(s=t.message)!=null&&s.includes("authentication")?"Invalid API key. Please check your API key in settings.":(i=t.message)!=null&&i.includes("429")||(a=t.message)!=null&&a.includes("rate limit")||(o=t.message)!=null&&o.includes("API limit")?"API rate limit reached. Please wait a moment and try again. Tip: Consider using a local LLM like Ollama for unlimited usage.":(r=t.message)!=null&&r.includes("500")||(c=t.message)!=null&&c.includes("502")||(l=t.message)!=null&&l.includes("503")?"API service is temporarily unavailable. Please try again later. Tip: Check https://status.openai.com or provider status page.":(d=t.message)!=null&&d.includes("404")||(g=t.message)!=null&&g.includes("model not found")?"Model not found. Please check the model name in settings.":(m=t.message)!=null&&m.includes("quota")||(f=t.message)!=null&&f.includes("billing")?"API quota exceeded or billing issue. Please check your provider dashboard. Tip: Consider using a local LLM like Ollama to avoid API costs.":`Failed to generate completion: ${t.message}`}async callAPIWithRetry(t,e,n){let s=n!=null?n:this.maxRetries,i;for(let a=0;a<=s;a++)try{if(a>0){let o=this.getRetryDelay(a);await this.sleep(o)}return await this.callAPIWithTimeout(t,e)}catch(o){if(i=o,this.shouldNotRetry(o))throw o;if(a<s){let r=this.getRetryDelay(a+1);console.log(`Retry attempt ${a+1}/${s} after ${r}ms`)}}throw i}shouldNotRetry(t){var n;let e=((n=t.message)==null?void 0:n.toLowerCase())||"";return!!(e.includes("401")||e.includes("authentication")||e.includes("404")||e.includes("model not found")||e.includes("429")||e.includes("rate limit")||e.includes("api limit")||e.includes("quota")||e.includes("billing"))}getRetryDelay(t){return this.initialRetryDelayMs*Math.pow(this.retryDelayMultiplier,t-1)}async streamAPI(t,e,n,s){var f,y,b,S;let i,a,o;switch(this.settings.apiProvider){case"openai":{i="https://api.openai.com/v1/chat/completions",a={"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`};let C=[...t];if(e){let x=C.map(v=>v.role).lastIndexOf("user");if(x!==-1){let v=C[x].content;C[x].content=[{type:"text",text:v},{type:"image_url",image_url:{url:e.startsWith("data:")?e:`data:image/jpeg;base64,${e}`}}]}}o={model:e?this.settings.model.includes("vision")?this.settings.model:"gpt-4o":this.settings.model,messages:C,temperature:this.settings.temperature,max_tokens:this.settings.maxTokens,stream:!0};break}case"anthropic":{i="https://api.anthropic.com/v1/messages",a={"Content-Type":"application/json","x-api-key":this.settings.apiKey,"anthropic-version":"2023-06-01"};let C=t.find(v=>v.role==="system"),x=t.filter(v=>v.role!=="system");o={model:this.settings.model,max_tokens:this.settings.maxTokens,temperature:this.settings.temperature,system:C==null?void 0:C.content,messages:x,stream:!0};break}case"ollama":{i=`${this.settings.customApiUrl||"http://localhost:11434"}/api/chat`,a={"Content-Type":"application/json"},o={model:this.settings.model,messages:t,options:{temperature:this.settings.temperature,num_predict:this.settings.maxTokens},stream:!0};break}case"custom":{if(!this.settings.customApiUrl)throw new Error("Custom API URL not configured");i=this.settings.customApiUrl,a={"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`},o={model:this.settings.model,messages:t,temperature:this.settings.temperature,max_tokens:this.settings.maxTokens,stream:!0};break}default:throw new Error(`Unknown API provider: ${this.settings.apiProvider}`)}let r="",c=0,l=0,d=0,g=await(0,Ae.requestUrl)({url:i,method:"POST",headers:a,body:JSON.stringify(o),throw:!1});if(g.status!==200){let C=g.text||"";throw new Error(`API request failed with status ${g.status}: ${C}`)}let m=g.text||"";if(this.settings.apiProvider==="ollama"){let C=m.split(`
`).filter(Boolean);for(let x of C)try{let v=JSON.parse(x);(f=v.message)!=null&&f.content&&(r+=v.message.content,s&&s(r)),v.eval_count&&(d=v.eval_count),v.prompt_eval_count&&(l=v.prompt_eval_count),v.done&&(c=(v.eval_count||0)+(v.prompt_eval_count||0),n&&n({content:r,done:!0,tokensUsed:c,inputTokens:l,outputTokens:d}))}catch(v){console.error("Failed to parse Ollama chunk:",x)}}else{let C=m.split(`
`);for(let x of C)if(x.startsWith("data: ")){let v=x.slice(6);if(v.trim()==="[DONE]"){n&&n({content:r,done:!0,tokensUsed:c,inputTokens:l,outputTokens:d});break}try{let M=JSON.parse(v),Se="";(S=(b=(y=M.choices)==null?void 0:y[0])==null?void 0:b.delta)!=null&&S.content&&(Se=M.choices[0].delta.content||""),M.usage&&(c=M.usage.total_tokens||0,M.usage.prompt_tokens&&(l=M.usage.prompt_tokens),M.usage.completion_tokens&&(d=M.usage.completion_tokens)),Se&&(r+=Se,s&&s(r))}catch(M){console.error("Failed to parse SSE data:",v)}}}return{text:r,tokensUsed:c||0,inputTokens:l,outputTokens:d}}sleep(t){return new Promise(e=>setTimeout(e,t))}async callAPIWithTimeout(t,e){return Promise.race([this.callAPI(t,e),this.timeoutPromise(this.timeoutMs)])}timeoutPromise(t){return new Promise((e,n)=>{setTimeout(()=>{let s=new Error(`Request timeout after ${t}ms`);s.name="AbortError",n(s)},t)})}async callAPI(t,e){var r,c,l,d,g,m;let n,s,i;switch(this.settings.apiProvider){case"openai":{n="https://api.openai.com/v1/chat/completions",s={"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`};let f=[...t];if(e){let y=f.map(b=>b.role).lastIndexOf("user");if(y!==-1){let b=f[y].content;f[y].content=[{type:"text",text:b},{type:"image_url",image_url:{url:e.startsWith("data:")?e:`data:image/jpeg;base64,${e}`}}]}}i={model:e?this.settings.model.includes("vision")?this.settings.model:"gpt-4o":this.settings.model,messages:f,temperature:this.settings.temperature,max_tokens:this.settings.maxTokens};break}case"anthropic":{n="https://api.anthropic.com/v1/messages",s={"Content-Type":"application/json","x-api-key":this.settings.apiKey,"anthropic-version":"2023-06-01"};let f=t.find(b=>b.role==="system"),y=t.filter(b=>b.role!=="system");i={model:this.settings.model,max_tokens:this.settings.maxTokens,temperature:this.settings.temperature,system:f==null?void 0:f.content,messages:y};break}case"ollama":{n=`${this.settings.customApiUrl||"http://localhost:11434"}/api/chat`,s={"Content-Type":"application/json"},i={model:this.settings.model,messages:t,options:{temperature:this.settings.temperature,num_predict:this.settings.maxTokens},stream:!1};break}case"custom":{if(!this.settings.customApiUrl)throw new Error("Custom API URL not configured");n=this.settings.customApiUrl,s={"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`},i={model:this.settings.model,messages:t,temperature:this.settings.temperature,max_tokens:this.settings.maxTokens};break}default:throw new Error(`Unknown API provider: ${this.settings.apiProvider}`)}let a=await(0,Ae.requestUrl)({url:n,method:"POST",headers:s,body:JSON.stringify(i),throw:!1});if(a.status!==200){let f=a.text||"";throw new Error(`API request failed with status ${a.status}: ${f}`)}let o={text:""};return this.settings.apiProvider==="anthropic"?(o.text=a.json.content[0].text,o.tokensUsed=(r=a.json.usage)==null?void 0:r.output_tokens):this.settings.apiProvider==="ollama"?(o.text=((c=a.json.message)==null?void 0:c.content)||"",o.tokensUsed=a.json.eval_count||0,o.inputTokens=a.json.prompt_eval_count||0,o.outputTokens=a.json.eval_count||0):(o.text=a.json.choices[0].message.content,o.inputTokens=(l=a.json.usage)==null?void 0:l.prompt_tokens,o.outputTokens=(d=a.json.usage)==null?void 0:d.completion_tokens,o.tokensUsed=(((g=a.json.usage)==null?void 0:g.prompt_tokens)||0)+(((m=a.json.usage)==null?void 0:m.completion_tokens)||0)),o}};var He=[{id:"summarize",name:"Summarize",description:"Create a concise summary of the text",category:"Writing",prompt:`Please provide a concise summary of the following text, capturing the main points and key takeaways:

{text}`,variables:["text"],isBuiltIn:!0},{id:"expand",name:"Expand Ideas",description:"Elaborate on ideas with more detail",category:"Writing",prompt:`Please expand on the following ideas with more detail, examples, and context:

{text}`,variables:["text"],isBuiltIn:!0},{id:"rewrite-formal",name:"Rewrite (Formal)",description:"Rewrite text in a more formal tone",category:"Writing",prompt:`Please rewrite the following text in a more formal, professional tone while preserving the original meaning:

{text}`,variables:["text"],isBuiltIn:!0},{id:"rewrite-casual",name:"Rewrite (Casual)",description:"Rewrite text in a more casual tone",category:"Writing",prompt:`Please rewrite the following text in a more casual, conversational tone while preserving the original meaning:

{text}`,variables:["text"],isBuiltIn:!0},{id:"proofread",name:"Proofread",description:"Check for grammar, spelling, and style",category:"Writing",prompt:`Please proofread the following text for grammar, spelling, punctuation, and style issues. Provide the corrected version and list the changes made:

{text}`,variables:["text"],isBuiltIn:!0},{id:"shorten",name:"Make Concise",description:"Shorten text while keeping key points",category:"Writing",prompt:`Please make the following text more concise while preserving all key information and meaning:

{text}`,variables:["text"],isBuiltIn:!0},{id:"explain",name:"Explain Simply",description:"Explain a topic in simple terms",category:"Research",prompt:`Please explain the following topic in simple terms that anyone can understand. Use analogies and examples where helpful:

{topic}`,variables:["topic"],isBuiltIn:!0},{id:"compare",name:"Compare & Contrast",description:"Compare two or more items",category:"Research",prompt:`Please compare and contrast the following items, highlighting their similarities, differences, advantages, and disadvantages:

{items}`,variables:["items"],isBuiltIn:!0},{id:"analyze",name:"Analyze",description:"Provide in-depth analysis",category:"Research",prompt:`Please provide an in-depth analysis of the following, including key insights, implications, and considerations:

{subject}`,variables:["subject"],isBuiltIn:!0},{id:"pros-cons",name:"Pros & Cons",description:"List advantages and disadvantages",category:"Research",prompt:`Please list the pros and cons of the following, with explanations for each point:

{subject}`,variables:["subject"],isBuiltIn:!0},{id:"key-points",name:"Extract Key Points",description:"Extract main points as bullet points",category:"Note-taking",prompt:`Please extract the key points from the following text as a bulleted list:

{text}`,variables:["text"],isBuiltIn:!0},{id:"questions",name:"Generate Questions",description:"Create thought-provoking questions",category:"Note-taking",prompt:`Please generate thought-provoking questions about the following topic that would help deepen understanding:

{topic}`,variables:["topic"],isBuiltIn:!0},{id:"outline",name:"Create Outline",description:"Generate a structured outline",category:"Note-taking",prompt:`Please create a detailed, structured outline for the following topic:

{topic}`,variables:["topic"],isBuiltIn:!0},{id:"flashcards",name:"Create Flashcards",description:"Generate Q&A flashcards for studying",category:"Note-taking",prompt:`Please create flashcards (question and answer pairs) from the following content for studying:

{content}`,variables:["content"],isBuiltIn:!0},{id:"action-items",name:"Extract Action Items",description:"Find and list action items/todos",category:"Note-taking",prompt:`Please extract all action items, tasks, and todos from the following text:

{text}`,variables:["text"],isBuiltIn:!0},{id:"explain-code",name:"Explain Code",description:"Explain what code does",category:"Coding",prompt:"Please explain what the following code does, including its purpose, how it works, and any notable patterns or techniques used:\n\n```\n{code}\n```",variables:["code"],isBuiltIn:!0},{id:"debug",name:"Debug Code",description:"Find potential bugs and issues",category:"Coding",prompt:"Please analyze the following code for potential bugs, issues, edge cases, and improvements:\n\n```\n{code}\n```",variables:["code"],isBuiltIn:!0},{id:"refactor",name:"Refactor Code",description:"Suggest code improvements",category:"Coding",prompt:"Please suggest improvements and refactoring for the following code to make it cleaner, more efficient, or more maintainable:\n\n```\n{code}\n```",variables:["code"],isBuiltIn:!0},{id:"document-code",name:"Document Code",description:"Add documentation and comments",category:"Coding",prompt:"Please add comprehensive documentation and comments to the following code:\n\n```\n{code}\n```",variables:["code"],isBuiltIn:!0},{id:"brainstorm",name:"Brainstorm Ideas",description:"Generate creative ideas",category:"Creative",prompt:`Please brainstorm creative ideas related to the following topic. Think outside the box and provide diverse suggestions:

{topic}`,variables:["topic"],isBuiltIn:!0},{id:"write-intro",name:"Write Introduction",description:"Create an engaging introduction",category:"Creative",prompt:`Please write an engaging introduction for a piece about the following topic:

{topic}`,variables:["topic"],isBuiltIn:!0},{id:"write-conclusion",name:"Write Conclusion",description:"Create a strong conclusion",category:"Creative",prompt:`Please write a strong, memorable conclusion for a piece about the following topic, summarizing key points:

{topic}`,variables:["topic"],isBuiltIn:!0}];function ze(){return`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}var V=class extends p.PluginSettingTab{constructor(e,n){super(e,n);this.errorElements=new Map;this.plugin=n}addSettingsActions(e){let n=e.createDiv({cls:"settings-actions"});n.style.display="flex",n.style.gap="0.5rem",n.style.marginBottom="1rem",n.createEl("button",{text:"Export Settings",cls:"mod-cta"}).addEventListener("click",()=>this.exportSettings()),n.createEl("button",{text:"Import Settings",cls:"mod-cta"}).addEventListener("click",()=>this.importSettings());let a=n.createDiv({cls:"setting-item-description"});a.textContent="Backup or restore your configuration"}addProfileSection(e){e.createEl("h3",{text:"AI Profiles"});let n=this.plugin.getActiveProfile();new p.Setting(e).setName("Active Profile").setDesc("Switch between different AI configurations").addDropdown(r=>{this.plugin.settings.profiles.forEach(c=>{r.addOption(c.id,c.name)}),r.setValue(this.plugin.settings.activeProfileId),r.onChange(async c=>{await this.plugin.switchProfile(c),this.display()})});let s=e.createDiv({cls:"profile-actions"});if(s.style.display="flex",s.style.gap="0.5rem",s.style.marginBottom="1rem",s.createEl("button",{text:"Create Profile",cls:"mod-cta"}).addEventListener("click",()=>this.openProfileEditor()),s.createEl("button",{text:"Edit Current"}).addEventListener("click",()=>{n&&this.openProfileEditor(n)}),s.createEl("button",{text:"Duplicate"}).addEventListener("click",async()=>{if(n){let r={...n,id:z(),name:`${n.name} (Copy)`};await this.plugin.createProfile(r),this.display()}}),n&&n.id!=="default"&&s.createEl("button",{text:"Delete",cls:"mod-warning"}).addEventListener("click",async()=>{confirm(`Delete profile "${n.name}"?`)&&(await this.plugin.deleteProfile(n.id),this.display())}),new p.Setting(e).setName("Add from Template").setDesc("Quickly add a preconfigured profile").addDropdown(r=>{r.addOption("","Select template..."),Te.forEach(c=>{r.addOption(c.id,c.name)}),r.onChange(async c=>{if(!c)return;let l=Te.find(d=>d.id===c);if(l){let d={...l,id:z()};await this.plugin.createProfile(d),this.display()}})}),n){let r=e.createDiv({cls:"profile-info"});r.style.padding="0.75rem",r.style.backgroundColor="var(--background-secondary)",r.style.borderRadius="var(--radius-s)",r.style.marginBottom="1rem",r.createEl("strong",{text:`Active: ${n.name}`});let c=r.createDiv();c.style.fontSize="var(--font-smaller)",c.style.color="var(--text-muted)",c.style.marginTop="0.25rem",c.textContent=`Provider: ${n.apiProvider} | Model: ${n.model} | Temp: ${n.temperature}`}}openProfileEditor(e){new Me(this.app,e||null,async s=>{e?await this.plugin.updateProfile(s):await this.plugin.createProfile(s),this.display()}).open()}addTemplatesSection(e){var i;e.createEl("h3",{text:"Prompt Templates"});let n=((i=this.plugin.settings.customTemplates)==null?void 0:i.length)||0,s=He.length;if(new p.Setting(e).setName("Templates").setDesc(`${s} built-in templates, ${n} custom templates`).addButton(a=>a.setButtonText("Create Custom Template").setCta().onClick(()=>this.openTemplateEditor())),n>0){let a=e.createDiv({cls:"custom-templates-list"});a.style.marginTop="0.5rem",a.style.marginBottom="1rem",this.plugin.settings.customTemplates.forEach(o=>{let r=a.createDiv({cls:"template-list-item"});r.style.display="flex",r.style.justifyContent="space-between",r.style.alignItems="center",r.style.padding="0.5rem",r.style.marginBottom="0.25rem",r.style.backgroundColor="var(--background-secondary)",r.style.borderRadius="var(--radius-s)";let c=r.createDiv();c.createEl("strong",{text:o.name});let l=c.createDiv();l.style.fontSize="var(--font-smaller)",l.style.color="var(--text-muted)",l.textContent=`${o.category} - ${o.description}`;let d=r.createDiv({cls:"template-actions"});d.style.display="flex",d.style.gap="0.25rem";let g=d.createEl("button",{text:"Edit"});g.style.fontSize="var(--font-smaller)",g.addEventListener("click",()=>this.openTemplateEditor(o));let m=d.createEl("button",{text:"Delete",cls:"mod-warning"});m.style.fontSize="var(--font-smaller)",m.addEventListener("click",async()=>{if(confirm(`Delete template "${o.name}"?`)){let f=this.plugin.settings.customTemplates.findIndex(y=>y.id===o.id);f>=0&&(this.plugin.settings.customTemplates.splice(f,1),await this.plugin.saveSettings(),this.display(),new p.Notice("Template deleted"))}})})}}openTemplateEditor(e){new Le(this.app,e||null,async s=>{if(this.plugin.settings.customTemplates||(this.plugin.settings.customTemplates=[]),e){let i=this.plugin.settings.customTemplates.findIndex(a=>a.id===s.id);i>=0&&(this.plugin.settings.customTemplates[i]=s)}else this.plugin.settings.customTemplates.push(s);await this.plugin.saveSettings(),this.display(),new p.Notice(e?"Template updated":"Template created")}).open()}display(){let{containerEl:e}=this;e.empty(),this.errorElements.clear(),e.createEl("h2",{text:"Obsidian Agent Settings"}),this.addSettingsActions(e),e.createEl("hr"),this.addProfileSection(e),e.createEl("hr"),this.addTemplatesSection(e),e.createEl("hr"),new p.Setting(e).setName("API Provider").setDesc("Select your AI API provider").addDropdown(n=>n.addOption("openai","OpenAI").addOption("anthropic","Anthropic").addOption("ollama","Ollama (Local)").addOption("custom","Custom API").setValue(this.plugin.settings.apiProvider).onChange(async s=>{switch(this.plugin.settings.apiProvider=s,s){case"ollama":this.plugin.settings.customApiUrl="http://localhost:11434",this.plugin.settings.model="llama3.2";break;case"openai":this.plugin.settings.customApiUrl="",this.plugin.settings.model="gpt-4";break;case"anthropic":this.plugin.settings.customApiUrl="",this.plugin.settings.model="claude-3-sonnet-20240229";break;case"custom":break}await this.plugin.saveSettings(),this.display()})),this.addApiKeySetting(e),(this.plugin.settings.apiProvider==="custom"||this.plugin.settings.apiProvider==="ollama")&&this.addCustomApiUrlSetting(e),this.addModelSetting(e),this.addTemperatureSetting(e),this.addMaxTokensSetting(e),this.addSystemPromptSetting(e),this.addAgentCorePromptSetting(e),this.addEmbeddingSettings(e),this.addContextAwarenessSetting(e),this.addVaultContextSettings(e),this.addConversationPersistenceSetting(e),this.addCacheSettings(e),this.addInlineCompletionSettings(e),this.addSuggestionSettings(e),this.addAccessibilitySettings(e),this.addTokenTrackingSetting(e),this.addReconnectButton(e),this.addTestConnectionButton(e)}addVaultContextSettings(e){e.createEl("h3",{text:"Vault-Wide Context"});let n=e.createEl("p",{cls:"setting-item-description"});n.textContent="Include content from related notes to give AI more context about your knowledge base.",n.style.marginBottom="1rem",new p.Setting(e).setName("Include Linked Notes").setDesc("Add content from notes linked in the current note").addToggle(s=>{var i;return s.setValue(((i=this.plugin.settings.contextConfig)==null?void 0:i.enableLinkedNotes)||!1).onChange(async a=>{this.plugin.settings.contextConfig||(this.plugin.settings.contextConfig={enableLinkedNotes:!1,enableBacklinks:!1,enableTagContext:!1,enableFolderContext:!1,maxNotesPerSource:5,maxTokensPerNote:1e3,linkDepth:1,excludeFolders:"templates, .obsidian"}),this.plugin.settings.contextConfig.enableLinkedNotes=a,await this.plugin.saveSettings()})}),new p.Setting(e).setName("Include Backlinks").setDesc("Add content from notes that link TO the current note").addToggle(s=>{var i;return s.setValue(((i=this.plugin.settings.contextConfig)==null?void 0:i.enableBacklinks)||!1).onChange(async a=>{this.plugin.settings.contextConfig||(this.plugin.settings.contextConfig={enableLinkedNotes:!1,enableBacklinks:!1,enableTagContext:!1,enableFolderContext:!1,maxNotesPerSource:5,maxTokensPerNote:1e3,linkDepth:1,excludeFolders:"templates, .obsidian"}),this.plugin.settings.contextConfig.enableBacklinks=a,await this.plugin.saveSettings()})}),new p.Setting(e).setName("Include Same-Tag Notes").setDesc("Add content from notes with the same tags").addToggle(s=>{var i;return s.setValue(((i=this.plugin.settings.contextConfig)==null?void 0:i.enableTagContext)||!1).onChange(async a=>{this.plugin.settings.contextConfig||(this.plugin.settings.contextConfig={enableLinkedNotes:!1,enableBacklinks:!1,enableTagContext:!1,enableFolderContext:!1,maxNotesPerSource:5,maxTokensPerNote:1e3,linkDepth:1,excludeFolders:"templates, .obsidian"}),this.plugin.settings.contextConfig.enableTagContext=a,await this.plugin.saveSettings()})}),new p.Setting(e).setName("Include Folder Notes").setDesc("Add content from notes in the same folder").addToggle(s=>{var i;return s.setValue(((i=this.plugin.settings.contextConfig)==null?void 0:i.enableFolderContext)||!1).onChange(async a=>{this.plugin.settings.contextConfig||(this.plugin.settings.contextConfig={enableLinkedNotes:!1,enableBacklinks:!1,enableTagContext:!1,enableFolderContext:!1,maxNotesPerSource:5,maxTokensPerNote:1e3,linkDepth:1,excludeFolders:"templates, .obsidian"}),this.plugin.settings.contextConfig.enableFolderContext=a,await this.plugin.saveSettings()})}),new p.Setting(e).setName("Max Notes Per Source").setDesc("Maximum number of notes to include from each source").addText(s=>{var i;return s.setPlaceholder("5").setValue(String(((i=this.plugin.settings.contextConfig)==null?void 0:i.maxNotesPerSource)||5)).onChange(async a=>{let o=parseInt(a);this.plugin.settings.contextConfig||(this.plugin.settings.contextConfig={enableLinkedNotes:!1,enableBacklinks:!1,enableTagContext:!1,enableFolderContext:!1,maxNotesPerSource:5,maxTokensPerNote:1e3,linkDepth:1,excludeFolders:"templates, .obsidian"}),this.plugin.settings.contextConfig.maxNotesPerSource=isNaN(o)?5:Math.max(1,o),await this.plugin.saveSettings()})}),new p.Setting(e).setName("Max Tokens Per Note").setDesc("Maximum tokens to include from each additional note").addText(s=>{var i;return s.setPlaceholder("1000").setValue(String(((i=this.plugin.settings.contextConfig)==null?void 0:i.maxTokensPerNote)||1e3)).onChange(async a=>{let o=parseInt(a);this.plugin.settings.contextConfig||(this.plugin.settings.contextConfig={enableLinkedNotes:!1,enableBacklinks:!1,enableTagContext:!1,enableFolderContext:!1,maxNotesPerSource:5,maxTokensPerNote:1e3,linkDepth:1,excludeFolders:"templates, .obsidian"}),this.plugin.settings.contextConfig.maxTokensPerNote=isNaN(o)?1e3:Math.max(100,o),await this.plugin.saveSettings()})}),new p.Setting(e).setName("Link Depth").setDesc("How many levels of links to follow (1 = direct links only)").addDropdown(s=>{var i;return s.addOption("1","1 (Direct links)").addOption("2","2 (Links of links)").setValue(String(((i=this.plugin.settings.contextConfig)==null?void 0:i.linkDepth)||1)).onChange(async a=>{this.plugin.settings.contextConfig||(this.plugin.settings.contextConfig={enableLinkedNotes:!1,enableBacklinks:!1,enableTagContext:!1,enableFolderContext:!1,maxNotesPerSource:5,maxTokensPerNote:1e3,linkDepth:1,excludeFolders:"templates, .obsidian"}),this.plugin.settings.contextConfig.linkDepth=parseInt(a),await this.plugin.saveSettings()})}),new p.Setting(e).setName("Exclude Folders").setDesc("Folders to exclude from context (comma-separated)").addText(s=>{var i;return s.setPlaceholder("templates, .obsidian").setValue(((i=this.plugin.settings.contextConfig)==null?void 0:i.excludeFolders)||"templates, .obsidian").onChange(async a=>{this.plugin.settings.contextConfig||(this.plugin.settings.contextConfig={enableLinkedNotes:!1,enableBacklinks:!1,enableTagContext:!1,enableFolderContext:!1,maxNotesPerSource:5,maxTokensPerNote:1e3,linkDepth:1,excludeFolders:"templates, .obsidian"}),this.plugin.settings.contextConfig.excludeFolders=a,await this.plugin.saveSettings()})})}addCacheSettings(e){var i;e.createEl("h3",{text:"Response Caching"});let n=e.createEl("p",{cls:"setting-item-description"});n.textContent="Cache AI responses to reduce API costs and improve response time for repeated queries.",n.style.marginBottom="1rem",this.plugin.settings.cacheConfig||(this.plugin.settings.cacheConfig={enabled:!0,maxEntries:100,maxAgeDays:30,matchThreshold:1}),new p.Setting(e).setName("Enable Response Caching").setDesc("Cache identical queries to save API calls").addToggle(a=>a.setValue(this.plugin.settings.cacheConfig.enabled).onChange(async o=>{var r,c;this.plugin.settings.cacheConfig.enabled=o,await this.plugin.saveSettings(),(c=(r=this.plugin.aiService)==null?void 0:r.getCacheService())==null||c.setEnabled(o)})),new p.Setting(e).setName("Max Cache Entries").setDesc("Maximum number of cached responses (oldest removed first)").addText(a=>a.setPlaceholder("100").setValue(String(this.plugin.settings.cacheConfig.maxEntries)).onChange(async o=>{var c;let r=parseInt(o);this.plugin.settings.cacheConfig.maxEntries=isNaN(r)?100:Math.max(10,r),await this.plugin.saveSettings(),(c=this.plugin.aiService)==null||c.updateCacheSettings(this.plugin.settings)})),new p.Setting(e).setName("Cache Expiration (Days)").setDesc("How long to keep cached responses").addText(a=>a.setPlaceholder("30").setValue(String(this.plugin.settings.cacheConfig.maxAgeDays)).onChange(async o=>{var c;let r=parseInt(o);this.plugin.settings.cacheConfig.maxAgeDays=isNaN(r)?30:Math.max(1,r),await this.plugin.saveSettings(),(c=this.plugin.aiService)==null||c.updateCacheSettings(this.plugin.settings)}));let s=(i=this.plugin.aiService)==null?void 0:i.getCacheService();if(s){let a=s.getStats(),o=s.getHitRate(),r=s.getEstimatedCostSavings(),c=e.createDiv({cls:"cache-stats"});c.style.padding="1rem",c.style.backgroundColor="var(--background-secondary)",c.style.borderRadius="var(--radius-s)",c.style.marginBottom="1rem",c.createEl("h4",{text:"Cache Statistics"}),c.style.marginTop="0";let l=c.createDiv({cls:"stats-grid"});l.style.display="grid",l.style.gridTemplateColumns="repeat(2, 1fr)",l.style.gap="0.5rem",l.style.marginTop="0.5rem",this.createStatCard(l,"Cached Entries",String(a.totalEntries)),this.createStatCard(l,"Cache Hits",String(a.totalHits)),this.createStatCard(l,"Cache Misses",String(a.totalMisses)),this.createStatCard(l,"Hit Rate",`${o.toFixed(1)}%`),this.createStatCard(l,"Tokens Saved",String(a.estimatedSavings)),this.createStatCard(l,"Est. Savings",`$${r.toFixed(4)}`),this.createStatCard(l,"Cache Size",s.getFormattedCacheSize());let d=c.createDiv({cls:"cache-actions"});d.style.display="flex",d.style.gap="0.5rem",d.style.marginTop="1rem",d.createEl("button",{text:"Clear Cache",cls:"mod-warning"}).addEventListener("click",async()=>{confirm("Clear all cached responses? This cannot be undone.")&&(s.clearCache(),this.plugin.settings.cacheData={entries:[],stats:s.getStats()},await this.plugin.saveSettings(),this.display(),new p.Notice("Cache cleared"))}),d.createEl("button",{text:"Clean Expired"}).addEventListener("click",async()=>{let y=s.cleanExpired(),b=s.exportCache();this.plugin.settings.cacheData={entries:b.entries,stats:b.stats},await this.plugin.saveSettings(),this.display(),new p.Notice(`Removed ${y} expired entries`)}),d.createEl("button",{text:"Reset Stats"}).addEventListener("click",async()=>{s.resetStats();let y=s.exportCache();this.plugin.settings.cacheData={entries:y.entries,stats:y.stats},await this.plugin.saveSettings(),this.display(),new p.Notice("Statistics reset")}),a.totalEntries>0&&d.createEl("button",{text:"View Entries"}).addEventListener("click",()=>{new De(this.app,this.plugin).open()})}}getCompletionConfig(){let e=this.plugin.settings.completionConfig;return e?this.plugin.settings.completionConfig={...E,...e,phraseTriggers:Array.isArray(e.phraseTriggers)&&e.phraseTriggers.length?e.phraseTriggers:[...E.phraseTriggers],excludedFolders:Array.isArray(e.excludedFolders)&&e.excludedFolders.length?e.excludedFolders:[...E.excludedFolders]}:this.plugin.settings.completionConfig={...E},this.plugin.settings.completionConfig}addInlineCompletionSettings(e){e.createEl("h3",{text:"Inline Completions"});let n=this.getCompletionConfig();new p.Setting(e).setName("Enable Inline Completions").setDesc("Show AI suggestions while typing inside the editor").addToggle(s=>s.setValue(n.enabled).onChange(async i=>{n.enabled=i,await this.plugin.saveSettings()})),new p.Setting(e).setName("Trigger Mode").setDesc("Manual = hotkey only, Auto = after a pause, Both = either").addDropdown(s=>s.addOption("manual","Manual").addOption("auto","Auto").addOption("both","Both").setValue(n.triggerMode).onChange(async i=>{n.triggerMode=i,await this.plugin.saveSettings()})),new p.Setting(e).setName("Auto Trigger Delay (ms)").setDesc("How long to wait after typing before auto suggestions run").addText(s=>s.setPlaceholder(String(E.autoTriggerDelay)).setValue(String(n.autoTriggerDelay)).onChange(async i=>{let a=parseInt(i,10);n.autoTriggerDelay=isNaN(a)?E.autoTriggerDelay:Math.max(200,a),await this.plugin.saveSettings()})),new p.Setting(e).setName("Manual Shortcut").setDesc("Keyboard shortcut to trigger completion (e.g., ctrl+space)").addText(s=>s.setValue(n.manualTriggerShortcut).onChange(async i=>{n.manualTriggerShortcut=i.trim()||E.manualTriggerShortcut,await this.plugin.saveSettings()})),new p.Setting(e).setName("Phrase Triggers").setDesc("Comma-separated endings that auto-request completions (e.g., ..., //)").addText(s=>s.setValue(n.phraseTriggers.join(", ")).onChange(async i=>{n.phraseTriggers=i.split(",").map(a=>a.trim()).filter(Boolean),await this.plugin.saveSettings()})),new p.Setting(e).setName("Max Suggestions per Request").setDesc("Limit how many completions are offered each time").addSlider(s=>s.setLimits(1,10,1).setDynamicTooltip().setValue(n.maxCompletions).onChange(async i=>{n.maxCompletions=i,await this.plugin.saveSettings()})),new p.Setting(e).setName("Max Tokens per Completion").setDesc("Shorter values keep inline completions snappy").addText(s=>s.setPlaceholder(String(E.maxTokens)).setValue(String(n.maxTokens)).onChange(async i=>{let a=parseInt(i,10);n.maxTokens=isNaN(a)?E.maxTokens:Math.max(16,a),await this.plugin.saveSettings()})),new p.Setting(e).setName("Show in Markdown Only").setDesc("Disable completions in other editor types").addToggle(s=>s.setValue(n.showInMarkdownOnly).onChange(async i=>{n.showInMarkdownOnly=i,await this.plugin.saveSettings()})),new p.Setting(e).setName("Excluded Folders").setDesc("Comma-separated list of folders where completions stay off").addText(s=>s.setPlaceholder(E.excludedFolders.join(", ")).setValue(n.excludedFolders.join(", ")).onChange(async i=>{n.excludedFolders=i.split(",").map(a=>a.trim()).filter(Boolean),await this.plugin.saveSettings()}))}getSuggestionConfig(){let e=this.plugin.settings.suggestionConfig;return e?this.plugin.settings.suggestionConfig={..._,...e,suggestionTypes:{..._.suggestionTypes,...e.suggestionTypes||{}}}:this.plugin.settings.suggestionConfig={..._},this.plugin.settings.suggestionConfig}addSuggestionSettings(e){e.createEl("h3",{text:"Intelligent Suggestions"});let n=this.getSuggestionConfig();new p.Setting(e).setName("Enable Suggestions").setDesc("Analyze the current note and propose improvements automatically").addToggle(i=>i.setValue(n.enabled).onChange(async a=>{n.enabled=a,await this.plugin.saveSettings()})),new p.Setting(e).setName("Auto Analyze Notes").setDesc("Run analysis automatically when you stop typing").addToggle(i=>i.setValue(n.autoAnalyze).onChange(async a=>{n.autoAnalyze=a,await this.plugin.saveSettings()})),new p.Setting(e).setName("Max Suggestions per Note").setDesc("Keep the list focused on the most useful actions").addSlider(i=>i.setLimits(1,10,1).setDynamicTooltip().setValue(n.maxSuggestions).onChange(async a=>{n.maxSuggestions=a,await this.plugin.saveSettings()})),new p.Setting(e).setName("Privacy Mode").setDesc("Choose whether to use cloud, local, or hybrid analysis models").addDropdown(i=>i.addOption("cloud","Cloud").addOption("local","Local only").addOption("hybrid","Hybrid (auto choose)").setValue(n.privacyMode).onChange(async a=>{n.privacyMode=a,await this.plugin.saveSettings()}));let s={links:"Link suggestions",tags:"Tag suggestions",summaries:"Summary prompts",todos:"TODO extraction",improvements:"Writing improvements",expansions:"Expansion ideas",organization:"Organization hints"};e.createEl("h4",{text:"Suggestion Types"}),Object.entries(s).forEach(([i,a])=>{new p.Setting(e).setName(a).addToggle(o=>o.setValue(n.suggestionTypes[i]).onChange(async r=>{n.suggestionTypes[i]=r,await this.plugin.saveSettings()}))})}addEmbeddingSettings(e){e.createEl("h3",{text:"Embedding & Semantic Brain"});let n=this.plugin.settings.embeddingConfig||{provider:"openai",model:"text-embedding-3-small",enabled:!1,autoRefresh:!0};new p.Setting(e).setName("Enable Semantic Features").setDesc("Enable vector embeddings for Semantic Search and Memory").addToggle(s=>s.setValue(n.enabled).onChange(async i=>{this.plugin.settings.embeddingConfig.enabled=i,await this.plugin.saveSettings(),this.display()})),n.enabled&&(new p.Setting(e).setName("Embedding Provider").setDesc("Select provider for generating vector embeddings").addDropdown(s=>s.addOption("openai","OpenAI (Requires Key)").addOption("ollama","Ollama (Local)").addOption("local","Local Transformers (Soon)").setValue(n.provider).onChange(async i=>{this.plugin.settings.embeddingConfig.provider=i,i==="ollama"&&!this.plugin.settings.embeddingConfig.model&&(this.plugin.settings.embeddingConfig.model="nomic-embed-text"),await this.plugin.saveSettings(),this.display()})),new p.Setting(e).setName("Embedding Model").setDesc("Model used for vectorization").addText(s=>s.setPlaceholder(n.provider==="openai"?"text-embedding-3-small":"nomic-embed-text").setValue(n.model).onChange(async i=>{this.plugin.settings.embeddingConfig.model=i,await this.plugin.saveSettings()})))}addConversationPersistenceSetting(e){var i;e.createEl("h3",{text:"Conversation History"}),new p.Setting(e).setName("Enable Conversation Persistence").setDesc("Save conversations across sessions").addToggle(a=>a.setValue(this.plugin.settings.enableConversationPersistence).onChange(async o=>{this.plugin.settings.enableConversationPersistence=o,await this.plugin.saveSettings()})),new p.Setting(e).setName("Max Saved Conversations").setDesc("Maximum number of conversations to keep (oldest are deleted)").addText(a=>a.setPlaceholder("20").setValue(String(this.plugin.settings.maxConversations)).onChange(async o=>{let r=parseInt(o);this.plugin.settings.maxConversations=isNaN(r)||r<1?20:r,await this.plugin.saveSettings()}));let n=((i=this.plugin.settings.conversations)==null?void 0:i.length)||0,s=new p.Setting(e).setName("Saved Conversations").setDesc(`${n} conversation(s) saved`);n>0&&s.addButton(a=>a.setButtonText("Clear All").setWarning().onClick(async()=>{confirm("Delete all saved conversations? This cannot be undone.")&&(this.plugin.settings.conversations=[],this.plugin.settings.activeConversationId=void 0,await this.plugin.saveSettings(),this.display(),new p.Notice("All conversations deleted"))}))}addAccessibilitySettings(e){e.createEl("h3",{text:"Accessibility"});let n=e.createEl("p",{cls:"setting-item-description"});n.textContent="Customize plugin for your accessibility needs.",n.style.marginBottom="1rem",this.plugin.settings.accessibilityConfig||(this.plugin.settings.accessibilityConfig={enableHighContrast:!1,enableReducedMotion:!1}),new p.Setting(e).setName("High Contrast Mode").setDesc("Increase color contrast for better visibility").addToggle(s=>s.setValue(this.plugin.settings.accessibilityConfig.enableHighContrast).onChange(async i=>{this.plugin.settings.accessibilityConfig.enableHighContrast=i,await this.plugin.saveSettings(),this.plugin.applyAccessibilitySettings(),new p.Notice(i?"High contrast enabled":"High contrast disabled")})),new p.Setting(e).setName("Reduced Motion").setDesc("Disable animations and transitions (also respects system preference)").addToggle(s=>s.setValue(this.plugin.settings.accessibilityConfig.enableReducedMotion).onChange(async i=>{this.plugin.settings.accessibilityConfig.enableReducedMotion=i,await this.plugin.saveSettings(),this.plugin.applyAccessibilitySettings(),new p.Notice(i?"Reduced motion enabled":"Reduced motion disabled")}))}addTokenTrackingSetting(e){new p.Setting(e).setName("Enable Token Tracking").setDesc("Track API token usage and estimate costs").addToggle(n=>n.setValue(this.plugin.settings.enableTokenTracking).onChange(async s=>{this.plugin.settings.enableTokenTracking=s,await this.plugin.saveSettings()})),new p.Setting(e).setName("Cost Warning Threshold ($)").setDesc("Show warning when estimated cost exceeds this amount").addText(n=>n.setPlaceholder("10").setValue(String(this.plugin.settings.costThreshold)).onChange(async s=>{let i=parseFloat(s);this.plugin.settings.costThreshold=isNaN(i)?10:i,await this.plugin.saveSettings()})),this.addUsageSummary(e)}addUsageSummary(e){let n=e.createDiv({cls:"usage-summary"});n.style.marginTop="1.5rem",n.style.padding="1rem",n.style.border="1px solid var(--background-modifier-border)",n.style.borderRadius="var(--radius-s)",n.style.backgroundColor="var(--background-secondary)";let s=this.plugin.settings,i=s.totalTokensUsed||0,a=s.totalRequests||0,o=s.estimatedCost||0;n.createEl("h3",{text:"Usage Summary"});let r=n.createDiv({cls:"stats-grid"});if(r.style.display="grid",r.style.gridTemplateColumns="repeat(2, 1fr)",r.style.gap="0.5rem",r.style.marginTop="0.5rem",this.createStatCard(r,"Total Requests",String(a)),this.createStatCard(r,"Tokens Used",String(i)),this.createStatCard(r,"Estimated Cost",`$${o.toFixed(2)}`),i>0){let l=(i/a).toFixed(0);this.createStatCard(r,"Avg Tokens/Request",l)}let c=n.createEl("button",{text:"Export Usage Data (CSV)",cls:"mod-cta"});c.style.marginTop="1rem",c.addEventListener("click",()=>this.exportUsageData())}createStatCard(e,n,s){let i=e.createDiv({cls:"stat-card"});i.style.padding="0.5rem",i.style.borderRadius="var(--radius-s)",i.style.backgroundColor="var(--background-primary)";let a=i.createDiv({cls:"stat-label"});a.style.fontSize="var(--font-smaller)",a.style.color="var(--text-muted)",a.textContent=n;let o=i.createDiv({cls:"stat-value"});o.style.fontSize="var(--font-ui-large)",o.style.fontWeight="bold",o.textContent=s}exportUsageData(){let e=this.plugin.settings,n=["Metric,Value",`Total Requests,${e.totalRequests||0}`,`Total Tokens Used,${e.totalTokensUsed||0}`,`Estimated Cost ($),${(e.estimatedCost||0).toFixed(2)}`,`Export Date,${new Date().toISOString()}`].join(`
`),s=new Blob([n],{type:"text/csv"}),i=URL.createObjectURL(s),a=document.createElement("a");a.href=i,a.download=`obsidian-agent-usage-${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i),new p.Notice("Usage data exported")}addApiKeySetting(e){let n=this.plugin.settings.apiProvider==="ollama";new p.Setting(e).setName("API Key").setDesc(n?"Not required for Ollama":"Enter your API key for the selected provider").addText(s=>{s.setPlaceholder(n?"N/A":"Enter your API key").setValue(this.plugin.settings.apiKey).onChange(async i=>{this.plugin.settings.apiKey=i,await this.plugin.saveSettings(),this.validateApiKeySetting(i,e)}),s.inputEl.disabled=n,n&&(s.inputEl.style.opacity="0.5")}),this.validateApiKeySetting(this.plugin.settings.apiKey,e)}validateApiKeySetting(e,n){let i=Array.from(n.querySelectorAll(".setting-item")).find(a=>{var o;return(o=a.textContent)==null?void 0:o.includes("API Key")});i&&(this.clearError("apiKey",i),this.plugin.settings.apiProvider!=="custom"&&!e.trim()&&this.showError("apiKey",i,"API Key is required for this provider"))}addCustomApiUrlSetting(e){new p.Setting(e).setName("Custom API URL").setDesc("Enter URL for your custom API endpoint").addText(n=>n.setPlaceholder("https://api.example.com/v1/chat").setValue(this.plugin.settings.customApiUrl).onChange(async s=>{this.plugin.settings.customApiUrl=s,await this.plugin.saveSettings(),this.validateCustomApiUrlSetting(s,e)})),this.validateCustomApiUrlSetting(this.plugin.settings.customApiUrl,e)}validateCustomApiUrlSetting(e,n){let i=Array.from(n.querySelectorAll(".setting-item")).find(a=>{var o;return(o=a.textContent)==null?void 0:o.includes("Custom API URL")});i&&(this.clearError("customApiUrl",i),e.trim()?this.isValidUrl(e)||this.showError("customApiUrl",i,"Please enter a valid URL (e.g., https://api.example.com/v1/chat)"):this.showError("customApiUrl",i,"Custom API URL is required when using Custom API provider"))}isValidUrl(e){try{return new URL(e),!0}catch(n){return!1}}addModelSetting(e){new p.Setting(e).setName("Model").setDesc("AI model to use").addText(n=>n.setPlaceholder("gpt-4").setValue(this.plugin.settings.model).onChange(async s=>{this.plugin.settings.model=s,await this.plugin.saveSettings(),this.validateModelSetting(s,e)})),this.validateModelSetting(this.plugin.settings.model,e)}validateModelSetting(e,n){let i=Array.from(n.querySelectorAll(".setting-item")).find(a=>{var o,r;return((o=a.textContent)==null?void 0:o.includes("Model"))&&!((r=a.textContent)!=null&&r.includes("Temperature"))});i&&(this.clearError("model",i),e.trim()||this.showError("model",i,"Model name is required"))}addTemperatureSetting(e){new p.Setting(e).setName("Temperature").setDesc("Controls randomness (0-1). Higher values make output more random.").addSlider(n=>n.setLimits(0,1,.1).setValue(this.plugin.settings.temperature).setDynamicTooltip().onChange(async s=>{this.plugin.settings.temperature=s,await this.plugin.saveSettings()}))}addMaxTokensSetting(e){new p.Setting(e).setName("Max Tokens").setDesc("Maximum number of tokens to generate").addText(n=>n.setPlaceholder("2000").setValue(String(this.plugin.settings.maxTokens)).onChange(async s=>{let i=parseInt(s);this.plugin.settings.maxTokens=isNaN(i)?2e3:i,await this.plugin.saveSettings(),this.validateMaxTokensSetting(s,e)})),this.validateMaxTokensSetting(String(this.plugin.settings.maxTokens),e)}validateMaxTokensSetting(e,n){let i=Array.from(n.querySelectorAll(".setting-item")).find(o=>{var r;return(r=o.textContent)==null?void 0:r.includes("Max Tokens")});if(!i)return;this.clearError("maxTokens",i);let a=parseInt(e);isNaN(a)||a<1?this.showError("maxTokens",i,"Max Tokens must be a positive integer (at least 1)"):a>1e5&&this.showError("maxTokens",i,"Max Tokens value is too large. Please use a reasonable value (e.g., 2000-8000)")}addSystemPromptSetting(e){new p.Setting(e).setName("System Prompt").setDesc("The system prompt that defines AI assistant behavior").addTextArea(n=>n.setPlaceholder("You are a helpful assistant...").setValue(this.plugin.settings.systemPrompt).onChange(async s=>{this.plugin.settings.systemPrompt=s,await this.plugin.saveSettings()}))}addAgentCorePromptSetting(e){new p.Setting(e).setName("Agent Core Prompt").setDesc("The core prompt that defines the autonomous agent's behavior, personality, and momentum policy").addTextArea(n=>{n.setPlaceholder("You are an intelligent AI assistant...").setValue(this.plugin.settings.agentCorePrompt).onChange(async s=>{this.plugin.settings.agentCorePrompt=s,await this.plugin.saveSettings()}),n.inputEl.rows=15,n.inputEl.style.width="100%",n.inputEl.style.fontFamily="var(--font-monospace)",n.inputEl.style.fontSize="12px"}),new p.Setting(e).setDesc("Reset agent prompt to default (includes Momentum Policy for forward-motion responses)").addButton(n=>n.setButtonText("Reset to Default").onClick(async()=>{let s=`You are an intelligent AI assistant helping a user with their Obsidian vault.

**MOMENTUM POLICY - YOU MUST FOLLOW THIS:**
Every response MUST include a concrete next step. This is a hard requirement, not a preference.
- Never end with only explanation
- If uncertain, propose the safest low-cost validation step
- If multiple paths exist, provide 2-3 options and recommend one
- If blocked by missing info, state exactly what to collect, then provide a temporary fallback action
- Prefer progress over perfection while respecting safety constraints

**Your capabilities:**
- Search the vault for relevant notes
- Read and analyze note contents
- Create new notes when helpful
- Update existing notes
- Remember important facts about the user
- List and explore folder contents

**Response Format Required:**
1. **Direct answer** (concise, to the point)
2. **Brief reasoning** (why this approach works)
3. **\u{1F3AF} NEXT STEP** (MANDATORY - you must always include this):
   - Action: <what specific action to take>
   - Owner: <user|agent - who will do it>
   - Effort: <5m|30m|half-day|1-day|2-days+>
   - Success looks like: <how you'll know it worked>
4. **Alternative paths** (if multiple good options exist)
5. **\u26A0\uFE0F Risks & Mitigation** (for non-trivial actions)

**Guidelines for helpful responses:**
1. Be conversational and natural - avoid robotic or mechanical language
2. When searches return no results, offer to create new content or suggest alternatives
3. Provide clear, well-formatted responses using markdown
4. Use tools proactively to gather information before answering
5. Cite sources using [[note-name]] format when referencing vault content
6. Be honest when you don't know something
7. Maintain a 70/30 ratio: 70% answer, 30% next action

**Avoid dead-end responses:**
- Don't end with "It depends..." unless you list specific options
- Don't say "You could..." without a clear recommendation
- Don't ask questions without suggesting answers
- Don't list options without recommending the best one for this context

**Remember:** You're here to help the user organize knowledge, improve writing, and discover connections in their notes. Focus on being genuinely helpful AND maintaining forward motion. Every response should advance the task.`;this.plugin.settings.agentCorePrompt=s,await this.plugin.saveSettings(),this.display()}))}addContextAwarenessSetting(e){new p.Setting(e).setName("Enable Context Awareness").setDesc("Allow agent to access current note context").addToggle(n=>n.setValue(this.plugin.settings.enableContextAwareness).onChange(async s=>{this.plugin.settings.enableContextAwareness=s,await this.plugin.saveSettings()}))}addReconnectButton(e){let n=e.createDiv({cls:"setting-item"}),s=n.createEl("button",{text:"Reconnect LLM",cls:"mod-cta"});s.addEventListener("click",async()=>{try{s.disabled=!0,s.textContent="Connecting...",this.plugin.aiService=new R(this.plugin.settings),new p.Notice("LLM connection refreshed successfully")}catch(a){new p.Notice(`Failed to reconnect: ${a.message}`),console.error("Reconnect Error:",a)}finally{s.disabled=!1,s.textContent="Reconnect LLM"}});let i=n.createDiv({cls:"setting-item-description"});i.textContent="Reinitialize LLM connection (useful after changing provider or API key)"}addTestConnectionButton(e){let n=e.createDiv({cls:"setting-item"}),s=n.createEl("button",{text:"Test Connection",cls:"mod-cta"});s.addEventListener("click",async()=>{try{s.disabled=!0,s.textContent="Testing...";let a=await this.plugin.aiService.testConnection();a.success?new p.Notice(`Connection successful! Response time: ${a.responseTime}ms`):new p.Notice(`Connection failed: ${a.message}`,5e3)}catch(a){new p.Notice(`Test failed: ${a.message}`,5e3),console.error("Test Connection Error:",a)}finally{s.disabled=!1,s.textContent="Test Connection"}});let i=n.createDiv({cls:"setting-item-description"});i.textContent="Verify your API configuration is working correctly"}showError(e,n,s){let i=this.errorElements.get(e);i||(i=n.createDiv({cls:"setting-error"}),i.style.color="var(--text-error)",i.style.fontSize="var(--font-smaller)",i.style.marginTop="0.5rem",this.errorElements.set(e,i)),i.textContent=s}clearError(e,n){let s=this.errorElements.get(e);s&&(s.remove(),this.errorElements.delete(e))}exportSettings(){let e={...this.plugin.settings,apiKey:this.plugin.settings.apiKey?"***":""},n=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),s=URL.createObjectURL(n),i=document.createElement("a");i.href=s,i.download=`obsidian-agent-settings-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s),new p.Notice("Settings exported successfully")}async importSettings(){let e=document.createElement("input");e.type="file",e.accept="application/json",e.onchange=async n=>{var i;let s=(i=n.target.files)==null?void 0:i[0];if(s)try{let a=await s.text(),o=JSON.parse(a),r=["apiProvider","model","temperature","maxTokens","systemPrompt","enableContextAwareness"];for(let l of r)if(!(l in o)){new p.Notice("Invalid settings file: missing required fields",3e3);return}if(!confirm("This will overwrite your current settings. Continue?"))return;Object.assign(this.plugin.settings,o),o.apiKey==="***"&&(this.plugin.settings.apiKey=""),await this.plugin.saveSettings(),this.display(),new p.Notice("Settings imported successfully")}catch(a){new p.Notice(`Failed to import settings: ${a.message}`,3e3),console.error("Import Error:",a)}},document.body.appendChild(e),e.click(),document.body.removeChild(e)}},Me=class extends p.Modal{constructor(t,e,n){super(t),this.profile=e,this.onSave=n,this.formData=e?{...e}:{id:z(),name:"",apiProvider:"openai",apiKey:"",customApiUrl:"",model:"gpt-4",temperature:.7,maxTokens:2e3,systemPrompt:"You are a helpful AI assistant integrated into Obsidian."}}onOpen(){let{contentEl:t}=this;t.createEl("h2",{text:this.profile?"Edit Profile":"Create Profile"}),new p.Setting(t).setName("Profile Name").addText(i=>i.setPlaceholder("My Profile").setValue(this.formData.name).onChange(a=>this.formData.name=a)),new p.Setting(t).setName("API Provider").addDropdown(i=>i.addOption("openai","OpenAI").addOption("anthropic","Anthropic").addOption("ollama","Ollama (Local)").addOption("custom","Custom API").setValue(this.formData.apiProvider).onChange(a=>{switch(this.formData.apiProvider=a,a){case"ollama":this.formData.customApiUrl="http://localhost:11434",this.formData.model="llama3.2";break;case"openai":this.formData.customApiUrl="",this.formData.model="gpt-4";break;case"anthropic":this.formData.customApiUrl="",this.formData.model="claude-3-sonnet-20240229";break;case"custom":break}})),new p.Setting(t).setName("API Key").setDesc("Leave empty for Ollama").addText(i=>i.setPlaceholder("sk-...").setValue(this.formData.apiKey).onChange(a=>this.formData.apiKey=a)),new p.Setting(t).setName("Custom API URL").setDesc("Required for Custom/Ollama providers").addText(i=>i.setPlaceholder("http://localhost:11434").setValue(this.formData.customApiUrl).onChange(a=>this.formData.customApiUrl=a)),new p.Setting(t).setName("Model").addText(i=>i.setPlaceholder("gpt-4").setValue(this.formData.model).onChange(a=>this.formData.model=a)),new p.Setting(t).setName("Temperature").addSlider(i=>i.setLimits(0,1,.1).setValue(this.formData.temperature).setDynamicTooltip().onChange(a=>this.formData.temperature=a)),new p.Setting(t).setName("Max Tokens").addText(i=>i.setPlaceholder("2000").setValue(String(this.formData.maxTokens)).onChange(a=>{let o=parseInt(a);this.formData.maxTokens=isNaN(o)?2e3:o})),new p.Setting(t).setName("System Prompt").addTextArea(i=>i.setPlaceholder("You are a helpful assistant...").setValue(this.formData.systemPrompt).onChange(a=>this.formData.systemPrompt=a));let e=t.createDiv({cls:"button-container"});e.style.display="flex",e.style.justifyContent="flex-end",e.style.gap="0.5rem",e.style.marginTop="1rem",e.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),e.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",()=>{if(!this.formData.name.trim()){new p.Notice("Profile name is required");return}this.onSave(this.formData),this.close()})}onClose(){let{contentEl:t}=this;t.empty()}},Le=class extends p.Modal{constructor(t,e,n){super(t),this.template=e,this.onSave=n,this.formData=e?{...e}:{id:ze(),name:"",description:"",category:"Custom",prompt:"",variables:[],isBuiltIn:!1}}onOpen(){let{contentEl:t}=this;t.createEl("h2",{text:this.template?"Edit Template":"Create Template"}),new p.Setting(t).setName("Template Name").addText(a=>a.setPlaceholder("My Template").setValue(this.formData.name).onChange(o=>this.formData.name=o)),new p.Setting(t).setName("Description").addText(a=>a.setPlaceholder("What this template does").setValue(this.formData.description).onChange(o=>this.formData.description=o)),new p.Setting(t).setName("Category").addDropdown(a=>a.addOption("Writing","Writing").addOption("Research","Research").addOption("Note-taking","Note-taking").addOption("Coding","Coding").addOption("Creative","Creative").addOption("Custom","Custom").setValue(this.formData.category).onChange(o=>this.formData.category=o)),new p.Setting(t).setName("Prompt Template").setDesc("Use {text}, {topic}, {code}, etc. as placeholders");let e=t.createEl("textarea");e.style.width="100%",e.style.minHeight="150px",e.style.marginBottom="1rem",e.style.padding="0.5rem",e.style.borderRadius="var(--radius-s)",e.style.border="1px solid var(--background-modifier-border)",e.style.fontFamily="var(--font-monospace)",e.placeholder=`Please summarize the following:

{text}`,e.value=this.formData.prompt,e.addEventListener("input",a=>{this.formData.prompt=a.target.value});let n=t.createDiv({cls:"button-container"});n.style.display="flex",n.style.justifyContent="flex-end",n.style.gap="0.5rem",n.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),n.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",()=>{if(!this.formData.name.trim()){new p.Notice("Template name is required");return}if(!this.formData.prompt.trim()){new p.Notice("Prompt template is required");return}this.onSave(this.formData),this.close()})}onClose(){let{contentEl:t}=this;t.empty()}},De=class extends p.Modal{constructor(e,n){var i;super(e);this.entries=[];this.searchTerm="";this.plugin=n;let s=(i=n.aiService)==null?void 0:i.getCacheService();s&&(this.entries=s.getAllEntries())}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Cached Responses"});let n=e.createDiv({cls:"cache-search"});n.style.marginBottom="1rem",new p.Setting(n).setName("Search").setDesc("Filter cached responses by keyword").addText(i=>i.setPlaceholder("Search cached responses...").onChange(a=>{this.searchTerm=a.toLowerCase(),this.renderEntries(e)})),this.renderEntries(e);let s=e.createEl("button",{text:"Close",cls:"mod-cta"});s.style.marginTop="1rem",s.addEventListener("click",()=>this.close())}renderEntries(e){let n=e.querySelector(".cache-entries-list");n&&n.remove();let s=this.searchTerm?this.entries.filter(a=>a.prompt.toLowerCase().includes(this.searchTerm)||a.response.toLowerCase().includes(this.searchTerm)):this.entries;if(s.length===0){let a=e.createDiv({cls:"cache-empty"});a.style.padding="2rem",a.style.textAlign="center",a.style.color="var(--text-muted)",a.textContent=this.searchTerm?"No cached responses match your search.":"No cached responses yet.";return}let i=e.createDiv({cls:"cache-entries-list"});if(i.style.maxHeight="400px",i.style.overflowY="auto",s.slice(0,50).forEach(a=>{let o=i.createDiv({cls:"cache-entry-item"});o.style.padding="0.75rem",o.style.marginBottom="0.5rem",o.style.backgroundColor="var(--background-secondary)",o.style.borderRadius="var(--radius-s)";let r=o.createDiv({cls:"cache-entry-header"});r.style.display="flex",r.style.justifyContent="space-between",r.style.alignItems="center",r.style.marginBottom="0.5rem";let c=r.createDiv();c.style.fontSize="var(--font-smaller)",c.style.color="var(--text-muted)";let l=new Date(a.createdAt).toLocaleDateString();c.textContent=`${l} | ${a.model} | ${a.tokensUsed} tokens | Used ${a.accessCount}x`;let d=r.createEl("button",{text:"Delete",cls:"mod-warning"});d.style.fontSize="var(--font-smaller)",d.style.padding="0.25rem 0.5rem",d.addEventListener("click",()=>{var f;if(confirm("Delete this cached response?")){let y=(f=this.plugin.aiService)==null?void 0:f.getCacheService();y&&y.deleteEntry(a.id)&&(this.entries=this.entries.filter(b=>b.id!==a.id),this.renderEntries(e),new p.Notice("Cached response deleted"))}});let g=o.createDiv({cls:"cache-entry-prompt"});g.style.fontWeight="bold",g.style.fontSize="var(--font-small)",g.style.marginBottom="0.25rem",g.textContent=a.prompt.substring(0,200)+(a.prompt.length>200?"...":"");let m=o.createDiv({cls:"cache-entry-response"});m.style.fontSize="var(--font-small)",m.style.color="var(--text-muted)",m.textContent=a.response.substring(0,300)+(a.response.length>300?"...":"")}),s.length>50){let a=e.createDiv({cls:"cache-more"});a.style.textAlign="center",a.style.color="var(--text-muted)",a.style.marginTop="0.5rem",a.textContent=`Showing 50 of ${s.length} entries. Use search to filter.`}}onClose(){let{contentEl:e}=this;e.empty()}};var w=require("obsidian");function G(h){var n,s,i,a,o;let t={answer:"",reasoning_summary:"",alternatives:[],risks:[],mitigation:[]},e=h.match(/```yaml\n([\s\S]*?)```/);if(e){let r=e[1],c=r.match(/answer:\s*(.+)/);c&&(t.answer=c[1].trim());let l=r.match(/reasoning_summary:\s*(.+)/);l&&(t.reasoning_summary=l[1].trim());let d=r.match(/next_step:\s*\n((?:\s+.*\n?)*)/);if(d){let g=d[1],m=(n=g.match(/\s+action:\s*(.+)/))==null?void 0:n[1],f=(s=g.match(/\s+owner:\s*(user|agent)/))==null?void 0:s[1],y=(i=g.match(/\s+effort:\s*(\d+m|half-day|1-day|2-days\+)/))==null?void 0:i[1],b=(a=g.match(/\s+expected_outcome:\s*(.+)/))==null?void 0:a[1],S=(o=g.match(/\s+type:\s*(do_now|choose_path|unblock)/))==null?void 0:o[1];m&&(t.next_step={action:m.trim(),owner:f||"user",effort:y||"30m",expected_outcome:(b==null?void 0:b.trim())||"Task completed successfully",type:S})}t.answer||(t.answer=h.replace(/```yaml[\s\S]*?```/,"").trim())}else{t.answer=h;let r=h.match(/(?:NEXT STEP|Next Step| NEXT STEP):\s*\n([\s\S]*?)(?=\n\n|$)/i);if(r){let c=r[1],l=c.match(/[-*]\s*(?:Action|action):\s*(.+)/i),d=c.match(/[-*]\s*(?:Owner|owner):\s*(user|agent)/i),g=c.match(/[-*]\s*(?:Effort|effort):\s*(\d+m|half-day|1-day|2-days\+)/i),m=c.match(/[-*]\s*(?:Success looks like|Expected outcome|expected_outcome):\s*(.+)/i);l&&(t.next_step={action:l[1].trim(),owner:(d==null?void 0:d[1])||"user",effort:(g==null?void 0:g[1])||"30m",expected_outcome:(m==null?void 0:m[1].trim())||"Task completed successfully"})}}return t}function qe(h){let t=[];return!h.answer&&!h.next_step&&t.push("answer"),h.next_step?((!h.next_step.action||h.next_step.action.length<5)&&t.push("next_step.action"),h.next_step.expected_outcome||t.push("next_step.expected_outcome"),t.length>0?{valid:!1,reason:"Incomplete next_step information",missing_fields:t,suggestions:["Provide more detail for the next step"]}:{valid:!0}):{valid:!1,reason:"Missing mandatory next_step field",missing_fields:["next_step"],suggestions:["Add a concrete action the user or agent should take","Specify who owns the next action (user or agent)","Estimate effort required","Describe what success looks like","Specify the continuation type (do_now, choose_path, unblock)"]}}function je(h){var e,n,s;let t=0;return(e=h.next_step)!=null&&e.action&&(t+=4),(n=h.next_step)!=null&&n.action&&h.next_step.action.length>20&&(t+=2),(s=h.next_step)!=null&&s.expected_outcome&&(t+=2),h.alternatives&&h.alternatives.length>0&&(t+=1),h.risks&&h.risks.length>0&&(t+=1),t}function Ve(h){let t="";return h.answer&&(t+=h.answer+`

`),h.reasoning_summary&&h.reasoning_summary!==h.answer&&(t+=`**Why this works:**
${h.reasoning_summary}

`),h.next_step&&(t+=`---
`,t+=`**\u{1F3AF} NEXT STEP:**
`,t+=`- **Action**: ${h.next_step.action}
`,t+=`- **Owner**: ${h.next_step.owner}
`,t+=`- **Effort**: ${h.next_step.effort}
`,t+=`- **Success looks like**: ${h.next_step.expected_outcome}
`,h.next_step.type&&(t+=`- **Type**: ${h.next_step.type}
`),t+=`
`),h.alternatives&&h.alternatives.length>0&&(t+=`**Alternative paths:**
`,h.alternatives.forEach((e,n)=>{t+=`${n+1}. ${e.option} - Use when ${e.when_to_use}
`,e.trade_offs&&(t+=`   *Trade-offs: ${e.trade_offs}*
`)}),t+=`
`),h.risks&&h.risks.length>0&&(t+=`**\u26A0\uFE0F Watch out for:**
`,h.risks.forEach(e=>{t+=`- ${e}
`}),t+=`
`),h.mitigation&&h.mitigation.length>0&&(t+=`**Mitigation:**
`,h.mitigation.forEach(e=>{t+=`- ${e}
`}),t+=`
`),t.trim()}var ot=[/it depends(?!\s+on\s+.+\.\s+(?:if|when|option))/i,/you could(?!\s+(?:try|do|start).*(?:\.|:)\s*(?:\d+\.|-))/i,/(?:let me know|tell me)\s+(?:if|what|how).*[?]$/i,/(?:there are many|several|various)\s+(?:ways|options|approaches)(?!\s*:\s*\d+\.)/i];function Ge(h){if(/(?:NEXT STEP|Next Step||```yaml)/i.test(h))return!1;let t=/(?:i recommend|i suggest|next step|you should|start by)/i.test(h);for(let n of ot)if(n.test(h)&&!t)return!0;return!!(/\?\s*$/.test(h.trim())&&!t)}var K={"gpt-4":8192,"gpt-4-32k":32768,"gpt-4-turbo":128e3,"gpt-4-turbo-preview":128e3,"gpt-4o":128e3,"gpt-4o-mini":128e3,"gpt-3.5-turbo":4096,"gpt-3.5-turbo-16k":16384,"claude-3-opus":2e5,"claude-3-sonnet":2e5,"claude-3-haiku":2e5,"claude-3-opus-20240229":2e5,"claude-3-sonnet-20240229":2e5,"claude-2":1e5,"claude-2.1":2e5,llama2:4096,"llama2:7b":4096,"llama2:13b":4096,"llama2:70b":4096,mistral:8192,mixtral:32768,codellama:16384,phi:2048,gemma:8192,default:4096};function P(h,t="openai"){if(!h)return 0;let e;switch(t){case"anthropic":e=3.5;break;case"ollama":e=4;break;default:e=4}let n=Math.ceil(h.length/e),s=h.match(/```[\s\S]*?```/g);if(s){let i=s.reduce((a,o)=>a+o.length,0);n+=Math.ceil(i*(1/3-1/e))}return Math.max(1,n)}function rt(h){if(K[h])return K[h];for(let[t,e]of Object.entries(K))if(h.toLowerCase().includes(t.toLowerCase()))return e;return K.default}function Ke(h,t,e,n,s,i){let a=P(h,i),o=P(t,i),r=e.reduce((m,f)=>m+P(f.content,i)+4,0),c=P(n,i),l=a+o+r+c,d=rt(s),g=Math.min(100,Math.round(l/d*100));return{systemPrompt:a,context:o,conversationHistory:r,currentPrompt:c,total:l,limit:d,percentage:g}}function We(h){return h>=95?"critical":h>=80?"high":h>=60?"medium":"low"}function Ye(h){switch(h){case"critical":return"var(--text-error)";case"high":return"var(--text-warning)";case"medium":return"var(--text-accent)";default:return"var(--text-muted)"}}function $e(h){return h>=1e3?`${(h/1e3).toFixed(1)}k`:h.toString()}function F(h,t,e="openai"){if(P(h,e)<=t)return h;let i=Math.floor(t*(e==="anthropic"?3.5:4));if(i<=100)return h.substring(0,i);let a=Math.floor(i*.6),o=i-a-20,r=h.substring(0,a),c=h.substring(h.length-o);return`${r}

[... content truncated ...]

${c}`}var A=require("obsidian"),W=class{constructor(t,e,n="do_now",s){this.container=t.createDiv({cls:"oa-next-step-container"});let i=this.container.createDiv({cls:"oa-next-step-label"});i.textContent=`Recommended next move (${n.replace("_"," ")}):`,this.button=this.container.createEl("button",{cls:`oa-next-step-btn oa-next-step-btn--${n}`,text:e});let a=n==="do_now"?"play":n==="choose_path"?"git-branch":"help-circle",o=document.createElement("span");o.className="oa-next-step-icon",this.button.prepend(o),(0,A.setIcon)(o,a),this.button.addEventListener("click",r=>{r.stopPropagation(),s()})}destroy(){this.container.remove()}},Y=class{constructor(t){this.dots=[];this.container=t.createDiv({cls:"oa-typing-indicator"}),this.container.createSpan({text:"AI is typing",cls:"oa-sr-only"});let e=this.container.createDiv({cls:"oa-typing-indicator__dots"});for(let n=0;n<3;n++)this.dots.push(e.createDiv({cls:"oa-typing-indicator__dot"}));this.hide()}show(){this.container.style.display="flex"}hide(){this.container.style.display="none"}destroy(){this.container.remove()}},Q=class{constructor(t,e){this.reactions=new Map;this.container=t.createDiv({cls:"oa-message__reactions"}),this.onReactionToggle=e;let n=this.container.createSpan({cls:"oa-reaction oa-reaction__add",text:"+"});(0,A.setTooltip)(n,"Add reaction"),n.addEventListener("click",s=>{s.stopPropagation(),this.showReactionPicker(s)})}addReaction(t,e=1,n=!1){this.reactions.set(t,{emoji:t,count:e,userReacted:n}),this.render()}removeReaction(t){this.reactions.delete(t),this.render()}toggleReaction(t){let e=this.reactions.get(t);e?e.userReacted?e.count>1?this.reactions.set(t,{...e,count:e.count-1,userReacted:!1}):this.reactions.delete(t):this.reactions.set(t,{...e,count:e.count+1,userReacted:!0}):this.reactions.set(t,{emoji:t,count:1,userReacted:!0}),this.render(),this.onReactionToggle(t)}render(){this.container.querySelectorAll(".oa-reaction:not(.oa-reaction__add)").forEach(n=>n.remove());let e=this.container.querySelector(".oa-reaction__add");this.reactions.forEach(n=>{let s=document.createElement("span");s.className=`oa-reaction ${n.userReacted?"oa-reaction--active":""}`,s.innerHTML=`${n.emoji} ${n.count>1?n.count:""}`,(0,A.setTooltip)(s,n.userReacted?"Remove reaction":"Add reaction"),s.addEventListener("click",i=>{i.stopPropagation(),this.toggleReaction(n.emoji)}),e?this.container.insertBefore(s,e):this.container.appendChild(s)})}showReactionPicker(t){let e=document.createElement("div");e.className="oa-reaction-picker",e.style.position="absolute",e.style.zIndex="1000",["\u{1F44D}","\u2764\uFE0F","\u{1F604}","\u{1F389}","\u{1F914}","\u{1F440}","\u{1F525}","\u2705"].forEach(a=>{e.createDiv({cls:"oa-reaction-picker__emoji",text:a}).addEventListener("click",()=>{this.toggleReaction(a),e.remove()})}),document.body.appendChild(e);let s=t.target.getBoundingClientRect();e.style.left=`${s.left}px`,e.style.top=`${s.top-e.offsetHeight-8}px`;let i=a=>{e.contains(a.target)||(e.remove(),document.removeEventListener("click",i))};setTimeout(()=>document.addEventListener("click",i),0)}destroy(){this.container.remove()}},X=class{constructor(t,e,n){this.unreadCount=0;this.onClick=n,this.button=t.createEl("button",{cls:"oa-scroll-bottom"}),(0,A.setIcon)(this.button,"arrow-down"),(0,A.setTooltip)(this.button,"Scroll to bottom"),this.badge=this.button.createDiv({cls:"oa-scroll-bottom__badge"}),this.badge.style.display="none",this.button.addEventListener("click",()=>{this.onClick(),this.hide()}),this.hide(),e.addEventListener("scroll",()=>{e.scrollHeight-e.scrollTop-e.clientHeight<100&&this.hide()})}show(){this.button.style.display="flex"}hide(){this.button.style.display="none",this.unreadCount=0,this.updateBadge()}incrementUnread(){this.unreadCount++,this.updateBadge(),this.show()}updateBadge(){this.unreadCount>0?(this.badge.style.display="flex",this.badge.textContent=this.unreadCount>99?"99+":String(this.unreadCount)):this.badge.style.display="none"}destroy(){this.button.remove()}},J=class{constructor(t,e,n){this.onSearch=e,this.onResultClick=n,this.container=t.createDiv({cls:"oa-search-container"});let s=this.container.createDiv({cls:"oa-search-input-wrapper"});s.createSpan({cls:"oa-search-icon"}),(0,A.setIcon)(s.querySelector(".oa-search-icon"),"search"),this.input=s.createEl("input",{cls:"oa-search-input",attr:{placeholder:"Search conversation...",type:"text"}});let i=s.createEl("button",{cls:"oa-search-clear"});(0,A.setIcon)(i,"x"),i.addEventListener("click",()=>{this.input.value="",this.clearResults(),this.input.focus()}),this.resultsContainer=this.container.createDiv({cls:"oa-search-results"}),this.resultsContainer.style.display="none";let a;this.input.addEventListener("input",()=>{clearTimeout(a),a=window.setTimeout(()=>{this.performSearch()},300)}),this.input.addEventListener("keydown",o=>{o.key==="Escape"&&(this.clearResults(),this.input.blur())})}performSearch(){let t=this.input.value.trim();if(!t){this.clearResults();return}let e=this.onSearch(t);this.renderResults(e,t)}renderResults(t,e){if(this.resultsContainer.empty(),t.length===0){this.resultsContainer.createDiv({cls:"oa-search-empty",text:"No results found"}),this.resultsContainer.style.display="block";return}t.forEach(n=>{let s=this.resultsContainer.createDiv({cls:"oa-search-result"}),i=n.content;n.matchRanges.forEach(([o,r])=>{let c=i.slice(o,r);i=i.slice(0,o)+`<span class="oa-search-result__match">${c}</span>`+i.slice(r)}),s.innerHTML=i;let a=new Date(n.timestamp).toLocaleTimeString();s.createDiv({cls:"oa-search-result__time",text:a}),s.addEventListener("click",()=>{this.onResultClick(n),this.clearResults()})}),this.resultsContainer.style.display="block"}clearResults(){this.resultsContainer.empty(),this.resultsContainer.style.display="none"}focus(){this.input.focus()}destroy(){this.container.remove()}},Z=class{constructor(t,e){this.container=t.createDiv({cls:"oa-message-actions"}),e.forEach(n=>{let s=this.container.createEl("button",{cls:"oa-message-action"});(0,A.setIcon)(s,n.icon),(0,A.setTooltip)(s,n.label),s.addEventListener("click",i=>{i.stopPropagation(),n.onClick()})})}destroy(){this.container.remove()}};function ct(h,t,e){return h.animate(t,e)}function Qe(h,t=300){return ct(h,[{transform:"translateY(20px)",opacity:0},{transform:"translateY(0)",opacity:1}],{duration:t,easing:"cubic-bezier(0.34, 1.56, 0.64, 1)",fill:"forwards"})}var I=class extends w.Modal{constructor(e,n,s,i,a,o,r=null){super(e);this.prompt="";this.context="";this.chatHistory=[];this.currentConversationId=null;this.isStreaming=!1;this.currentResponse="";this.messageReactions=new Map;if(this.aiService=n,this.agentService=r,this.settings=s,this.saveSettings=i,this.context=a,this.onSubmit=o,this.settings.enableConversationPersistence&&this.settings.activeConversationId){let c=this.settings.conversations.find(l=>l.id===this.settings.activeConversationId);c&&(this.currentConversationId=c.id,this.chatHistory=[...c.messages])}}onOpen(){let{contentEl:e}=this;this.modalEl.addClass("obsidian-agent-modal"),e.addClass("oa-modal-content");let n=e.createDiv({cls:"oa-modal-header-glass"});this.renderHeader(n);let s=e.createDiv({cls:"oa-search-wrapper"});s.style.display="none",this.searchInterface=new J(s,i=>this.searchMessages(i),i=>this.scrollToMessage(i.id)),this.chatHistoryContainer=e.createDiv({cls:"chat-history-container"}),this.messageListEl=this.chatHistoryContainer.createDiv({cls:"oa-message-list"}),this.typingIndicator=new Y(this.messageListEl),this.scrollButton=new X(e,this.chatHistoryContainer,()=>this.scrollToBottom()),this.renderChatHistory(),this.renderInputArea(e),setTimeout(()=>{var i;return(i=this.textAreaElement)==null?void 0:i.focus()},0)}renderHeader(e){let n=e.createDiv({cls:"oa-header-row"});n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center";let s=n.createDiv();s.createEl("h2",{text:"AI Agent Assistant",cls:"oa-modal-title"}),s.createEl("p",{text:"Ask anything about your notes",cls:"oa-header-subtitle"});let i=n.createDiv({cls:"oa-header-actions"});i.style.display="flex",i.style.gap="var(--oa-space-sm)";let a=i.createEl("button",{cls:"oa-input-action"});(0,w.setIcon)(a,"search"),(0,w.setTooltip)(a,"Search conversation"),a.addEventListener("click",()=>{var l;let c=this.contentEl.querySelector(".oa-search-wrapper");if(c){let d=c.style.display!=="none";c.style.display=d?"none":"block",d||(l=this.searchInterface)==null||l.focus()}});let o=i.createEl("button",{cls:"oa-input-action"});(0,w.setIcon)(o,"trash-2"),(0,w.setTooltip)(o,"Clear chat"),o.addEventListener("click",()=>this.clearChatWithConfirmation());let r=i.createEl("button",{cls:"oa-input-action"});(0,w.setIcon)(r,"download"),(0,w.setTooltip)(r,"Export conversation"),r.addEventListener("click",()=>this.exportConversation())}renderInputArea(e){let n=e.createDiv({cls:"oa-input-container"});this.tokenCounterContainer=n.createDiv({cls:"token-counter-container"});let s=this.tokenCounterContainer.createDiv({cls:"token-bar-container"});this.tokenCounterBar=s.createDiv({cls:"token-bar-fill"}),this.tokenCounterText=this.tokenCounterContainer.createDiv({cls:"token-text"}),this.updateTokenCounter();let i=n.createDiv({cls:"oa-input-wrapper"}),a=new w.TextAreaComponent(i);this.textAreaElement=a.inputEl,this.textAreaElement.addClass("oa-input"),this.textAreaElement.placeholder="Type your message...",this.textAreaElement.addEventListener("keydown",l=>this.handleKeyDown(l)),a.onChange(l=>{this.prompt=l,this.updateTokenCounter()});let o=i.createDiv({cls:"oa-input-actions"}),r=o.createEl("button",{cls:"oa-input-action"});(0,w.setIcon)(r,"mic"),(0,w.setTooltip)(r,"Voice input (coming soon)"),r.addEventListener("click",()=>{new w.Notice("Voice input feature coming soon!")});let c=o.createEl("button",{cls:"oa-input-action"});(0,w.setIcon)(c,"layout-template"),(0,w.setTooltip)(c,"Use template"),c.addEventListener("click",()=>this.openTemplatesPicker()),this.submitButton=o.createEl("button",{cls:"oa-input-action oa-input-action--primary"}),(0,w.setIcon)(this.submitButton,"send"),(0,w.setTooltip)(this.submitButton,"Send message (Enter)"),this.submitButton.addEventListener("click",()=>this.handleSubmit()),this.stopButton=o.createEl("button",{cls:"oa-input-action oa-input-action--danger"}),(0,w.setIcon)(this.stopButton,"square"),(0,w.setTooltip)(this.stopButton,"Stop generation"),this.stopButton.style.display="none",this.stopButton.addEventListener("click",()=>this.stopGeneration())}renderChatHistory(){if(this.messageListEl.empty(),this.chatHistory.length===0){this.showWelcomeMessage();return}this.chatHistory.forEach((e,n)=>{this.renderMessage(e,n)}),this.scrollToBottom()}renderMessage(e,n){let s=e.role==="user",i=this.messageListEl.createDiv({cls:`oa-message oa-message--${s?"user":"assistant"}`});n===this.chatHistory.length-1&&Qe(i,300);let a=i.createDiv({cls:"oa-message__bubble"}),o=a.createDiv({cls:"message-content"});if(s)o.textContent=e.content;else{o.innerHTML=this.renderMarkdown(e.content);let d=G(e.content);d.next_step&&new W(a,d.next_step.action,d.next_step.type,()=>{this.handleNextStepClick(d.next_step)})}!s&&this.isStreaming&&n===this.chatHistory.length-1&&o.createSpan({cls:"oa-streaming-cursor"});let r=a.createDiv({cls:"message-meta"});r.style.fontSize="var(--font-smallest)",r.style.color="var(--text-muted)",r.style.marginTop="var(--oa-space-xs)";let c=new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(r.textContent=c,e.tokensUsed&&(r.textContent+=` \xB7 ${e.tokensUsed} tokens`),e.fromCache&&(r.textContent+=" \xB7 cached"),new Z(i,[{icon:"copy",label:"Copy message",onClick:()=>{navigator.clipboard.writeText(e.content),new w.Notice("Message copied to clipboard")}},{icon:"quote",label:"Reply",onClick:()=>this.quoteMessage(e)},{icon:"trash-2",label:"Delete",onClick:()=>this.deleteMessage(n)}]),!s){let d=new Q(i,g=>{new w.Notice(`Reacted with ${g}`)});this.messageReactions.set(n,d)}let l=this.messageListEl.querySelector(".oa-typing-indicator");l?this.messageListEl.insertBefore(i,l):this.messageListEl.appendChild(i)}handleNextStepClick(e){let n=e.action,s=e.type||"do_now";s==="unblock"?this.prompt="Here is the info you needed: ":s==="choose_path"?this.prompt=`I'd like to proceed with path: ${n}`:this.prompt=`Please proceed with: ${n}`,this.textAreaElement.value=this.prompt,this.textAreaElement.focus(),this.updateTokenCounter(),new w.Notice("Next step selected. Press Enter to confirm.")}renderMarkdown(e){let n=e.replace(/```yaml\n([\s\S]*?)```/g,'<div class="oa-yaml-block"><pre><code>$1</code></pre></div>').replace(/```(\w*)\n([\s\S]*?)```/g,'<pre><code class="language-$1">$2</code></pre>').replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\*\*\*([^*]+)\*\*\*/g,"<strong><em>$1</em></strong>").replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/\*([^*]+)\*/g,"<em>$1</em>").replace(/~~([^~]+)~~/g,"<del>$1</del>").replace(/### (.+)/g,"<h4>$1</h4>").replace(/## (.+)/g,"<h3>$1</h3>").replace(/# (.+)/g,"<h2>$1</h2>").replace(/^> (.+)/gm,"<blockquote>$1</blockquote>").replace(/^- \[ \] (.+)/gm,'<div class="oa-task oa-task--todo">$1</div>').replace(/^- \[x\] (.+)/gm,'<div class="oa-task oa-task--done">$1</div>').replace(/^[-*] (.+)/gm,"<li>$1</li>").replace(/\n/g,"<br>");return n=n.replace(/(<li>.*<\/li>)/s,"<ul>$1</ul>"),n}showWelcomeMessage(){let e=this.messageListEl.createDiv({cls:"oa-welcome-message"});e.style.textAlign="center",e.style.padding="var(--oa-space-2xl)",e.style.color="var(--text-muted)";let n=e.createDiv({cls:"oa-welcome-icon"});n.style.fontSize="3rem",n.style.marginBottom="var(--oa-space-md)",n.textContent="\u2728",e.createEl("h3",{text:"Welcome to AI Agent"}),e.createEl("p",{text:"Ask me anything about your notes, or use templates for common tasks."})}async handleSubmit(e=!1){if(!this.prompt.trim()){new w.Notice("Please enter a message");return}let n=this.prompt;e&&this.aiService.setBypassCache(!0),this.addMessage("user",this.prompt),this.prompt="",this.textAreaElement.value="",this.updateTokenCounter(),this.typingIndicator.show(),this.isStreaming=!0,this.submitButton.style.display="none",this.stopButton.style.display="flex";try{if(this.agentService){let s=await this.agentService.run(n);this.currentResponse=s,this.addMessage("assistant",s),this.typingIndicator.hide(),this.isStreaming=!1,this.submitButton.style.display="flex",this.stopButton.style.display="none"}else{let s=await this.aiService.generateCompletion({prompt:n,context:this.context,stream:!0,onChunk:i=>{this.onStreamChunk(i),i.done&&this.finishStreaming(s)},onProgress:i=>{this.isStreaming&&this.onStreamProgress(i)}})}}catch(s){s.name!=="AbortError"&&(new w.Notice(`Error: ${s.message}`),console.error("Agent Error:",s)),this.stopStreaming()}}onStreamChunk(e){if(!e.done&&e.content&&(this.currentResponse+=e.content,this.chatHistory.length>0)){let n=this.chatHistory[this.chatHistory.length-1];n.role==="assistant"&&(n.content=this.currentResponse,this.updateLastMessage())}}onStreamProgress(e){if(this.typingIndicator.hide(),this.chatHistory.length===0||this.chatHistory[this.chatHistory.length-1].role!=="assistant")this.addMessage("assistant",e,!1);else{let n=this.chatHistory[this.chatHistory.length-1];n.content=e,this.updateLastMessage()}this.scrollToBottom()}finishStreaming(e){if(this.stopStreaming(),this.currentResponse){if(this.chatHistory.length>0){let n=this.chatHistory[this.chatHistory.length-1];n.role==="assistant"&&(n.content=this.currentResponse,n.tokensUsed=e.tokensUsed,n.fromCache=e.fromCache)}this.renderChatHistory(),this.saveCurrentConversation(),e.fromCache&&new w.Notice("Response loaded from cache"),this.onSubmit(this.currentResponse)}this.currentResponse=""}stopStreaming(){this.isStreaming=!1,this.typingIndicator.hide(),this.submitButton.style.display="flex",this.stopButton.style.display="none"}stopGeneration(){this.aiService.cancelCurrentRequest(),this.stopStreaming(),new w.Notice("Generation stopped")}addMessage(e,n,s,i){this.chatHistory.push({role:e,content:n,timestamp:Date.now(),fromCache:s,tokensUsed:i}),this.renderMessage(this.chatHistory[this.chatHistory.length-1],this.chatHistory.length-1),this.scrollToBottom()}updateLastMessage(){let e=this.messageListEl.querySelectorAll(".oa-message");if(e.length>0){let s=e[e.length-1].querySelector(".message-content");if(s){let i=this.chatHistory[this.chatHistory.length-1];s.innerHTML=this.renderMarkdown(i.content),this.isStreaming&&i.role==="assistant"&&s.createSpan({cls:"oa-streaming-cursor"})}}}updateTokenCounter(){if(!this.tokenCounterBar||!this.tokenCounterText)return;let e=Ke(this.settings.systemPrompt,this.settings.enableContextAwareness?this.context:"",this.chatHistory,this.prompt,this.settings.model,this.settings.apiProvider),n=We(e.percentage),s=Ye(n);this.tokenCounterBar.style.width=`${Math.min(100,e.percentage)}%`,this.tokenCounterBar.style.backgroundColor=s,this.tokenCounterText.empty(),this.tokenCounterText.createSpan({text:`${$e(e.total)} / ${$e(e.limit)} tokens`})}handleKeyDown(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this.handleSubmit()),e.key==="Escape"&&this.close(),(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="k"&&(e.preventDefault(),this.clearChatWithConfirmation())}scrollToBottom(){this.chatHistoryContainer.scrollTop=this.chatHistoryContainer.scrollHeight}searchMessages(e){let n=[],s=e.toLowerCase();return this.chatHistory.forEach((i,a)=>{let r=i.content.toLowerCase().indexOf(s);r!==-1&&n.push({id:String(a),content:i.content,timestamp:i.timestamp,matchRanges:[[r,r+e.length]]})}),n}scrollToMessage(e){let n=this.messageListEl.querySelectorAll(".oa-message"),s=parseInt(e);n[s]&&(n[s].scrollIntoView({behavior:"smooth",block:"center"}),n[s].classList.add("oa-message--highlighted"),setTimeout(()=>{n[s].classList.remove("oa-message--highlighted")},2e3))}quoteMessage(e){let n=e.content.split(`
`).map(s=>`> ${s}`).join(`
`);this.prompt=`${n}

`,this.textAreaElement.value=this.prompt,this.textAreaElement.focus(),this.updateTokenCounter()}deleteMessage(e){confirm("Delete this message?")&&(this.chatHistory.splice(e,1),this.renderChatHistory(),this.saveCurrentConversation())}clearChatWithConfirmation(){this.chatHistory.length!==0&&confirm("Clear the entire conversation?")&&(this.chatHistory=[],this.currentConversationId=null,this.settings.activeConversationId=void 0,this.renderChatHistory(),this.saveSettings(),new w.Notice("Conversation cleared"))}exportConversation(){if(this.chatHistory.length===0){new w.Notice("No conversation to export");return}let e=`# AI Conversation Export

`;e+=`*Exported on ${new Date().toLocaleString()}*

---

`,this.chatHistory.forEach(n=>{let s=n.role==="user"?"**You**":"**AI**",i=new Date(n.timestamp).toLocaleString();e+=`${s} *(${i})*:

${n.content}

---

`}),navigator.clipboard.writeText(e),new w.Notice("Conversation copied to clipboard")}openTemplatesPicker(){new w.Notice("Template picker coming soon!")}async saveCurrentConversation(){if(!this.settings.enableConversationPersistence)return;let e=Date.now();if(this.currentConversationId){let n=this.settings.conversations.findIndex(s=>s.id===this.currentConversationId);n>=0&&(this.settings.conversations[n].messages=[...this.chatHistory],this.settings.conversations[n].updatedAt=e)}else this.currentConversationId=`conv_${e}_${Math.random().toString(36).substr(2,9)}`,this.settings.conversations.unshift({id:this.currentConversationId,title:this.generateConversationTitle(),messages:[...this.chatHistory],createdAt:e,updatedAt:e}),this.settings.conversations.length>this.settings.maxConversations&&(this.settings.conversations=this.settings.conversations.slice(0,this.settings.maxConversations));this.settings.activeConversationId=this.currentConversationId,await this.saveSettings()}generateConversationTitle(){let e=this.chatHistory.find(n=>n.role==="user");return e?e.content.substring(0,50)+(e.content.length>50?"...":""):`Conversation ${new Date().toLocaleDateString()}`}onClose(){this.aiService.cancelCurrentRequest(),this.typingIndicator.destroy(),this.scrollButton.destroy(),this.messageReactions.forEach(e=>e.destroy()),this.contentEl.empty()}};var Xe=require("obsidian");var ee=class{constructor(t){this.app=t}async gatherContext(t,e,n,s="openai"){let i=[];if(n.sources.find(a=>a.type==="current"&&a.enabled)){let a=F(e,n.maxTokensPerNote,s);i.push({source:"current",notePath:(t==null?void 0:t.path)||"current",noteTitle:(t==null?void 0:t.basename)||"Current Note",content:a,tokens:P(a,s)})}if(!t)return i;if(n.sources.find(a=>a.type==="linked"&&a.enabled)){let a=await this.getLinkedNotesContext(t,n,s);i.push(...a)}if(n.sources.find(a=>a.type==="backlinks"&&a.enabled)){let a=await this.getBacklinksContext(t,n,s);i.push(...a)}if(n.sources.find(a=>a.type==="tags"&&a.enabled)){let a=await this.getTagContexts(t,n,s);i.push(...a)}if(n.sources.find(a=>a.type==="folder"&&a.enabled)){let a=await this.getFolderContexts(t,n,s);i.push(...a)}return this.dedupeContexts(i)}async getLinkedNotesContext(t,e,n){let s=[],i=this.app.metadataCache.getFileCache(t);if(!(i!=null&&i.links))return s;let a=new Set,o=[...i.links],r=0;for(;o.length>0&&r<e.linkDepth&&s.length<e.maxNotesPerSource;){let c=[...o];o.length=0;for(let l of c){if(s.length>=e.maxNotesPerSource)break;let d=this.app.metadataCache.getFirstLinkpathDest(l.link,t.path);if(!(!d||a.has(d.path))&&!this.isExcluded(d.path,e.excludeFolders)){a.add(d.path);try{let g=await this.app.vault.read(d),m=F(g,e.maxTokensPerNote,n);if(s.push({source:"linked",notePath:d.path,noteTitle:d.basename,content:m,tokens:P(m,n)}),r<e.linkDepth-1){let f=this.app.metadataCache.getFileCache(d);f!=null&&f.links&&o.push(...f.links)}}catch(g){console.error(`Failed to read linked note: ${d.path}`,g)}}}r++}return s}async getBacklinksContext(t,e,n){let s=[],i=[],a=this.app.metadataCache.resolvedLinks||{};for(let[o,r]of Object.entries(a)){if(!r||!r[t.path]||o===t.path)continue;let c=this.app.vault.getAbstractFileByPath(o);c instanceof Xe.TFile&&i.push(c)}for(let o of i.slice(0,e.maxNotesPerSource))if(!this.isExcluded(o.path,e.excludeFolders))try{let r=await this.app.vault.read(o),c=F(r,e.maxTokensPerNote,n);s.push({source:"backlink",notePath:o.path,noteTitle:o.basename,content:c,tokens:P(c,n)})}catch(r){console.error(`Failed to read backlink: ${o.path}`,r)}return s}async getTagContexts(t,e,n){let s=[],i=this.app.metadataCache.getFileCache(t);if(!(i!=null&&i.tags))return s;let a=new Set(i.tags.map(c=>c.tag)),o=new Set([t.path]),r=this.app.vault.getMarkdownFiles();for(let c of r){if(s.length>=e.maxNotesPerSource)break;if(o.has(c.path)||this.isExcluded(c.path,e.excludeFolders))continue;let l=this.app.metadataCache.getFileCache(c);if(!(l!=null&&l.tags))continue;if(l.tags.map(m=>m.tag).some(m=>a.has(m))){o.add(c.path);try{let m=await this.app.vault.read(c),f=F(m,e.maxTokensPerNote,n);s.push({source:"tag",notePath:c.path,noteTitle:c.basename,content:f,tokens:P(f,n)})}catch(m){console.error(`Failed to read tagged note: ${c.path}`,m)}}}return s}async getFolderContexts(t,e,n){let s=[],i=t.parent;if(!i)return s;let a=this.app.vault.getMarkdownFiles().filter(o=>{var r;return((r=o.parent)==null?void 0:r.path)===i.path&&o.path!==t.path});for(let o of a.slice(0,e.maxNotesPerSource))if(!this.isExcluded(o.path,e.excludeFolders))try{let r=await this.app.vault.read(o),c=F(r,e.maxTokensPerNote,n);s.push({source:"folder",notePath:o.path,noteTitle:o.basename,content:c,tokens:P(c,n)})}catch(r){console.error(`Failed to read folder note: ${o.path}`,r)}return s}isExcluded(t,e){let n=t.replace(/\\/g,"/").toLowerCase(),s=n.split("/").filter(Boolean);return e.some(i=>{let a=i.trim().replace(/\\/g,"/").toLowerCase();if(!a)return!1;if(a.includes("/")){let o=a.replace(/^\/+|\/+$/g,"");return n===o||n.startsWith(`${o}/`)||n.includes(`/${o}/`)}return s.includes(a)})}dedupeContexts(t){let e=new Set,n=[];for(let s of t)e.has(s.notePath)||(e.add(s.notePath),n.push(s));return n}formatContextsForPrompt(t){if(t.length===0)return"";let e="",n={};t.forEach(s=>{n[s.source]||(n[s.source]=[]),n[s.source].push(s)});for(let[s,i]of Object.entries(n)){let a=this.getSourceLabel(s);e+=`
--- ${a} ---
`,i.forEach(o=>{s!=="current"&&(e+=`
[${o.noteTitle}]
`),e+=`${o.content}
`})}return e}getSourceLabel(t){return{current:"Current Note",linked:"Linked Notes",backlink:"Notes Linking Here",tag:"Notes with Same Tags",folder:"Notes in Same Folder"}[t]||t}};var te=require("obsidian");var B=class{constructor(t){T.required(t,"app"),this.app=t,this.vault=t.vault}async scanVault(t){var a,o;let e=Date.now(),n=[],s=this.vault.getMarkdownFiles(),i=0;for(let r=0;r<s.length;r++){let c=s[r];t&&t(r+1,s.length);let l=await this.scanFile(c);n.push(...l);let d=this.app.metadataCache.getFileCache(c);d&&(i+=(((a=d.links)==null?void 0:a.length)||0)+(((o=d.embeds)==null?void 0:o.length)||0))}return{totalLinks:i,deadLinks:n,brokenCount:n.length,scanDuration:Date.now()-e,filesScanned:s.length}}async scanFile(t){var s,i;if(!t||!(t instanceof te.TFile))return[];let e=[],n=this.app.metadataCache.getFileCache(t);if(!n)return e;if(n.links)for(let a of n.links)this.resolveLink(a.link,t.path)||e.push({sourceFile:t.basename,sourcePath:t.path,linkText:a.displayText||a.link,linkTarget:a.link,lineNumber:((s=a.position)==null?void 0:s.start.line)||0,type:"wikilink",suggestions:await this.findSuggestions(a.link)});if(n.embeds)for(let a of n.embeds)this.resolveLink(a.link,t.path)||e.push({sourceFile:t.basename,sourcePath:t.path,linkText:a.displayText||a.link,linkTarget:a.link,lineNumber:((i=a.position)==null?void 0:i.start.line)||0,type:"embed",suggestions:await this.findSuggestions(a.link)});return e}resolveLink(t,e){try{let n=t.split("#")[0].split("^")[0];return n?this.app.metadataCache.getFirstLinkpathDest(n,e):null}catch(n){return console.error("Error resolving link:",t,n),null}}async findSuggestions(t){let e=this.vault.getMarkdownFiles(),n=t.split("#")[0].split("^")[0].toLowerCase();return e.map(i=>({file:i,score:this.calculateSimilarity(n,i.basename.toLowerCase())})).filter(i=>i.score>.3).sort((i,a)=>a.score-i.score).slice(0,5).map(i=>i.file.path)}calculateSimilarity(t,e){let n=t.length>e.length?t:e,s=t.length>e.length?e:t;if(n.length===0)return 1;if(n.includes(s))return .8;let i=this.levenshteinDistance(t,e);return(n.length-i)/n.length}levenshteinDistance(t,e){let n=[];for(let s=0;s<=e.length;s++)n[s]=[s];for(let s=0;s<=t.length;s++)n[0][s]=s;for(let s=1;s<=e.length;s++)for(let i=1;i<=t.length;i++)e.charAt(s-1)===t.charAt(i-1)?n[s][i]=n[s-1][i-1]:n[s][i]=Math.min(n[s-1][i-1]+1,n[s][i-1]+1,n[s-1][i]+1);return n[e.length][t.length]}async repairLinks(t,e=!1){var a;let n=[],s=0,i=0;for(let o of t){if(!e&&(!o.suggestions||o.suggestions.length===0)){i++;continue}let r=(a=o.suggestions)==null?void 0:a[0];if(!r){i++;continue}try{let c=this.vault.getAbstractFileByPath(o.sourcePath);if(!(c instanceof te.TFile)){i++,n.push({file:o.sourcePath,oldLink:o.linkTarget,newLink:r,success:!1});continue}let l=await this.vault.read(c),d=this.vault.getAbstractFileByPath(r),g=d instanceof te.TFile?d.basename:r,m=o.type==="embed"?`![[${o.linkTarget}]]`:`[[${o.linkTarget}]]`,f=o.type==="embed"?`![[${g}]]`:`[[${g}]]`;l.includes(m)?(l=l.replace(m,f),await this.vault.modify(c,l),s++,n.push({file:o.sourcePath,oldLink:o.linkTarget,newLink:g,success:!0})):(i++,n.push({file:o.sourcePath,oldLink:o.linkTarget,newLink:g,success:!1}))}catch(c){console.error("Error repairing link:",o,c),i++,n.push({file:o.sourcePath,oldLink:o.linkTarget,newLink:r,success:!1})}}return{repairedCount:s,failedCount:i,repairs:n}}async removeDeadLinks(t,e){try{let n=await this.vault.read(t),s=0,i=e.filter(a=>a.sourcePath===t.path);for(let a of i){let o=a.type==="embed"?`![[${a.linkTarget}]]`:`[[${a.linkTarget}]]`;n.includes(o)&&(n=n.replace(o,a.linkText||""),s++)}return s>0&&await this.vault.modify(t,n),s}catch(n){return console.error("Error removing dead links:",n),0}}generateReport(t){let e=[];if(e.push(`# Dead Links Report
`),e.push(`**Scan Date:** ${new Date().toISOString()}
`),e.push(`**Files Scanned:** ${t.filesScanned}`),e.push(`**Total Links:** ${t.totalLinks}`),e.push(`**Broken Links:** ${t.brokenCount}`),e.push(`**Scan Duration:** ${t.scanDuration}ms
`),t.deadLinks.length===0)e.push(`\u2705 No dead links found!
`);else{e.push(`## Broken Links
`);let n=new Map;for(let s of t.deadLinks)n.has(s.sourcePath)||n.set(s.sourcePath,[]),n.get(s.sourcePath).push(s);for(let[s,i]of n){e.push(`### [[${s}]]
`);for(let a of i)e.push(`- **Line ${a.lineNumber}:** \`[[${a.linkTarget}]]\` (${a.type})`),a.suggestions&&a.suggestions.length>0&&e.push(`  - Suggestions: ${a.suggestions.slice(0,3).map(o=>`[[${o}]]`).join(", ")}`);e.push("")}}return e.join(`
`)}};var Je=require("obsidian");var lt={minRelevanceScore:.5,maxSuggestionsPerNote:10,excludeTags:[],includeTags:[],semanticThreshold:.6},ne=class{constructor(t){T.required(t,"app"),this.vault=t.vault,this.metadataCache=t.metadataCache}async suggestLinks(t,e){if(!t||!(t instanceof Je.TFile))return[];let n={...lt,...e},s=await this.vault.read(t),i=this.metadataCache.getFileCache(t),a=this.getExistingLinks(i),o=[],r=this.vault.getMarkdownFiles().filter(c=>c.path!==t.path);for(let c of r){if(a.has(c.path))continue;let l=await this.calculateRelevance(t,c,s,n);l.relevanceScore>=n.minRelevanceScore&&o.push({targetFile:c.basename,targetPath:c.path,relevanceScore:l.relevanceScore,matchType:l.matchType,matchedPhrase:l.matchedPhrase,context:l.context})}return o.sort((c,l)=>l.relevanceScore-c.relevanceScore),o.slice(0,n.maxSuggestionsPerNote)}getExistingLinks(t){let e=new Set;if(!t)return e;if(t.links)for(let n of t.links){let s=this.metadataCache.getFirstLinkpathDest(n.link,"");s&&e.add(s.path)}if(t.embeds)for(let n of t.embeds){let s=this.metadataCache.getFirstLinkpathDest(n.link,"");s&&e.add(s.path)}return e}async calculateRelevance(t,e,n,s){let i=0,a="semantic",o,r,c=e.basename,l=await this.vault.read(e),d=this.metadataCache.getFileCache(e),g=this.metadataCache.getFileCache(t),m=new RegExp(`\\b${this.escapeRegex(c)}\\b`,"i");if(m.test(n)){i=1,a="exact",o=c;let S=n.match(m);return S&&(r=this.extractContext(n,S.index||0)),{relevanceScore:i,matchType:a,matchedPhrase:o,context:r}}let f=c.toLowerCase().split(/\s+/);for(let S of f)if(S.length>3){let C=new RegExp(`\\b${this.escapeRegex(S)}\\b`,"i");if(C.test(n)){let x=.8*(S.length/c.length);if(x>i){i=x,a="partial",o=S;let v=n.match(C);v&&(r=this.extractContext(n,v.index||0))}}}if(g!=null&&g.tags&&(d!=null&&d.tags)){let S=new Set(g.tags.map(v=>v.tag)),C=new Set(d.tags.map(v=>v.tag)),x=[...S].filter(v=>C.has(v));if(x.length>0){let v=.7*(x.length/Math.max(S.size,C.size));v>i&&(i=v,a="tag",o=x.join(", "))}}let y=this.calculateSemanticSimilarity(n,l);return y>=s.semanticThreshold&&y>i&&(i=y*.6,a="semantic"),this.getExistingLinks(d).has(t.path)&&(i=Math.min(1,i+.2)),{relevanceScore:i,matchType:a,matchedPhrase:o,context:r}}calculateSemanticSimilarity(t,e){let n=r=>{let c=r.toLowerCase().replace(/[#*_\[\]()]/g," ").split(/\s+/).filter(l=>l.length>3&&!/^\d+$/.test(l));return new Set(c)},s=n(t),i=n(e);if(s.size===0||i.size===0)return 0;let a=[...s].filter(r=>i.has(r)).length,o=s.size+i.size-a;return a/o}extractContext(t,e,n=100){let s=Math.max(0,e-n),i=Math.min(t.length,e+n),a=t.substring(s,i),o=a.lastIndexOf(".",n),r=a.indexOf(".",n);return o!==-1&&(a=a.substring(o+1)),r!==-1&&(a=a.substring(0,r+1)),a.trim()}escapeRegex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async applyLinks(t,e,n=!1){try{let s=await this.vault.read(t),i=0;for(let a of e){if(!a.matchedPhrase||a.matchType==="semantic")continue;let o=new RegExp(`\\b(${this.escapeRegex(a.matchedPhrase)})\\b(?!\\]\\])`,"gi");o.test(s)&&(s=s.replace(o,`[[$1|${a.matchedPhrase}]]`),i++)}return i>0&&n&&await this.vault.modify(t,s),i}catch(s){return console.error("Error applying links:",s),0}}generateReport(t,e){let n=[];if(n.push(`# Link Suggestions for [[${t.basename}]]
`),n.push(`**Generated:** ${new Date().toISOString()}
`),n.push(`**Suggestions Found:** ${e.length}
`),e.length===0)return n.push(`No link suggestions found.
`),n.join(`
`);n.push(`## Suggested Links
`);for(let s of e){let i=(s.relevanceScore*100).toFixed(1);n.push(`### [[${s.targetPath}|${s.targetFile}]]`),n.push(`- **Relevance:** ${i}%`),n.push(`- **Match Type:** ${s.matchType}`),s.matchedPhrase&&n.push(`- **Matched:** "${s.matchedPhrase}"`),s.context&&n.push(`- **Context:** "${s.context}"`),n.push("")}return n.join(`
`)}};var Re=require("obsidian");var dt={minConfidence:.4,maxSuggestions:5,learnFromHistory:!0,useSemanticSimilarity:!0},U=class{constructor(t){this.tagPatterns=null;this.idfCache=null;T.required(t,"app"),this.vault=t.vault,this.metadataCache=t.metadataCache}async suggestTags(t,e={}){if(!t||!(t instanceof Re.TFile))return[];let n={...dt,...e},s=await this.vault.read(t),i=this.getExistingTags(t),a=[];this.tagPatterns||await this.buildTagPatterns();let o=await this.suggestFromContent(s,i);if(a.push(...o),n.learnFromHistory){let c=await this.suggestFromPatterns(s,i);a.push(...c)}if(n.useSemanticSimilarity){let c=await this.suggestFromSimilarNotes(t,s,i);a.push(...c)}if(i.length>0){let c=this.suggestFromCoOccurrence(i);a.push(...c)}return this.mergeSuggestions(a).filter(c=>c.confidence>=n.minConfidence).sort((c,l)=>l.confidence-c.confidence).slice(0,n.maxSuggestions)}async applyTags(t,e){if(!t||!(t instanceof Re.TFile))throw new Error("Invalid file");let n=await this.vault.read(t),s=this.metadataCache.getFileCache(t);s!=null&&s.frontmatter?n=this.addTagsToFrontmatter(n,e):n=`
`+e.map(a=>`#${a}`).join(" ")+`

`+n,await this.vault.modify(t,n)}async buildTagPatterns(){this.tagPatterns=new Map;let t=this.vault.getMarkdownFiles(),e=new Map;for(let s of t){let i=this.metadataCache.getFileCache(s);if(!(i!=null&&i.tags))continue;let a=await this.vault.read(s),o=this.extractKeywords(a),r=i.tags.map(c=>c.tag);for(let c of r){this.tagPatterns.has(c)||this.tagPatterns.set(c,{tag:c,keywords:new Set,frequency:0,coOccurrences:new Map});let l=this.tagPatterns.get(c);l.frequency++,o.forEach(d=>l.keywords.add(d));for(let d of r)if(d!==c){let g=l.coOccurrences.get(d)||0;l.coOccurrences.set(d,g+1)}}o.forEach(c=>{e.set(c,(e.get(c)||0)+1)})}this.idfCache=new Map;let n=t.length;for(let[s,i]of e)this.idfCache.set(s,Math.log(n/i))}async suggestFromContent(t,e){var a;let n=[],s=this.extractKeywords(t),i=new Set(e);if(!this.tagPatterns)return n;for(let[o,r]of this.tagPatterns){if(i.has(o))continue;let c=s.filter(g=>r.keywords.has(g));if(c.length===0)continue;let l=0;for(let g of c){let m=((a=this.idfCache)==null?void 0:a.get(g))||1;l+=m}let d=Math.min(1,l/(r.keywords.size*.5));d>.3&&n.push({tag:o.replace("#",""),confidence:d,reason:"content_match",examples:c.slice(0,3)})}return n}async suggestFromPatterns(t,e){let n=[],s=this.extractKeywords(t),i=new Set(e);if(!this.tagPatterns)return n;for(let[a,o]of this.tagPatterns){if(i.has(a))continue;let r=s.filter(g=>o.keywords.has(g)).length;if(r<2)continue;let c=r/o.keywords.size,l=Math.log(o.frequency+1)/10,d=Math.min(1,c*.7+l*.3);d>.35&&n.push({tag:a.replace("#",""),confidence:d,reason:"pattern_learned"})}return n}async suggestFromSimilarNotes(t,e,n){let s=[],i=this.vault.getMarkdownFiles().filter(d=>d.path!==t.path),a=new Set(n),o=new Set(this.extractKeywords(e)),r=[];for(let d of i.slice(0,100)){let g=await this.vault.read(d),m=new Set(this.extractKeywords(g)),f=[...o].filter(S=>m.has(S)),y=new Set([...o,...m]),b=f.length/y.size;b>.3&&r.push({file:d,score:b})}r.sort((d,g)=>g.score-d.score);let c=new Map,l=new Map;for(let{file:d,score:g}of r.slice(0,5)){let m=this.metadataCache.getFileCache(d);if(m!=null&&m.tags)for(let f of m.tags){let y=f.tag.replace("#","");a.has(y)||(c.set(y,(c.get(y)||0)+1),l.set(y,Math.max(l.get(y)||0,g)))}}for(let[d,g]of c){let m=(l.get(d)||0)*(g/5);m>.3&&s.push({tag:d,confidence:m,reason:"similar_notes"})}return s}suggestFromCoOccurrence(t){let e=[];if(!this.tagPatterns)return e;let n=new Set(t.map(i=>i.startsWith("#")?i:`#${i}`)),s=new Map;for(let i of n){let a=this.tagPatterns.get(i);if(a)for(let[o,r]of a.coOccurrences)n.has(o)||s.set(o,(s.get(o)||0)+r)}for(let[i,a]of s){let o=Math.min(1,a/10);o>.3&&e.push({tag:i.replace("#",""),confidence:o,reason:"frequency"})}return e}mergeSuggestions(t){let e=new Map;for(let n of t){let s=e.get(n.tag);s?s.confidence=Math.min(1,Math.max(s.confidence,n.confidence)+Math.min(s.confidence,n.confidence)*.3):e.set(n.tag,{...n})}return Array.from(e.values())}getExistingTags(t){let e=this.metadataCache.getFileCache(t);return e!=null&&e.tags?e.tags.map(n=>n.tag.replace("#","")):[]}extractKeywords(t){let n=t.replace(/```[\s\S]*?```/g,"").replace(/`[^`]+`/g,"").replace(/!\[\[.*?\]\]/g,"").replace(/\[\[(.*?)\]\]/g,"$1").replace(/[#*_\[\]()]/g," ").toLowerCase().split(/\s+/).filter(s=>s.length>3).filter(s=>!/^\d+$/.test(s)).filter(s=>!this.isStopWord(s));return[...new Set(n)]}isStopWord(t){return new Set(["the","and","for","are","but","not","you","all","can","her","was","one","our","out","day","get","has","him","his","how","its","may","new","now","old","see","two","who","boy","did","she","use","way","will","with","this","that","have","from","they","been","what","when","make","like","time","just","know","take","into","year","your","some","could","them","than","then","these","would","other"]).has(t)}addTagsToFrontmatter(t,e){let n=/^---\n([\s\S]*?)\n---/,s=t.match(n);if(s){let i=s[1],a=/^tags:\s*(.*)$/m,o=i.match(a);if(o){let r=o[1].replace(/[\[\]]/g,"").split(",").map(g=>g.trim()).filter(g=>g),l=`tags: [${[...new Set([...r,...e])].join(", ")}]`,d=i.replace(a,l);return t.replace(n,`---
${d}
---`)}else{let r=`${i}
tags: [${e.join(", ")}]`;return t.replace(n,`---
${r}
---`)}}else return`---
tags: [${e.join(", ")}]
---

`+t}clearCache(){this.tagPatterns=null,this.idfCache=null}};var ht={level:"standard",includeSections:!1,includeKeyPoints:!0,includeQuotes:!1,maxLength:0,preserveStructure:!1},gt={mode:"thematic",includeCitations:!0,identifyGaps:!0,findContradictions:!0},H=class{constructor(t,e){T.required(t,"app"),T.required(e,"aiService"),this.vault=t.vault,this.aiService=e}async summarizeNote(t,e={}){let n={...ht,...e},s=await this.vault.read(t),i=n.includeSections?this.extractSections(s):null,a=this.buildSummaryPrompt(s,t.basename,n,i),r=(await this.aiService.generateCompletion(a)).text.trim(),c=n.includeKeyPoints?await this.extractKeyPoints(s):void 0,l=n.includeQuotes?this.extractQuotes(s):void 0;return{summary:r,level:n.level,wordCount:r.split(/\s+/).length,keyPoints:c,quotes:l,sections:i||void 0}}async synthesizeNotes(t,e={}){let n={...gt,...e},s=await Promise.all(t.map(async g=>({file:g,content:await this.vault.read(g)}))),i=this.buildSynthesisPrompt(s,n),o=(await this.aiService.generateCompletion(i)).text.trim(),r=n.mode==="thematic"?await this.extractThemes(o):void 0,c=n.findContradictions?this.identifyContradictions(o):void 0,l=n.identifyGaps?this.identifyGaps(o):void 0,d=n.includeCitations?this.extractCitations(o,t):new Map;return{synthesis:o,mode:n.mode,sources:t.map(g=>g.basename),themes:r,contradictions:c,gaps:l,citations:d}}async generateProgressiveSummary(t){let e=new Map,n=["quick","standard","detailed"];for(let s of n){let i=await this.summarizeNote(t,{level:s});e.set(s,i.summary)}return e}buildSummaryPrompt(t,e,n,s){let a={quick:`Provide a TL;DR summary of "${e}" in 1-2 sentences. Focus on the single most important idea.

Content:
${t}

TL;DR:`,standard:`Summarize "${e}" in a concise paragraph (3-5 sentences). Include the main points and key takeaways.

Content:
${t}

Summary:`,detailed:`Create a detailed summary of "${e}" with the following structure:
1. Overview (2-3 sentences)
2. Key Points (bulleted list of 5-7 main ideas)
3. Important Details (2-3 paragraphs covering significant information)
4. Conclusion (1-2 sentences)

Content:
${t}

Detailed Summary:`,academic:`Provide an academic-style summary of "${e}" with this structure:

**Abstract:** (150-200 words summarizing the entire content)

**Main Arguments/Claims:** (Bulleted list of key arguments or claims made)

**Methods/Approach:** (If applicable, how the topic is explored or analyzed)

**Key Findings/Insights:** (Main discoveries, conclusions, or insights)

**Implications:** (Significance and potential applications)

**References:** (Key concepts, theories, or sources mentioned)

Content:
${t}

Academic Summary:`}[n.level];if(n.includeSections&&s&&s.size>0){a+=`

Summarize each major section:
`;for(let[o,r]of s)a+=`
## ${o}
${r.substring(0,500)}...
`}return n.maxLength&&n.maxLength>0&&(a+=`

Keep the summary under ${n.maxLength} words.`),a}buildSynthesisPrompt(t,e){let n=e.topic||"the provided notes",s=`Synthesize insights across ${t.length} notes about ${n}.

Notes:
${t.map(o=>`
### [[${o.file.basename}]]
${this.extractKeyContent(o.content)}
`).join(`
`)}
`,i={thematic:`Organize the synthesis by themes:
1. Identify 3-5 major themes across the notes
2. For each theme, synthesize what the notes say
3. Note where notes agree, differ, or complement each other
4. Include [[note references]] for all claims`,chronological:`Organize the synthesis chronologically:
1. Identify the timeline or progression of ideas
2. Show how concepts developed or evolved
3. Highlight turning points or key developments
4. Connect earlier and later ideas`,comparative:`Organize the synthesis as a comparison:
1. Identify areas of agreement between notes
2. Highlight differences in perspective or approach
3. Analyze why differences exist
4. Synthesize a balanced view incorporating all perspectives`,argumentative:`Organize the synthesis as an argument:
1. Identify the main claim or thesis supported by these notes
2. Present supporting evidence from across notes
3. Address counterarguments or limitations
4. Build a coherent, well-supported argument`},a=s+`
`+i[e.mode];return e.identifyGaps&&(a+=`

**Knowledge Gaps:** Identify what information is missing or underexplored.`),e.findContradictions&&(a+=`

**Contradictions:** Note any contradictions or tensions between the notes.`),e.includeCitations&&(a+=`

Use [[note name]] format to cite sources for all claims.`),a}extractSections(t){let e=new Map,n=/^(#{1,6})\s+(.+)$/gm,s=[],i;for(;(i=n.exec(t))!==null;)s.push({level:i[1].length,title:i[2],position:i.index});for(let a=0;a<s.length;a++){let o=s[a].position,r=a<s.length-1?s[a+1].position:t.length,c=t.substring(o,r).trim();e.set(s[a].title,c)}return e}async extractKeyPoints(t){let e=[],n=t.match(/^[\s]*[-*]\s+(.+)$/gm);n&&n.length>0&&e.push(...n.map(i=>i.replace(/^[\s]*[-*]\s+/,"").trim()).slice(0,5));let s=t.split(/\n\n+/);for(let i of s.slice(0,5)){let a=i.match(/^[^.!?]+[.!?]/);if(a){let o=a[0].trim();o.length>20&&!e.includes(o)&&e.push(o)}}return e.slice(0,7)}extractQuotes(t){let e=[],n=t.match(/^>\s+(.+)$/gm);n&&e.push(...n.map(i=>i.replace(/^>\s+/,"").trim()));let s=t.match(/"([^"]{20,200})"/g);return s&&e.push(...s.slice(0,3)),e.slice(0,5)}extractKeyContent(t,e=1e3){let n=t.replace(/```[\s\S]*?```/g,"[code]");n=n.substring(0,e);let s=n.lastIndexOf(".");return s>e*.7&&(n=n.substring(0,s+1)),n+"..."}async extractThemes(t){let e=[],n=t.match(/^#{2,3}\s+(.+)$/gm);return n&&e.push(...n.map(s=>s.replace(/^#{2,3}\s+/,"").trim())),e}identifyContradictions(t){let e=[],n=["however","contradicts","conflicts with","disagrees","on the other hand","in contrast","while","whereas"],s=t.split(/[.!?]+/);for(let i of s){let a=i.toLowerCase();n.some(o=>a.includes(o))&&e.push(i.trim())}return e.slice(0,5)}identifyGaps(t){let e=[],n=["missing","unclear","not addressed","unexplored","gap","unknown","needs further","requires more"],s=t.split(/[.!?]+/);for(let i of s){let a=i.toLowerCase();n.some(o=>a.includes(o))&&e.push(i.trim())}return e.slice(0,5)}extractCitations(t,e){let n=new Map,s=/\[\[([^\]]+)\]\]/g,i;for(;(i=s.exec(t))!==null;){let a=i[1].split("|")[0].trim();if(e.find(r=>r.basename===a)){n.has(a)||n.set(a,[]);let r=Math.max(0,i.index-100),c=Math.min(t.length,i.index+100),l=t.substring(r,c).trim();n.get(a).push(l)}}return n}};var ut={exactMatchThreshold:1,nearDuplicateThreshold:.95,semanticThreshold:.7,minContentLength:50,ignoreFrontmatter:!0,compareTitle:!0,compareTags:!0},se=class{constructor(t){this.tfidfCache=null;this.idfCache=null;this.contentHashes=null;T.required(t,"app"),this.vault=t.vault,this.metadataCache=t.metadataCache}async findDuplicates(t={}){let e={...ut,...t},n=this.vault.getMarkdownFiles(),s=[],i=new Set;await this.buildCaches(n,e);let a=await this.findExactDuplicates(n,e);s.push(...a),a.forEach(c=>c.notes.forEach(l=>i.add(l.path)));let o=await this.findNearDuplicates(n.filter(c=>!i.has(c.path)),e);s.push(...o),o.forEach(c=>c.notes.forEach(l=>i.add(l.path)));let r=await this.findSemanticDuplicates(n.filter(c=>!i.has(c.path)),e);return s.push(...r),s}async compareNotes(t,e){let n=await this.vault.read(t),s=await this.vault.read(e),i=this.calculateSimilarity(n,s),a;i===1?a="exact":i>=.95?a="near-exact":t.basename.toLowerCase()===e.basename.toLowerCase()?a="title":a="semantic";let o=this.extractSections(n),r=this.extractSections(s),c=[],l=new Map;for(let[d,g]of o)r.has(d)?c.push(d):(l.has(t.basename)||l.set(t.basename,[]),l.get(t.basename).push(d));for(let[d,g]of r)o.has(d)||(l.has(e.basename)||l.set(e.basename,[]),l.get(e.basename).push(d));return{file1:t,file2:e,similarity:i,matchType:a,commonSections:c,uniqueSections:l}}async mergeDuplicates(t,e){if(t.notes.length<2)throw new Error("Need at least 2 notes to merge");let n;switch(e.type){case"keep-first":n=t.notes[0];break;case"keep-longest":n=await this.getLongestNote(t.notes);break;case"merge-content":n=await this.mergeContent(t.notes,e);break;default:n=t.notes[0]}e.createBackup&&await this.createBackups(t.notes);let s=new Set,i=new Set;if(e.preserveTags||e.preserveLinks)for(let o of t.notes){let r=this.metadataCache.getFileCache(o);e.preserveTags&&(r!=null&&r.tags)&&r.tags.forEach(c=>s.add(c.tag)),e.preserveLinks&&(r!=null&&r.links)&&r.links.forEach(c=>i.add(c.link))}let a=await this.vault.read(n);e.preserveTags&&s.size>0&&(a=this.addTagsToContent(a,[...s])),e.preserveLinks&&i.size>0&&(a=this.addLinksSection(a,[...i])),await this.vault.modify(n,a);for(let o of t.notes)o.path!==n.path&&await this.vault.delete(o);return n}async buildCaches(t,e){this.tfidfCache=new Map,this.idfCache=new Map,this.contentHashes=new Map;let n=new Map,s=t.length;for(let i of t){let a=await this.vault.read(i),o=this.cleanContent(a,e);if(o.length<e.minContentLength)continue;this.contentHashes.set(i.path,this.hashContent(o));let r=this.extractTerms(o),c=new Map;for(let g of r)c.set(g,(c.get(g)||0)+1);let l=Math.max(...c.values());for(let[g,m]of c)c.set(g,m/l);this.tfidfCache.set(i.path,c);let d=new Set(r);for(let g of d)n.set(g,(n.get(g)||0)+1)}for(let[i,a]of n)this.idfCache.set(i,Math.log(s/a));for(let[i,a]of this.tfidfCache){let o=new Map;for(let[r,c]of a){let l=this.idfCache.get(r)||0;o.set(r,c*l)}this.tfidfCache.set(i,o)}}async findExactDuplicates(t,e){let n=[],s=new Map;if(!this.contentHashes)return n;for(let i of t){let a=this.contentHashes.get(i.path);a&&(s.has(a)||s.set(a,[]),s.get(a).push(i))}for(let[i,a]of s)if(a.length>1){let o=await this.vault.read(a[0]);n.push({id:`exact-${i}`,notes:a,similarity:1,duplicateType:"exact",commonContent:o.substring(0,200)+"..."})}return n}async findNearDuplicates(t,e){let n=[],s=new Set;for(let i=0;i<t.length;i++){if(s.has(t[i].path))continue;let a=[t[i]];s.add(t[i].path);for(let o=i+1;o<t.length;o++){if(s.has(t[o].path))continue;await this.calculateNoteSimilarity(t[i],t[o])>=e.nearDuplicateThreshold&&(a.push(t[o]),s.add(t[o].path))}a.length>1&&n.push({id:`near-${t[i].path}`,notes:a,similarity:e.nearDuplicateThreshold,duplicateType:"near-exact"})}return n}async findSemanticDuplicates(t,e){let n=[],s=new Set;for(let i=0;i<t.length;i++){if(s.has(t[i].path))continue;let a=[t[i]];s.add(t[i].path);for(let o=i+1;o<t.length;o++){if(s.has(t[o].path))continue;let r=await this.calculateNoteSimilarity(t[i],t[o]);r>=e.semanticThreshold&&r<e.nearDuplicateThreshold&&(a.push(t[o]),s.add(t[o].path))}a.length>1&&n.push({id:`semantic-${t[i].path}`,notes:a,similarity:e.semanticThreshold,duplicateType:"semantic"})}return n}async calculateNoteSimilarity(t,e){if(!this.tfidfCache)return 0;let n=this.tfidfCache.get(t.path),s=this.tfidfCache.get(e.path);return!n||!s?0:this.cosineSimilarity(n,s)}cosineSimilarity(t,e){let n=0,s=0,i=0;for(let[a,o]of t){let r=e.get(a)||0;n+=o*r,s+=o*o}for(let a of e.values())i+=a*a;return s===0||i===0?0:n/(Math.sqrt(s)*Math.sqrt(i))}calculateSimilarity(t,e){let n=new Set(this.extractTerms(t)),s=new Set(this.extractTerms(e)),i=[...n].filter(o=>s.has(o)).length,a=new Set([...n,...s]).size;return a===0?0:i/a}cleanContent(t,e){let n=t;return e.ignoreFrontmatter&&(n=n.replace(/^---\n[\s\S]*?\n---\n/,"")),n=n.replace(/```[\s\S]*?```/g,""),n=n.replace(/`[^`]+`/g,""),n=n.replace(/\[\[([^\]]+)\]\]/g,"$1"),n=n.replace(/\[([^\]]+)\]\([^\)]+\)/g,"$1"),n=n.replace(/[#*_~]/g,""),n=n.replace(/\s+/g," ").trim(),n.toLowerCase()}extractTerms(t){return t.toLowerCase().split(/\s+/).filter(n=>n.length>2).filter(n=>!/^\d+$/.test(n)).filter(n=>!this.isStopWord(n))}isStopWord(t){return new Set(["the","and","for","are","but","not","you","all","can","her","was","one","our","out","day","get","has","him","his","how","its","may","new","now","old","see","two","who","boy","did","she","use","way","will","with","this","that","have","from","they","been","what","when","make","like","time"]).has(t)}hashContent(t){let e=0;for(let n=0;n<t.length;n++){let s=t.charCodeAt(n);e=(e<<5)-e+s,e=e&e}return e.toString(36)}extractSections(t){let e=new Map,n=/^#{1,6}\s+(.+)$/gm,s=[],i;for(;(i=n.exec(t))!==null;)s.push({title:i[1],position:i.index});for(let a=0;a<s.length;a++){let o=s[a].position,r=a<s.length-1?s[a+1].position:t.length;e.set(s[a].title,t.substring(o,r))}return e}async getLongestNote(t){let e=t[0],n=0;for(let s of t){let i=await this.vault.read(s);i.length>n&&(n=i.length,e=s)}return e}async mergeContent(t,e){return this.getLongestNote(t)}async createBackups(t){let e="Backups/Duplicates";for(let n of t){let s=await this.vault.read(n),i=`${e}/${n.basename} - ${Date.now()}.md`;await this.vault.create(i,s)}}addTagsToContent(t,e){let n=/^---\n([\s\S]*?)\n---/,s=t.match(n);if(s){let i=s[1],a=`tags: [${e.join(", ")}]`;if(i.includes("tags:"))return t;{let o=`${i}
${a}`;return t.replace(n,`---
${o}
---`)}}else return`${e.map(a=>a.startsWith("#")?a:`#${a}`).join(" ")}

${t}`}addLinksSection(t,e){let n=`

## Related Links
${e.map(s=>`- [[${s}]]`).join(`
`)}`;return t+n}clearCache(){this.tfidfCache=null,this.idfCache=null,this.contentHashes=null}};var Ie=require("obsidian"),ie=class{constructor(t,e,n,s){this.linkGraphCache=null;this.RECENCY_DECAY_DAYS=30;this.MAX_LINK_DISTANCE=3;this.vault=t,this.metadataCache=e,this.vectorStore=n,this.embeddingService=s}async buildSemanticClusters(){return new Map}async scoreNoteRelevance(t,e,n){let s=this.computeRecencyScore(t),i=0;n&&(i=this.computeLinkScore(n,t));let a=0,o=s*.3+i*.2,r=[];return s>70&&r.push("Recently modified"),i>50&&r.push("Connected via links"),{file:t,score:o,reasons:r,recencyScore:s,linkScore:i,semanticScore:a}}async getAdaptiveContext(t,e,n=4e3){if(!this.embeddingService)throw new Error("Embedding service required for adaptive context");let s=await this.embeddingService.generateEmbedding(e),i=await this.vectorStore.search(s.vector,20,.4),a=[],o=new Set,r=await this.vault.read(t),c=`# Current Note: ${t.basename}

${r}

`,l=this.estimateTokens(c);c+=`# Related Context (Semantic Search)

`;for(let d of i){if(d.id===t.path)continue;let g=this.vault.getAbstractFileByPath(d.id);if(!(g instanceof Ie.TFile))continue;let f=(await this.vault.read(g)).substring(0,500).replace(/\n/g," "),y=`## ${g.basename} (Relevance: ${(d.score*100).toFixed(0)}%)
${f}...

`,b=this.estimateTokens(y);if(l+b>n)break;c+=y,l+=b,a.push(g)}return{primaryNote:t,relatedNotes:a,contextText:c,tokenEstimate:l,includedClusters:Array.from(o)}}async detectProjectBoundaries(){var i,a;let t=new Map,e=this.vault.getMarkdownFiles(),n=new Map,s=new Map;for(let o of e){let r=this.metadataCache.getFileCache(o),c=[];if((i=r==null?void 0:r.frontmatter)!=null&&i.tags){let d=Array.isArray(r.frontmatter.tags)?r.frontmatter.tags:[r.frontmatter.tags];c.push(...d.map(String))}r!=null&&r.tags&&c.push(...r.tags.map(d=>d.tag));for(let d of c){let g=String(d).replace(/^#/,"");(g.startsWith("project-")||g.includes("project"))&&(n.has(g)||n.set(g,[]),n.get(g).push(o))}let l=((a=o.parent)==null?void 0:a.path)||"root";s.has(l)||s.set(l,[]),s.get(l).push(o)}for(let[o,r]of n){if(r.length<2)continue;let c=this.computeProjectStats(r);t.set(`tag-${o}`,{name:o,notes:r,startDate:c.startDate,lastModified:c.lastModified,isActive:this.isProjectActive(c.lastModified),tags:[o]})}for(let[o,r]of s){if(r.length<3||t.has(`folder-${o}`))continue;let c=this.computeProjectStats(r);t.set(`folder-${o}`,{name:o,notes:r,startDate:c.startDate,lastModified:c.lastModified,isActive:this.isProjectActive(c.lastModified),tags:[]})}return t}async findClusterMates(t){if(!this.vectorStore)return[];let e=this.vectorStore.get(t.path);if(!e)return[];let n=await this.vectorStore.search(e.vector,5,.5),s=[];for(let i of n){if(i.id===t.path)continue;let a=this.vault.getAbstractFileByPath(i.id);a instanceof Ie.TFile&&s.push(a)}return s}async getClusterTheme(t){return"Semantic Cluster"}computeRecencyScore(t){let n=(Date.now()-t.stat.mtime)/(1e3*60*60*24);return Math.max(0,100*Math.exp(-n/this.RECENCY_DECAY_DAYS))}computeLinkScore(t,e){let n=this.computeLinkDistance(t,e);return n===0?0:n===1?100:n===2?60:n===3?30:10}computeLinkDistance(t,e){var i;this.linkGraphCache||this.buildLinkGraph();let n=[[t.path,0]],s=new Set([t.path]);for(;n.length>0;){let[a,o]=n.shift();if(a===e.path)return o;if(o>=this.MAX_LINK_DISTANCE)continue;let r=((i=this.linkGraphCache)==null?void 0:i.get(a))||new Set;for(let c of r)s.has(c)||(s.add(c),n.push([c,o+1]))}return 0}buildLinkGraph(){this.linkGraphCache=new Map;let t=this.vault.getMarkdownFiles();for(let e of t){let n=this.metadataCache.getFileCache(e),s=new Set;if(n!=null&&n.links)for(let i of n.links){let a=this.metadataCache.getFirstLinkpathDest(i.link,e.path);a&&s.add(a.path)}this.linkGraphCache.set(e.path,s)}}computeProjectStats(t){let e=1/0,n=0;for(let s of t)s.stat.ctime<e&&(e=s.stat.ctime),s.stat.mtime>n&&(n=s.stat.mtime);return{startDate:e,lastModified:n}}isProjectActive(t){return(Date.now()-t)/(1e3*60*60*24)<7}estimateTokens(t){return Math.ceil(t.length/4)}clearCaches(){this.linkGraphCache=null}};var ae=class{constructor(t,e,n,s){this.vault=t,this.metadataCache=e,this.contextEngine=n,this.aiService=s}async synthesizeNotes(t,e){let n=new Map,s=[];for(let l of t){let d=await this.vault.read(l);s.push(`# ${l.basename}
${d}`);let g=this.extractKeyPassages(d);g.length>0&&n.set(l.basename,g)}let i=s.join(`

---

`),a=this.buildSynthesisPrompt(i,e),r=(await this.aiService.generateCompletion(a)).text;return{...this.parseSynthesisResponse(r),citations:n,notesAnalyzed:t.length}}async researchQuery(t){let e=await this.findMatchingNotes(t);return e.length===0?{summary:"No notes found matching your query.",keyInsights:[],contradictions:[],knowledgeGaps:["No existing notes on this topic"],citations:new Map,notesAnalyzed:0}:await this.synthesizeNotes(e,t.query)}async extractArgumentMap(t){let e=[],n=[],s=[];for(let a of t){let o=await this.vault.read(a),r=await this.extractClaims(o,a.basename);e.push(...r);let c=await this.extractEvidence(o,a.basename);n.push(...c)}for(let a of n)for(let o of e)this.evidenceSupports(a,o)&&(s.push({from:a.id,to:o.id,type:"supports"}),a.supportsClaims.push(o.id));for(let a=0;a<e.length;a++)for(let o=a+1;o<e.length;o++)this.claimsContradict(e[a],e[o])&&s.push({from:e[a].id,to:e[o].id,type:"contradicts"});let i=[];for(let a of e)s.filter(r=>r.to===a.id&&r.type==="supports").length===0&&i.push(`Claim "${a.text.substring(0,50)}..." lacks supporting evidence`);return{claims:e,evidence:n,relationships:s,logicalGaps:i}}async findContradictions(t){let e=await this.extractArgumentMap(t),n=[];for(let s of e.relationships)if(s.type==="contradicts"){let i=e.claims.find(o=>o.id===s.from),a=e.claims.find(o=>o.id===s.to);i&&a&&n.push(`"${i.text}" (${i.sourceNote}) contradicts "${a.text}" (${a.sourceNote})`)}return n}async identifyKnowledgeGaps(t,e){let n=[],s=await this.synthesizeNotes(e,t),i=`Based on the following research summary about "${t}", identify key knowledge gaps and unanswered questions:

${s.summary}

Key insights found:
${s.keyInsights.map((c,l)=>`${l+1}. ${c}`).join(`
`)}

Provide a list of 5-10 important questions or gaps that remain unanswered in this research. Focus on:
- Missing perspectives or viewpoints
- Unexplored connections
- Methodological limitations
- Areas needing more evidence
- Conflicting information that needs resolution

Format: One gap per line, as a question or statement.`,r=(await this.aiService.generateCompletion(i)).text.split(`
`).filter(c=>c.trim().length>0);for(let c of r){let l=c.replace(/^[\d.\-*\s]+/,"").trim();l.length>10&&n.push(l)}return n}async suggestResearchDirections(t,e){let n=[],s=await this.synthesizeNotes(e,t),i=await this.identifyKnowledgeGaps(t,e),a=`Based on this research about "${t}":

Summary: ${s.summary}

Knowledge Gaps:
${i.map((l,d)=>`${d+1}. ${l}`).join(`
`)}

Suggest 3-5 promising research directions to pursue next. For each direction:
1. Describe the research direction
2. Explain why it's valuable
3. Suggest specific sources or methods to explore

Format each suggestion as:
DIRECTION: [brief title]
REASONING: [why this matters]
SOURCES: [specific suggestions]
PRIORITY: [high/medium/low]
---`,c=(await this.aiService.generateCompletion(a)).text.split("---").filter(l=>l.trim());for(let l of c){let d=this.extractField(l,"DIRECTION"),g=this.extractField(l,"REASONING"),m=this.extractField(l,"SOURCES"),f=this.extractField(l,"PRIORITY");d&&g&&n.push({direction:d,reasoning:g,suggestedSources:m?[m]:[],priority:f||"medium"})}return n}async answerResearchQuestion(t,e=20){let n=this.vault.getMarkdownFiles(),s=[];for(let d of n){let g=await this.contextEngine.scoreNoteRelevance(d,t);g.score>30&&s.push(g)}s.sort((d,g)=>g.score-d.score);let i=s.slice(0,e).map(d=>d.file),a=[];for(let d of i){let g=await this.vault.read(d),m=this.extractRelevantExcerpt(g,t,500);a.push(`[${d.basename}]
${m}`)}let o=a.join(`

---

`),r=`Answer the following research question based on the provided notes from my knowledge base:

QUESTION: ${t}

KNOWLEDGE BASE EXCERPTS:
${o}

Provide a comprehensive answer that:
1. Synthesizes information from multiple sources
2. Cites specific notes in the format [[Note Name]]
3. Acknowledges any contradictions or uncertainties
4. Identifies gaps in available information
5. Provides a clear, well-reasoned conclusion

ANSWER:`;return(await this.aiService.generateCompletion(r)).text}async findMatchingNotes(t){let e=this.vault.getMarkdownFiles();t.tags&&t.tags.length>0&&(e=e.filter(i=>{let a=this.metadataCache.getFileCache(i),o=this.extractTags(a);return t.tags.some(r=>o.includes(r))})),t.folders&&t.folders.length>0&&(e=e.filter(i=>{var o;let a=((o=i.parent)==null?void 0:o.path)||"";return t.folders.some(r=>a.startsWith(r))})),t.dateRange&&(e=e.filter(i=>{let a=i.stat.mtime;return a>=t.dateRange.start&&a<=t.dateRange.end}));let n=[];for(let i of e){let a=await this.contextEngine.scoreNoteRelevance(i,t.query);a.score>30&&n.push(a)}n.sort((i,a)=>a.score-i.score);let s=t.maxNotes||10;return n.slice(0,s).map(i=>i.file)}extractTags(t){var n;let e=[];if((n=t==null?void 0:t.frontmatter)!=null&&n.tags){let s=Array.isArray(t.frontmatter.tags)?t.frontmatter.tags:[t.frontmatter.tags];e.push(...s.map(String))}return t!=null&&t.tags&&e.push(...t.tags.map(s=>s.tag)),e}extractKeyPassages(t,e=5){let n=[],s=t.split(`
`),i=["**","==","- [ ]","> ","# "];for(let a of s){if(n.length>=e)break;let o=a.trim();o.length<20||i.some(r=>o.includes(r))&&n.push(o)}return n}buildSynthesisPrompt(t,e){return`Synthesize the following notes ${e?`with particular focus on: "${e}"`:"across all topics covered"}.

${t}

Provide:
1. SUMMARY: A comprehensive synthesis (2-3 paragraphs)
2. KEY INSIGHTS: 5-7 most important insights (bullet points)
3. CONTRADICTIONS: Any conflicting information found (if any)
4. KNOWLEDGE GAPS: What important questions remain unanswered

Format your response with clear section headers.`}parseSynthesisResponse(t){let e=this.extractSection(t,"SUMMARY")||t,n=this.extractBulletPoints(t,"KEY INSIGHTS"),s=this.extractBulletPoints(t,"CONTRADICTIONS"),i=this.extractBulletPoints(t,"KNOWLEDGE GAPS");return{summary:e,keyInsights:n,contradictions:s,knowledgeGaps:i}}extractSection(t,e){let n=new RegExp(`${e}:?\\s*([\\s\\S]*?)(?=\\n\\n[A-Z]|$)`,"i"),s=t.match(n);return s?s[1].trim():null}extractBulletPoints(t,e){let n=this.extractSection(t,e);return n?n.split(`
`).map(i=>i.replace(/^[\d.\-*\s]+/,"").trim()).filter(i=>i.length>0):[]}async extractClaims(t,e){let n=[],s=t.split(/[.!?]+/).filter(a=>a.trim().length>20),i=["is","are","must","will","should","proves","demonstrates"];for(let a=0;a<s.length;a++){let o=s[a].trim();i.some(r=>o.toLowerCase().includes(` ${r} `))&&n.push({id:`claim-${e}-${a}`,text:o,sourceNote:e,confidence:"medium",type:"supporting"})}return n.slice(0,10)}async extractEvidence(t,e){let n=[],s=["according to","research shows","data indicates","study found"],i=t.split(/[.!?]+/).filter(a=>a.trim().length>20);for(let a=0;a<i.length;a++){let o=i[a].trim().toLowerCase();s.some(r=>o.includes(r))&&n.push({id:`evidence-${e}-${a}`,text:i[a].trim(),sourceNote:e,supportsClaims:[],type:"empirical"})}return n}evidenceSupports(t,e){let n=new Set(this.extractKeywords(t.text)),s=new Set(this.extractKeywords(e.text)),i=0;for(let a of s)n.has(a)&&i++;return i>=2}claimsContradict(t,e){let n=t.text.toLowerCase(),s=e.text.toLowerCase(),i=[["is","is not"],["must","must not"],["should","should not"],["increases","decreases"],["positive","negative"]];for(let[a,o]of i)if(n.includes(a)&&s.includes(o)||n.includes(o)&&s.includes(a)){let r=new Set(this.extractKeywords(n)),c=new Set(this.extractKeywords(s)),l=0;for(let d of r)c.has(d)&&l++;if(l>=2)return!0}return!1}extractKeywords(t){let e=t.toLowerCase().replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(s=>s.length>3),n=new Set(["this","that","with","from","have","been","will","would"]);return e.filter(s=>!n.has(s))}extractRelevantExcerpt(t,e,n){let s=new Set(this.extractKeywords(e)),i=t.split(`

`),a=i[0]||"",o=0;for(let r of i){if(r.trim().length<50)continue;let c=new Set(this.extractKeywords(r)),l=0;for(let d of s)c.has(d)&&l++;l>o&&(o=l,a=r)}return a.length<=n?a:a.substring(0,n)+"..."}extractField(t,e){let n=new RegExp(`${e}:?\\s*(.+?)(?=\\n[A-Z]+:|$)`,"i"),s=t.match(n);return s?s[1].trim():""}};var Ne=require("obsidian"),oe=class{constructor(t){this.settings=t}async generateEmbedding(t){var n;if(!t||t.trim().length===0)throw new Error("Text is empty");let e=((n=this.settings.embeddingConfig)==null?void 0:n.provider)||"openai";if(e==="local")throw new Error("Local (Transformers.js) embeddings not yet implemented");return e==="ollama"?this.generateOllamaEmbedding(t):this.generateOpenAIEmbedding(t)}async generateOllamaEmbedding(t){var a;let e=this.settings.customApiUrl||"http://localhost:11434",n=((a=this.settings.embeddingConfig)==null?void 0:a.model)||"llama2",s=await(0,Ne.requestUrl)({url:`${e}/api/embeddings`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:n,prompt:t})});if(s.status!==200)throw new Error(`Ollama Embedding failed: ${s.status} - ${s.text}`);return{vector:s.json.embedding,tokensUsed:0}}async generateOpenAIEmbedding(t){var s;if(!this.settings.apiKey)throw new Error("OpenAI API key is required for embeddings");let e=await(0,Ne.requestUrl)({url:"https://api.openai.com/v1/embeddings",method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.settings.apiKey}`},body:JSON.stringify({input:t,model:((s=this.settings.embeddingConfig)==null?void 0:s.model)||"text-embedding-3-small"})});if(e.status!==200)throw new Error(`Embedding request failed: ${e.status} - ${e.text}`);let n=e.json;return{vector:n.data[0].embedding,tokensUsed:n.usage.total_tokens}}};var O=class{constructor(t,e=".obsidian/plugins/obsidian-agent/vector_store.json"){this.vectors=new Map;this.metadata=new Map;this.vault=t,this.STORAGE_FILE=e}async add(t){this.vectors.set(t.id,t.vector),this.metadata.set(t.id,t.metadata)}async remove(t){this.vectors.delete(t),this.metadata.delete(t)}get(t){let e=this.vectors.get(t),n=this.metadata.get(t);return!e||!n?null:{id:t,vector:e,metadata:n,content:n.content||""}}async search(t,e=10,n=0,s=!0){let i=[],a=Date.now(),o=30*24*60*60*1e3;for(let[r,c]of this.vectors){let l=this.cosineSimilarity(t,c);if(s&&l>.3){let d=this.metadata.get(r);if(d&&d.mtime){let g=a-d.mtime,m=Math.max(0,.1*(1-g/(6*o)));l=l*(1+m)}}l>=n&&i.push({id:r,score:l,metadata:this.metadata.get(r)||{}})}return i.sort((r,c)=>c.score-r.score).slice(0,e)}async save(){let t={version:1,vectors:Object.fromEntries(this.vectors),metadata:Object.fromEntries(this.metadata)};await this.vault.adapter.write(this.STORAGE_FILE,JSON.stringify(t))}async load(){if(await this.vault.adapter.exists(this.STORAGE_FILE))try{let t=await this.vault.adapter.read(this.STORAGE_FILE);if(!t||t.trim()==="")return;let e=JSON.parse(t);e&&typeof e=="object"&&(e.vectors&&typeof e.vectors=="object"&&(this.vectors=new Map(Object.entries(e.vectors))),e.metadata&&typeof e.metadata=="object"&&(this.metadata=new Map(Object.entries(e.metadata)))),console.log(`VectorStore loaded: ${this.vectors.size} documents.`)}catch(t){console.error("Failed to load VectorStore:",t)}}async clear(){this.vectors.clear(),this.metadata.clear(),await this.save()}size(){return this.vectors.size}cosineSimilarity(t,e){let n=0,s=0,i=0;for(let a=0;a<t.length;a++)n+=t[a]*e[a],s+=t[a]*t[a],i+=e[a]*e[a];return s===0||i===0?0:n/(Math.sqrt(s)*Math.sqrt(i))}};var re=require("obsidian"),ce=class{constructor(t,e,n){this.app=t,this.embeddingService=e,this.vectorStore=n}async indexVault(t=!1){let e=this.app.vault.getMarkdownFiles(),n=e.length,s=0,i=0,a=0,o=0;new re.Notice(`Starting vault index... (${n} files)`);for(let r of e){s++,s%10===0&&new re.Notice(`Indexing: ${s}/${n} files...`,2e3);try{let c=this.vectorStore.get(r.path);if(!t&&c&&c.metadata.mtime===r.stat.mtime){o++;continue}let l=await this.app.vault.read(r);if(!l.trim()){o++;continue}let d=l.substring(0,3e4),g=await this.embeddingService.generateEmbedding(d);await this.vectorStore.add({id:r.path,vector:g.vector,content:d,metadata:{mtime:r.stat.mtime,basename:r.basename,path:r.path}}),i++}catch(c){console.error(`Failed to index ${r.path}`,c),a++}}await this.vectorStore.save(),new re.Notice(`Indexing complete!
Indexed: ${i}
Skipped: ${o}
Failed: ${a}`)}};var le=class{constructor(){this.maxMessages=20;this.maxAge=36e5;this.context={messages:[],goals:[],mentioned_notes:[],mentioned_concepts:[],unresolved_questions:[],user_preferences:new Map}}addMessage(t,e,n){let s={role:t,content:e,timestamp:Date.now(),metadata:n};this.context.messages.push(s),this.extractGoals(e),this.extractMentions(e),this.extractQuestions(e,t),this.pruneOldMessages()}extractGoals(t){let e=[/I (?:want|need) to (.+?)(?:\.|$)/gi,/(?:help me|I'm trying to) (.+?)(?:\.|$)/gi,/my goal is to (.+?)(?:\.|$)/gi,/I'm working on (.+?)(?:\.|$)/gi];for(let n of e){let s=t.matchAll(n);for(let i of s){let a=i[1].trim();a.length>5&&!this.context.goals.includes(a)&&this.context.goals.push(a)}}this.context.goals.length>5&&(this.context.goals=this.context.goals.slice(-5))}extractMentions(t){let e=t.matchAll(/\[\[([^\]]+)\]\]/g);for(let s of e){let i=s[1];this.context.mentioned_notes.includes(i)||this.context.mentioned_notes.push(i)}let n=t.matchAll(/"([^"]+)"/g);for(let s of n){let i=s[1];i.length>3&&!this.context.mentioned_concepts.includes(i)&&this.context.mentioned_concepts.push(i)}this.context.mentioned_notes.length>10&&(this.context.mentioned_notes=this.context.mentioned_notes.slice(-10)),this.context.mentioned_concepts.length>10&&(this.context.mentioned_concepts=this.context.mentioned_concepts.slice(-10))}extractQuestions(t,e){if(e==="user"){if(t.includes("?")){let n=t.split("?").filter(s=>s.trim().length>5);for(let s of n){let i=s.trim()+"?";this.context.unresolved_questions.includes(i)||this.context.unresolved_questions.push(i)}}}else this.context.unresolved_questions=this.context.unresolved_questions.filter(n=>t.length<200||t.includes("clarify")||t.includes("not sure"));this.context.unresolved_questions.length>3&&(this.context.unresolved_questions=this.context.unresolved_questions.slice(-3))}pruneOldMessages(){let t=Date.now();this.context.messages=this.context.messages.filter(e=>t-e.timestamp<this.maxAge),this.context.messages.length>this.maxMessages&&(this.context.messages=this.context.messages.slice(-this.maxMessages))}learnPreference(t,e){this.context.user_preferences.set(t,e)}getPreference(t){return this.context.user_preferences.get(t)}getSummary(){let t="";return this.context.goals.length>0&&(t+=`User goals: ${this.context.goals.join(", ")}
`),this.context.mentioned_notes.length>0&&(t+=`Discussed notes: ${this.context.mentioned_notes.map(e=>`[[${e}]]`).join(", ")}
`),this.context.mentioned_concepts.length>0&&(t+=`Key concepts: ${this.context.mentioned_concepts.join(", ")}
`),this.context.unresolved_questions.length>0&&(t+=`Unresolved: ${this.context.unresolved_questions.join("; ")}
`),t}getContext(){let t=this.getSummary();return t?`
[Session Context]
${t}
`:""}getHistory(t=5){return this.context.messages.slice(-t)}wasDiscussed(t){let e=t.toLowerCase();return this.context.mentioned_notes.some(s=>s.toLowerCase().includes(e))||this.context.mentioned_concepts.some(s=>s.toLowerCase().includes(e))?!0:this.getHistory(10).some(s=>s.content.toLowerCase().includes(e))}getCurrentGoal(){return this.context.goals[this.context.goals.length-1]}clear(){this.context={messages:[],goals:[],mentioned_notes:[],mentioned_concepts:[],unresolved_questions:[],user_preferences:new Map}}export(){return{...this.context,user_preferences:Array.from(this.context.user_preferences.entries())}}import(t){this.context={...t,user_preferences:new Map(t.user_preferences||[])}}};var de=class{estimate(t,e){let n=this.estimateFactualConfidence(t,e),s=this.estimateLogicalConfidence(t),i=this.estimateCompleteness(t,e),a=n*.4+s*.3+i*.3,o=a>=.7?"high":a>=.4?"medium":"low",r=this.generateDisclaimers(n,s,i,e);return{factual:n,logical:s,complete:i,overall:a,level:o,disclaimers:r}}estimateFactualConfidence(t,e){let n=.5;e.vaultSearchResults>0&&(n+=.3);let s=(t.match(/\[\[([^\]]+)\]\]/g)||[]).length;n+=Math.min(s*.05,.2);let i=[/I think/gi,/probably/gi,/might be/gi,/could be/gi,/I'm not sure/gi,/possibly/gi];for(let a of i)a.test(t)&&(n-=.1);return!e.vaultSearchResults&&!s&&(n-=.2),Math.max(0,Math.min(1,n))}estimateLogicalConfidence(t){let e=.6,n=[/because/gi,/therefore/gi,/this means/gi,/as a result/gi,/consequently/gi];for(let a of n)a.test(t)&&(e+=.1);let s=[/(?:but|however),?\s+(?:also|still)/gi,/on the other hand/gi];for(let a of s)a.test(t)&&(e-=.15);let i=t.match(/if\s+.*?then/gi);return i&&i.length>2&&(e-=.1),Math.max(0,Math.min(1,e))}estimateCompleteness(t,e){let n=.5;t.length>300&&(n+=.2),(t.includes("NEXT STEP")||t.includes("\u{1F3AF}"))&&(n+=.2),(t.includes("Alternative")||t.includes("option"))&&(n+=.1),t.trim().endsWith("?")&&(n-=.2);let s=[/I couldn't find/gi,/I don't have enough information/gi,/I need to know more about/gi,/missing/gi];for(let i of s)i.test(t)&&(n-=.15);return Math.max(0,Math.min(1,n))}generateDisclaimers(t,e,n,s){let i=[];return t<.5&&(s.vaultSearchResults?i.push("I have limited confidence in these facts - please verify"):i.push("I couldn't find this information in your vault, so I'm relying on general knowledge")),e<.5&&i.push("This reasoning involves some assumptions that may not apply to your situation"),n<.4&&i.push("This answer may be incomplete - I may be missing important context"),t<.3&&e<.3&&i.push("\u26A0\uFE0F Low confidence: This response is speculative and should be verified"),i}formatConfidence(t){if(t.level==="high")return"";let e=`
---
`;return t.level==="medium"?e+=`**\u{1F4CA} Confidence: Medium**
`:e+=`**\u26A0\uFE0F Confidence: Low**
`,t.disclaimers.length>0&&(e+=t.disclaimers.map(n=>`- ${n}`).join(`
`),e+=`
`),t.level==="low"&&(e+=`
*Please verify this information before relying on it.*
`),e}shouldWarn(t){return t.level==="low"||t.overall<.4}getLowConfidenceNextStep(t){return t.factual<.4?"Verify facts against reliable sources or search your vault for related content":t.logical<.4?"Review the reasoning and consider alternative perspectives":t.complete<.4?"Provide additional context or clarify your question for a more complete answer":"Verify this information independently"}};var he=class{constructor(t,e,n,s){this.maxSteps=10;this.momentumThreshold=8;this.aiService=t,this.tools=e,this.settings=n,this.memoryService=s,this.conversationMemory=new le,this.confidenceEstimator=new de}async run(t){this.conversationMemory.addMessage("user",t);let e=await this.memoryService.getContextualMemory(t),n=this.settings.agentCorePrompt+`

`;n+=this.getEnforcementInstructions();let s=n+`
`;s+=this.formatMemoryContext(e);let i=this.conversationMemory.getContext();i&&(s+=`Recent Conversation:
`+i+`
`),s+=`Available tools:
`,this.tools.forEach(l=>s+=`- ${l.name}: ${l.description}
`),s+=`
User's question: ${t}
`;let a=0,o=0,r=2,c={toolsUsed:[],vaultSearchResults:0};for(;a<this.maxSteps;){a++;let d=(await this.aiService.generateCompletion({prompt:s})).text,g=d.match(/Action:\s*(.+?)$/m),m=d.match(/Action Input:\s*(.+?)$/m);if(g&&m){s+=d+`
`;let S=g[1].trim(),C=this.tools.find(x=>x.name===S);if(C){c.toolsUsed.push(S);try{let x=await C.execute(m[1].trim());s+=`Observation: ${x}

`,S.toLowerCase().includes("search")&&(c.vaultSearchResults=Math.max(c.vaultSearchResults,(x.match(/\n/g)||[]).length))}catch(x){s+=`Observation: Error executing tool - ${x.message}

`}}else s+=`Observation: Error - tool "${S}" not found.

`;continue}let f=G(d),y=this.evaluateResponse(f,d,c,a);if(!y.valid||y.momentumScore<this.momentumThreshold)if(o<r){o++,s+=d+`

**SELF-EVALUATION FEEDBACK (Retry ${o}/${r}):**
`+y.feedback;continue}else return this.applyFallbackLadder(f,y.confidence);this.conversationMemory.addMessage("agent",d,{tools_used:c.toolsUsed,confidence:y.confidence.overall});let b=Ve(f);return y.confidence.level!=="high"&&(b+=`

`+this.confidenceEstimator.formatConfidence(y.confidence)),b}return"I apologize, but I couldn't reach a high-momentum conclusion. Recommended next move: break your request into smaller parts."}getEnforcementInstructions(){return`**MOMENTUM POLICY - STRICT ENFORCEMENT:**
1. Every response MUST include a concrete NEXT STEP.
2. Response is INVALID if no actionable continuation exists.
3. You must use exactly ONE of these 3 continuation types:
   - **do_now**: A single concrete action to perform immediately.
   - **choose_path**: 2-3 clear options with trade-offs.
   - **unblock**: Specific info needed if you are stuck.

**RESPONSE CONTRACT:**
Your output must include a YAML block at the end:
\`\`\`yaml
answer: <direct response>
reasoning_summary: <rationale>
next_step:
  action: <single best action>
  owner: <user|agent>
  effort: <5m|30m|half-day|1-day|2-days+>
  expected_outcome: <success criteria>
  type: <do_now|choose_path|unblock>
alternatives:
  - option: <path A>
    when_to_use: <condition>
risks:
  - <main risk>
mitigation:
  - <how to reduce risk>
\`\`\`
Maintain 70/30 ratio: 70% answer, 30% action.`}formatMemoryContext(t){let e="";return t.user.length>0&&(e+=`[User Preferences]
${t.user.join(`
`)}

`),t.session.length>0&&(e+=`[Task Context]
${t.session.join(`
`)}

`),t.longTerm.length>0&&(e+=`[Relevant SOPs/Knowledge]
${t.longTerm.join(`
`)}

`),e}evaluateResponse(t,e,n,s){var l;let i=qe(t),a=je(t),o=Ge(e),r=this.confidenceEstimator.estimate(e,{vaultSearchResults:n.vaultSearchResults,toolsUsed:n.toolsUsed,reasoningSteps:s}),c="";return i.valid||(c+=`- Missing fields: ${(l=i.missing_fields)==null?void 0:l.join(", ")}
`),o&&(c+=`- Avoid dead-end phrasing. Propose a concrete action.
`),a<this.momentumThreshold&&(c+=`- Low momentum (${a}/10). Make the next step more specific and ambitious.
`),{valid:i.valid&&!o,momentumScore:a,confidence:r,feedback:c}}applyFallbackLadder(t,e){let n=t.answer||"I'm having trouble finding a clear path forward.";return n+=`

---
**\u{1F3AF} FALLBACK PLAN:**
`,e.level==="low"?(n+=`- **Minimal Viable Action**: I will run a diagnostic check on the current file path.
`,n+=`- **Clarification**: I'm assuming you want to organize based on content similarity. Is that correct?
`,n+=`- **Next Step (unblock)**: Please confirm the target folder name or provide more context on the desired structure.
`):(n+=`- **Option A**: Proceed with current assumptions but use a temporary backup folder.
`,n+=`- **Option B**: List all relevant tags first to manually select the best one.
`,n+=`- **Next Step (choose_path)**: Select Option A to move fast, or Option B for more control.
`),n}clearMemory(){this.conversationMemory.clear()}getConversationSummary(){return this.conversationMemory.getSummary()}};var Ze=require("obsidian");var ge=class{constructor(t,e){this.sessionMemories=[];this.vectorStore=new O(t,".obsidian/plugins/obsidian-agent/memory_store.json"),this.embeddingService=e}async load(){await this.vectorStore.load()}async addMemory(t,e="long_term",n={}){if(!t||t.trim().length===0)return;let s=`memory_${e}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,i={id:s,text:t,timestamp:Date.now(),layer:e,metadata:{...n,text:t,layer:e}};if(e==="session")this.sessionMemories.push(i),this.sessionMemories.length>50&&this.sessionMemories.shift();else{let a=await this.embeddingService.generateEmbedding(t);await this.vectorStore.add({id:s,vector:a.vector,content:t,metadata:i.metadata}),await this.vectorStore.save()}}async getRelevantMemories(t,e=10){let n=await this.getContextualMemory(t,e);return[...n.session,...n.user,...n.longTerm].slice(0,e)}async getContextualMemory(t,e=10){let n=await this.embeddingService.generateEmbedding(t),s=await this.vectorStore.search(n.vector,e,.5);return{session:this.sessionMemories.filter(a=>this.isTextRelevant(a.text,t)).map(a=>a.text),user:s.filter(a=>a.metadata.layer==="user").map(a=>a.metadata.text),longTerm:s.filter(a=>a.metadata.layer==="long_term").map(a=>a.metadata.text)}}isTextRelevant(t,e){let n=e.toLowerCase().split(/\s+/).filter(i=>i.length>3),s=t.toLowerCase();return n.some(i=>s.includes(i))||n.length===0}async learnUserPreference(t){await this.addMemory(t,"user")}async clearSession(){this.sessionMemories=[]}async clearAll(){this.sessionMemories=[],await this.vectorStore.clear()}};var ue=class{constructor(t,e){this.vectorStore=t;this.embeddingService=e;this.name="search_vault";this.description="Search the vault for notes relevant to a query. Returns a list of note paths and relevance scores. Input: A search query string."}async execute(t){try{let e=await this.embeddingService.generateEmbedding(t),n=await this.vectorStore.search(e.vector,10,.4);return n.length===0?"No relevant notes found.":n.map(s=>`- ${s.id} (Score: ${(s.score*100).toFixed(0)}%)`).join(`
`)}catch(e){return`Error searching vault: ${e.message}`}}},me=class{constructor(t){this.app=t;this.name="read_note";this.description='Read the content of a specific note. Input: The exact file path of the note (e.g., "Folder/My Note.md").'}async execute(t){let e=this.app.vault.getAbstractFileByPath(t.trim());if(!e||!(e instanceof Ze.TFile))return`Error: Note not found at path "${t}".`;try{let n=await this.app.vault.read(e);return`Content of "${e.path}":

${n}`}catch(n){return`Error reading note: ${n.message}`}}},pe=class{constructor(t){this.app=t;this.name="list_files";this.description='List all files in a specific folder. Input: The folder path (e.g., "Projects"). Leave empty for root.'}async execute(t){let e=t.trim()||"/",n=this.app.vault.getAbstractFileByPath(e);return e==="/"||e===""?this.app.vault.getRoot().children.map(i=>i.path).join(`
`):n&&"children"in n?n.children.map(i=>i.path).join(`
`):`Error: Folder not found at "${e}".`}},fe=class{constructor(t){this.memoryService=t;this.name="remember";this.description='Save information to memory. Input format: "<layer>|<text>". Valid layers: "user" (preferences/identity), "session" (current task state), "long_term" (facts/decisions). Example: "user|Prefers concise code summaries"'}async execute(t){try{let e="long_term",n=t;if(t.includes("|")){let s=t.split("|"),i=s[0].trim().toLowerCase();n=s.slice(1).join("|").trim(),i==="user"?e="user":i==="session"&&(e="session")}return await this.memoryService.addMemory(n,e),`Information saved to ${e} memory: "${n}"`}catch(e){return`Error saving to memory: ${e.message}`}}};var ve=require("obsidian"),ye=class{constructor(t){this.app=t;this.name="create_note";this.description='Create a new note in the vault. Input format: "path:Title of Note|content:Content here" or just the title.'}async execute(t){try{let e="",n="";if(t.includes("path:")&&t.includes("|content:")){let a=t.split("|content:");e=a[0].replace("path:","").trim(),n=a[1].trim()}else if(t.includes("|")){let[a,o]=t.split("|");e=`${a.trim()}.md`,n=o.trim()}else e=`${t.trim()}.md`,n=`# ${t.trim()}

Created by Obsidian Agent
`;if(e.endsWith(".md")||(e+=".md"),this.app.vault.getAbstractFileByPath(e)instanceof ve.TFile)return`Error: Note "${e}" already exists. Use read_note to view it.`;let i=await this.app.vault.create(e,n);return new ve.Notice(`Created note: ${i.path}`),`Successfully created note "${i.path}" with ${n.length} characters.`}catch(e){return`Error creating note: ${e.message}`}}};var be=require("obsidian"),we=class{constructor(t){this.app=t;this.name="update_note";this.description='Update or append content to an existing note. Input format: "path:Note.md|content:New content to append" or "path:Note.md|replace:Old text|with:New text"'}async execute(t){try{let e=t.match(/path:([^|]+)/),n=t.match(/\|content:(.+)/),s=t.match(/\|replace:([^|]+)\|with:(.+)/);if(!e)return"Error: Must specify path (e.g., path:MyNote.md)";let i=e[1].trim();i.endsWith(".md")||(i+=".md");let a=this.app.vault.getAbstractFileByPath(i);if(!(a instanceof be.TFile))return`Error: Note "${i}" not found. Use create_note to create it.`;let o=await this.app.vault.read(a),r;if(s){let c=s[1].trim(),l=s[2].trim();if(r=o.replace(c,l),r===o)return`Warning: Text "${c}" not found in note. No changes made.`}else if(n){let c=n[1].trim();r=o+`

`+c}else return"Error: Must specify either |content: or |replace:|with:";return await this.app.vault.modify(a,r),new be.Notice(`Updated: ${a.path}`),`Successfully updated "${a.path}". Content now has ${r.length} characters.`}catch(e){return`Error updating note: ${e.message}`}}};var xe=class{constructor(t,e){this.settings=t;this.vault=e}async transcribe(t){if(!this.settings.apiKey)throw new Error("OpenAI API key is required for transcription");let e=await this.vault.readBinary(t),n=new FormData,s=new Blob([e],{type:t.extension==="mp3"?"audio/mpeg":"audio/wav"});n.append("file",s,`audio.${t.extension}`),n.append("model","whisper-1");let i=await fetch("https://api.openai.com/v1/audio/transcriptions",{method:"POST",headers:{Authorization:`Bearer ${this.settings.apiKey}`},body:n});if(!i.ok){let o=await i.text();throw new Error(`Transcription failed: ${i.status} - ${o}`)}return(await i.json()).text}};var mt=`
/* Enhanced UI RGB Variables */
:root {
  --background-primary-rgb: 255, 255, 255;
  --background-secondary-rgb: 245, 245, 245;
  --text-muted-rgb: 128, 128, 128;
  --interactive-accent-rgb: 0, 122, 255;
}

.theme-dark {
  --background-primary-rgb: 30, 30, 30;
  --background-secondary-rgb: 45, 45, 45;
  --text-muted-rgb: 150, 150, 150;
  --interactive-accent-rgb: 100, 170, 255;
}
`,Fe=class extends u.Modal{constructor(t,e,n,s){super(t),this.profiles=e,this.activeProfileId=n,this.onSelect=s}onOpen(){let{contentEl:t}=this;t.createEl("h2",{text:"Switch AI Profile"});let e=t.createDiv({cls:"profile-list"});e.style.display="flex",e.style.flexDirection="column",e.style.gap="0.5rem",this.profiles.forEach(n=>{let s=n.id===this.activeProfileId,i=e.createDiv({cls:"profile-item"});i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="space-between",i.style.padding="0.75rem",i.style.borderRadius="var(--radius-s)",i.style.border="1px solid var(--background-modifier-border)",i.style.cursor="pointer",i.style.backgroundColor=s?"var(--interactive-accent)":"var(--background-secondary)",i.style.color=s?"var(--text-on-accent)":"var(--text-normal)";let a=i.createDiv();a.createEl("strong",{text:n.name});let o=a.createDiv();o.style.fontSize="var(--font-smaller)",o.style.opacity="0.8",o.textContent=`${n.apiProvider} - ${n.model}`,s&&i.createEl("span",{text:"(Active)"}),i.addEventListener("click",()=>{s||this.onSelect(n.id),this.close()})})}onClose(){let{contentEl:t}=this;t.empty()}},Ce=class extends u.Plugin{async onload(){try{if(await this.loadSettings(),await this.migrateToProfiles(),this.settings.loggingConfig.enabled&&$.setLogLevel(Pe[this.settings.loggingConfig.logLevel]),$.info("Obsidian Agent plugin loaded",{component:"Plugin",version:"1.0.0"}),this.registerStyles(),!this.settings)throw new L("Failed to load plugin settings");this.aiService=new R(this.settings),this.contextProvider=new ee(this.app),this.embeddingService=new oe(this.settings),this.vectorStore=new O(this.app.vault),await this.vectorStore.load(),this.indexingService=new ce(this.app,this.embeddingService,this.vectorStore),this.memoryService=new ge(this.app.vault,this.embeddingService),await this.memoryService.load(),this.audioService=new xe(this.settings,this.app.vault),this.agentService=new he(this.aiService,[new ue(this.vectorStore,this.embeddingService),new me(this.app),new pe(this.app),new ye(this.app),new we(this.app),new fe(this.memoryService)],this.settings,this.memoryService),this.contextEngine=new ie(this.app.vault,this.app.metadataCache,this.vectorStore,this.embeddingService),this.multiNoteSynthesizer=new ae(this.app.vault,this.app.metadataCache,this.contextEngine,this.aiService),this.settings.totalRequests||(this.settings.totalRequests=0),this.settings.totalTokensUsed||(this.settings.totalTokensUsed=0),this.settings.estimatedCost||(this.settings.estimatedCost=0),this.addRibbonIcon("bot","Ask AI Agent",async()=>{let t=this.app.workspace.getActiveViewOfType(u.MarkdownView);if(!t||!t.file){new u.Notice("Please open a note first");return}try{let e=t.editor.getValue(),n=await this.gatherFullContext(t.file,e);new I(this.app,this.aiService,this.settings,()=>this.saveSettings(),n,s=>{s&&typeof s=="string"&&t.editor.replaceSelection(s)},this.agentService).open()}catch(e){this.handleError(e,"Failed to open AI Agent")}}),this.addCommand({id:"ask-ai-agent",name:"Ask AI Agent",editorCallback:async(t,e)=>{try{let n=e;if(!n||!n.file){new u.Notice("No active file found");return}let s=t.getValue(),i=await this.gatherFullContext(n.file,s);new I(this.app,this.aiService,this.settings,()=>this.saveSettings(),i,a=>{a&&typeof a=="string"&&t.replaceSelection(a)},this.agentService).open()}catch(n){this.handleError(n,"Failed to open AI Agent")}}}),this.addCommand({id:"ask-ai-agent-vault-context",name:"Ask AI Agent (with Linked Notes)",editorCallback:async(t,e)=>{try{let n=e;if(!n||!n.file){new u.Notice("No active file found");return}let s=t.getValue(),i=await this.gatherFullContext(n.file,s,!0);new I(this.app,this.aiService,this.settings,()=>this.saveSettings(),i,a=>{a&&typeof a=="string"&&t.replaceSelection(a)}).open()}catch(n){this.handleError(n,"Failed to open AI Agent with vault context")}}}),this.addCommand({id:"generate-summary",name:"Generate Summary",editorCallback:async t=>{let n=t.getSelection()||t.getValue();if(!n.trim()){new u.Notice("No text to summarize");return}new u.Notice("Generating summary...");try{let s=await this.aiService.generateCompletion({prompt:`Please provide a concise summary of the following text:

${n}`});await this.trackTokenUsage(s),t.replaceSelection(`

## Summary
${s.text}
`),new u.Notice("Summary generated!")}catch(s){new u.Notice(`Error: ${s.message}`),console.error("Summary Error:",s)}}}),this.addCommand({id:"multi-level-summary",name:"Multi-Level Summary (Quick/Standard/Detailed)",callback:async()=>{try{let t=this.app.workspace.getActiveFile();if(!t){new u.Notice("No active file");return}new u.Notice("Generating multi-level summaries...");let n=await new H(this.app,this.aiService).generateProgressiveSummary(t),s=`# Summaries: ${t.basename}

## \u{1F680} Quick Summary (TL;DR)
${n.get("quick")||"N/A"}

## \u{1F4CB} Standard Summary  
${n.get("standard")||"N/A"}

## \u{1F4DA} Detailed Summary
${n.get("detailed")||"N/A"}

---
*Generated on ${new Date().toLocaleString()}*
*Source: [[${t.basename}]]*
`,i=await this.app.vault.create(`Summaries - ${t.basename} - ${new Date().toISOString().split("T")[0]}.md`,s);await this.app.workspace.getLeaf().openFile(i),new u.Notice("Multi-level summaries generated!")}catch(t){this.handleError(t,"Failed to generate multi-level summary")}}}),this.addCommand({id:"academic-summary",name:"Generate Academic Summary",callback:async()=>{try{let t=this.app.workspace.getActiveFile();if(!t){new u.Notice("No active file");return}new u.Notice("Generating academic summary...");let n=await new H(this.app,this.aiService).summarizeNote(t,{level:"academic",includeSections:!0,includeKeyPoints:!0}),s=await this.app.vault.read(t),i=`# Academic Summary

${n.summary}

---

${s}`;await this.app.vault.modify(t,i),new u.Notice("Academic summary added to note!")}catch(t){this.handleError(t,"Failed to generate academic summary")}}}),this.addCommand({id:"expand-ideas",name:"Expand Ideas",editorCallback:async t=>{let e=t.getSelection();if(!e.trim()){new u.Notice("Please select text to expand");return}new u.Notice("Expanding ideas...");try{let n=await this.aiService.generateCompletion({prompt:`Please expand on following ideas with more detail and context:

${e}`});await this.trackTokenUsage(n),t.replaceSelection(n.text),new u.Notice("Ideas expanded!")}catch(n){new u.Notice(`Error: ${n.message}`),console.error("Expand Error:",n)}}}),this.addCommand({id:"improve-writing",name:"Improve Writing",editorCallback:async t=>{let e=t.getSelection();if(!e.trim()){new u.Notice("Please select text to improve");return}new u.Notice("Improving writing...");try{let n=await this.aiService.generateCompletion({prompt:`Please improve following text for clarity, grammar, and style:

${e}`});await this.trackTokenUsage(n),t.replaceSelection(n.text),new u.Notice("Writing improved!")}catch(n){new u.Notice(`Error: ${n.message}`),console.error("Improve Writing Error:",n)}}}),this.addCommand({id:"generate-outline",name:"Generate Outline",editorCallback:async t=>{let e=t.getSelection();if(!e.trim()){new u.Notice("Please select a topic for the outline");return}new u.Notice("Generating outline...");try{let n=await this.aiService.generateCompletion({prompt:`Please create a detailed outline for the following topic:

${e}`});await this.trackTokenUsage(n),t.replaceSelection(`

${n.text}
`),new u.Notice("Outline generated!")}catch(n){new u.Notice(`Error: ${n.message}`),console.error("Outline Error:",n)}}}),this.addCommand({id:"answer-question",name:"Answer Question Based on Note",editorCallback:t=>{let e=t.getValue();new I(this.app,this.aiService,this.settings,()=>this.saveSettings(),e,n=>{let s=t.getCursor();t.replaceRange(`

**Q:** ${n}
`,s)}).open()}}),this.addCommand({id:"switch-ai-profile",name:"Switch AI Profile",callback:()=>{let t=this.settings.profiles;if(t.length<=1){new u.Notice("No other profiles available. Create profiles in settings.");return}new Fe(this.app,t,this.settings.activeProfileId,async n=>{await this.switchProfile(n)}).open()}}),this.addCommand({id:"scan-dead-links",name:"Scan Vault for Dead Links",callback:async()=>{try{new u.Notice("Scanning vault for dead links...");let t=new B(this.app),e=await t.scanVault((i,a)=>{i%10===0&&new u.Notice(`Scanning... ${i}/${a} files`)}),n=t.generateReport(e),s=await this.app.vault.create(`Dead Links Report ${new Date().toISOString().split("T")[0]}.md`,n);await this.app.workspace.getLeaf().openFile(s),new u.Notice(`Scan complete: ${e.brokenCount} dead links found`)}catch(t){this.handleError(t,"Failed to scan for dead links")}}}),this.addCommand({id:"scan-file-dead-links",name:"Scan Current File for Dead Links",callback:async()=>{try{let t=this.app.workspace.getActiveFile();if(!t){new u.Notice("No active file");return}new u.Notice("Scanning file for dead links...");let n=await new B(this.app).scanFile(t);if(n.length===0)new u.Notice("\u2705 No dead links found in this file!");else{let s=`Found ${n.length} dead link${n.length>1?"s":""} in ${t.basename}`;new u.Notice(s),console.log("Dead links:",n)}}catch(t){this.handleError(t,"Failed to scan file for dead links")}}}),this.addCommand({id:"suggest-links",name:"Suggest Internal Links for Current File",callback:async()=>{try{let t=this.app.workspace.getActiveFile();if(!t){new u.Notice("No active file");return}new u.Notice("Analyzing file for link suggestions...");let e=new ne(this.app),n=await e.suggestLinks(t);if(n.length===0)new u.Notice("No link suggestions found");else{let s=e.generateReport(t,n),i=await this.app.vault.create(`Link Suggestions - ${t.basename} - ${new Date().toISOString().split("T")[0]}.md`,s);await this.app.workspace.getLeaf().openFile(i),new u.Notice(`Found ${n.length} link suggestions`)}}catch(t){this.handleError(t,"Failed to suggest links")}}}),this.addCommand({id:"suggest-tags",name:"Suggest Tags for Current Note",callback:async()=>{try{let t=this.app.workspace.getActiveFile();if(!t){new u.Notice("No active file");return}new u.Notice("Analyzing note for tag suggestions...");let e=new U(this.app),n=await e.suggestTags(t);if(n.length===0){new u.Notice("No tag suggestions found");return}new Oe(this.app,n,async s=>{s.length>0&&(await e.applyTags(t,s),new u.Notice(`Applied ${s.length} tags`))}).open()}catch(t){this.handleError(t,"Failed to suggest tags")}}}),this.addCommand({id:"auto-tag-note",name:"Auto-Tag Current Note (Top Suggestions)",callback:async()=>{try{let t=this.app.workspace.getActiveFile();if(!t){new u.Notice("No active file");return}new u.Notice("Auto-tagging note...");let e=new U(this.app),n=await e.suggestTags(t,{minConfidence:.6,maxSuggestions:3});if(n.length===0){new u.Notice("No confident tag suggestions found");return}let s=n.map(i=>i.tag);await e.applyTags(t,s),new u.Notice(`Auto-tagged with: ${s.join(", ")}`)}catch(t){this.handleError(t,"Failed to auto-tag note")}}}),this.addCommand({id:"find-duplicates",name:"Find Duplicate & Similar Notes",callback:async()=>{try{new u.Notice("Scanning vault for duplicates...");let e=await new se(this.app).findDuplicates({exactMatchThreshold:1,nearDuplicateThreshold:.95,semanticThreshold:.7,minContentLength:50});if(e.length===0){new u.Notice("\u2705 No duplicates found!");return}let n=this.generateDuplicateReport(e),s=await this.app.vault.create(`Duplicate Notes Report - ${new Date().toISOString().split("T")[0]}.md`,n);await this.app.workspace.getLeaf().openFile(s),new u.Notice(`Found ${e.length} duplicate groups`)}catch(t){this.handleError(t,"Failed to find duplicates")}}}),this.addCommand({id:"compare-notes",name:"Compare Current Note with Another",callback:async()=>{try{if(!this.app.workspace.getActiveFile()){new u.Notice("No active file");return}new u.Notice("Select a note to compare with..."),new u.Notice("File comparison feature coming soon!")}catch(t){this.handleError(t,"Failed to compare notes")}}}),this.addCommand({id:"synthesize-notes",name:"Synthesize Insights from Multiple Notes",callback:async()=>{var t;try{let e=this.app.vault.getMarkdownFiles(),n=await this.promptUser("Enter tag (with #) or folder path to synthesize, or leave empty for all notes:"),s=[];if(n&&n.startsWith("#")){let c=n.substring(1);for(let l of e){let d=this.app.metadataCache.getFileCache(l),g=((t=d==null?void 0:d.frontmatter)==null?void 0:t.tags)||[];(Array.isArray(g)?g:[g]).includes(c)&&s.push(l)}}else n?s=e.filter(c=>{var l;return(l=c.parent)==null?void 0:l.path.includes(n)}):s=e.sort((c,l)=>l.stat.mtime-c.stat.mtime).slice(0,20);if(s.length===0){new u.Notice("No notes found matching criteria");return}new u.Notice(`Synthesizing ${s.length} notes...`);let i=await this.multiNoteSynthesizer.synthesizeNotes(s),a=this.generateSynthesisReport(i),o=`Synthesis - ${new Date().toISOString().split("T")[0]}.md`;await this.app.vault.create(o,a);let r=this.app.vault.getAbstractFileByPath(o);r instanceof u.TFile&&await this.app.workspace.getLeaf().openFile(r),new u.Notice(`\u2713 Synthesis complete! (${s.length} notes)`)}catch(e){this.handleError(e,"Failed to synthesize notes")}}}),this.addCommand({id:"research-assistant",name:"Research Assistant - Answer from Vault",callback:async()=>{try{let t=await this.promptUser("What would you like to research in your vault?");if(!t)return;new u.Notice("Researching across your vault...");let e=await this.multiNoteSynthesizer.answerResearchQuestion(t,15),n=this.app.workspace.getActiveFile(),s=this.app.workspace.getActiveViewOfType(u.MarkdownView),i=`## Research Question

${t}

## Answer

${e}

---
*Generated by Research Assistant on ${new Date().toLocaleString()}*

`;if(s&&n){let a=s.editor;a.replaceRange(i,a.getCursor())}else{let a=`Research - ${t.substring(0,50)}.md`;await this.app.vault.create(a,i);let o=this.app.vault.getAbstractFileByPath(a);o instanceof u.TFile&&await this.app.workspace.getLeaf().openFile(o)}new u.Notice("\u2713 Research complete!")}catch(t){this.handleError(t,"Research failed")}}}),this.addCommand({id:"find-knowledge-gaps",name:"Identify Knowledge Gaps in Research",callback:async()=>{try{let t=await this.promptUser("What topic would you like to analyze for knowledge gaps?");if(!t)return;new u.Notice("Analyzing knowledge gaps...");let e=this.app.vault.getMarkdownFiles(),n=[];for(let c of e){let l=await this.contextEngine.scoreNoteRelevance(c,t);l.score>30&&n.push({file:c,score:l.score})}n.sort((c,l)=>l.score-c.score);let s=n.slice(0,10).map(c=>c.file);if(s.length===0){new u.Notice("No relevant notes found");return}let i=await this.multiNoteSynthesizer.identifyKnowledgeGaps(t,s),a=`# Knowledge Gap Analysis: ${t}

*Based on ${s.length} relevant notes*

## Identified Gaps

`+i.map((c,l)=>`${l+1}. ${c}`).join(`
`)+`

## Related Notes

`+s.map(c=>`- [[${c.basename}]]`).join(`
`)+`

---
*Generated ${new Date().toLocaleString()}*`,o=`Gap Analysis - ${t}.md`;await this.app.vault.create(o,a);let r=this.app.vault.getAbstractFileByPath(o);r instanceof u.TFile&&await this.app.workspace.getLeaf().openFile(r),new u.Notice(`\u2713 Found ${i.length} knowledge gaps`)}catch(t){this.handleError(t,"Gap analysis failed")}}}),this.addCommand({id:"suggest-research-directions",name:"Suggest Next Research Directions",callback:async()=>{try{let t=await this.promptUser("What research topic would you like suggestions for?");if(!t)return;new u.Notice("Analyzing research directions...");let e=this.app.vault.getMarkdownFiles(),n=[];for(let c of e){let l=await this.contextEngine.scoreNoteRelevance(c,t);l.score>30&&n.push({file:c,score:l.score})}n.sort((c,l)=>l.score-c.score);let s=n.slice(0,10).map(c=>c.file);if(s.length===0){new u.Notice("No relevant notes found");return}let i=await this.multiNoteSynthesizer.suggestResearchDirections(t,s),a=`# Research Direction Suggestions: ${t}

`;a+=`*Based on analysis of ${s.length} notes*

`;for(let c of i){let l=c.priority==="high"?"\u{1F534}":c.priority==="medium"?"\u{1F7E1}":"\u{1F7E2}";a+=`## ${l} ${c.direction}

`,a+=`**Why this matters:** ${c.reasoning}

`,c.suggestedSources.length>0&&(a+=`**Suggested sources:**
`,a+=c.suggestedSources.map(d=>`- ${d}`).join(`
`),a+=`

`)}a+=`## Source Notes

`,a+=s.map(c=>`- [[${c.basename}]]`).join(`
`),a+=`

---
*Generated ${new Date().toLocaleString()}*`;let o=`Research Directions - ${t}.md`;await this.app.vault.create(o,a);let r=this.app.vault.getAbstractFileByPath(o);r instanceof u.TFile&&await this.app.workspace.getLeaf().openFile(r),new u.Notice(`\u2713 Generated ${i.length} research suggestions`)}catch(t){this.handleError(t,"Failed to generate suggestions")}}}),this.addCommand({id:"find-related-notes",name:"Find Semantically Related Notes",callback:async()=>{try{let t=this.app.workspace.getActiveFile();if(!t){new u.Notice("No active file");return}new u.Notice("Finding related notes...");let e=await this.contextEngine.findClusterMates(t);if(e.length===0){new u.Notice("No semantically related notes found");return}let n=`# Notes Related to ${t.basename}

`;n+=`Found ${e.length} semantically similar notes:

`,n+=e.map(i=>`- [[${i.basename}]]`).join(`
`),n+=`

---
*Generated by Context Engine on ${new Date().toLocaleString()}*`;let s=this.app.workspace.getActiveViewOfType(u.MarkdownView);if(s){let i=s.editor;i.replaceRange(n,i.getCursor())}else{let i=`Related to ${t.basename}.md`;await this.app.vault.create(i,n)}new u.Notice(`\u2713 Found ${e.length} related notes`)}catch(t){this.handleError(t,"Failed to find related notes")}}}),this.addCommand({id:"build-semantic-clusters",name:"Discover Semantic Note Clusters",callback:async()=>{try{new u.Notice("Building semantic clusters... This may take a moment.");let t=await this.contextEngine.buildSemanticClusters(),e=`# Semantic Note Clusters

`;e+=`Discovered ${t.size} thematic clusters in your vault:

`;for(let[i,a]of t)e+=`## ${a.theme}

`,e+=`*Keywords: ${a.keywords.join(", ")}*

`,e+=`**Notes (${a.notes.length}):**
`,e+=a.notes.map(o=>`- [[${o.basename}]]`).join(`
`),e+=`

`;e+=`---
*Generated ${new Date().toLocaleString()}*`;let n=`Semantic Clusters - ${new Date().toISOString().split("T")[0]}.md`;await this.app.vault.create(n,e);let s=this.app.vault.getAbstractFileByPath(n);s instanceof u.TFile&&await this.app.workspace.getLeaf().openFile(s),new u.Notice(`\u2713 Found ${t.size} clusters`)}catch(t){this.handleError(t,"Clustering failed")}}}),this.addCommand({id:"rebuild-index",name:"Rebuild Semantic Index",callback:async()=>{let t=await this.promptUser('Rebuild entire index? This may cost API credits. Type "yes" to confirm.');(t==null?void 0:t.toLowerCase())==="yes"&&await this.indexingService.indexVault(!0)}}),this.addCommand({id:"semantic-search",name:"Semantic Search",callback:async()=>{let t=await this.promptUser("Enter search query:");if(t){new u.Notice("Searching...");try{let e=await this.embeddingService.generateEmbedding(t),n=await this.vectorStore.search(e.vector,10,.5);if(n.length===0){new u.Notice("No relevant results found.");return}let s=`# Semantic Search Results: "${t}"

`+n.map(o=>`- [[${o.metadata.basename}]] (Score: ${(o.score*100).toFixed(1)}%)`).join(`
`),i=`Search Results - ${Date.now()}.md`;await this.app.vault.create(i,s);let a=this.app.vault.getAbstractFileByPath(i);a instanceof u.TFile&&await this.app.workspace.getLeaf().openFile(a)}catch(e){this.handleError(e,"Semantic Search Failed")}}}}),this.addCommand({id:"ask-agent-auto",name:"Ask Agent (Auto)",callback:async()=>{let t=await this.promptUser("What would you like me to do?");if(t){new u.Notice("Agent is thinking...");try{let e=await this.memoryService.getRelevantMemories(t),n=e.length>0?`Context about user: ${e.join("; ")}

Question: ${t}`:t,s=await this.agentService.run(n),i=new u.Modal(this.app);i.contentEl.createEl("h2",{text:"Agent Response"}),i.contentEl.createEl("div",{text:s}),i.open()}catch(e){this.handleError(e,"Agent Error")}}}}),this.addCommand({id:"transcribe-audio",name:"Transcribe Selected Audio File",callback:async()=>{let t=this.app.workspace.getActiveFile();if(!t||!["mp3","wav","m4a","webm"].includes(t.extension)){new u.Notice("Please open an audio file first.");return}new u.Notice("Transcribing...");try{let e=await this.audioService.transcribe(t),n=`Transcript - ${t.basename}.md`;await this.app.vault.create(n,`# Transcript: ${t.basename}

${e}`),new u.Notice("Transcription complete!")}catch(e){this.handleError(e,"Transcription Failed")}}}),this.addCommand({id:"analyze-image",name:"Analyze Current Image",callback:async()=>{let t=this.app.workspace.getActiveFile();if(!t||!["png","jpg","jpeg","webp"].includes(t.extension)){new u.Notice("Please open an image file first.");return}let e=await this.promptUser("What would you like to know about this image?");if(e){new u.Notice("Analyzing image...");try{let n=await this.app.vault.readBinary(t),s=btoa(new Uint8Array(n).reduce((o,r)=>o+String.fromCharCode(r),"")),i=await this.aiService.generateCompletion({prompt:e,imageData:s}),a=new u.Modal(this.app);a.contentEl.createEl("h2",{text:"Image Analysis"}),a.contentEl.createEl("div",{text:i.text}),a.open()}catch(n){this.handleError(n,"Image Analysis Failed")}}}}),this.addSettingTab(new V(this.app,this)),console.log("Obsidian Agent plugin loaded")}catch(t){this.handleError(t,"Failed to load plugin")}}onunload(){console.log("Obsidian Agent plugin unloaded")}async loadSettings(){this.settings=Object.assign({},_e,await this.loadData())}async gatherFullContext(t,e,n=!1){e||(e="");let s=this.settings.contextConfig;if(!(n||(s==null?void 0:s.enableLinkedNotes)||(s==null?void 0:s.enableBacklinks)||(s==null?void 0:s.enableTagContext)||(s==null?void 0:s.enableFolderContext))||!t)return e;let a={sources:[{type:"current",enabled:!0},{type:"linked",enabled:n||(s==null?void 0:s.enableLinkedNotes)||!1},{type:"backlinks",enabled:(s==null?void 0:s.enableBacklinks)||!1},{type:"tags",enabled:(s==null?void 0:s.enableTagContext)||!1},{type:"folder",enabled:(s==null?void 0:s.enableFolderContext)||!1}],maxNotesPerSource:Math.max(1,(s==null?void 0:s.maxNotesPerSource)||5),maxTokensPerNote:Math.max(100,(s==null?void 0:s.maxTokensPerNote)||1e3),linkDepth:Math.max(1,Math.min(3,(s==null?void 0:s.linkDepth)||1)),excludeFolders:((s==null?void 0:s.excludeFolders)||"templates, .obsidian").split(",").map(o=>o.trim()).filter(o=>o.length>0)};try{let o=await this.contextProvider.gatherContext(t,e,a,this.settings.apiProvider);if(!o||o.length===0)return e;let r=this.contextProvider.formatContextsForPrompt(o);if(o.length>1){let c=o.length-1;new u.Notice(`Loaded context from ${c} additional note(s)`)}return r||e}catch(o){return console.error("Failed to gather vault context:",o),new u.Notice("Warning: Could not load vault context, using current note only"),e}}async migrateToProfiles(){if(!this.settings.profiles||this.settings.profiles.length===0){let t=Be(this.settings);this.settings.profiles=[t],this.settings.activeProfileId="default",await this.saveSettings(),console.log("Migrated settings to profile system")}}getActiveProfile(){return this.settings.profiles.find(t=>t.id===this.settings.activeProfileId)}async switchProfile(t){let e=this.settings.profiles.find(n=>n.id===t);if(!e){new u.Notice("Profile not found");return}this.settings.activeProfileId=t,this.settings.apiProvider=e.apiProvider,this.settings.apiKey=e.apiKey,this.settings.customApiUrl=e.customApiUrl,this.settings.model=e.model,this.settings.temperature=e.temperature,this.settings.maxTokens=e.maxTokens,this.settings.systemPrompt=e.systemPrompt,await this.saveSettings(),new u.Notice(`Switched to profile: ${e.name}`)}async createProfile(t){this.settings.profiles.push(t),await this.saveSettings(),new u.Notice(`Profile created: ${t.name}`)}async updateProfile(t){let e=this.settings.profiles.findIndex(n=>n.id===t.id);e>=0&&(this.settings.profiles[e]=t,t.id===this.settings.activeProfileId&&(this.settings.apiProvider=t.apiProvider,this.settings.apiKey=t.apiKey,this.settings.customApiUrl=t.customApiUrl,this.settings.model=t.model,this.settings.temperature=t.temperature,this.settings.maxTokens=t.maxTokens,this.settings.systemPrompt=t.systemPrompt),await this.saveSettings())}async deleteProfile(t){if(t==="default"){new u.Notice("Cannot delete the default profile");return}let e=this.settings.profiles.findIndex(n=>n.id===t);if(e>=0){let n=this.settings.profiles[e].name;this.settings.profiles.splice(e,1),this.settings.activeProfileId===t?await this.switchProfile("default"):await this.saveSettings(),new u.Notice(`Profile deleted: ${n}`)}}generateDuplicateReport(t){let e=[];e.push(`# Duplicate & Similar Notes Report
`),e.push(`**Scan Date:** ${new Date().toISOString()}
`),e.push(`**Groups Found:** ${t.length}
`);let n=t.filter(a=>a.duplicateType==="exact"),s=t.filter(a=>a.duplicateType==="near-exact"),i=t.filter(a=>a.duplicateType==="semantic");return e.push(`- Exact Duplicates: ${n.length}`),e.push(`- Near-Exact Duplicates: ${s.length}`),e.push(`- Semantic Duplicates: ${i.length}
`),n.length>0&&(e.push(`## \u{1F534} Exact Duplicates
`),e.push(`These notes have identical content and should be merged.
`),n.forEach((a,o)=>{e.push(`### Group ${o+1} (${a.notes.length} notes)`),e.push(`**Similarity:** 100%
`),a.notes.forEach(r=>{e.push(`- [[${r.path}]]`)}),a.commonContent&&e.push(`
**Preview:**
> ${a.commonContent}
`),e.push("")})),s.length>0&&(e.push(`## \u{1F7E1} Near-Exact Duplicates
`),e.push(`These notes are 95%+ similar with minor differences.
`),s.forEach((a,o)=>{e.push(`### Group ${o+1} (${a.notes.length} notes)`);let r=Math.round(a.similarity*100);e.push(`**Similarity:** ${r}%
`),a.notes.forEach(c=>{e.push(`- [[${c.path}]]`)}),e.push("")})),i.length>0&&(e.push(`## \u{1F7E2} Semantic Duplicates
`),e.push(`These notes cover similar topics or themes.
`),i.forEach((a,o)=>{e.push(`### Group ${o+1} (${a.notes.length} notes)`);let r=Math.round(a.similarity*100);e.push(`**Similarity:** ${r}%
`),a.notes.forEach(c=>{e.push(`- [[${c.path}]]`)}),e.push("")})),e.push(`---
`),e.push(`## \u{1F4A1} Recommendations
`),e.push("- **Exact Duplicates:** Delete all but one copy"),e.push("- **Near-Exact:** Review differences and merge if appropriate"),e.push(`- **Semantic:** Consider linking or consolidating related content
`),e.join(`
`)}generateSynthesisReport(t){let e=[];if(e.push(`# Multi-Note Synthesis Report
`),e.push(`**Generated:** ${new Date().toLocaleString()}`),e.push(`**Notes Analyzed:** ${t.notesAnalyzed}
`),e.push(`## Summary
`),e.push(t.summary+`
`),t.keyInsights&&t.keyInsights.length>0&&(e.push(`## Key Insights
`),t.keyInsights.forEach((n,s)=>{e.push(`${s+1}. ${n}`)}),e.push("")),t.contradictions&&t.contradictions.length>0&&(e.push(`## \u26A0\uFE0F Contradictions Found
`),t.contradictions.forEach(n=>{e.push(`- ${n}`)}),e.push("")),t.knowledgeGaps&&t.knowledgeGaps.length>0&&(e.push(`## \u{1F50D} Knowledge Gaps
`),t.knowledgeGaps.forEach(n=>{e.push(`- ${n}`)}),e.push("")),t.citations&&t.citations.size>0){e.push(`## \u{1F4DA} Source Citations
`);for(let[n,s]of t.citations)e.push(`### [[${n}]]`),s.forEach(i=>{e.push(`> ${i}`)}),e.push("")}return e.push("---"),e.push("*Generated by Multi-Note Synthesizer*"),e.join(`
`)}async promptUser(t){return new Promise(e=>{new class extends u.Modal{constructor(){super(...arguments);this.result=null}onOpen(){let{contentEl:i}=this;i.createEl("h3",{text:t});let a=i.createEl("input",{type:"text",attr:{style:"width: 100%; padding: 8px; margin: 10px 0;"}}),o=i.createDiv({attr:{style:"display: flex; gap: 10px; justify-content: flex-end;"}});o.createEl("button",{text:"Submit"}).addEventListener("click",()=>{this.result=a.value||null,this.close()}),o.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.result=null,this.close()}),a.addEventListener("keypress",l=>{l.key==="Enter"&&(this.result=a.value||null,this.close())}),a.focus()}onClose(){let{contentEl:i}=this;i.empty(),e(this.result)}}(this.app).open()})}async trackTokenUsage(t){try{if(!this.settings.enableTokenTracking||!t.tokensUsed)return;this.settings.totalRequests=(this.settings.totalRequests||0)+1,this.settings.totalTokensUsed=(this.settings.totalTokensUsed||0)+t.tokensUsed;let e=this.estimateCost(t);this.settings.estimatedCost=(this.settings.estimatedCost||0)+e;let n=this.settings.costThreshold||10;this.settings.estimatedCost>n&&new u.Notice(`Cost warning: You've spent approximately $${this.settings.estimatedCost.toFixed(2)} this session`,5e3),await this.saveSettings()}catch(e){console.error("Failed to track token usage:",e)}}handleError(t,e){let n=e;t instanceof k?n=`Validation error: ${t.message}`:t instanceof D?n=`API error: ${t.message}`:t instanceof L?n=`Configuration error: ${t.message}`:t.message&&(n=`${e}: ${t.message}`),console.error(e,t),new u.Notice(n,5e3)}registerStyles(){this.app.vault.adapter.read("styles.css").then(n=>{if(n){let s=document.createElement("style");s.textContent=n,s.className="obsidian-agent-styles",document.head.appendChild(s)}}),this.app.vault.adapter.read("styles-enhanced.css").then(n=>{if(n){let s=document.createElement("style");s.textContent=mt+`
`+n,s.className="obsidian-agent-styles-enhanced",document.head.appendChild(s)}}),this.applyAccessibilitySettings()}applyAccessibilitySettings(){var t,e;document.body.classList.remove("oa-high-contrast","oa-reduced-motion"),(t=this.settings.accessibilityConfig)!=null&&t.enableHighContrast&&document.body.classList.add("oa-high-contrast"),(e=this.settings.accessibilityConfig)!=null&&e.enableReducedMotion&&document.body.classList.add("oa-reduced-motion")}estimateCost(t){if(this.settings.apiProvider==="openai"){let e=(t.inputTokens||0)/1e3*.03,n=(t.outputTokens||0)/1e3*.06;return e+n}else if(this.settings.apiProvider==="anthropic")return(t.tokensUsed||0)/1e3*.075;return 0}async saveSettings(){var s,i,a;let t=(s=this.aiService)==null?void 0:s.getCacheService();if(t&&((i=this.settings.cacheConfig)!=null&&i.enabled)){let o=t.exportCache();this.settings.cacheData={entries:o.entries,stats:o.stats}}await this.saveData(this.settings);let e=new R(this.settings),n=(a=this.aiService)==null?void 0:a.getCacheService();n&&t&&e.getCacheService().importCache({entries:n.exportCache().entries,stats:n.getStats(),settings:this.settings.cacheConfig}),this.aiService=e}},Oe=class extends u.Modal{constructor(e,n,s){super(e);this.selectedTags=new Set;this.suggestions=n,this.onSelect=s}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Suggested Tags"}),e.createEl("p",{text:"Select tags to apply to this note:",cls:"setting-item-description"});let n=e.createEl("div",{cls:"tag-suggestion-list"});this.suggestions.forEach(r=>{let c=n.createEl("div",{cls:"tag-suggestion-item",attr:{"data-tag":r.tag}}),l=c.createEl("input",{type:"checkbox",cls:"tag-checkbox"}),d=c.createEl("label",{cls:"tag-label"});d.createEl("span",{text:`#${r.tag}`,cls:"tag-name"});let g=Math.round(r.confidence*100);d.createEl("span",{text:"% ",cls:"tag-confidence"});let m=d.createEl("span",{text:this.getReasonText(r.reason),cls:"tag-reason"});r.examples&&r.examples.length>0&&m.createEl("span",{text:" ()",cls:"tag-examples"}),l.addEventListener("change",()=>{l.checked?(this.selectedTags.add(r.tag),c.addClass("selected")):(this.selectedTags.delete(r.tag),c.removeClass("selected"))}),g>=70&&(l.checked=!0,this.selectedTags.add(r.tag),c.addClass("selected"))});let s=e.createEl("div",{cls:"modal-button-container"});s.createEl("button",{text:"Apply Selected Tags",cls:"mod-cta"}).addEventListener("click",()=>{this.onSelect([...this.selectedTags]),this.close()}),s.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.close()});let o=e.createEl("style");o.textContent=`
.tag-suggestion-list {
margin: 20px 0;
max-height: 400px;
overflow-y: auto;
}
.tag-suggestion-item {
padding: 10px;
margin: 5px 0;
border: 1px solid var(--background-modifier-border);
border-radius: 5px;
display: flex;
align-items: center;
cursor: pointer;
transition: all 0.2s;
}
.tag-suggestion-item:hover {
background-color: var(--background-modifier-hover);
}
.tag-suggestion-item.selected {
background-color: var(--interactive-accent);
color: var(--text-on-accent);
border-color: var(--interactive-accent);
}
.tag-checkbox {
margin-right: 10px;
}
.tag-label {
flex: 1;
display: flex;
flex-wrap: wrap;
align-items: center;
gap: 5px;
}
.tag-name {
font-weight: 600;
margin-right: 10px;
}
.tag-confidence {
color: var(--text-accent);
font-size: 0.9em;
}
.tag-reason {
color: var(--text-muted);
font-size: 0.85em;
}
.tag-examples {
font-style: italic;
}
.modal-button-container {
display: flex;
justify-content: flex-end;
gap: 10px;
margin-top: 20px;
}
`}getReasonText(e){return{content_match:"content match",pattern_learned:"learned pattern",similar_notes:"similar notes",frequency:"frequently co-occurs"}[e]||e}onClose(){let{contentEl:e}=this;e.empty()}};
